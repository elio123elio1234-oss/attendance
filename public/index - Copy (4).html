
<!DOCTYPE html>
<html lang="en" class="bg-white dark:bg-gray-900 min-h-screen">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta id="meta-theme-color" name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>SIRC Weekly</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // Forces Tailwind to use class-based dark mode instead of system preference
            theme: {
                extend: {
                    colors: {
                        // Custom colors can be added here in the future
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- חסימת העתקה רק במובייל (מסכים צרים מ-768 פיקסלים) --- */
        @media (max-width: 768px) {
            *, *::before, *::after {
                -webkit-touch-callout: none; /* מונע תפריט לחיצה ארוכה באייפון */
                -webkit-user-select: none;   /* ספארי/כרום במובייל */
                user-select: none;           /* כל השאר */
            }

            /* --- חובה: החזרת האפשרות להקליד בשדות טקסט --- */
            input, textarea, [contenteditable="true"] {
                -webkit-user-select: text !important;
                user-select: text !important;
                -webkit-touch-callout: default !important;
                cursor: text;
            }
        }

        /* --- [תיקון 3] הסתרת פסי גלילה בכל האפליקציה --- */

        html, body {
            -webkit-text-size-adjust: 100%; /* מונע מדפדפנים לשנות את גודל הטקסט */
            text-size-adjust: 100%;         /* תקן עתידי לאותה מטרה */
            overscroll-behavior: none; /* מונע bounce effect */
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden !important; /* Prevent horizontal scroll on body */
            max-width: 100vw !important;
            background-color: #ffffff;
            transition: background-color 0.2s ease;
        }
        
        .dark html, .dark body {
            background-color: #111827;
        }
        
        /* --- [תיקון 2] הסתרת פסי גלילה בכל האפליקציה (כולל body) --- */
        html, body {
            scrollbar-width: none; /* For Firefox */
            -ms-overflow-style: none;  /* For Internet Explorer and Edge */
        }
        html::-webkit-scrollbar,
        body::-webkit-scrollbar { /* הכלל הוחל גם על body */
            display: none; /* For WebKit browsers */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Clean white background */
        }

        /* Force pure white only on the root document elements. Avoid overriding
           Tailwind utility classes used for table headers and TL rows. */
        html, body {
            /* מחקנו את background-color !important */
            overscroll-behavior: none;
        }

        /* העלמת החצים הקטנים בתיבת input מסוג number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }

        /* --- Dark mode: set dark backgrounds for main containers and body --- */
        .dark body,
        .dark #app-container,
        .dark #auth-container {
            background-color: #111827 !important; /* Tailwind gray-900 */
            color: #f9fafb !important; /* Tailwind gray-50 */
        }
        
        /* Remove gray panels by making them transparent in dark mode */
        .dark #app-container .bg-white,
        .dark #auth-container .bg-white,
        .dark #app-container .p-6, 
        .dark #app-container .p-8,
        .dark #auth-container .p-6, 
        .dark #auth-container .p-8,
        .dark #app-container .overflow-x-auto, 
        .dark #auth-container .overflow-x-auto {
            background-color: transparent !important;
            color: #f9fafb !important;
        }

        /* --- Make app look like a clean white page (no boxed white cards) --- */
        /* Remove the boxed white panels, shadows and rounded corners that create
           the separate "card" rectangles on main pages. Scoped to the main
           containers so modals and inputs keep their intended styles. */
        #auth-container .w-full.max-w-md.bg-white,
        #auth-container .rounded-xl,
        #auth-container .shadow-lg,
        #app-container .rounded-xl,
        #app-container .shadow-md,
        #app-container .bg-white {
            background-color: transparent !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            border: none !important;
        }

        /* Keep inputs and small white elements intact by limiting the scope above.
           Also ensure loading overlay matches the new white background. */
        #loading-spinner {
            background-color: #ffffff;
        }

        /* --- Mobile: reduce side padding and allow full-width containers --- */
        @media (max-width: 640px) {
            /* Remove large side gaps for mobile devices */
            #app-container, #auth-container {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                max-width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                overflow-x: hidden !important; /* Prevent page from scrolling horizontally */
            }

            /* Ensure inner 'card' wrappers expand to full width when we removed their borders */
            #auth-container > div.w-full.max-w-md,
            #app-container > div {
                width: 100% !important;
                max-width: 100% !important;
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }

            /* Remove heavy padding on common padding utilities inside containers so tables reach edges */
            #app-container .p-6, #app-container .p-8,
            #auth-container .p-6, #auth-container .p-8 {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }

            /* Tables and overflow wrappers should use full width */
            #app-container .overflow-x-auto, #auth-container .overflow-x-auto,
            #app-container .overflow-auto, #auth-container .overflow-auto {
                padding-left: 0 !important;
                padding-right: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                width: 100% !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            /* Reduce table cell horizontal padding on mobile (improves fit).
               Allow wrapping of long status labels so they don't overflow
               into the next day's cell. We keep nowrap removed so labels
               can wrap gracefully; use text-overflow/ellipsis only when
               explicit truncation is desired on larger screens. */
            #app-container table td, #app-container table th,
            #auth-container table td, #auth-container table th {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                white-space: normal !important; /* allow wrapping on phones */
                word-break: break-word !important;
                overflow-wrap: anywhere !important;
            }

            /* Tabs and nav should use more horizontal space */
            nav#main-nav {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
            /* Team View: allow tables to bleed near screen edges on phones */
            #content-display, #content-display .bg-white, #team-view-container {
                width: 98vw !important; /* nearly full viewport width */
                max-width: 98vw !important;
                margin-left: calc((100vw - 98vw) / -2) !important; /* shift to the left so it sits closer to the screen edge */
                margin-right: calc((100vw - 98vw) / -2) !important; /* shift to the right symmetrically */
                padding-left: 0.25rem !important; /* keep a tiny inner gutter */
                padding-right: 0.25rem !important;
            }
            /* Make any tables inside team view expand to full available width.
               Also allow horizontal scroll if content still doesn't fit. */
            #team-view-container table {
                width: 100% !important;
                min-width: 100% !important;
                table-layout: auto !important; /* allow columns to size to content */
            }
            /* Remove inner card padding only for the team view card to maximize space */
            #content-display > div.bg-white {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
            
            /* Sticky header on mobile */
            #sticky-header {
                padding: 0.75rem 0.5rem !important;
            }
            
            #app-container {
                padding-top: 6rem !important;
            }
        }


        
        /* --- תיקון סופי ללוגו באייפון PWA --- */
        .louly-app-logo {
            /* בידוד: מבטיח שה-SVG לא יושפע מצבעי הרקע/טקסט של ההדר */
            isolation: isolate;
            z-index: 50;
            position: relative;
        }

        .louly-app-logo text {
            /* 1. הגרדיאנט הוא המלך */
            fill: url(#gradElectricDarkApp) !important;
            
            /* 2. מחיקת כל זכר לצבע טקסט רגיל (זה מה שיוצר את העכירות) */
            color: transparent !important;
            -webkit-text-fill-color: transparent !important;
            
            /* 3. הגדרות רינדור לאייפון */
            stroke: none !important;
            mix-blend-mode: normal !important; /* מונע ערבוב עם הרקע השחור */
        }
        
        .louly-app-logo path {
            stroke: url(#gradElectricDarkApp) !important;
            color: transparent !important;
        }
        
        /* --- New Gradient Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            background-size: 200% auto;
            border: none;
        }
        .btn:hover {
            background-position: right center; /* change the direction of the change here */
            box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.2);
        }
        .btn-primary {
            /* [MODIFICATION] New multi-color gradient for the sign-in button */
            background-image: linear-gradient(to right, #ec4899 0%, #a855f7 33%, #4ade80 66%, #3b82f6 100%);
        }
        .btn-danger {
            background-image: linear-gradient(to right, #ef4444 0%, #db2777 51%, #ef4444 100%);
        }
        .btn-success {
             background-image: linear-gradient(to right, #22c55e 0%, #15803d 51%, #22c55e 100%);
        }

        /* --- Animated Gradient Logo Text --- */
        .animated-gradient-text {
            background: linear-gradient(90deg, #1428a0, #ec4899, #a855f7, #4ade80, #1428a0);
            background-size: 300% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-flow 15s ease-in-out infinite;
        }
        @keyframes gradient-flow {
            0% { background-position: 200% 50%; }
            50% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        /* --- Samsung SVG Logo Color --- */
        .samsung-logo-svg {
            fill: #1428a0;
        }
        .dark .samsung-logo-svg {
            fill: #8ab4f8; /* A lighter, more accessible blue for dark backgrounds */
        }


        /* --- New Theme Colors & Links --- */
        .theme-purple-bg { background-color: #ede9fe; } /* violet-100 */
        .theme-purple-border { border-color: #c4b5fd; } /* violet-300 */
        .theme-purple-text { color: #7c3aed; } /* violet-600 */
        .theme-purple-text-dark { color: #5b21b6; } /* violet-700 */
        .theme-link {
            font-weight: 500; 
            background-image: linear-gradient(to right, #FF3399, #FF40FF, #9D40FF);
            background-size: 150% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: all .3s ease-in-out;
        }
        .theme-link:hover {
            color: transparent;
            transform: scale(1.05);
            background-position: right center;
        }

        /* --- [שינוי] Tab Animation Styles --- */
        .tab-btn {
            transition: color 0.3s ease-in-out, transform 0.1s ease-out;
            position: relative;
            z-index: 1;
        }
        .tab-btn.active {
            font-weight: 700;
            /* שימוש במשתני CSS כדי לשלוט בצבע הגרדיאנט דרך JS */
            --tab-active-start: #a855f7;
            --tab-active-end: #ec4899;
            background-image: linear-gradient(to right, var(--tab-active-start), var(--tab-active-end));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent !important;
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px; /* מכסה את הקו האפור */
            left: 0;
            right: 0;
            height: 2px;
            background-color: #fdf2f8;
            z-index: 2;
        }
        .dark .tab-btn.active::after {
            background-color: #111827; /* תואם לרקע של dark mode */
        }
        .tab-btn.active:hover {
            color: transparent !important;
        }
        #active-tab-indicator {
            position: absolute;
            bottom: 0;
            height: 100%;
            background-color: #fdf2f8; /* pink-50 */
            border-bottom: 2px solid #ec4899; /* pink-500 */
            border-radius: 0.375rem; /* rounded-md */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        /* Highlight today's header in the Team View table */
        .day-header-today {
            font-weight: 700 !important; /* Bold but softer */
            background: linear-gradient(135deg, #ff1493, #ec4899, #f472b6, #ff1493);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 6s ease infinite;
        }
        .dark .day-header-today {
            font-weight: 700 !important;
            background: linear-gradient(135deg, #ff69b4, #f472b6, #ec4899, #ff69b4);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 6s ease infinite;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Remove bold from non-current days in dark mode */
        .dark #team-view-container table th {
            font-weight: 400 !important;
        }
        .dark #team-view-container table th.day-header-today {
            font-weight: 700 !important;
        }

        /* Sticky header dark mode */
        .dark #sticky-header {
            background-color: #111827;
        }

        /* Share App title colors */
        #share-app-title {
            color: #111827 !important; /* Black in light mode */
        }
        .dark #share-app-title {
            color: #f9fafb !important; /* White in dark mode */
        }

        /* Sticky header styles */
        #sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            padding-top: env(safe-area-inset-top);
            background-color: #ffffff;
            transition: background-color 0.2s ease;
            right: 0;
            z-index: 1000;
            background-color: #ffffff;
            padding: 1rem 1.5rem;
        }
        .dark #sticky-header {
            background-color: #111827;
        }

        
        /* Add padding to app container to account for fixed header */
        #app-container {
            padding-top: 7rem !important;
        }

        /* Gentle slow blink for Sunday when today is Fri/Sat - smooth opacity transition only */
        @keyframes slow-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .sun-blink {
            font-weight: 700; /* Keep bold always */
            animation: slow-blink 3s ease-in-out infinite;
        }

        /* --- [חדש] סגנון עבור חלקיקי ניצוצות --- */
        .sparkle-particle {
            position: fixed;
            z-index: 9999;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 1;
            transition: transform 0.8s cubic-bezier(0.1, 0.8, 0.7, 1), opacity 0.8s ease-out;
        }
        
        .form-input:focus {
            border-color: #8b5cf6; /* violet-500 */
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
            outline: none;
        }
        
        #auth-container .form-input {
            border-width: 2px;
            border-radius: 0.5rem; /* Ensure radius is always present */
        }

        /* --- Hide Tab Scrollbar --- */
        nav::-webkit-scrollbar {
            display: none;
        }
        nav {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

/* --- הסתרת פסי גלילה בטבלאות --- */
        .overflow-x-auto::-webkit-scrollbar {
            display: none;
        }
        .overflow-x-auto {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;     /* Firefox */
            overscroll-behavior-x: none !important; /* Completely prevent overscroll */
            max-width: 100% !important;
        }
        
        #team-view-container {
            overscroll-behavior-x: none !important; /* No overscroll at all */
            overscroll-behavior: none !important;
            max-width: 100vw !important;
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
        }

        /* --- New Loading Spinner --- */
        #loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* --- [שינוי] רקע תואם למסך הלוגין --- */
            background-color: #020617 !important;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(123, 0, 255, 0.15), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(255, 0, 128, 0.15), transparent 25%);
            background-attachment: fixed;
            background-size: cover;
            
            /* --- [התיקון כאן] --- */
            /* שיניתי מ-100 ל-9999 כדי שזה יהיה מעל ההדר (שהוא 1000) */
            z-index: 9999;
            
            /* אנימציית היעלמות חלקה */
            transition: opacity 0.5s ease-out, visibility 0.5s;
            opacity: 1;
            visibility: visible;
        }
        
        #loading-spinner.fade-out {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .quantum-spinner {
            width: 70px;
            height: 70px;
            position: relative;
        }
        .quantum-spinner .dot {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #a855f7;
            animation: quantum-orbit 2s linear infinite;
        }
        .quantum-spinner .dot:nth-child(1) {
            top: 0; left: 50%; transform: translateX(-50%);
            animation-delay: -1.8s;
        }
        .quantum-spinner .dot:nth-child(2) {
            top: 50%; right: 0; transform: translateY(-50%);
            animation-delay: -1.4s;
            background: #ec4899;
        }
        .quantum-spinner .dot:nth-child(3) {
            bottom: 0; left: 50%; transform: translateX(-50%);
            animation-delay: -1.0s;
            background: #4ade80;
        }
        .quantum-spinner .dot:nth-child(4) {
            top: 50%; left: 0; transform: translateY(-50%);
            animation-delay: -0.6s;
            background: #3b82f6;
        }
        .quantum-spinner .center-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 15px;
            height: 15px;
            background: linear-gradient(to right, #a855f7, #ec4899);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: quantum-pulse 2s ease-in-out infinite;
        }
        @keyframes quantum-orbit {
            0% { transform: rotate(0deg) translateX(30px) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(30px) rotate(-360deg); }
        }
        @keyframes quantum-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(0.8); }
        }

        /* --- Glassmorphism Wizard Styles --- */
        .glass-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7); /* Dark semi-transparent */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 24px;
        }

        /* --- PRO Wizard Styles --- */
        
        /* Progress Bar Animation */
        #wizard-progress-bar {
            transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5); 
        }

        /* Step Container Logic */
        .wizard-step {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            
            /* מצב התחלתי (מחכה בצד ימין) */
            opacity: 0;
            transform: translateX(60px) scale(0.95);
            filter: blur(10px);
            pointer-events: none;
            
            /* מעבר חלק ויוקרתי */
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* מצב פעיל (במרכז) */
        .wizard-step.active {
            opacity: 1;
            transform: translateX(0) scale(1);
            filter: blur(0);
            pointer-events: auto;
            position: relative; /* חשוב כדי לתפוס מקום בגובה */
        }

        /* מצב יציאה (זז שמאלה) */
        .wizard-step.prev {
            opacity: 0;
            transform: translateX(-60px) scale(0.95);
            filter: blur(10px);
            position: absolute;
        }

        /* --- Staggered Content Animation (התוכן נכנס בדירוג) --- */
        /* כאשר השלב פעיל, הילדים שלו יקבלו את האנימציה הזו */
        .wizard-step.active > * {
            animation: stagger-fade-up 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0; /* מתחילים מוסתרים */
        }

        /* דירוג זמנים לכל אלמנט בתוך השלב */
        .wizard-step.active > *:nth-child(1) { animation-delay: 0.1s; } /* כותרת */
        .wizard-step.active > *:nth-child(2) { animation-delay: 0.2s; } /* תת כותרת */
        .wizard-step.active > *:nth-child(3) { animation-delay: 0.3s; } /* תוכן/אינפוטים */
        .wizard-step.active > *:nth-child(4) { animation-delay: 0.4s; } 

        @keyframes stagger-fade-up {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Checkbox for Wizard */
        .glass-checkbox:checked + div {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            border-color: transparent;
            color: white;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
        }

        /* Glass Input */
        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: #a855f7;
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
        }

        .weekly-summary-card {
            background-color: #f9fafb; /* gray-50 - same as other statistics cards */
            border: 1px solid #e5e7eb; /* gray-200 border like other cards */
            position: relative;
            border-radius: 0.75rem; /* rounded-xl - 12px */
        }
        /* Dark mode version */
        .dark .weekly-summary-card {
            background-color: rgba(31, 41, 55, 0.5); /* darker background */
            border: 1px solid rgba(255, 255, 255, 0.1); /* subtle border in dark mode */
        }

        /* Circular Progress Indicators */
        .progress-circles-container {
            display: flex;
            gap: 2rem;
            overflow-x: auto;
            padding: 1rem 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db transparent; /* gray-300 */
        }
        
        /* Mobile: tighter spacing between circles */
        @media (max-width: 640px) {
            .progress-circles-container {
                gap: 0.5rem;
            }
        }
        
        .progress-circles-container::-webkit-scrollbar {
            height: 8px;
        }
        .progress-circles-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .progress-circles-container::-webkit-scrollbar-thumb {
            background: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        .progress-circles-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* gray-400 */
        }
        .progress-circle-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            flex-shrink: 0;
        }
        .progress-circle {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .progress-circle svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .progress-circle-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        .dark .progress-circle-bg {
            stroke: #374151;
        }
        .progress-circle-fill {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .progress-circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .progress-circle-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .dark .progress-circle-percentage {
            color: #f3f4f6;
        }
        .progress-circle-label {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            text-align: center;
            max-width: 120px;
            overflow-wrap: break-word;
        }
        .dark .progress-circle-label {
            color: #9ca3af;
        }
        .progress-circle-count {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .dark .progress-circle-count {
            color: #9ca3af;
        }

        /* --- [NEW] Return to today button styles --- */
        @keyframes slow-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.95; }
        }
        .return-to-today-btn {
            cursor: pointer;
            animation: gradient-flow 15s ease-in-out infinite, slow-pulse 3s ease-in-out infinite;
            display: inline-block;
            transition: transform 0.3s ease;
        }
        .return-to-today-btn:hover {
            transform: scale(1.05);
        }

        /* Custom Modal Styles - מניעת קפיצות גומי */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            overflow-y: auto; /* מאפשר גלילה אם התוכן ארוך מדי */
            
            /* --- התיקון: מניעת אפקט ה"גומי" (Bouncing) --- */
            overscroll-behavior: none; 
            -webkit-overflow-scrolling: touch;
        }
        .modal-overlay.z-60 {
            z-index: 60;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* More rounded */
            max-width: 500px;
            width: 90%;
            margin: 2rem 0; /* Add some margin for scrolling */
        }
        @media (min-width: 640px) {
            .modal-content {
                padding: 2rem;
            }
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .dragging {
            opacity: 0.5;
            background: #eef2ff;
            border: 1px dashed #1428a0;
        }
        .drag-over-indicator {
            border-top: 2px solid #1428a0 !important;
            background-color: #ebf0ff;
        }

        .sticky-col {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            left: 0;
            z-index: 20;
            isolation: isolate;
        }

        /* Light Mode - Sticky Header: gray background with dark text */
        thead th.sticky-col {
            background-color: #f9fafb !important; /* bg-gray-50 */
            color: #4b5563 !important; /* text-gray-600 */
            z-index: 30; /* Header above rows */
        }

        /* Light Mode - ALL headers should have light background */
        thead th {
            background-color: #f9fafb !important; /* bg-gray-50 */
            color: #4b5563 !important; /* text-gray-600 */
        }

        /* Light Mode - Email column only should be black */
        tbody tr td:nth-child(2) {
            color: #111827 !important; /* text-gray-900 - black text for emails */
        }

        /* Light Mode - Group column should be black */
        tbody tr td:nth-child(3) {
            color: #111827 !important; /* text-gray-900 - black text for groups */
        }

        /* Light Mode - Sticky Rows: white background with dark text */
        tbody tr td.sticky-col {
            background-color: #ffffff !important;
            color: #111827 !important; /* text-gray-900 */
        }

        /* Light Mode - TL rows with gray background */
        tbody tr.bg-gray-50 td.sticky-col {
            background-color: #f9fafb !important; /* bg-gray-50 */
            color: #111827 !important; /* text-gray-900 */
        }
        
        /* Ensure table wrapper has proper z-index context */
        .overflow-x-auto {
            position: relative;
            z-index: 1;
            isolation: isolate;
        }

        /* Team View - tighter weekday columns on larger screens */
        #team-view-container table th,
        #team-view-container table td {
            padding-left: 0.5rem !important; /* default reduced padding */
            padding-right: 0.5rem !important;
        }

        /* Slightly smaller weekday labels and tighter spacing for desktop/tablet */
        @media (min-width: 641px) {
            #team-view-container table th.weekday, #team-view-container table th.day {
                padding-left: 0.4rem !important;
                padding-right: 0.4rem !important;
                font-size: 0.85rem !important;
                letter-spacing: -0.2px !important;
            }
            #team-view-container table td {
                padding-left: 0.4rem !important;
                padding-right: 0.4rem !important;
            }
        }

        /* Mobile: allow day columns to expand slightly when content is long
           to avoid overlapping the next day's ellipse. We keep a sensible
           min-width but allow flexing by using percentage widths and
           letting table-layout be auto for phones. */
        @media (max-width: 640px) {
            /* Keep employee name column larger to avoid squeezing names */
            #team-view-container table thead th:nth-child(1),
            #team-view-container table tbody td:nth-child(1) {
                min-width: 120px !important;
                width: 28% !important;
            }

            /* Prefer single-line day cells on phones by increasing min-width.
               This keeps row height consistent. If the viewport is too narrow,
               horizontal scroll will appear on the table. */
            #team-view-container table thead th:nth-child(n+2),
            #team-view-container table tbody td:nth-child(n+2) {
                min-width: 92px !important; /* wider baseline to keep statuses single-line */
                width: auto !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                text-align: center !important;
                white-space: nowrap !important; /* prefer single-line */
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            /* Keep status-label single-line on phones (no wrapping) */
            #team-view-container table tbody td .status-label {
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: inline-block !important;
                max-width: 100% !important;
            }
        }

        /* Force weekday columns - FIXED styling like Reference */
        @media (min-width: 641px) {
            /* עמודת העובד - נשארת רחבה */
            #team-view-container table thead th:nth-child(1),
            #team-view-container table tbody td:nth-child(1) {
                width: 180px !important;
                min-width: 140px !important;
                max-width: 260px !important;
                padding-left: 0.6rem !important;
                padding-right: 0.6rem !important;
            }

            /* [תיקון - כמו ברפרנס] כל העמודות של הימים (החל מהשנייה) */
            /* משתמשים במידות המדויקות מהרפרנס: 56px רוחב */
            #team-view-container table thead th:nth-child(n+2),
            #team-view-container table tbody td:nth-child(n+2) {
                width: 56px !important;       /* זהה לרפרנס */
                min-width: 56px !important;   /* זהה לרפרנס */
                max-width: 72px !important;   /* זהה לרפרנס */
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
                text-align: center !important;
                overflow: hidden !important;
                white-space: nowrap !important;
                text-overflow: ellipsis !important;
            }

            /* התאמת התגיות הצבעוניות שייכנסו ברוחב הצר */
            #team-view-container table tbody td span {
                display: inline-block !important;
                max-width: 100% !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
                
                /* --- התיקון: הסרנו את הגדרות הגודל הדורסניות --- */
                /* מחקנו את font-size ו-padding מכאן כדי שהמחלקה .status-pill תקבע אותם */
            }
        }

        /* Ensure clean overlay in dark mode */
        .dark .sticky-col {
            background-blend-mode: normal;
        }

        /* --- Drag and Drop Styles --- */
        .drag-over-animated {
            background: linear-gradient(135deg, #4ade80, #ec4899, #a855f7, #4ade80);
            background-size: 300% 300%;
            animation: drag-over-flow 1.5s ease infinite;
            transform: scale(1.2);
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        @keyframes drag-over-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .dragging-item {
            opacity: 0.4;
            cursor: grabbing;
        }

        /* --- [NEW/CORRECTED] Drag Handle Animation --- */
        /* [FIX] Changed keyframe 'to' position from -100% to -200% for a seamless loop */
        @keyframes flow-down {
            from { background-position: 0 0; }
            to { background-position: 0 -200%; }
        }
        .animated-chevron {
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            background: linear-gradient(180deg, #a855f7, #ec4899, #4ade80, #a855f7);
            background-size: 100% 200%;
            animation: flow-down 3s linear infinite;

            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='3' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 13l-7 7-7-7m14-8l-7 7-7-7' /%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='3' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 13l-7 7-7-7m14-8l-7 7-7-7' /%3E%3C/svg%3E");
            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
        }
        
        /* --- [חדש] Success Animation --- */
        .success-animation-container {
            width: 40px;
            height: 40px;
            display: none;
            margin-left: 1rem;
            vertical-align: middle;
        }

        .success-animation-container.show {
            display: inline-block;
        }

        .success-animation-container svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .success-animation-container .circle-bg {
            stroke-width: 3;
            stroke: #e5e7eb; /* gray-200 */
            fill: none;
        }
        .dark .success-animation-container .circle-bg {
            stroke: #4b5563; /* gray-600 */
        }

        .success-animation-container .circle-progress,
        .success-animation-container .checkmark {
            stroke-width: 3;
            stroke: #22c55e; /* green-500 */
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .success-animation-container.show .circle-progress {
            stroke-dasharray: 151;
            stroke-dashoffset: 151;
            animation: circle-progress 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .success-animation-container.show .checkmark {
            stroke-dasharray: 30;
            stroke-dashoffset: 30;
            animation: checkmark 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.7s forwards;
        }

        @keyframes circle-progress {
            to {
                stroke-dashoffset: 0;
            }
        }

        @keyframes checkmark {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* --- Dark Mode Styles --- */
        /* Add smooth transition for background color changes */
        .bg-white, .bg-gray-50, .bg-gray-100 {
            transition: background-color 0.2s ease-in-out;
        }
        .dark body { background-color: #111827; } /* gray-900 */
        .dark #auth-container .bg-white { background-color: transparent; }
        .dark .text-gray-800, .dark .text-gray-900 { color: #f9fafb; } /* gray-50 */
        .dark .text-gray-700 { color: #d1d5db; } /* gray-300 */
        .dark #active-tab-indicator {
            background-color: #111827 !important;
        }
        .dark .text-gray-600 { color: #9ca3af; } /* gray-400 */
        .dark .text-gray-500 { color: #6b7280; } /* gray-500 */
        .dark .bg-white { background-color: transparent; }
        .dark .bg-gray-50 { background-color: rgba(255, 255, 255, 0.03); } /* Very subtle light */
        .dark .bg-gray-100 { background-color: rgba(255, 255, 255, 0.05); } 
        .dark .bg-gray-200 { background-color: rgba(255, 255, 255, 0.08); }
        .dark .border-b, .dark .border, .dark .theme-purple-border { border-color: rgba(255, 255, 255, 0.1); }
        .dark .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: rgba(255, 255, 255, 0.1); }
        .dark .form-input {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: #f9fafb;
        }
        .dark .form-input::placeholder { color: #9ca3af; } /* gray-400 */
        .dark .form-input:focus {
            border-color: #a78bfa; /* violet-400 */
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.2);
            background-color: rgba(255, 255, 255, 0.08);
        }
        /* Fix for select dropdowns in dark mode */
        .dark select.form-input {
            background-color: #1f2937; /* gray-800 */
            color: #f9fafb; /* gray-50 */
        }
        .dark select.form-input option {
            background-color: #1f2937; /* gray-800 */
            color: #f9fafb; /* gray-50 */
        }
        .dark #auth-container .form-input:focus {
            background: linear-gradient(#111827, #111827) padding-box, linear-gradient(to right, #a7f3d0, #fbcfe8, #ddd6fe) border-box;
        }
        .dark #active-tab-indicator {
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom-color: #f472b6;
        }
        .dark #loading-spinner { background-color: #111827; }
        .dark .modal-content { background-color: #111827; }
        .dark .modal-overlay { background-color: rgba(0, 0, 0, 0.8); }
        .dark #modal-cancel, .dark #edit-modal-cancel, .dark #reauth-cancel, .dark #manage-groups-close, .dark #super-admin-edit-cancel, .dark #forgot-cancel { 
            background-color: rgba(255, 255, 255, 0.1);
            color: #f9fafb;
        }
        .dark #modal-cancel:hover, .dark #edit-modal-cancel:hover, .dark #reauth-cancel:hover, .dark #manage-groups-close:hover, .dark #super-admin-edit-cancel:hover, .dark #forgot-cancel:hover { 
            background-color: rgba(255, 255, 255, 0.15); 
        }

        /* Team View Table Dark Mode Fixes */
        /* Header styles - using the same color as TL rows for better hierarchy */
        .dark thead tr {
            background-color: rgb(55, 65, 81) !important; /* Same as TL rows */
        }
        
        .dark thead th {
            background-color: rgb(55, 65, 81) !important; /* Same as TL rows */
            color: #ffffff !important; /* White text */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600 !important; /* Make headers more prominent */
        }

        .dark thead th.sticky-col {
            background-color: rgb(55, 65, 81) !important; /* Match other headers in dark mode */
            color: #ffffff !important; /* White text */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Regular row styles */
        .dark tbody tr {
            background-color: #111827 !important;
        }

        .dark tbody tr td {
            background-color: #111827 !important;
            color: #9ca3af !important; /* text-gray-400 */
        }

        .dark tbody tr td.sticky-col {
            background-color: #111827 !important;
            color: #f3f4f6 !important; /* text-gray-100 */
        }

        .dark tbody tr td.font-medium {
            color: #f3f4f6 !important; /* text-gray-100 for bold items */
        }

        /* TL row styles - using rgb instead of hex for exact color matching */
        .dark tbody tr.bg-gray-50 {
            background-color: rgb(55, 65, 81) !important; /* Solid color for TL rows */
        }

        .dark tbody tr.bg-gray-50 td {
            background-color: rgb(55, 65, 81) !important;
        }

        .dark tbody tr.bg-gray-50 td.sticky-col {
            background-color: rgb(55, 65, 81) !important;
        }

        /* Ensure table borders are consistent */
        .dark table {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        .dark .divide-y > :not([hidden]) ~ :not([hidden]) {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        .dark .bg-green-100 { background-color: rgba(16, 185, 129, 0.1); color: #34d399; }
        .dark .bg-blue-100 { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; }
        .dark .bg-red-100 { background-color: rgba(239, 68, 68, 0.1); color: #f87171; }
        .dark .bg-yellow-100 { background-color: rgba(245, 158, 11, 0.1); color: #fbbf24; }
        .dark .bg-purple-100 { background-color: rgba(139, 92, 246, 0.1); color: #a78bfa; }
        .dark .bg-indigo-100 { background-color: rgba(99, 102, 241, 0.1); color: #818cf8; }
        .dark .text-red-700 { color: #f87171; }
        .dark .weekly-summary-card { 
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark .weekly-summary-card::before { background: linear-gradient(to right, rgba(236, 72, 153, 0.3), rgba(74, 222, 128, 0.3), rgba(96, 165, 250, 0.3), rgba(167, 139, 250, 0.3)); }

        /* Weekly Summary Title Colors */
        .weekly-summary-title {
            color: #000000 !important; /* Black in light mode */
        }
        .dark .weekly-summary-title {
            color: #ffffff !important; /* White in dark mode */
        }

/* --- עיצוב כהה נקי (Clean Dark Mode) --- */

/* 1. הגדרת הרקע הכללי למסך */
#auth-container {
    background-color: #020617 !important;
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(123, 0, 255, 0.15), transparent 25%), 
        radial-gradient(circle at 85% 30%, rgba(255, 0, 128, 0.15), transparent 25%);
    background-attachment: fixed;
    background-size: cover;
}

/* 2. ביטול מוחלט של ה"כרטיס" באמצע */
/* אנחנו הופכים אותו לשקוף ומסירים גבולות וצללים */
#auth-container .w-full.max-w-md {
    background-color: transparent !important;
    backdrop-filter: none !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important; /* ביטול ריפוד מיותר אם קיים */
}

/* 3. עיצוב תיבות האינפוט - כהות ושקופות */
#auth-container input, 
#auth-container select {
    background-color: rgba(0, 0, 0, 0.3) !important; /* רקע שחור שקוף */
    border: 1px solid rgba(255, 255, 255, 0.15) !important; /* גבול דק ועדין */
    color: #ffffff !important; /* טקסט לבן בוהק */
    border-radius: 12px !important; /* פינות עגולות יותר */
    
    /* --- שינוי לעיבוי התיבות --- */
    padding-top: 20px !important;    /* רווח פנימי גדול יותר מלמעלה */
    padding-bottom: 20px !important; /* רווח פנימי גדול יותר מלמטה */
    font-size: 16px !important;      /* אופציונלי: הגדלה קלה של הטקסט */
}

/* אפקט כשלוחצים על התיבה */
#auth-container input:focus, 
#auth-container select:focus {
    background-color: rgba(0, 0, 0, 0.5) !important; /* כהה ושקוף */
    background-image: none !important; /* מוודא שאין רקע לבן */
    border-color: #a855f7 !important;
    box-shadow: 0 0 15px rgba(168, 85, 247, 0.2) !important;
    outline: none;
    font-size: 18px !important; /* הגדלת הטקסט כשכותבים */
}

/* צבע הטקסט המקדים (Placeholder) */
#auth-container input::placeholder {
    color: #94a3b8; /* אפור בהיר */
}

/* Calendar Styles for Requests */
.cal-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    color: #374151;
}
.dark .cal-day { color: #d1d5db; }
.cal-day:hover:not(.empty) { background-color: #f3f4f6; }
.dark .cal-day:hover:not(.empty) { background-color: #374151; }

/* טווח נבחר */
.cal-day.selected {
    background-color: #a855f7 !important; /* סגול ראשי */
    color: white !important;
    font-weight: bold;
    box-shadow: 0 4px 6px -1px rgba(168, 85, 247, 0.4);
}
.cal-day.in-range {
    background-color: #f3e8ff; /* סגול בהיר מאוד לרקע */
    color: #7e22ce;
    border-radius: 0; /* חיבור רציף */
}
.dark .cal-day.in-range {
    background-color: rgba(168, 85, 247, 0.2);
    color: #e9d5ff;
}
.cal-day.range-start {
    border-top-left-radius: 0.5rem;
    border-bottom-left-radius: 0.5rem;
}
.cal-day.range-end {
    border-top-right-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
}
.cal-day.empty { cursor: default; pointer-events: none; }

        /* --- עיצוב פס גלילה מותאם אישית (Custom Scrollbar) --- */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px; /* דק ועדין */
            height: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent; /* רקע שקוף */
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* אפור בהיר (slate-300) */
            border-radius: 99px; /* פינות עגולות לגמרי */
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8; /* כהה יותר במעבר עכבר */
        }

        /* התאמה ל-Dark Mode */
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #374151; /* אפור כהה (gray-700) */
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #4b5563;
        }

        /* --- Creative Color Palette (Luminous Squircles) --- */

        /* המגש שמחזיק את הצבעים */
        .palette-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); /* סידור רספונסיבי */
            gap: 12px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.03); /* רקע עדין למגש */
            border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dark .palette-grid {
            background: rgba(255, 255, 255, 0.03);
            border-color: rgba(255,255,255,0.05);
        }

        /* הכפתור עצמו (Squircle) */
        .color-swatch {
            position: relative;
            width: 42px;
            height: 42px;
            border-radius: 14px; /* פינות עגולות מודרניות */
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* קפיציות */
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* אפקט ריחוף */
        .color-swatch:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        /* מצב נבחר */
        .color-swatch.selected {
            transform: scale(1.15);
            border-color: white;
            /* הצללה זוהרת בצבע של הכפתור - נוצרת דינמית ב-JS, כאן זה גיבוי */
            box-shadow: 0 0 0 2px white, 0 8px 20px -6px rgba(0,0,0,0.3); 
            z-index: 20;
        }
        .dark .color-swatch.selected {
            border-color: #1f2937; /* צבע רקע כהה */
            box-shadow: 0 0 0 2px #1f2937, 0 8px 20px -6px rgba(0,0,0,0.5); 
        }

        /* האייקון של ה-V בפנים */
        .color-swatch .check-icon {
            width: 20px;
            height: 20px;
            color: white;
            opacity: 0;
            transform: scale(0.5) rotate(-45deg);
            transition: all 0.3s ease;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); /* צל לוי שיהיה קריא על כל צבע */
        }

        /* כשהוא נבחר - ה-V מופיע */
        .color-swatch.selected .check-icon {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        /* --- עיצוב ה-Pill - תואם בדיוק 1:1 ל-Reference --- */
        .status-pill {
            display: inline-block;
            border-radius: 9999px;
            white-space: nowrap;
            font-weight: 600; /* font-semibold */
            line-height: 1;   /* leading-none */
            
            /* מידות לדסקטופ (תואם ל- sm:px-2.5 sm:py-1.5 sm:text-xs) */
            padding: 0.375rem 0.625rem; /* שזה 6px לגובה, 10px לרוחב */
            font-size: 0.75rem;         /* שזה 12px */
        }

        /* התאמה למובייל (תואם ל- px-2 py-1 text-[11px]) */
        @media (max-width: 640px) {
            .status-pill {
                padding: 0.25rem 0.5rem; /* שזה 4px לגובה, 8px לרוחב */
                font-size: 11px;
            }
        }

        /* --- העתק מדויק מקובץ הרפרנס: דריסת צבעי Tailwind ל-Dark Mode --- */
        /* זה מה שגורם ל-bg-green-100 להיראות טוב בשחור */
        
        .dark .bg-green-100 { background-color: rgba(16, 185, 129, 0.15) !important; color: #34d399 !important; }
        .dark .bg-blue-100 { background-color: rgba(59, 130, 246, 0.15) !important; color: #60a5fa !important; }
        .dark .bg-red-100 { background-color: rgba(239, 68, 68, 0.15) !important; color: #f87171 !important; }
        .dark .bg-yellow-100 { background-color: rgba(234, 179, 8, 0.15) !important; color: #fbbf24 !important; }
        .dark .bg-purple-100 { background-color: rgba(168, 85, 247, 0.15) !important; color: #c084fc !important; }
        .dark .bg-indigo-100 { background-color: rgba(99, 102, 241, 0.15) !important; color: #818cf8 !important; }
        .dark .bg-pink-100 { background-color: rgba(236, 72, 153, 0.15) !important; color: #f472b6 !important; }
        .dark .bg-orange-100 { background-color: rgba(249, 115, 22, 0.15) !important; color: #fb923c !important; }
        .dark .bg-gray-100 { background-color: rgba(107, 114, 128, 0.2) !important; color: #d1d5db !important; }
        
        /* צבעים נוספים למקרה הצורך */
        .dark .bg-teal-100 { background-color: rgba(20, 184, 166, 0.15) !important; color: #2dd4bf !important; }
        .dark .bg-cyan-100 { background-color: rgba(6, 182, 212, 0.15) !important; color: #22d3ee !important; }
        .dark .bg-lime-100 { background-color: rgba(132, 204, 22, 0.15) !important; color: #a3e635 !important; }
        .dark .bg-rose-100 { background-color: rgba(244, 63, 94, 0.15) !important; color: #fb7185 !important; }

        /* Planner Calendar Styles */
        .planner-day-cell {
            min-height: 120px;
            background-color: white;
            transition: background-color 0.2s;
            position: relative;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .dark .planner-day-cell {
            background-color: #1f2937; /* gray-800 */
        }
        .planner-day-cell:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .dark .planner-day-cell:hover {
            background-color: #374151; /* gray-700 */
        }
        .planner-day-number {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 4px;
            color: #374151;
        }
        .dark .planner-day-number {
            color: #d1d5db;
        }
        .planner-day-cell.other-month {
            background-color: #f9fafb;
            opacity: 0.6;
        }
        .dark .planner-day-cell.other-month {
            background-color: #111827;
            opacity: 0.4;
        }
        .planner-day-cell.today {
            background-color: #f0f9ff; /* blue-50 */
        }
        .dark .planner-day-cell.today {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .planner-day-cell.today .planner-day-number {
            color: #2563eb; /* blue-600 */
            font-weight: 800;
        }

        /* Dots Styling */
        .planner-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        .planner-event-row {
            font-size: 10px;
            display: flex;
            align-items: center;
            padding: 2px 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Planner Mobile Interaction Styles --- */

        /* הגדרות מעבר חלק לאנימציית הזום */
        #planner-inner-grid {
            transition: min-width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: top left;
        }

        /* --- מצב מכווץ (ברירת מחדל במובייל) --- */
        /* כשהטבלה לא במצב expanded, היא מתכווצת ל-100% רוחב */
        @media (max-width: 768px) {
            #planner-inner-grid:not(.expanded) {
                min-width: 100% !important;
                width: 100% !important;
            }

            /* הקטנת גובה התאים במצב מכווץ */
            #planner-inner-grid:not(.expanded) .planner-day-cell {
                min-height: 60px !important; /* גובה קטן כמו באייפון */
                padding: 2px !important;
                align-items: center; /* מירכוז */
            }

            /* הקטנת המספרים במצב מכווץ */
            #planner-inner-grid:not(.expanded) .planner-day-number {
                font-size: 0.75rem !important;
                margin-bottom: 2px;
            }

            /* הסתרת שורות הטקסט הרגילות במצב מכווץ */
            #planner-inner-grid:not(.expanded) .planner-event-row,
            #planner-inner-grid:not(.expanded) .text-\[10px\] {
                display: none !important;
            }

            /* הצגת אינדיקטור נקודות בלבד במצב מכווץ */
            #planner-inner-grid:not(.expanded) .mobile-dots-container {
                display: flex !important;
                flex-wrap: wrap;
                justify-content: center;
                gap: 2px;
                margin-top: auto;
                margin-bottom: 4px;
            }
        }

        /* הסתרת קונטיינר הנקודות בדסקטופ או במצב מורחב */
        .mobile-dots-container {
            display: none;
        }

        /* --- אנימציית רמז לצביטה (Pinch Hint) --- */

        /* השכבה שמכילה את האנימציה - ממורכזת מעל הלוח */
        .pinch-hint-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* חשוב! שהלחיצות יעברו דרך השכבה ללוח שנה עצמו */
            z-index: 50; /* שיהיה מעל הכל */
            overflow: hidden;
        }

        /* עיצוב ה"אצבעות" */
        .pinch-finger {
            width: 60px;
            height: 60px;
            background-color: rgba(156, 163, 175, 0.6); /* אפור חצי שקוף */
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            position: absolute;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            opacity: 0; /* מתחיל בלתי נראה */
        }

        /* האצבע השמאלית */
        .finger-left {
            animation: pinchOutLeft 1.5s ease-in-out forwards;
        }

        /* האצבע הימנית */
        .finger-right {
            animation: pinchOutRight 1.5s ease-in-out forwards;
        }

        /* --- הגדרת תנועת האנימציה (Keyframes) --- */

        @keyframes pinchOutLeft {
            0% {
                opacity: 0;
                transform: translateX(-20px) scale(0.8);
            }
            20% {
                opacity: 1; /* מופיע */
            }
            80% {
                opacity: 1;
                transform: translateX(-100px) scale(1); /* זז שמאלה */
            }
            100% {
                opacity: 0; /* נעלם */
                transform: translateX(-120px) scale(0.9);
            }
        }

        @keyframes pinchOutRight {
            0% {
                opacity: 0;
                transform: translateX(20px) scale(0.8);
            }
            20% {
                opacity: 1; /* מופיע */
            }
            80% {
                opacity: 1;
                transform: translateX(100px) scale(1); /* זז ימינה */
            }
            100% {
                opacity: 0; /* נעלם */
                transform: translateX(120px) scale(0.9);
            }
        }
        .planner-event-row:hover {
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

/* --- Rolodex Effect Setup --- */
#my-requests-list, #team-requests-list {
    perspective: 1200px;
    transform-style: preserve-3d;
    padding-top: 10px;
}

#my-requests-list > div, #team-requests-list > div {
    transform-origin: top center;
    /* התיקון: מעבר איטי וחלק (0.4 שניות) */
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 0.4s ease-out;
    will-change: transform, filter;
    background-color: white;
}

.dark #my-requests-list > div, .dark #team-requests-list > div {
    background-color: #1f2937;
}

    </style>
</head>
<body class="min-h-screen bg-[#020617] dark:bg-gray-900">
    <svg width="0" height="0" style="position:absolute; visibility:hidden;">
        <defs>
            <linearGradient id="gradElectricDark" x1="0%" y1="100%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#FF3399;stop-opacity:1" /> 
                <stop offset="50%" style="stop-color:#FF40FF;stop-opacity:1" /> 
                <stop offset="100%" style="stop-color:#9D40FF;stop-opacity:1" /> 
            </linearGradient>
            <linearGradient id="gradElectricDarkApp" x1="0%" y1="100%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#FF3399;stop-opacity:1" /> 
                <stop offset="50%" style="stop-color:#FF40FF;stop-opacity:1" /> 
                <stop offset="100%" style="stop-color:#9D40FF;stop-opacity:1" /> 
            </linearGradient>

            <linearGradient id="gradHeaderLogoUnique" x1="0%" y1="100%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#FF3399;stop-opacity:1" /> 
                <stop offset="50%" style="stop-color:#FF40FF;stop-opacity:1" /> 
                <stop offset="100%" style="stop-color:#9D40FF;stop-opacity:1" /> 
            </linearGradient>
        </defs>
    </svg>

    <!-- Loading Spinner -->
    <div id="loading-spinner">
        <!-- [MODIFICATION 2] New Spinner -->
        <div class="quantum-spinner">
            <div class="center-dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        <div id="login-card" class="w-full max-w-md rounded-xl p-6 sm:p-8 transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)] opacity-0 translate-y-10">
            <div class="text-center mb-8">
                <!-- ================================================================== -->
                <!-- מיקום 1: מסך הכניסה                                                     -->
                <!-- שנה את הערך "h-12" כדי לשלוט בגובה הלוגו. למשל: h-10, h-14, h-16 -->
                <!-- ================================================================== -->
                <svg class="samsung-logo-svg inline-block h-16" viewBox="0 0 837.6507 222.51334" xmlns="http://www.w3.org/2000/svg" style="fill: #8ab4f8;">
        <g transform="matrix(1.3333333,0,0,-1.3333333,0,222.51333)">
            <g transform="translate(558.9328,88.5098)">
                <path d="m 0,0 v -11.358 h 7.982 v -11.269 c 0.025,-1.007 -0.03,-2.093 -0.203,-2.962 -0.317,-2.102 -2.314,-5.681 -7.98,-5.681 -5.632,0 -7.593,3.579 -7.933,5.681 -0.143,0.869 -0.204,1.955 -0.204,2.962 v 35.593 c 0,1.259 0.085,2.637 0.352,3.68 0.387,1.897 2.068,5.638 7.743,5.638 5.957,0 7.444,-3.944 7.785,-5.638 0.224,-1.122 0.237,-3.004 0.237,-3.004 V 9.32 h 19.613 v 2.555 c 0,0 0.089,2.666 -0.149,5.154 C 25.769,31.638 13.732,36.26 -0.07,36.26 c -13.827,0 -25.62,-4.665 -27.338,-19.231 -0.155,-1.332 -0.392,-3.728 -0.392,-5.154 v -32.742 c 0,-1.426 0.046,-2.53 0.31,-5.136 1.28,-14.207 13.593,-19.243 27.365,-19.243 13.857,0 26.085,5.036 27.387,19.243 0.231,2.606 0.255,3.71 0.286,5.136 V 0 Z m -135.235,34.165 h -19.696 v -57.613 c 0.031,-1.004 0,-2.132 -0.173,-2.959 -0.411,-1.934 -2.05,-5.656 -7.484,-5.656 -5.364,0 -7.046,3.722 -7.426,5.656 -0.197,0.827 -0.222,1.955 -0.197,2.959 v 57.613 h -19.69 V -21.66 c -0.025,-1.439 0.088,-4.379 0.173,-5.149 1.359,-14.547 12.824,-19.27 27.14,-19.27 14.344,0 25.802,4.723 27.186,19.27 0.109,0.77 0.252,3.71 0.167,5.149 z m -180.97,0 -9.825,-60.876 -9.819,60.876 h -31.771 l -1.685,-77.878 h 19.464 l 0.527,72.094 13.392,-72.094 h 19.748 l 13.404,72.094 0.529,-72.094 h 19.513 l -1.742,77.878 z m -117.631,0 -14.426,-77.878 h 21.037 l 10.871,72.094 10.61,-72.094 h 20.891 l -14.366,77.878 z m 367.435,-62.701 -18.34,62.701 h -28.9 v -77.066 h 19.118 l -1.11,64.707 19.696,-64.707 h 27.717 v 77.066 h -19.243 z m -176.838,42.433 c -0.346,1.538 -0.246,3.172 -0.067,4.026 0.557,2.493 2.232,5.212 7.058,5.212 4.498,0 7.135,-2.804 7.135,-7.012 v -4.762 h 19.2 v 5.428 c 0,16.78 -15.044,19.416 -25.936,19.416 -13.718,0 -24.921,-4.522 -26.967,-17.148 -0.541,-3.436 -0.675,-6.486 0.186,-10.378 3.336,-15.743 30.743,-20.31 34.721,-30.266 0.702,-1.886 0.501,-4.291 0.143,-5.708 -0.596,-2.591 -2.339,-5.197 -7.506,-5.197 -4.846,0 -7.763,2.786 -7.763,6.985 l -0.006,7.474 h -20.666 v -5.941 c 0,-17.215 13.484,-22.409 28.007,-22.409 13.909,0 25.397,4.753 27.24,17.637 0.879,6.657 0.216,10.993 -0.137,12.626 -3.22,16.147 -32.431,21.004 -34.642,30.017 m -253.273,0.191 c -0.377,1.57 -0.289,3.227 -0.079,4.091 0.532,2.481 2.217,5.248 7.128,5.248 4.555,0 7.237,-2.831 7.237,-7.073 v -4.82 h 19.425 v 5.471 c 0,16.941 -15.274,19.641 -26.285,19.641 -13.833,0 -25.136,-4.592 -27.204,-17.309 -0.566,-3.491 -0.663,-6.562 0.155,-10.497 3.372,-15.922 31.05,-20.526 35.077,-30.601 0.754,-1.873 0.526,-4.278 0.152,-5.75 -0.639,-2.618 -2.396,-5.261 -7.606,-5.261 -4.865,0 -7.775,2.834 -7.775,7.091 l -0.027,7.494 h -20.898 v -5.955 c 0,-17.412 13.675,-22.648 28.311,-22.648 14.071,0 25.626,4.795 27.511,17.828 0.937,6.718 0.234,11.09 -0.082,12.748 -3.287,16.345 -32.823,21.186 -35.04,30.302" />
            </g>
        </g>
    </svg>
                <p class="animated-gradient-text text-lg font-bold tracking-widest -mt-1">R&D CENTER ISRAEL</p>
            </div>
            
            <!-- Login Form -->
            <form id="login-form" class="transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)]">
                <h2 class="text-2xl font-bold text-center text-white mb-2">Weekly Check-In</h2>
                <p class="text-center text-gray-400 mb-6">Sign in to continue</p>
                <div class="mb-4">
                    <label for="login-identifier" class="block text-gray-200 text-sm font-bold mb-2">Email Address</label>
                    <input type="text" id="login-identifier" class="form-input shadow-sm appearance-none border rounded-lg w-full py-[11px] px-4 text-gray-900 text-lg leading-tight focus:outline-none focus:shadow-outline transition duration-150 ease-in-out" required>
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-gray-200 text-sm font-bold mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="login-password" class="form-input shadow-sm appearance-none border rounded-lg w-full py-[11px] pl-4 pr-10 text-gray-900 text-lg leading-tight focus:outline-none focus:shadow-outline transition duration-150 ease-in-out" required>
                        
                        <button type="button" id="toggle-password-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white focus:outline-none transition-colors p-1">
                            <svg id="eye-open" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <svg id="eye-closed" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="flex justify-end mb-6">
                    <a href="#" id="show-forgot-password" class="text-sm theme-link hover:underline">Forgot Password?</a>
                </div>
                <p id="login-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                <button type="submit" class="w-full btn btn-primary focus:outline-none focus:shadow-outline">Sign In</button>
                <div class="text-center text-sm text-gray-400 mt-4 space-y-2">
                    <p>
                        <a href="#" id="show-register" class="theme-link hover:underline">Join existing team</a>
                    </p>
                    <div class="relative flex py-2 items-center" style="display: none !important;">
                        <div class="flex-grow border-t border-gray-600"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-500 text-xs">OR</span>
                        <div class="flex-grow border-t border-gray-600"></div>
                    </div>
                    <p>
                        <a href="#" id="show-company-register" class="font-bold text-violet-400 hover:text-violet-300" style="display: none !important;">Create new organization</a>
                    </p>
                </div>
            </form>

            <form id="register-form" class="hidden transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)]">
                <h2 class="text-2xl font-bold text-center text-white mb-2">Request Access</h2>
                <p class="text-center text-gray-400 mb-6">Join your team workspace</p>

                <div id="reg-step-code" class="w-full">
                    <div class="mb-8">
                        <label class="block text-gray-200 text-sm font-bold mb-4 text-center">Enter Organization Code</label>
                        
                        <div id="otp-container" class="flex gap-2 sm:gap-3 justify-center" dir="ltr">
                            <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-xl font-bold rounded-lg border border-gray-600 bg-gray-800/50 text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 outline-none transition-all uppercase placeholder-gray-600" placeholder="-">
                            <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-xl font-bold rounded-lg border border-gray-600 bg-gray-800/50 text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 outline-none transition-all uppercase placeholder-gray-600" placeholder="-">
                            <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-xl font-bold rounded-lg border border-gray-600 bg-gray-800/50 text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 outline-none transition-all uppercase placeholder-gray-600" placeholder="-">
                            <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-xl font-bold rounded-lg border border-gray-600 bg-gray-800/50 text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 outline-none transition-all uppercase placeholder-gray-600" placeholder="-">
                            <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-xl font-bold rounded-lg border border-gray-600 bg-gray-800/50 text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 outline-none transition-all uppercase placeholder-gray-600" placeholder="-">
                            <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-xl font-bold rounded-lg border border-gray-600 bg-gray-800/50 text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 outline-none transition-all uppercase placeholder-gray-600" placeholder="-">
                        </div>

                        <input type="hidden" id="org-code-input">
                        
                        <p class="text-xs text-gray-500 mt-4 text-center">Ask your manager for the 6-character code.</p>
                    </div>
                    <p id="org-code-error" class="text-red-500 text-xs italic mb-4 hidden text-center"></p>
                    <button type="button" id="verify-code-btn" class="w-full btn btn-primary py-3">Next</button>
                </div>

                <div id="reg-step-details" class="hidden w-full">
                    <div class="p-3 bg-gray-800/50 rounded-lg mb-4 border border-gray-700 flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400">Joining Organization:</p>
                            <p id="org-name-display" class="font-bold text-white text-sm">Loading...</p>
                        </div>
                        <button type="button" id="change-code-btn" class="text-xs text-violet-400 hover:underline">Change</button>
                    </div>

                    <div class="mb-4">
                        <label for="register-fullname" class="block text-gray-200 text-sm font-bold mb-2">Full Name</label>
                        <input type="text" id="register-fullname" class="form-input shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-900 text-lg" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-200 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="register-email" class="form-input shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-900 text-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-group" class="block text-gray-200 text-sm font-bold mb-2">Group</label>
                        <select id="register-group" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-3 px-4 text-gray-900">
                            </select>
                    </div>
                    
                    <p id="register-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <p id="register-success" class="text-green-500 text-sm italic mb-4 hidden">Your request has been sent for approval!</p>
                    
                    <button type="submit" class="w-full btn btn-primary">Send Request</button>
                </div>

                <p class="text-center text-sm text-gray-400 mt-6">
                    Already have an account? <a href="#" id="show-login" class="theme-link hover:underline">Sign In</a>
                </p>
            </form>

            <form id="company-register-form" class="hidden relative min-h-[380px] flex flex-col justify-start pt-10 transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)] opacity-0 translate-y-10">
    <h2 class="text-2xl font-bold text-center text-white mb-2">Create Organization</h2>
    <p class="text-center text-gray-400 mb-8">Start managing your team's attendance.</p>
    
    <div id="comp-step-1" class="step-content w-full transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)] transform opacity-100 translate-y-0">
        <div class="mb-4">
            <label class="block text-gray-200 text-sm font-bold mb-2">What is your Company Name?</label>
            <input type="text" id="new-company-name" class="form-input shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-900 focus:ring-2 focus:ring-purple-500 bg-gray-50 focus:bg-white transition-colors" placeholder="e.g. Acme Corp" required>
        </div>
        <button type="button" onclick="nextStep(2)" class="w-full btn btn-primary mt-4 transform hover:-translate-y-1 transition-transform">Continue &rarr;</button>
    </div>

    <div id="comp-step-2" class="step-content w-full hidden transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)] transform opacity-0 translate-y-8">
        <div class="mb-4">
            <label class="block text-gray-200 text-sm font-bold mb-2">What is your Full Name?</label>
            <input type="text" id="new-company-admin-name" class="form-input shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-900 focus:ring-2 focus:ring-purple-500 bg-gray-50 focus:bg-white transition-colors" placeholder="John Doe">
        </div>
        <div class="flex gap-3 mt-4">
            <button type="button" onclick="prevStep(1)" class="px-6 py-2 rounded-lg bg-gray-800 border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors">Back</button>
            <button type="button" onclick="nextStep(3)" class="flex-1 btn btn-primary transform hover:-translate-y-1 transition-transform">Continue &rarr;</button>
        </div>
    </div>

    <div id="comp-step-3" class="step-content w-full hidden transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)] transform opacity-0 translate-y-8">
        <div class="mb-4">
            <label class="block text-gray-200 text-sm font-bold mb-2">What is your Email Address?</label>
            <input type="email" id="new-company-email" class="form-input shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-900 focus:ring-2 focus:ring-purple-500 bg-gray-50 focus:bg-white transition-colors" placeholder="name@company.com">
        </div>
        <div class="flex gap-3 mt-4">
            <button type="button" onclick="prevStep(2)" class="px-6 py-2 rounded-lg bg-gray-800 border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors">Back</button>
            <button type="button" onclick="nextStep(4)" class="flex-1 btn btn-primary transform hover:-translate-y-1 transition-transform">Continue &rarr;</button>
        </div>
    </div>

    <div id="comp-step-4" class="step-content w-full hidden transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)] transform opacity-0 translate-y-8">
        <div class="mb-6">
            <label class="block text-gray-200 text-sm font-bold mb-2">Choose a Password</label>
            <input type="password" id="new-company-password" class="form-input shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-900 focus:ring-2 focus:ring-purple-500 bg-gray-50 focus:bg-white transition-colors" placeholder="Min. 6 characters">
        </div>

        <p id="company-register-error" class="text-red-400 text-sm bg-red-900/30 p-2 rounded mb-4 hidden border border-red-500/50"></p>
        
        <div class="flex gap-3 mt-4">
            <button type="button" onclick="prevStep(3)" class="px-6 py-2 rounded-lg bg-gray-800 border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors">Back</button>
            <button type="submit" class="flex-1 btn btn-primary shadow-lg shadow-purple-500/30 transform hover:-translate-y-1 transition-transform">Create & Start Free</button>
        </div>
    </div>

    <div class="absolute bottom-4 left-0 right-0 flex justify-center space-x-3">
        <div id="dot-1" class="w-2.5 h-2.5 rounded-full bg-white transition-all duration-500 shadow shadow-white/50"></div>
        <div id="dot-2" class="w-2.5 h-2.5 rounded-full bg-gray-600 transition-all duration-500"></div>
        <div id="dot-3" class="w-2.5 h-2.5 rounded-full bg-gray-600 transition-all duration-500"></div>
        <div id="dot-4" class="w-2.5 h-2.5 rounded-full bg-gray-600 transition-all duration-500"></div>
    </div>

    <p class="absolute bottom-4 right-0 left-0 text-center text-sm text-gray-400" style="bottom: -25px;">
        <a href="#" id="back-to-login-from-company" class="theme-link hover:underline opacity-70 hover:opacity-100 transition-opacity">Back to Sign In</a>
    </p>
</form>
        </div>
        <!-- [MODIFICATION] Install PWA button moved here and restyled -->
        <div class="mt-6 text-center">
            <button id="install-pwa-button" class="btn btn-primary" style="display: none;">
                Install App
            </button>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden max-w-[98%] mx-auto p-3 sm:p-4 lg:p-6">
        <header id="sticky-header" class="flex justify-between items-center mb-6 pb-4 border-b">
            <div class="flex flex-col items-start relative z-50 shrink-0">
                  <!-- ================================================================== -->
                  <!-- מיקום 2: מסך האפליקציה                                                -->
                  <!-- שנה את הערך "h-12" כדי לשלוט בגובה הלוגו. למשל: h-10, h-14, h-16 -->
                  <!-- ================================================================== -->
                  <svg class="samsung-logo-svg h-12" viewBox="0 0 837.6507 222.51334" xmlns="http://www.w3.org/2000/svg">
        <g transform="matrix(1.3333333,0,0,-1.3333333,0,222.51333)">
            <g transform="translate(558.9328,88.5098)">
                <path d="m 0,0 v -11.358 h 7.982 v -11.269 c 0.025,-1.007 -0.03,-2.093 -0.203,-2.962 -0.317,-2.102 -2.314,-5.681 -7.98,-5.681 -5.632,0 -7.593,3.579 -7.933,5.681 -0.143,0.869 -0.204,1.955 -0.204,2.962 v 35.593 c 0,1.259 0.085,2.637 0.352,3.68 0.387,1.897 2.068,5.638 7.743,5.638 5.957,0 7.444,-3.944 7.785,-5.638 0.224,-1.122 0.237,-3.004 0.237,-3.004 V 9.32 h 19.613 v 2.555 c 0,0 0.089,2.666 -0.149,5.154 C 25.769,31.638 13.732,36.26 -0.07,36.26 c -13.827,0 -25.62,-4.665 -27.338,-19.231 -0.155,-1.332 -0.392,-3.728 -0.392,-5.154 v -32.742 c 0,-1.426 0.046,-2.53 0.31,-5.136 1.28,-14.207 13.593,-19.243 27.365,-19.243 13.857,0 26.085,5.036 27.387,19.243 0.231,2.606 0.255,3.71 0.286,5.136 V 0 Z m -135.235,34.165 h -19.696 v -57.613 c 0.031,-1.004 0,-2.132 -0.173,-2.959 -0.411,-1.934 -2.05,-5.656 -7.484,-5.656 -5.364,0 -7.046,3.722 -7.426,5.656 -0.197,0.827 -0.222,1.955 -0.197,2.959 v 57.613 h -19.69 V -21.66 c -0.025,-1.439 0.088,-4.379 0.173,-5.149 1.359,-14.547 12.824,-19.27 27.14,-19.27 14.344,0 25.802,4.723 27.186,19.27 0.109,0.77 0.252,3.71 0.167,5.149 z m -180.97,0 -9.825,-60.876 -9.819,60.876 h -31.771 l -1.685,-77.878 h 19.464 l 0.527,72.094 13.392,-72.094 h 19.748 l 13.404,72.094 0.529,-72.094 h 19.513 l -1.742,77.878 z m -117.631,0 -14.426,-77.878 h 21.037 l 10.871,72.094 10.61,-72.094 h 20.891 l -14.366,77.878 z m 367.435,-62.701 -18.34,62.701 h -28.9 v -77.066 h 19.118 l -1.11,64.707 19.696,-64.707 h 27.717 v 77.066 h -19.243 z m -176.838,42.433 c -0.346,1.538 -0.246,3.172 -0.067,4.026 0.557,2.493 2.232,5.212 7.058,5.212 4.498,0 7.135,-2.804 7.135,-7.012 v -4.762 h 19.2 v 5.428 c 0,16.78 -15.044,19.416 -25.936,19.416 -13.718,0 -24.921,-4.522 -26.967,-17.148 -0.541,-3.436 -0.675,-6.486 0.186,-10.378 3.336,-15.743 30.743,-20.31 34.721,-30.266 0.702,-1.886 0.501,-4.291 0.143,-5.708 -0.596,-2.591 -2.339,-5.197 -7.506,-5.197 -4.846,0 -7.763,2.786 -7.763,6.985 l -0.006,7.474 h -20.666 v -5.941 c 0,-17.215 13.484,-22.409 28.007,-22.409 13.909,0 25.397,4.753 27.24,17.637 0.879,6.657 0.216,10.993 -0.137,12.626 -3.22,16.147 -32.431,21.004 -34.642,30.017 m -253.273,0.191 c -0.377,1.57 -0.289,3.227 -0.079,4.091 0.532,2.481 2.217,5.248 7.128,5.248 4.555,0 7.237,-2.831 7.237,-7.073 v -4.82 h 19.425 v 5.471 c 0,16.941 -15.274,19.641 -26.285,19.641 -13.833,0 -25.136,-4.592 -27.204,-17.309 -0.566,-3.491 -0.663,-6.562 0.155,-10.497 3.372,-15.922 31.05,-20.526 35.077,-30.601 0.754,-1.873 0.526,-4.278 0.152,-5.75 -0.639,-2.618 -2.396,-5.261 -7.606,-5.261 -4.865,0 -7.775,2.834 -7.775,7.091 l -0.027,7.494 h -20.898 v -5.955 c 0,-17.412 13.675,-22.648 28.311,-22.648 14.071,0 25.626,4.795 27.511,17.828 0.937,6.718 0.234,11.09 -0.082,12.748 -3.287,16.345 -32.823,21.186 -35.04,30.302" />
            </g>
        </g>
    </svg>
                <p class="animated-gradient-text text-md font-bold tracking-widest -mt-1 pl-3">R&D CENTER ISRAEL</p>
            </div>
            <div class="flex items-center space-x-4">
                
                <button id="logout-button" class="hidden sm:block text-sm font-medium text-gray-600 hover:text-red-600 transition duration-150 ease-in-out">
                    Logout
                </button>

                <button id="mobile-menu-btn" onclick="toggleMobileMenu()" class="sm:hidden p-2 text-gray-600 dark:text-gray-300 focus:outline-none z-50 relative">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>

            </div>
        </header>
        
        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-200">
            <nav id="main-nav" class="relative flex w-full sm:w-auto justify-between sm:justify-center space-x-1 sm:space-x-4 overflow-x-hidden pb-2 -mb-2">
                <div id="active-tab-indicator"></div>

                <button id="tab-requests" class="tab-btn flex-1 sm:flex-none w-full sm:w-auto text-center relative z-10 whitespace-nowrap py-3 px-1 sm:px-4 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 order-1 sm:order-4">
                    Requests
                    <span id="requests-notification-dot" class="absolute top-2 right-2 h-2.5 w-2.5 rounded-full bg-red-500 hidden"></span>
                </button>

                <button id="tab-update" class="tab-btn flex-1 sm:flex-none w-full sm:w-auto text-center relative z-10 whitespace-nowrap py-3 px-1 sm:px-4 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 order-2 sm:order-2">
                    Update Week
                </button>

                <button id="tab-display" class="tab-btn active flex-1 sm:flex-none w-full sm:w-auto text-center relative z-10 whitespace-nowrap py-3 px-1 sm:px-4 font-medium text-sm order-3 sm:order-3">
                    Team View
                </button>

                <button id="tab-profile" class="tab-btn hidden sm:block relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 sm:order-1">
                    My Profile
                </button>

                <button id="tab-calendar" class="tab-btn hidden relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 sm:order-5">
                    Team Calendar
                </button>

                <button id="tab-statistics" class="tab-btn hidden sm:block relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 sm:order-6">
                    Statistics
                </button>

                <button id="tab-tl-tools" class="tab-btn hidden relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 sm:order-7">
                    Team Desk
                    <span id="tl-notification-dot" class="absolute top-2 right-2 h-2.5 w-2.5 rounded-full bg-red-500 hidden"></span>
                </button>

                <button id="tab-super-admin" class="tab-btn hidden relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 hover:text-gray-700 sm:order-8">
                    Settings
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- Profile Content -->
            <div id="content-profile" class="tab-content hidden">
                <div class="mb-6 text-center sm:text-left">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">My Profile</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Manage your personal information and settings</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Employee Information</h2>
                        <form id="profile-form">
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label for="full-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="full-name" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="email" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                </div>
                                <div>
                                    <label for="group" class="block text-sm font-medium text-gray-700">Group</label>
                                      <div class="flex items-center space-x-2 mt-1">
                                           <select id="group" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3"></select>
                                           <button type="button" id="manage-groups-btn" class="hidden p-2 rounded-md bg-gray-200 hover:bg-gray-300">
                                               <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                                           </button>
                                       </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Role</label>
                                    <p id="role-display" class="mt-1 text-md font-semibold text-gray-900"></p>
                                </div>
                            </div>
                            <div class="mt-8 flex items-center">
                                <button type="submit" class="btn btn-primary">Save Profile</button>
                                <div id="profile-success-animation" class="success-animation-container">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                        <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                        <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                        <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                    </svg>
                                </div>
                            </div>
                        </form>
                    </div>
                      <!-- [MODIFICATION 2] Right card is now "Settings" -->
                       <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold text-gray-900 mb-8">Settings</h2>
                            
                            <!-- Dark Mode Toggle -->
                            <div class="flex justify-between items-center">
                                <div>
                                    <label for="dark-mode-toggle" class="block text-sm font-medium text-gray-700">Dark Mode</label>
                                    <p class="text-xs text-gray-500">Toggle to switch themes</p>
                                </div>
                                <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" id="dark-mode-toggle" class="sr-only peer">
                                    <!-- Apple-style toggle with gradient -->
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-gradient-to-r from-pink-400 via-purple-400 to-green-400"></div>
                                </label>
                            </div>

                            <!-- Divider and Change Password Section -->
                            <div class="mt-8 pt-8 border-t">
                                 <h3 class="text-lg font-bold text-gray-900 mb-6">Change Password</h3>
                                <form id="change-password-form">
                                    <div class="grid grid-cols-1 gap-6">
                                        <div>
                                            <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                                            <input type="password" id="new-password" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                        </div>
                                        <div>
                                            <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                                            <input type="password" id="confirm-new-password" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                        </div>
                                    </div>
                                     <p id="password-change-error" class="text-red-500 text-xs italic mt-4 hidden"></p>
                                    <div class="mt-8 flex items-center">
                                        <button type="submit" class="btn btn-primary">Change Password</button>
                                        <div id="password-change-success-animation" class="success-animation-container">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                                <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                                <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                                <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                            </svg>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                                <h3 id="share-app-title" class="text-lg font-bold mb-6 text-gray-900 dark:text-white">Share Workspace</h3>
                                
                                <div id="org-code-display-container" class="hidden">
                                    <label class="block text-xs font-semibold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider mb-2">Organization Invite Code</label>
                                    
                                    <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-500/30 rounded-xl flex justify-between items-center transition-colors duration-300">
                                        <div>
                                            <div class="flex items-center gap-3">
                                                <span id="settings-org-code" data-real-code="" class="text-2xl font-mono font-black text-gray-900 dark:text-white tracking-[0.2em] min-w-[140px] inline-block">******</span>
                                                
                                                <button id="reveal-code-btn" class="p-2 rounded-lg hover:bg-indigo-200/50 dark:hover:bg-indigo-500/30 text-indigo-600 dark:text-indigo-300 transition-all group" title="Reveal Code">
                                                    <svg id="icon-eye-off" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>
                                                    <svg id="icon-eye-on" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                                </button>
                                            </div>
                                            <p class="text-[10px] text-gray-500 dark:text-indigo-300/70 mt-1">Hidden for security. Click eye to reveal.</p>
                                        </div>
                                        
                                        <button id="copy-org-code-btn" class="px-4 py-2 bg-white dark:bg-indigo-600 text-indigo-600 dark:text-white text-sm font-bold rounded-lg shadow-sm hover:shadow-md transition-all active:scale-95">
                                            Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Update Week Content -->
            <div id="content-update" class="tab-content hidden">
                <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                    <div class="flex items-center justify-center space-x-2 sm:space-x-4">
                        <button id="update-view-prev-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div class="text-center">
                            <h2 id="update-week-main-title" class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Weekly Attendance</h2>
                            <p id="week-dates-title" class="text-sm sm:text-md text-gray-500">Loading...</p>
                        </div>
                        <button id="update-view-next-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <form id="attendance-form" class="mt-6">
                        <div id="attendance-days-container" class="space-y-4">
                        </div>
                        <div class="mt-8 flex items-center">
                            <button type="submit" class="btn btn-primary">Save Week</button>
                            <div id="week-success-animation" class="success-animation-container">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                    <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                    <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                    <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                </svg>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Team View Content -->
            <div id="content-display" class="tab-content">
                 <div class="bg-white dark:bg-transparent p-4 sm:p-6 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                         <div class="flex items-center justify-center sm:justify-start space-x-2 sm:space-x-4">
                            <button id="team-view-prev-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <div class="text-center sm:text-left">
                                <h2 id="team-view-main-title" class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Team View</h2>
                                <p id="team-week-dates-title" class="text-sm sm:text-md text-gray-500">Loading...</p>
                            </div>
                            <button id="team-view-next-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div class="flex items-center justify-center">
                            <label for="group-filter" class="block text-sm font-medium text-gray-700 mr-3 whitespace-nowrap">Group:</label>
                            <select id="group-filter" class="form-input block w-full max-w-xs border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </select>
                        </div>
                    </div>
                    <div id="team-view-container" class="overflow-x-auto mt-6">
                    </div>
                </div>
            </div>

            <!-- Statistics Content -->
            <div id="content-statistics" class="tab-content hidden">
                <div class="mb-6 text-center sm:text-left">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Analytics & Reports</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">View attendance trends and weekly summaries</p>
                </div>

                 <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                         <div class="flex items-center justify-center sm:justify-start space-x-2 sm:space-x-4">
                            <button id="stats-view-prev-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <div class="text-center sm:text-left">
                                <h2 id="statistics-main-title" class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Statistics</h2>
                                <p id="stats-week-dates-title" class="text-sm sm:text-md text-gray-500">Loading...</p>
                            </div>
                            <button id="stats-view-next-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div class="flex flex-row items-start justify-center gap-2 sm:gap-4 flex-wrap">
                            <div class="flex-1 min-w-[140px]">
                                <label for="stats-group-filter" class="block text-sm font-medium text-gray-700 mb-1">Group:</label>
                                <select id="stats-group-filter" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                                     </select>
                            </div>
                            <div class="flex-1 min-w-[140px]">
                                <label for="stats-employee-filter" class="block text-sm font-medium text-gray-700 mb-1">Employee:</label>
                                <select id="stats-employee-filter" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                                     </select>
                            </div>
                            <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
                                
                                <div class="flex items-center bg-white dark:bg-gray-800 shadow-sm border border-gray-300 dark:border-gray-600 p-1" style="border-radius: 12px !important;">
                                    
                                    <button id="prev-month-btn" class="p-2 rounded-lg hover:text-violet-700 hover:bg-violet-50 dark:hover:bg-gray-700 transition focus:outline-none" style="color: #4b5563 !important;">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                                    </button>
                                    
                                    <span id="export-month-text" class="px-2 text-sm font-extrabold min-w-[150px] text-center select-none tracking-wide" style="color: #111827 !important;">
                                        November 2025
                                    </span>

                                    <button id="next-month-btn" class="p-2 rounded-lg hover:text-violet-700 hover:bg-violet-50 dark:hover:bg-gray-700 transition focus:outline-none" style="color: #4b5563 !important;">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                                    </button>
                                </div>

                                <button id="export-stats-pdf-btn" class="group relative flex items-center gap-2 px-6 py-2.5 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 text-white text-sm font-bold shadow-md hover:shadow-lg hover:shadow-purple-500/30 transition-all duration-300 transform hover:-translate-y-0.5 overflow-hidden" style="border-radius: 12px !important;">
                                    <div class="absolute inset-0 bg-white/20 group-hover:translate-x-full transition-transform duration-700 ease-in-out -translate-x-full skew-x-12"></div>
                                    <svg class="w-4 h-4 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    <span class="relative z-10">Export Report</span>
                                </button>

                            </div>
                        </div>
                    </div>
                    <div id="statistics-container" class="mt-8">
                    </div>
                 </div>
            </div>

            <!-- Requests Content -->
            <div id="content-requests" class="tab-content hidden">
                <div class="max-w-6xl mx-auto">
                    
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Requests Center</h2>
                        
                        <div id="requests-sub-nav" class="hidden w-full max-w-md mx-auto flex bg-gray-100 dark:bg-gray-800 p-1.5 rounded-2xl shadow-inner mb-6">
    
    <button id="sub-req-personal" class="flex-1 py-3 rounded-xl text-base sm:text-lg font-bold shadow-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-all">
        My Personal
    </button>
    
    <button id="sub-req-team" class="flex-1 py-3 rounded-xl text-base sm:text-lg font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-all flex items-center justify-center gap-2">
        Team Inbox
        <span id="team-inbox-badge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
    </button>

</div>

                        <button id="new-request-btn" class="btn btn-primary flex items-center gap-2 shadow-lg hover:shadow-purple-500/30 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            New Request
                        </button>
                    </div>

                    <div id="view-personal-requests" class="transition-all duration-300">
                        <div class="bg-white dark:bg-transparent p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300 mb-4">My Request History</h3>
                            <div id="my-requests-list" class="overflow-y-auto max-h-[65vh] px-2 pt-4 pb-24 custom-scrollbar relative scroll-smooth">
                                <p class="text-gray-500 text-sm">Loading your history...</p>
                            </div>
                            
                            <div class="mt-6 mb-2 text-center">
                                <button id="show-more-requests-btn" class="hidden group relative inline-flex items-center justify-center px-6 py-2.5 text-sm font-bold text-purple-600 dark:text-purple-400 bg-white dark:bg-gray-800 border border-purple-200 dark:border-gray-600 rounded-full shadow-sm hover:shadow-md hover:bg-purple-50 dark:hover:bg-gray-700 transition-all duration-300 transform active:scale-95">
                                    <span class="mr-2">Load previous requests</span>
                                    <svg class="w-4 h-4 transition-transform group-hover:translate-y-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="view-team-requests" class="hidden transition-all duration-300">
                        
                        <div id="pending-registrations-section" class="hidden bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Pending Registrations</h2>
        <div id="pending-actions-container" class="hidden">
            <div class="flex space-x-2">
                <button id="approve-all-btn" class="btn btn-success text-xs py-2 px-3">Approve All</button>
                <button id="reject-all-btn" class="btn btn-danger text-xs py-2 px-3">Reject All</button>
            </div>
        </div>
    </div>
    <div id="pending-users-container">
        <p class="text-gray-500 dark:text-gray-400">Loading pending requests...</p>
    </div>
</div>

                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between sticky top-0 z-20">
    
    <div class="relative w-full md:w-96">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>
        <input type="text" id="req-search" class="pl-11 py-3.5 form-input block w-full rounded-xl border-gray-300 dark:border-gray-600 dark:bg-gray-700/50 text-sm focus:ring-purple-500 focus:border-purple-500 transition-shadow shadow-sm" placeholder="Search employee by name...">
    </div>

    <div class="flex flex-wrap gap-3 w-full md:w-auto">
        <div class="relative flex-1 md:flex-none">
            <select id="req-filter-group" class="form-input w-full appearance-none text-sm py-3.5 pl-4 pr-10 rounded-xl border-gray-300 dark:border-gray-600 dark:bg-gray-700/50 cursor-pointer hover:border-purple-400 transition-colors shadow-sm">
                <option value="all">All Groups</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
        </div>

        <div class="relative flex-1 md:flex-none">
            <select id="req-filter-status" class="form-input w-full appearance-none text-sm py-3.5 pl-4 pr-10 rounded-xl border-gray-300 dark:border-gray-600 dark:bg-gray-700/50 cursor-pointer hover:border-purple-400 transition-colors shadow-sm">
                <option value="all">All Statuses</option>
                <option value="pending" selected>Pending Only</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
        </div>
    </div>
</div>



                        <div class="hidden md:grid grid-cols-12 gap-4 px-4 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                            <div class="col-span-3">Employee</div>
                            <div class="col-span-4">Request Details</div>
                            <div class="col-span-2">Group</div>
                            <div class="col-span-3 text-right">Status / Actions</div>
                        </div>

                        <div id="leave-requests-header" class="hidden flex justify-between items-center mb-6 mt-8 px-1">
    
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Holiday Requests</h2>
    
    <div id="leave-requests-actions" class="hidden flex space-x-2">
        <button id="req-approve-all-btn" class="btn btn-success text-xs py-2 px-3 shadow-sm transition transform active:scale-95">Approve All</button>
        <button id="req-reject-all-btn" class="btn btn-danger text-xs py-2 px-3 shadow-sm transition transform active:scale-95">Reject All</button>
    </div>
</div>

                        <div id="team-requests-list" class="space-y-2 pb-8">
                        </div>

                        <div class="mt-4 mb-6 text-center">
                            <button id="show-more-team-btn" class="hidden group relative inline-flex items-center justify-center px-6 py-2.5 text-sm font-bold text-purple-600 dark:text-purple-400 bg-white dark:bg-gray-800 border border-purple-200 dark:border-gray-600 rounded-full shadow-sm hover:shadow-md hover:bg-purple-50 dark:hover:bg-gray-700 transition-all duration-300 transform active:scale-95">
                                <span class="mr-2">Load older requests</span>
                                <svg class="w-4 h-4 transition-transform group-hover:translate-y-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>

                        <div id="team-requests-empty" class="hidden flex flex-col items-center justify-center py-20 text-center">
                            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">All Clear!</h3>
                            <p class="text-gray-500 dark:text-gray-400 mt-1">No pending requests found.</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Calendar Content -->
            <div id="content-calendar" class="tab-content hidden">
                <div class="mb-6 text-center sm:text-left">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Team Planner</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Monthly overview of team availability.</p>
                </div>

                <div class="bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-2xl p-5 mb-8 shadow-sm">
    
                    <div class="flex flex-col xl:flex-row gap-5 justify-between items-center mb-5 border-b border-gray-200 dark:border-gray-700 pb-5">
        
                        <div class="flex items-center bg-white dark:bg-gray-800 p-1.5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-600">
                            <button id="planner-prev-month" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <span id="planner-month-year" class="text-lg font-bold text-gray-800 dark:text-white min-w-[160px] text-center tracking-tight">Loading...</span>
                            <button id="planner-next-month" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>

                        <div class="flex flex-wrap gap-3 w-full xl:w-auto justify-end">
                            <div class="relative group w-full sm:w-auto">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <select id="planner-group-filter" class="form-input text-sm py-2.5 pl-9 pr-8 w-full rounded-xl border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-purple-500/20 cursor-pointer font-medium shadow-sm">
                                    <option value="all">All Groups</option>
                                </select>
                            </div>

                            <div class="relative group w-full sm:w-auto">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </div>
                                <select id="planner-employee-filter" class="form-input text-sm py-2.5 pl-9 pr-8 w-full rounded-xl border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-purple-500/20 cursor-pointer font-medium shadow-sm">
                                    <option value="all">All Employees</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                            <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Filter by Status</span>
                        </div>
        
                        <div id="planner-category-chips" class="flex flex-wrap gap-2">
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-transparent p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">

                    <div class="overflow-x-auto overflow-y-hidden touch-pan-x touch-pan-y" id="planner-scroll-container">
                        <div id="planner-inner-grid" class="min-w-[100%] md:min-w-[800px]">
                            
                            <div class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-t-lg overflow-hidden">
                                <div class="p-2 text-center text-xs font-bold text-gray-500 uppercase bg-gray-50 dark:bg-gray-800">Sun</div>
                                <div class="p-2 text-center text-xs font-bold text-gray-500 uppercase bg-gray-50 dark:bg-gray-800">Mon</div>
                                <div class="p-2 text-center text-xs font-bold text-gray-500 uppercase bg-gray-50 dark:bg-gray-800">Tue</div>
                                <div class="p-2 text-center text-xs font-bold text-gray-500 uppercase bg-gray-50 dark:bg-gray-800">Wed</div>
                                <div class="p-2 text-center text-xs font-bold text-gray-500 uppercase bg-gray-50 dark:bg-gray-800">Thu</div>
                                <div class="p-2 text-center text-xs font-bold text-gray-500 uppercase bg-gray-50 dark:bg-gray-800">Fri</div>
                                <div class="p-2 text-center text-xs font-bold text-gray-500 uppercase bg-gray-50 dark:bg-gray-800">Sat</div>
                            </div>

                            <div id="planner-grid" class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 border-x border-b border-gray-200 dark:border-gray-700 rounded-b-lg">
                            </div>
                        </div>
                    </div>

                    <p class="text-center text-xs text-gray-400 mt-2 sm:hidden flex items-center justify-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                        Pinch to expand view
                    </p>

                    <div class="mt-6 flex flex-wrap gap-4 text-xs text-gray-500 justify-center" id="planner-legend">
                        </div>

                </div>
            </div>

            <!-- TL Tools Content -->
            <div id="content-tl-tools" class="tab-content hidden">
                <div class="mb-6 text-center sm:text-left">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Team Leader Tools</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Manage team requests, users, and bulk actions</p>
                </div>

                 <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Bulk Attendance Update</h2>
                    <p class="text-sm text-gray-600 mb-6">Set a status for all employees on a specific day of a chosen week.</p>
                     <div class="flex items-center justify-center space-x-2 sm:space-x-4 mb-6">
                        <button id="tl-view-prev-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div class="text-center">
                            <h3 id="tl-week-dates-title" class="text-lg font-semibold text-gray-800">Loading...</h3>
                        </div>
                        <button id="tl-view-next-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <form id="tl-form">
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="tl-day" class="block text-sm font-medium text-gray-700">Day of Week</label>
                                <select id="tl-day" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                                </select>
                            </div>
                            <div>
                                <label for="tl-group-filter" class="block text-sm font-medium text-gray-700">Target Group</label>
                                <select id="tl-group-filter" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                                    <option value="all">All Groups</option>
                                </select>
                            </div>
                             <div>
                                <label for="tl-status-select" class="block text-sm font-medium text-gray-700">Set Status To</label>
                                <select id="tl-status-select" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                                 </select>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button id="bulk-update-btn" type="submit" class="btn btn-danger">Update All Employees</button>
                        </div>
                    </form>
                </div>

                <!-- Divider -->
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent my-8"></div>

                <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Create New User</h2>
                    <p class="text-sm text-gray-600 mb-6">Create a new employee profile. The default password will be <span class="font-mono bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-2 py-1 rounded">123456</span>.</p>
                    <form id="create-user-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="new-user-fullname" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="new-user-fullname" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="new-user-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" id="new-user-email" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                             <div class="md:col-span-2">
                                <label for="new-user-group" class="block text-sm font-medium text-gray-700">Group</label>
                                <select id="new-user-group" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                                     </select>
                            </div>
                        </div>
                         <p id="create-user-error" class="text-red-500 text-xs italic mt-4 hidden"></p>
                        <div class="mt-8 flex items-center">
                            <button type="submit" class="btn btn-primary">Create User</button>
                            <div id="create-user-success-animation" class="success-animation-container">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                    <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                    <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                    <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                </svg>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Divider -->
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent my-8"></div>

                <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Remove User</h2>
                    <p class="text-sm text-gray-600 mb-6">Select a user to permanently remove them from the system. This will delete their profile and all attendance records.</p>
                    <form id="remove-user-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="remove-user-group-filter" class="block text-sm font-medium text-gray-700">Filter by Group</label>
                                <select id="remove-user-group-filter" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm"></select>
                            </div>
                            <div>
                                <label for="remove-user-select" class="block text-sm font-medium text-gray-700">Select User to Remove</label>
                                <select id="remove-user-select" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                                    <option value="">-- Select a user --</option>
                                </select>
                            </div>
                        </div>
                        <p id="remove-user-error" class="text-red-500 text-xs italic mt-4 hidden"></p>
                        <div class="mt-8">
                            <button type="submit" class="btn btn-danger">Remove User</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Super Admin Content -->
            <div id="content-super-admin" class="tab-content hidden">
                <div class="mb-6 text-center sm:text-left">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">System Administration</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Configure global settings, work days, and permissions</p>
                </div>

                <div id="activation-panel" class="hidden bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-6 mb-8 rounded-r-xl shadow-sm animate-in fade-in zoom-in duration-300">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                        
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-red-700 dark:text-red-400 flex items-center gap-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                Trial Mode: Locked
                            </h3>
                            
                            <p class="text-sm text-red-600 dark:text-red-300 mt-2 mb-4 leading-relaxed">
                                Your organization is currently in trial mode. You are limited to <span id="limit-display" class="font-bold">1</span> user (yourself). 
                                <br>Please enter the 6-character activation code to unlock full access.
                            </p>

                            <a href="mailto:louly.deliable@gmail.com?subject=Request Activation Code&body=Hi, I would like to request an activation code for my company." class="inline-flex items-center gap-2 text-sm font-bold text-red-700 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 bg-red-100 dark:bg-red-900/40 px-3 py-1.5 rounded-lg transition-colors border border-red-200 dark:border-red-800/50">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                Don't have a code? Contact Support
                            </a>
                        </div>

                        <form id="activation-form" class="flex flex-col items-center gap-4 w-full lg:w-auto bg-white/50 dark:bg-gray-800/50 p-4 rounded-xl border border-red-100 dark:border-red-900/30 shadow-sm">
                            <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Enter Code</label>
                            
                            <div id="activation-otp-container" class="flex gap-2 justify-center" dir="ltr">
                                <input type="text" maxlength="1" class="activation-otp w-10 h-12 text-center text-xl font-bold rounded-lg border-2 border-red-200 dark:border-red-500 !bg-white dark:!bg-gray-900 text-gray-900 dark:text-white focus:border-red-600 focus:ring-2 focus:ring-red-500/40 outline-none transition-all uppercase placeholder-red-200 dark:placeholder-red-800 shadow-sm" placeholder="-">
                                <input type="text" maxlength="1" class="activation-otp w-10 h-12 text-center text-xl font-bold rounded-lg border-2 border-red-200 dark:border-red-500 !bg-white dark:!bg-gray-900 text-gray-900 dark:text-white focus:border-red-600 focus:ring-2 focus:ring-red-500/40 outline-none transition-all uppercase placeholder-red-200 dark:placeholder-red-800 shadow-sm" placeholder="-">
                                <input type="text" maxlength="1" class="activation-otp w-10 h-12 text-center text-xl font-bold rounded-lg border-2 border-red-200 dark:border-red-500 !bg-white dark:!bg-gray-900 text-gray-900 dark:text-white focus:border-red-600 focus:ring-2 focus:ring-red-500/40 outline-none transition-all uppercase placeholder-red-200 dark:placeholder-red-800 shadow-sm" placeholder="-">
                                <input type="text" maxlength="1" class="activation-otp w-10 h-12 text-center text-xl font-bold rounded-lg border-2 border-red-200 dark:border-red-500 !bg-white dark:!bg-gray-900 text-gray-900 dark:text-white focus:border-red-600 focus:ring-2 focus:ring-red-500/40 outline-none transition-all uppercase placeholder-red-200 dark:placeholder-red-800 shadow-sm" placeholder="-">
                                <input type="text" maxlength="1" class="activation-otp w-10 h-12 text-center text-xl font-bold rounded-lg border-2 border-red-200 dark:border-red-500 !bg-white dark:!bg-gray-900 text-gray-900 dark:text-white focus:border-red-600 focus:ring-2 focus:ring-red-500/40 outline-none transition-all uppercase placeholder-red-200 dark:placeholder-red-800 shadow-sm" placeholder="-">
                                <input type="text" maxlength="1" class="activation-otp w-10 h-12 text-center text-xl font-bold rounded-lg border-2 border-red-200 dark:border-red-500 !bg-white dark:!bg-gray-900 text-gray-900 dark:text-white focus:border-red-600 focus:ring-2 focus:ring-red-500/40 outline-none transition-all uppercase placeholder-red-200 dark:placeholder-red-800 shadow-sm" placeholder="-">
                            </div>
                            
                            <button type="submit" class="w-full btn bg-red-600 hover:bg-red-700 text-white shadow-lg whitespace-nowrap px-6 py-2.5 h-10 flex items-center justify-center rounded-lg font-bold transition-transform active:scale-95 text-sm">
                                Unlock Access
                            </button>
                        </form>
                    </div>
                </div>

                <div id="usage-panel" class="hidden bg-white dark:bg-transparent p-6 mb-8 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 transition-all" style="display: none !important;">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700 dark:text-gray-300">Plan Usage</h3>
                        <span id="usage-text" class="text-sm font-bold text-purple-600">Loading...</span>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mb-4">
                        <div id="usage-bar" class="bg-purple-600 h-2.5 rounded-full transition-all duration-1000 relative" style="width: 0%">
                            <div class="absolute inset-0 bg-white/30 rounded-full animate-pulse"></div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-3 border-t border-gray-100 dark:border-gray-700 pt-4">
                        
                        <button id="upgrade-limit-btn" class="group flex items-center justify-center gap-2 w-full py-2 text-sm font-bold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 rounded-lg transition-all">
                            <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                            Need more users? Upgrade Limit
                        </button>

                        <div class="text-center">
                            <a href="mailto:louly.deliable@gmail.com?subject=Support Request: System Help" class="inline-flex items-center justify-center gap-1.5 text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors mb-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                Having trouble? Contact Support
                            </a>
                            
                            <p class="text-[10px] text-gray-400 dark:text-gray-600 font-mono select-all cursor-text" title="Click to select email">
                                louly.deliable@gmail.com
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">User Management</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <input type="text" id="user-search-input" class="form-input block w-full md:w-1/3 border-gray-300 rounded-lg shadow-sm" placeholder="Search by name or email...">
                        <select id="user-group-filter" class="form-input block w-full md:w-1/4 border-gray-300 rounded-lg shadow-sm">
                            <option value="all">All Groups</option>
                        </select>
                    </div>
                    <div id="user-management-container" class="overflow-x-auto">
                        <p class="text-gray-500">Loading users...</p>
                    </div>
                </div>

                <div class="mt-8 bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Work Days Configuration</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Select the working days for your organization. Changes will affect all views immediately.</p>
                    
                    <form id="work-days-form">
                        <div class="flex flex-wrap justify-center sm:justify-start gap-4 mb-6">
                            <label class="cursor-pointer">
                                <input type="checkbox" name="workday" value="0" class="peer sr-only">
                                <div class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 font-bold peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-900/20 peer-checked:text-violet-600 dark:peer-checked:text-violet-400 transition-all">
                                    Sun
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="workday" value="1" class="peer sr-only">
                                <div class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 font-bold peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-900/20 peer-checked:text-violet-600 dark:peer-checked:text-violet-400 transition-all">
                                    Mon
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="workday" value="2" class="peer sr-only">
                                <div class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 font-bold peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-900/20 peer-checked:text-violet-600 dark:peer-checked:text-violet-400 transition-all">
                                    Tue
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="workday" value="3" class="peer sr-only">
                                <div class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 font-bold peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-900/20 peer-checked:text-violet-600 dark:peer-checked:text-violet-400 transition-all">
                                    Wed
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="workday" value="4" class="peer sr-only">
                                <div class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 font-bold peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-900/20 peer-checked:text-violet-600 dark:peer-checked:text-violet-400 transition-all">
                                    Thu
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="workday" value="5" class="peer sr-only">
                                <div class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 font-bold peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-900/20 peer-checked:text-violet-600 dark:peer-checked:text-violet-400 transition-all">
                                    Fri
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="workday" value="6" class="peer sr-only">
                                <div class="w-12 h-12 flex items-center justify-center rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 font-bold peer-checked:border-violet-500 peer-checked:bg-violet-50 dark:peer-checked:bg-violet-900/20 peer-checked:text-violet-600 dark:peer-checked:text-violet-400 transition-all">
                                    Sat
                                </div>
                            </label>
                        </div>
                        <div class="flex items-center">
                            <button type="submit" class="btn btn-primary px-6">Save Settings</button>
                            
                            <div id="work-days-success-animation" class="success-animation-container">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                    <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                    <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                    <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                </svg>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="mt-8 bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Attendance Types</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Customize the options available in the dropdown menu (e.g. Office, Home, Sick).</p>
                    
                    <div id="manage-attendance-list" class="flex flex-wrap gap-2 mb-6">
                    </div>

                    <form id="add-attendance-type-form" class="flex flex-col gap-4">
                        <div class="flex gap-2 w-full items-center">
                            <input type="text" id="new-attendance-type" class="form-input flex-1 block border-gray-300 rounded-lg shadow-sm" placeholder="New Type Name" required>
                            <button type="submit" class="btn btn-primary px-4 py-2 whitespace-nowrap h-full">Add</button>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Select Color</label>
                            <div id="admin-color-palette" class="flex flex-wrap gap-2">
                            </div>
                            <input type="hidden" id="new-attendance-color" value="#10b981">
                        </div>
                    </form>
                </div>

                <div class="mt-8 bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Company Branding</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Customize the slogan displayed below the logo. Leave empty to hide it.</p>
                    
                    <form id="slogan-form" class="max-w-md">
                        <div class="mb-4">
                            <label for="company-slogan-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Slogan Text</label>
                            <input type="text" id="company-slogan-input" class="form-input block w-full border-gray-300 rounded-lg shadow-sm" placeholder="e.g. Innovating the Future">
                        </div>
                        
                        <div class="flex items-center mt-6">
                            <button type="submit" class="btn btn-primary px-6">Save Branding</button>
                            
                            <div id="slogan-success-animation" class="success-animation-container">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                    <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                    <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                    <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                </svg>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <!-- Mobile Drawer -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[2000] hidden transition-opacity duration-300 opacity-0" onclick="toggleMobileMenu()"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-[80%] max-w-xs bg-white dark:bg-gray-800 shadow-2xl z-[2001] transform transition-transform duration-300 translate-x-full flex flex-col h-full border-l border-gray-100 dark:border-gray-700">
    
    <div class="flex items-center justify-between p-6 border-b border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800">
        <div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white tracking-tight">Menu</h3>
        </div>
        <button onclick="toggleMobileMenu()" class="p-2 -mr-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto overscroll-contain py-6 px-4 space-y-1">
        
        <a href="#" onclick="openMobileTab(event, 'tab-profile')" class="flex items-center px-4 py-3.5 text-base font-medium text-gray-600 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 hover:text-purple-600 dark:hover:text-white transition-all group">
            <svg class="w-6 h-6 mr-4 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            My Profile
        </a>

        <a href="#" id="mobile-stats-link" onclick="openMobileTab(event, 'tab-statistics')" class="flex items-center px-4 py-3.5 text-base font-medium text-gray-600 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 hover:text-blue-600 dark:hover:text-white transition-all group">
            <svg class="w-6 h-6 mr-4 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Statistics
        </a>

        <a href="#" id="mobile-calendar-link" onclick="openMobileTab(event, 'tab-calendar')" class="hidden flex items-center px-4 py-3.5 text-base font-medium text-gray-600 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 hover:text-purple-600 dark:hover:text-white transition-all group">
            <svg class="w-6 h-6 mr-4 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Team Calendar
        </a>

        <a href="#" id="mobile-tl-link" onclick="openMobileTab(event, 'tab-tl-tools')" class="hidden flex items-center px-4 py-3.5 text-base font-medium text-gray-600 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 hover:text-orange-600 dark:hover:text-white transition-all group">
            <svg class="w-6 h-6 mr-4 text-gray-400 group-hover:text-orange-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Team Desk
        </a>

        <a href="#" id="mobile-sa-link" onclick="openMobileTab(event, 'tab-super-admin')" class="hidden flex items-center px-4 py-3.5 text-base font-medium text-gray-600 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 hover:text-red-600 dark:hover:text-white transition-all group">
            <svg class="w-6 h-6 mr-4 text-gray-400 group-hover:text-red-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Settings
        </a>

    </div>

    <div class="p-6 border-t border-gray-100 dark:border-gray-700">
        <button id="mobile-logout-link" onclick="handleMobileLogout(event)" class="w-full flex items-center justify-center p-3.5 rounded-xl bg-gray-50 dark:bg-gray-700/30 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 font-bold transition-all group">
            <svg class="w-5 h-5 mr-3 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            Sign Out
        </button>
    </div>
</div>

    <!-- Modals -->
    <div id="planner-more-modal" class="modal-overlay hidden z-[2005] fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            
            <div class="bg-gray-50 dark:bg-gray-700/50 p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                <h3 id="planner-more-title" class="text-lg font-bold text-gray-800 dark:text-white">
                </h3>
                <button onclick="document.getElementById('planner-more-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div id="planner-more-list" class="p-4 max-h-[60vh] overflow-y-auto space-y-2 custom-scrollbar">
            </div>

            <div class="p-3 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-center">
                <button onclick="document.getElementById('planner-more-modal').classList.add('hidden')" class="text-sm font-bold text-purple-600 hover:text-purple-700 dark:text-purple-400">Close</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden z-[1001]">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4" id="modal-title">Confirm Action</h3>
            <p id="modal-body" class="mb-6 text-gray-700">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="modal-confirm" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="action-note-modal" class="modal-overlay hidden z-[2001]">
        <div class="modal-content max-w-md">
            <h3 class="text-lg font-bold mb-2" id="action-note-title">Add Note</h3>
            <p class="text-sm text-gray-500 mb-4">Optional: Add a note for the employee.</p>
            
            <textarea id="action-note-input" class="form-input w-full h-24 resize-none rounded-lg mb-4" placeholder="e.g. Approved, enjoy your vacation!"></textarea>
            
            <div class="flex justify-end gap-3">
                <button id="action-note-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg text-sm font-bold">Cancel</button>
                <button id="action-note-confirm" class="btn btn-primary text-sm shadow-lg">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="edit-employee-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4" id="edit-modal-title">Edit Attendance</h3>
            <div id="edit-modal-body" class="space-y-4">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="edit-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="edit-modal-save" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="modal-overlay hidden z-[9000] flex items-center justify-center p-4 backdrop-blur-sm bg-black/40 transition-opacity duration-300">
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform scale-100 transition-all border border-gray-100 dark:border-gray-700">
            <div class="p-6 text-center">
                <div id="notif-icon-container" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-6 transition-colors">
                </div>
                
                <h3 id="notif-title" class="text-xl font-bold text-gray-900 dark:text-white mb-2"></h3>
                <p id="notif-message" class="text-gray-500 dark:text-gray-300 text-sm mb-6 leading-relaxed"></p>
                
                <button id="notif-close-btn" class="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold rounded-xl shadow-lg hover:shadow-purple-500/30 hover:transform hover:scale-[1.02] transition-all">
                    Got it
                </button>
            </div>
        </div>
    </div>

    <div id="upgrade-modal" class="modal-overlay hidden z-[9000] flex items-center justify-center p-4 backdrop-blur-sm bg-black/50 transition-opacity duration-300">
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 p-0 overflow-hidden">
            
            <div class="bg-gradient-to-r from-purple-600 via-fuchsia-500 to-pink-500 p-6 text-center">
                <h3 class="text-2xl font-bold text-white mb-1">Upgrade Plan</h3>
                <p class="text-purple-100 text-sm">Scale your team with more seats</p>
            </div>

            <div class="p-8">
                <label class="block text-center text-xs font-bold text-gray-400 dark:text-gray-500 mb-6 uppercase tracking-widest">
                    Desired Total Users
                </label>

                <div class="flex items-center justify-center gap-4 mb-8">
                    <button id="upgrade-minus" class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 hover:bg-purple-100 hover:text-purple-600 dark:hover:bg-purple-900/30 transition-all active:scale-95 shadow-sm flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20 12H4"></path></svg>
                    </button>
                    
                    <div class="relative w-32">
                        <input 
                            type="number" 
                            id="upgrade-amount-input" 
                            value="15" 
                            min="1" 
                            inputmode="numeric" 
                            pattern="[0-9]*"
                            class="w-full text-center text-5xl font-black bg-transparent border-b-2 border-gray-200 dark:border-gray-600 focus:border-purple-500 text-gray-900 dark:text-white focus:outline-none pb-2 transition-colors placeholder-gray-300"
                        >
                    </div>

                    <button id="upgrade-plus" class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 hover:bg-purple-100 hover:text-purple-600 dark:hover:bg-purple-900/30 transition-all active:scale-95 shadow-sm flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>

                <div class="flex gap-3">
                    <button id="upgrade-cancel" class="flex-1 py-3.5 px-4 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    
                    <button id="upgrade-confirm" class="flex-[2] py-3.5 px-4 bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold rounded-xl shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 transition-transform hover:-translate-y-0.5 active:scale-95">
                        <span>Send Request</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="reauth-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Confirm Your Identity</h3>
            <p class="mb-4 text-gray-700">To change your email address, please enter your current password.</p>
            <form id="reauth-form">
                <label for="reauth-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                <input type="password" id="reauth-password" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                 <p id="reauth-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="reauth-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="manage-groups-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Manage Groups</h3>
            <p id="manage-groups-error" class="bg-red-100 text-red-700 p-3 rounded-md text-sm mb-4 hidden"></p>
            <div id="manage-groups-list" class="my-4 max-h-60 overflow-y-auto space-y-2">
             </div>
             <form id="add-group-form" class="mt-6 border-t pt-4">
                <label for="new-group-name" class="block text-sm font-medium text-gray-700">Add New Group</label>
                <div class="flex items-center space-x-2 mt-1">
                    <input type="text" id="new-group-name" class="form-input block w-full border-gray-300 rounded-lg shadow-sm" required>
                    <button type="submit" class="btn btn-primary px-4 py-2">Add</button>
                </div>
                <p id="add-group-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
            </form>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="manage-groups-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Super Admin Edit User Modal -->
    <div id="super-admin-edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4" id="sa-modal-title">Edit User</h3>
            <form id="super-admin-edit-form">
                <div class="space-y-4">
                    <div>
                        <label for="sa-edit-fullname" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="sa-edit-fullname" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                    </div>
                     <div>
                        <div class="flex justify-between items-center">
                            <label for="sa-edit-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <button type="button" id="sa-email-info-btn">
                                <svg class="w-5 h-5 text-gray-400 hover:text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                                </svg>
                            </button>
                        </div>
                        <input type="email" id="sa-edit-email" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed dark:bg-gray-600" readonly>
                    </div>
                     <div>
                        <label for="sa-edit-group" class="block text-sm font-medium text-gray-700">Group</label>
                        <select id="sa-edit-group" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Role</label>
                        <div class="mt-2 space-y-2">
                             <div class="flex items-center">
                                <input id="sa-role-employee" name="sa-role" type="radio" value="employee" class="h-4 w-4 text-violet-600 border-gray-300 focus:ring-violet-500">
                                <label for="sa-role-employee" class="ml-3 block text-sm font-medium text-gray-700">Employee</label>
                            </div>
                            <div class="flex items-center">
                                <input id="sa-role-tl" name="sa-role" type="radio" value="tl" class="h-4 w-4 text-violet-600 border-gray-300 focus:ring-violet-500">
                                <label for="sa-role-tl" class="ml-3 block text-sm font-medium text-gray-700">Team Leader</label>
                            </div>
                             <div class="flex items-center">
                                <input id="sa-role-superadmin" name="sa-role" type="radio" value="superadmin" class="h-4 w-4 text-violet-600 border-gray-300 focus:ring-violet-500">
                                <label for="sa-role-superadmin" class="ml-3 block text-sm font-medium text-gray-700">Super Admin</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="super-admin-edit-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Reset Password</h3>
            <p class="mb-4 text-gray-700">Enter your email address and we'll send you a link to reset your password.</p>
            <form id="forgot-password-form">
                <label for="forgot-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="forgot-email" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                 <p id="forgot-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                 <p id="forgot-success" class="text-green-600 text-sm mt-4 hidden"></p>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="forgot-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Modal -->
    <div id="request-modal" class="modal-overlay hidden z-[2000] backdrop-blur-sm transition-opacity duration-300 opacity-0 items-center justify-center overscroll-none fixed inset-0 bg-black/60">
        
        <div class="modal-content w-[95%] max-w-lg md:max-w-4xl h-[92dvh] md:h-auto md:max-h-[85vh] flex flex-col md:flex-row bg-white dark:bg-gray-900 shadow-2xl transition-all duration-300 transform scale-90 opacity-0 rounded-3xl overflow-hidden p-0">
            
            <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50/50 dark:bg-gray-800/30">
                
                <div class="shrink-0 px-6 pt-6 pb-2 md:hidden">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Schedule Absence</h3>
                    <p class="text-gray-500 text-sm">Select dates and type.</p>
                </div>

                <div class="flex-1 flex flex-col justify-center items-center px-4 overflow-y-auto">
                    <div class="w-full max-w-sm py-4">
                        <div class="flex justify-between items-center mb-6">
                            <button id="cal-prev" class="p-3 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-colors shadow-sm bg-white/50 dark:bg-gray-700/50">
                                <svg class="w-5 h-5 text-gray-700 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <span id="cal-month-year" class="text-xl font-bold text-gray-800 dark:text-gray-100"></span>
                            <button id="cal-next" class="p-3 hover:bg-white dark:hover:bg-gray-700 rounded-full transition-colors shadow-sm bg-white/50 dark:bg-gray-700/50">
                                <svg class="w-5 h-5 text-gray-700 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>

                        <div class="grid grid-cols-7 gap-1 text-center mb-3">
                            <div class="text-xs font-bold text-gray-400 uppercase">Su</div>
                            <div class="text-xs font-bold text-gray-400 uppercase">Mo</div>
                            <div class="text-xs font-bold text-gray-400 uppercase">Tu</div>
                            <div class="text-xs font-bold text-gray-400 uppercase">We</div>
                            <div class="text-xs font-bold text-gray-400 uppercase">Th</div>
                            <div class="text-xs font-bold text-gray-400 uppercase">Fr</div>
                            <div class="text-xs font-bold text-gray-400 uppercase">Sa</div>
                        </div>

                        <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-lg font-medium">
                        </div>
                    </div>
                </div>
            </div>

            <div class="shrink-0 md:w-96 bg-white dark:bg-gray-900 p-5 md:p-8 border-t md:border-t-0 md:border-l border-gray-100 dark:border-gray-800 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-20 flex flex-col justify-center">
                
                <div class="hidden md:block mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Schedule Absence</h3>
                    <p class="text-gray-500 text-sm">Select dates and type.</p>
                </div>

                <div class="mb-4">
                    <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 rounded-xl p-3 border border-gray-200 dark:border-gray-700">
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Start</span>
                            <span id="display-start-date" class="font-bold text-gray-900 dark:text-white text-base">Select</span>
                        </div>
                        <div class="text-gray-300 dark:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </div>
                        <div class="flex flex-col text-right">
                            <span class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">End</span>
                            <span id="display-end-date" class="font-bold text-gray-900 dark:text-white text-base">Select</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Absence Type</label>
                    <select id="request-type-select" class="form-input w-full h-12 text-base px-4 rounded-xl border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-purple-500 transition-all cursor-pointer">
                    </select>
                </div>

                <div class="flex items-center justify-between mb-4 px-1">
                    <span class="text-sm font-medium text-gray-500">Total Duration:</span>
                    <div class="flex items-baseline gap-1">
                        <span id="total-days-count" class="text-2xl font-black text-purple-600 dark:text-purple-400 leading-none">0</span>
                        <span class="text-xs font-bold text-gray-400 uppercase">Days</span>
                    </div>
                </div>

                <div class="flex items-center gap-3 mt-auto md:mt-0">
                    <button id="close-request-modal" class="h-12 md:h-12 px-6 rounded-xl bg-gray-100 text-gray-600 font-bold text-sm hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>

                    <button id="submit-request-btn" class="flex-1 h-12 md:h-12 btn btn-primary text-base font-bold rounded-xl shadow-lg shadow-purple-500/30 disabled:opacity-50 disabled:shadow-none transition-all active:scale-95" disabled>
                        Send Request
                    </button>
                </div>
            </div>

        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        /*
        =============================================================================
        ACTION REQUIRED: FIREBASE SECURITY RULES UPDATE
        =============================================================================

        To allow users who are not logged in to see the list of available groups
        during registration, the `config` collection needs to be readable by everyone.

        HOW TO FIX:
        1. Go to your Firebase project.
        2. In the left menu, go to Build -> Firestore Database.
        3. Click the "Rules" tab at the top.
        4. Add/Update the following rule blocks inside the main `match /databases/{database}/documents { ... }` block:

        // Update your existing config rule to look like this
        match /config/{docId} {
            allow read: if true; // Allows group list on registration page
            allow write: if isSuperAdmin() || isTL();
        }

        5. Click "Publish". This allows anyone to see the group list.
        */
        
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, updatePassword, EmailAuthProvider, reauthenticateWithCredential, updateEmail, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, Timestamp, deleteDoc, writeBatch, updateDoc, orderBy, onSnapshot, limit, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDzYoBxIWBh2TVN9HrdP8mq4zVPOkyZU2o",
            authDomain: "attendance-samsung.firebaseapp.com",
            projectId: "attendance-samsung",
            storageBucket: "attendance-samsung.firebasestorage.app",
            messagingSenderId: "358353821443",
            appId: "1:358353821443:web:32a65c3b8199542c1b5336",
            measurementId: "G-KLRM1EDLE5"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize Status Bar on app load
        (async function initializeStatusBar() {
            // [שינוי] התחלה עם צבע הלוגין
            updateStatusBar(false, true);
        })();

        // Explicitly set persistence to 'local' to remember the user across browser sessions.
        setPersistence(auth, browserLocalPersistence);

        // --- Smooth Multi-step Form Logic ---

        window.nextStep = async function(targetStep) {
            const currentStepNum = targetStep - 1;
            let inputToValidate;
            
            if (currentStepNum === 1) inputToValidate = document.getElementById('new-company-name');
            if (currentStepNum === 2) inputToValidate = document.getElementById('new-company-admin-name');
            if (currentStepNum === 3) inputToValidate = document.getElementById('new-company-email');

            // 1. בדיקות בסיסיות
            if (inputToValidate) {
                if (!inputToValidate.value.trim()) {
                    showInputError(inputToValidate, "This field is required.");
                    return;
                }
                // For email step, check format
                if (currentStepNum === 3) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(inputToValidate.value.trim())) {
                        showInputError(inputToValidate, "Please enter a valid email address.");
                        return;
                    }
                }
            }

            // 2. בדיקת כפילות מול הרשימה הציבורית החדשה
            if (currentStepNum === 1) {
                const companyName = inputToValidate.value.trim();
                // נרמול השם לאותיות קטנות כדי ש-"Samsung" ו-"samsung" ייחשבו אותו דבר
                const normalizedName = companyName.toLowerCase(); 

                const btn = document.querySelector(`#comp-step-1 button`);
                const originalText = btn.innerHTML;
                btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                btn.disabled = true;

                try {
                    // בדיקה ישירה לפי ה-ID (הרבה יותר יעיל ומהיר משאילתה)
                    const docRef = doc(db, "public_company_names", normalizedName);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        showInputError(inputToValidate, "This company name is already taken.");
                        return;
                    }
                } catch (error) {
                    console.error("Error checking name:", error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    // אם זו שגיאת הרשאות - נתריע
                    if (error.code === 'permission-denied') {
                         showInputError(inputToValidate, "Security setup incomplete. Check 'public_company_names' rules.");
                    } else {
                         showInputError(inputToValidate, "Connection error. Please try again.");
                    }
                    return;
                }

                btn.innerHTML = originalText;
                btn.disabled = false;
            }

            animateStepChange(currentStepNum, targetStep, 'next');
        };

        // פונקציית עזר להצגת שגיאות יפה
        // --- פונקציה חדשה להצגת שגיאות מעוצבות (Inline) ---
        function showInputError(input, message) {
            // 1. הסרת הודעות קודמות (אם יש)
            clearInputError(input);

            // 2. יצירת אלמנט שגיאה חדש
            const errorMsgId = input.id + '-error-msg';
            let errorText = document.getElementById(errorMsgId);
            
            if (!errorText) {
                errorText = document.createElement('p');
                errorText.id = errorMsgId;
                errorText.className = "text-red-400 text-xs mt-1 ml-1 font-medium transition-all duration-300";
                // הוספת האלמנט לדף מיד אחרי האינפוט
                input.parentNode.insertBefore(errorText, input.nextSibling);
            }

            // 3. הגדרת הטקסט והצגה
            errorText.textContent = message;
            
            // 4. עיצוב האינפוט עצמו (בורדר אדום ורעידה)
            input.classList.add('border-red-500', 'ring-1', 'ring-red-500', 'animate-pulse');
            setTimeout(() => input.classList.remove('animate-pulse'), 500);

            // 5. מאזין להסרת השגיאה ברגע שמתחילים להקליד
            input.addEventListener('input', function() {
                clearInputError(input);
            }, { once: true });
            
            input.focus();
        }

        // פונקציית עזר לניקוי השגיאה
        function clearInputError(input) {
            input.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
            const errorMsgId = input.id + '-error-msg';
            const existingError = document.getElementById(errorMsgId);
            if (existingError) {
                existingError.remove();
            }
        }

        window.prevStep = function(targetStep) {
            const currentStepNum = targetStep + 1;
            animateStepChange(currentStepNum, targetStep, 'prev');
        };

        function animateStepChange(currentStep, targetStep, direction) {
            const currentEl = document.getElementById(`comp-step-${currentStep}`);
            const targetEl = document.getElementById(`comp-step-${targetStep}`);
            
            // 1. אנימציית יציאה
            if (direction === 'next') {
                // עולים למעלה ונעלמים
                currentEl.classList.add('opacity-0', '-translate-y-8');
            } else {
                // יורדים למטה ונעלמים (כשלוחצים Back)
                currentEl.classList.add('opacity-0', 'translate-y-8');
            }

            // זמן המתנה קצר שיתאים ל-duration-700 ב-CSS
            setTimeout(() => {
                currentEl.classList.add('hidden');
                // איפוס מיקומים לאלמנט שיצא
                currentEl.classList.remove('opacity-0', '-translate-y-8', 'translate-y-8');
                
                // הכנת האלמנט החדש
                targetEl.classList.remove('hidden');
                targetEl.classList.add('opacity-0');
                
                if (direction === 'next') {
                    // האלמנט הבא מגיע מלמטה
                    targetEl.classList.add('translate-y-8'); 
                } else {
                    // האלמנט הקודם נוחת מלמעלה
                    targetEl.classList.add('-translate-y-8');
                }

                requestAnimationFrame(() => {
                    // הפעלת הטרנזישן
                    targetEl.classList.remove('opacity-0', 'translate-y-8', '-translate-y-8');
                    targetEl.classList.add('translate-y-0');
                    
                    const nextInput = targetEl.querySelector('input');
                    if(nextInput) nextInput.focus();
                });
                
            }, 400); // תזמון אופטימלי לחלקות

            updateDots(targetStep);
        }

        // פונקציית הנקודות נשארה זהה, רק עם אפקט עדין יותר ב-CSS
        function updateDots(step) {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (i <= step) {
                    dot.classList.remove('bg-gray-600', 'scale-75', 'opacity-50');
                    dot.classList.add('bg-white', 'scale-100', 'opacity-100');
                } else {
                    dot.classList.remove('bg-white', 'scale-100', 'opacity-100');
                    dot.classList.add('bg-gray-600', 'scale-75', 'opacity-50');
                }
            }
        }

        // תמיכה בלחיצה על Enter כדי לעבור שלב
        document.addEventListener('keydown', function(event) {
            if (event.key === "Enter") {
                // בודק אם אנחנו בתוך הטופס של החברה
                const companyForm = document.getElementById('company-register-form');
                if (!companyForm.classList.contains('hidden')) {
                    // מציאת השלב הפעיל כרגע
                    const activeStep = document.querySelector('.step-content:not(.hidden)');
                    if (activeStep && activeStep.id !== 'comp-step-4') {
                        event.preventDefault(); // מניעת שליחת טופס מוקדמת
                        const currentStepNum = parseInt(activeStep.id.split('-')[2]);
                        window.nextStep(currentStepNum + 1);
                    }
                }
            }
        });

        // --- Global State ---
        let currentUser = null;
        let currentUserProfile = null;
        let currentDate = new Date(); // This will be updated by getEffectiveCurrentDate
        let tlToolDate = new Date();
        let availableGroups = ["Management", "CIS1", "CIS2", "Application", "DT", "DV", "FW"];
        let globalWorkDays = [0, 1, 2, 3, 4]; // ברירת מחדל: ראשון עד חמישי
        // [CHANGE] החלפת הקבוע ברשימה דינמית עם ברירת מחדל קצרה
        let globalAttendanceOptions = ["Office", "Home", "Vacation", "Sick"];
        
        // משתנים לניהול התראות בזמן אמת (המוח המרכזי)
        let userProfileUnsubscribe = null;
        let myRequestsUnsubscribe = null;
        let incomingRequestsUnsubscribe = null; // משתנה חדש למניעת כפילויות
        let managerRequestsCache = []; // מאגר בקשות מנהלים לסינון בקליינט
        let currentRequestsLimit = 2; // מתחילים רק עם 2 בקשות אחרונות
        let currentTeamLimit = 5; // מתחילים עם 5 בקשות אחרונות למנהל

        // משתני עזר להחלטה על הנקודה
        let maxMyRequestTime = 0;          // הזמן של העדכון האחרון בבקשות שלי
        let hasPendingIncomingRequests = false; // האם יש בקשות צוות ממתינות (למנהלים)
        let hasPendingRegistrations = false;    // [חדש] בקשות משתמשים חדשים

        // --- המוח המרכזי: בדיקת הנקודה ---
        function checkNotificationDot() {
            const dot = document.getElementById('requests-notification-dot');
            if (!dot) return;

            // אם אנחנו בתוך הטאב כרגע - תמיד נכבה את הנקודה
            const isRequestsTabActive = tabs.requests.classList.contains('active');
            if (isRequestsTabActive) {
                dot.classList.add('hidden');
                return;
            }

            // 1. לוגיקה לעובד (My Requests) - מסונכרן בין מכשירים
            let showForMyRequests = false;

            // === [הלוגיקה החדשה והפשוטה] ===
            // בדיקה האם יש דגל דולק בפרופיל המשתמש
            if (currentUserProfile && currentUserProfile.hasUnreadRequestUpdates === true) {
                showForMyRequests = true;
            }
            // ===============================

            // 2. לוגיקה למנהל (TL Logic) - ביקשת שלא ישתנה
            // אם יש בקשות ממתינות, הנקודה נשארת דולקת
            
            // החלטה סופית: או שיש עדכון בחופש שלי, או שיש עבודה למנהל, או משתמשים חדשים
            if (showForMyRequests || hasPendingIncomingRequests || hasPendingRegistrations) {
                dot.classList.remove('hidden');
                // אפקט פעימה אם יש דברים דחופים
                if (hasPendingIncomingRequests || hasPendingRegistrations) {
                    dot.classList.add('animate-pulse');
                } else {
                    dot.classList.remove('animate-pulse');
                }
            } else {
                dot.classList.add('hidden');
            }
        }

        // --- פונקציה לאיחוד ספירת ההתראות (חופשות + משתמשים) ---
        function updateTeamInboxBadge() {
            const badge = document.getElementById('team-inbox-badge');
            if (!badge) return;

            // 1. ספירת בקשות חופשה ממתינות (מתוך המטמון הקיים)
            // אנחנו מסננים רק את ה-pending ורק את הקבוצה הרלוונטית (הפילטור כבר קרה בטעינה)
            const pendingLeavesCount = managerRequestsCache.filter(req => req.status === 'pending').length;

            // 2. ספירת משתמשים חדשים ממתינים
            const pendingUsersCount = pendingUsersSnapshot ? pendingUsersSnapshot.size : 0;

            // 3. סכום כולל
            const total = pendingLeavesCount + pendingUsersCount;

            // 4. עדכון התצוגה
            if (total > 0) {
                badge.textContent = total;
                badge.classList.remove('hidden');
                
                // עדכון משתני המצב הגלובליים לנקודה הראשית
                hasPendingIncomingRequests = (pendingLeavesCount > 0);
                hasPendingRegistrations = (pendingUsersCount > 0);
            } else {
                badge.classList.add('hidden');
                hasPendingIncomingRequests = false;
                hasPendingRegistrations = false;
            }

            // 5. עדכון הנקודה בטאב הראשי
            checkNotificationDot();
        }

        // בדיקה שהמשתמש לא מנסה לשנות לעצמו הרשאות ניהול (בדיקת ערכים בטוחה)
        function notUpdatingPrivileges() {
          // אנחנו בודקים שהערך *העתידי* (request.resource) זהה לערך *הקיים* (resource)
          // השימוש ב-get מבטיח שלא נקרוס אם השדה חסר
          return request.resource.data.get('isSuperAdmin', false) == resource.data.get('isSuperAdmin', false)
              && request.resource.data.get('isTL', false) == resource.data.get('isTL', false)
              && request.resource.data.get('companyId', '') == resource.data.get('companyId', '');
        }

        // --- Constant Color Palette (Tailwind CSS v3 Standard - 500 Shades) ---
        const FIXED_PALETTE = [
            "#64748b", // Slate 500
            "#ef4444", // Red 500
            "#f97316", // Orange 500
            "#f59e0b", // Amber 500
            "#eab308", // Yellow 500
            "#84cc16", // Lime 500
            "#22c55e", // Green 500
            "#10b981", // Emerald 500
            "#14b8a6", // Teal 500
            "#06b6d4", // Cyan 500
            "#0ea5e9", // Sky 500
            "#3b82f6", // Blue 500
            "#6366f1", // Indigo 500
            "#8b5cf6", // Violet 500
            "#a855f7", // Purple 500
            "#d946ef", // Fuchsia 500
            "#ec4899", // Pink 500
            "#f43f5e"  // Rose 500
        ];

        // מיפוי מקוד צבע (HEX) למחלקות Tailwind (בדיוק כמו ברפרנס)
        const TAILWIND_CLASS_MAP = {
            // ירוקים
            "#10b981": "bg-green-100 text-green-800",   // Emerald (Office)
            "#22c55e": "bg-green-100 text-green-800",   // Green
            "#84cc16": "bg-lime-100 text-lime-800",     // Lime
            "#14b8a6": "bg-teal-100 text-teal-800",     // Teal

            // כחולים
            "#3b82f6": "bg-blue-100 text-blue-800",     // Blue (Home)
            "#0ea5e9": "bg-cyan-100 text-cyan-800",     // Sky
            "#06b6d4": "bg-cyan-100 text-cyan-800",     // Cyan
            "#6366f1": "bg-indigo-100 text-indigo-800", // Indigo

            // אדומים/ורודים
            "#ef4444": "bg-red-100 text-red-800",       // Red (Sick)
            "#f43f5e": "bg-rose-100 text-rose-800",     // Rose (Vacation)
            "#ec4899": "bg-pink-100 text-pink-800",     // Pink
            "#d946ef": "bg-purple-100 text-purple-800", // Fuchsia

            // סגולים
            "#a855f7": "bg-purple-100 text-purple-800", // Purple (Happy Hour)
            "#8b5cf6": "bg-purple-100 text-purple-800", // Violet

            // צהובים/כתומים
            "#eab308": "bg-yellow-100 text-yellow-800", // Yellow (Half Day)
            "#f59e0b": "bg-yellow-100 text-yellow-800", // Amber
            "#f97316": "bg-orange-100 text-orange-800", // Orange

            // אפורים
            "#64748b": "bg-gray-100 text-gray-800",     // Slate
            "#6b7280": "bg-gray-100 text-gray-800"      // Gray
        };

        // פונקציית עזר לקבלת ה-Classes
        function getTailwindClasses(hexColor) {
            if (!hexColor) return "bg-gray-100 text-gray-800";
            const key = hexColor.toLowerCase();
            // אם הצבע קיים במילון - תחזיר את המחלקות. אחרת - תחזיר אפור.
            return TAILWIND_CLASS_MAP[key] || "bg-gray-100 text-gray-800";
        }

        // פונקציה ליצירת פלטת הצבעים המעוצבת (Luminous Squircles)
        function renderColorPalette(containerId, inputId, defaultColorIndex = 0) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            
            if (!container || !input) return;
            
            // החלת העיצוב על הקונטיינר (המגש)
            container.className = 'palette-grid';
            container.innerHTML = ''; // ניקוי
            
            FIXED_PALETTE.forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                
                // הוספת אייקון ה-"וי" פנימה
                swatch.innerHTML = `
                    <svg class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                `;
                
                // בחירת ברירת מחדל
                if (index === defaultColorIndex) {
                    selectSwatch(swatch, color, input, container);
                }
                
                swatch.addEventListener('click', () => {
                    selectSwatch(swatch, color, input, container);
                });
                
                container.appendChild(swatch);
            });
        }

        // פונקציית עזר לביצוע הבחירה והאפקטים
        function selectSwatch(element, color, inputElement, container) {
            // 1. הסרת בחירה מכולם
            container.querySelectorAll('.color-swatch').forEach(el => {
                el.classList.remove('selected');
                el.style.boxShadow = ''; // איפוס הצללה מותאמת אישית
            });
            
            // 2. סימון הנוכחי
            element.classList.add('selected');
            
            // 3. יצירת אפקט זוהר בצבע הנבחר (Dynamic Glow)
            // אנו משתמשים בצבע עצמו כדי ליצור הילה תואמת
            element.style.boxShadow = `0 0 0 2px ${document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff'}, 0 0 15px ${color}`;
            
            // 4. עדכון הערך בשדה הנסתר
            inputElement.value = color;
        }
        
        let allUsersCache = []; // Cache for user management panel
        let pendingUsersSnapshot = null; // Cache for pending users
        
        // Realtime listeners cleanup functions
        let teamViewUnsubscribe = null;
        let updateWeekUnsubscribe = null;
        let statisticsUnsubscribe = null;
        let pendingUsersUnsubscribe = null;


        // --- [חדש] לוגיקה עבור אפקט הטאבים ---
        const tabClickState = {};
        const nav = document.getElementById('main-nav');

        // אתחול אובייקט המצב עבור כל הטאבים
        nav.querySelectorAll('.tab-btn').forEach(tab => {
            tabClickState[tab.id] = {
                count: 0,
                lastClickTime: 0,
                heat: 0, // 'חום' הלחיצות, בין 0 ל-1
                cooldownTimer: null
            };
        });
        
        // פונקציה ליצירת חלקיקי ניצוצות
        function createSparkles(e, heat) {
            const tab = e.target;
            const rect = tab.getBoundingClientRect();
            const originX = rect.left + rect.width / 2;
            const originY = rect.top + rect.height / 2;
            
            const particleCount = 2 + Math.floor(heat * 15);

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('sparkle-particle');
                document.body.appendChild(particle);

                const angle = Math.random() * 2 * Math.PI;
                const distance = 50 + Math.random() * 80 * heat;
                const size = 3 + Math.random() * 5;
                const hue = 300 + (Math.random() * 120); // Pink to Red to Yellow

                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.background = `hsl(${hue}, 100%, 70%)`;
                particle.style.left = `${originX}px`;
                particle.style.top = `${originY}px`;
                
                // Trigger animation
                requestAnimationFrame(() => {
                    const finalX = Math.cos(angle) * distance;
                    const finalY = Math.sin(angle) * distance;
                    particle.style.transform = `translate(${finalX}px, ${finalY}px) scale(0)`;
                    particle.style.opacity = '0';
                });
                
                // Remove particle after animation
                setTimeout(() => {
                    particle.remove();
                }, 800);
            }
        }
        
        // פונקציה שמתחילה את תהליך ה"קירור" של הטאב
        function startCooldown(tab) {
            const state = tabClickState[tab.id];
            if (state.cooldownTimer) cancelAnimationFrame(state.cooldownTimer);
            
            const cool = () => {
                if (state.heat > 0) {
                    state.heat -= 0.01; // קצב הקירור
                    updateTabStyle(tab);
                    state.cooldownTimer = requestAnimationFrame(cool);
                } else {
                    state.heat = 0;
                    updateTabStyle(tab); // ודא שהצבע חזר למקורי
                    cancelAnimationFrame(state.cooldownTimer);
                }
            };
            state.cooldownTimer = requestAnimationFrame(cool);
        }

        // פונקציה שמעדכנת את סגנון הטאב (צבע ופעימה)
        function updateTabStyle(tab) {
            const state = tabClickState[tab.id];
            const heat = Math.max(0, Math.min(1, state.heat)); // הגבלת הערך בין 0 ל-1

            // עדכון צבע - אינטרפולציה בין סגול/ורוד לאדום
            const startColor = { r: 168, g: 85, b: 247 }; // #a855f7
            const endColor = { r: 236, g: 72, b: 153 }; // #ec4899
            const hotColor = { r: 239, g: 68, b: 68 }; // #ef4444 (red-500)

            const r1 = startColor.r * (1 - heat) + hotColor.r * heat;
            const g1 = startColor.g * (1 - heat) + hotColor.g * heat;
            const b1 = startColor.b * (1 - heat) + hotColor.b * heat;
            
            const r2 = endColor.r * (1 - heat) + hotColor.r * heat;
            const g2 = endColor.g * (1 - heat) + hotColor.g * heat;
            const b2 = endColor.b * (1 - heat) + hotColor.b * heat;

            tab.style.setProperty('--tab-active-start', `rgb(${r1}, ${g1}, ${b1})`);
            tab.style.setProperty('--tab-active-end', `rgb(${r2}, ${g2}, ${b2})`);
            
            // עדכון פעימה
            const pulseScale = 1 + Math.min(state.count * 0.01, 0.08) + heat * 0.05;
            tab.style.transform = `scale(${pulseScale})`;
            setTimeout(() => {
                if(tab.style) tab.style.transform = 'scale(1)';
            }, 100);
        }
        
        // מאזין אירועים ראשי לניווט
        nav.addEventListener('click', (e) => {
            const tab = e.target.closest('.tab-btn');
            if (!tab) return;
            
            const state = tabClickState[tab.id];
            if (!state) return;

            const now = Date.now();
            const timeDiff = now - state.lastClickTime;
            
            if (timeDiff > 800) { // אם עבר הרבה זמן, אפס את הספירה והחום
                state.count = 0;
                state.heat = 0;
            }

            state.count++;
            state.lastClickTime = now;
            
            // הגברת ה'חום' בהתבסס על מהירות הלחיצה
            const heatIncrease = (500 - Math.min(timeDiff, 500)) / 500 * 0.2;
            state.heat = Math.min(1, state.heat + heatIncrease);

            if (state.cooldownTimer) cancelAnimationFrame(state.cooldownTimer);
            
            // הפעל את האפקטים
            updateTabStyle(tab);
            
            if (state.count > 10) {
                createSparkles(e, state.heat);
            }
            
            // התחל טיימר לקירור אם המשתמש יפסיק ללחוץ
            setTimeout(() => startCooldown(tab), 1000);
        });
        // --- סוף הלוגיקה החדשה ---


        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Forms
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const profileForm = document.getElementById('profile-form');
        const attendanceForm = document.getElementById('attendance-form');
        const tlForm = document.getElementById('tl-form');
        const createUserForm = document.getElementById('create-user-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const addGroupForm = document.getElementById('add-group-form');
        const removeUserForm = document.getElementById('remove-user-form');
        const superAdminEditForm = document.getElementById('super-admin-edit-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const sloganForm = document.getElementById('slogan-form');

        // Buttons & Links
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        // const showAboutLink = document.getElementById('show-about');
        const showForgotPasswordLink = document.getElementById('show-forgot-password');
        // const aboutContent = document.getElementById('about-content');
        const logoutButton = document.getElementById('logout-button');
        const bulkUpdateButton = document.getElementById('bulk-update-btn');
        const manageGroupsBtn = document.getElementById('manage-groups-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // Containers
        const userManagementContainer = document.getElementById('user-management-container');


        // Filters
        const groupFilter = document.getElementById('group-filter');
        const statsGroupFilter = document.getElementById('stats-group-filter');
        const statsEmployeeFilter = document.getElementById('stats-employee-filter');

        // Month navigation for PDF export
        const now = new Date();
        let currentExportMonthIndex = 0;
        const availableMonths = [];
        
        // Generate 12 months
        for (let i = 0; i < 12; i++) {
            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            availableMonths.push({
                value: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                text: date.toLocaleString('en-US', { month: 'long', year: 'numeric' })
            });
        }
        
        // Update the display
        function updateExportMonthDisplay() {
            const monthText = document.getElementById('export-month-text');
            const monthContainer = monthText.parentElement;
            monthText.textContent = availableMonths[currentExportMonthIndex].text;
            
            // Check if we're on current month (index 0 is current month)
            const isCurrentMonth = currentExportMonthIndex === 0;
            
            if (isCurrentMonth) {
                // Remove gradient and pulse effects
                monthContainer.classList.remove('return-to-today-btn', 'animated-gradient-text');
                monthContainer.style.cursor = 'default';
            } else {
                // Add gradient and pulse effects
                monthContainer.classList.add('return-to-today-btn', 'animated-gradient-text');
                monthContainer.style.cursor = 'pointer';
            }
            
            // Disable/enable buttons at boundaries
            document.getElementById('prev-month-btn').disabled = (currentExportMonthIndex === availableMonths.length - 1);
            document.getElementById('next-month-btn').disabled = (currentExportMonthIndex === 0);
        }
        
        updateExportMonthDisplay();
        
        // Add click handler to return to current month
        document.getElementById('export-month-text').parentElement.addEventListener('click', (e) => {
            // Only respond if we're not on current month
            if (currentExportMonthIndex !== 0) {
                currentExportMonthIndex = 0;
                updateExportMonthDisplay();
            }
        });
        
        // Previous month button
        document.getElementById('prev-month-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentExportMonthIndex < availableMonths.length - 1) {
                currentExportMonthIndex++;
                updateExportMonthDisplay();
            }
        });
        
        // Next month button
        document.getElementById('next-month-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentExportMonthIndex > 0) {
                currentExportMonthIndex--;
                updateExportMonthDisplay();
            }
        });
        
        // Export button
        document.getElementById('export-stats-pdf-btn').addEventListener('click', async (e) => {
            e.stopPropagation();
            const selectedMonth = availableMonths[currentExportMonthIndex];
            await exportPDFForMonth(selectedMonth.value, selectedMonth.text);
        });
        const removeUserGroupFilter = document.getElementById('remove-user-group-filter');
        const removeUserSelect = document.getElementById('remove-user-select');
        const userSearchInput = document.getElementById('user-search-input');
        const userGroupFilter = document.getElementById('user-group-filter');

        // Week Nav Buttons
        const teamViewPrevWeekBtn = document.getElementById('team-view-prev-week');
        const teamViewNextWeekBtn = document.getElementById('team-view-next-week');
        const updateViewPrevWeekBtn = document.getElementById('update-view-prev-week');
        const updateViewNextWeekBtn = document.getElementById('update-view-next-week');
        const statsViewPrevWeekBtn = document.getElementById('stats-view-prev-week');
        const statsViewNextWeekBtn = document.getElementById('stats-view-next-week');
        const tlViewPrevWeekBtn = document.getElementById('tl-view-prev-week');
        const tlViewNextWeekBtn = document.getElementById('tl-view-next-week');


        // Modals
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        
        const editEmployeeModal = document.getElementById('edit-employee-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editModalBody = document.getElementById('edit-modal-body');
        const editModalCancel = document.getElementById('edit-modal-cancel');
        const editModalSave = document.getElementById('edit-modal-save');

        const reauthModal = document.getElementById('reauth-modal');
        const reauthForm = document.getElementById('reauth-form');
        const reauthCancel = document.getElementById('reauth-cancel');
        const reauthError = document.getElementById('reauth-error');

        const manageGroupsModal = document.getElementById('manage-groups-modal');
        const manageGroupsClose = document.getElementById('manage-groups-close');
        const addGroupError = document.getElementById('add-group-error');
        const manageGroupsError = document.getElementById('manage-groups-error');
        const manageGroupsList = document.getElementById('manage-groups-list');
        
        const superAdminEditModal = document.getElementById('super-admin-edit-modal');
        const superAdminEditCancel = document.getElementById('super-admin-edit-cancel');

        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const forgotCancelBtn = document.getElementById('forgot-cancel');
        const forgotError = document.getElementById('forgot-error');
        const forgotSuccess = document.getElementById('forgot-success');


        // Error/Success Messages
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const registerSuccess = document.getElementById('register-success');
        const createUserError = document.getElementById('create-user-error');
        const passwordChangeError = document.getElementById('password-change-error');
        const usernameError = document.getElementById('username-error');
        const profileSuccessAnimation = document.getElementById('profile-success-animation');
        const weekSuccessAnimation = document.getElementById('week-success-animation');
        const passwordChangeSuccessAnimation = document.getElementById('password-change-success-animation');
        const createUserSuccessAnimation = document.getElementById('create-user-success-animation');
        const sloganSuccessAnimation = document.getElementById('slogan-success-animation');

        // Track whether Statistics tab has been visited
        let statisticsTabVisited = false;

        // Tabs
        const tabs = {
            profile: document.getElementById('tab-profile'),
            update: document.getElementById('tab-update'),
            display: document.getElementById('tab-display'),
            statistics: document.getElementById('tab-statistics'),
            calendar: document.getElementById('tab-calendar'),
            requests: document.getElementById('tab-requests'),
            tlTools: document.getElementById('tab-tl-tools'),
            superAdmin: document.getElementById('tab-super-admin'),
        };
        const contents = {
            profile: document.getElementById('content-profile'),
            update: document.getElementById('content-update'),
            display: document.getElementById('content-display'),
            statistics: document.getElementById('content-statistics'),
            calendar: document.getElementById('content-calendar'),
            requests: document.getElementById('content-requests'),
            tlTools: document.getElementById('content-tl-tools'),
            superAdmin: document.getElementById('content-super-admin'),
        };
        
        // --- Mobile Menu Logic (Updated & Fixed) ---
        // הערה: המשתנים mobileMenuBtn, mobileDrawer וכו' כבר מוגדרים בראש הקובץ, לא צריך להגדיר שוב!
        
        const mobileLogoutLink = document.getElementById('mobile-logout-link');

        // --- פונקציית עזר למניעת גלילה במובייל ---
        const preventScroll = (e) => {
            e.preventDefault();
            e.stopPropagation();
            return false;
        };

        // --- פונקציה גלובלית לפתיחה/סגירה עם נעילה הרמטית ---
        window.toggleMobileMenu = function() {
            const mobileDrawer = document.getElementById('mobile-drawer');
            const mobileDrawerOverlay = document.getElementById('mobile-drawer-overlay');
            
            if (!mobileDrawer || !mobileDrawerOverlay) return;

            const isClosed = mobileDrawer.classList.contains('translate-x-full');
            
            if (isClosed) {
                // --- פתיחה (Open) ---
                
                // 1. נעילה כפולה: גם body וגם html (קריטי לאייפון)
                document.body.style.overflow = 'hidden';
                document.documentElement.style.overflow = 'hidden';
                
                // אופציונלי: קיבוע גובה למניעת קפיצות
                document.body.style.height = '100%';
                document.documentElement.style.height = '100%';

                mobileDrawerOverlay.classList.remove('hidden');
                
                // 2. "חומת מגן": חסימת אירועי מגע על ה-Overlay עצמו
                // זה מונע מהאצבע "לתפוס" את הרקע ולגרור אותו
                mobileDrawerOverlay.addEventListener('touchmove', preventScroll, { passive: false });

                // אנימציה
                requestAnimationFrame(() => {
                    mobileDrawerOverlay.classList.remove('opacity-0');
                    mobileDrawer.classList.remove('translate-x-full');
                });
            } else {
                // --- סגירה (Close) ---
                
                // 1. שחרור הנעילה
                document.body.style.overflow = ''; 
                document.documentElement.style.overflow = '';
                document.body.style.height = '';
                document.documentElement.style.height = '';
                
                // 2. הסרת החסימה מה-Overlay
                mobileDrawerOverlay.removeEventListener('touchmove', preventScroll);

                mobileDrawerOverlay.classList.add('opacity-0');
                mobileDrawer.classList.add('translate-x-full');
                
                setTimeout(() => {
                    mobileDrawerOverlay.classList.add('hidden');
                }, 300);
            }
        }

        // --- פונקציה חדשה: קישור כפתורי המובייל לטאבים האמיתיים ---
        window.openMobileTab = function(event, tabId) {
            event.preventDefault(); // מונע מהקישור לקפוץ לראש העמוד
            
            // 1. סגור את התפריט
            toggleMobileMenu();
            
            // 2. מצא את הטאב המקורי (המוסתר) ולחץ עליו
            const originalTab = document.getElementById(tabId);
            if (originalTab) {
                // מדמה לחיצה אמיתית שמפעילה את כל הלוגיקה של האפליקציה
                originalTab.click(); 
            } else {
                console.error("Tab not found:", tabId);
            }
        };

        // --- פונקציה חדשה: התנתקות דרך המובייל ---
        window.handleMobileLogout = function(event) {
            event.preventDefault();
            toggleMobileMenu(); // סגור תפריט
            
            const mainLogoutBtn = document.getElementById('logout-button');
            if (mainLogoutBtn) {
                mainLogoutBtn.click(); // לחץ על כפתור ההתנתקות המקורי
            }
        };

        // 1. לחיצה על כפתור ההמבורגר (רק אם לא הוגדר כבר ב-HTML)
        const menuBtn = document.getElementById('mobile-menu-btn');
        if (menuBtn) {
            // נקה מאזינים קודמים אם יש (כדי למנוע כפילויות)
            const newBtn = menuBtn.cloneNode(true);
            menuBtn.parentNode.replaceChild(newBtn, menuBtn);
            newBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMobileMenu();
            });
        }

        // 2. לחיצה על פריט בתפריט
        document.querySelectorAll('.mobile-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = item.dataset.target;
                const originalTab = document.getElementById(targetId);
                
                if (originalTab) {
                    originalTab.click(); // מדמה לחיצה על הטאב המקורי
                    toggleMobileMenu();  // סוגר את התפריט
                }
            });
        });

        // 3. לוגיקה להתנתקות במובייל
        if (mobileLogoutLink) {
            mobileLogoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                const mainLogoutBtn = document.getElementById('logout-button');
                if (mainLogoutBtn) mainLogoutBtn.click();
            });
        }
        
        // --- Helper Functions ---
        function showSuccessAnimation(element) {
            if (!element) return;
            element.classList.remove('show');
            // A trick to restart the CSS animation.
            void element.offsetWidth; 
            element.classList.add('show');

            // Hide after some time
            setTimeout(() => {
                element.classList.remove('show');
            }, 3000);
        }

        function hideAllMessages() {
            if(loginError) loginError.classList.add('hidden');
            if(registerError) registerError.classList.add('hidden');
            if(registerSuccess) registerSuccess.classList.add('hidden');
            if(createUserError) createUserError.classList.add('hidden');
            if(passwordChangeError) passwordChangeError.classList.add('hidden');
            // usernameError.classList.add('hidden'); // <--- מחקנו את השורה הזו שגרמה לקריסה!
            if(forgotError) forgotError.classList.add('hidden');
            if(forgotSuccess) forgotSuccess.classList.add('hidden');
            
            if(profileSuccessAnimation) profileSuccessAnimation.classList.remove('show');
            if(weekSuccessAnimation) weekSuccessAnimation.classList.remove('show');
            if(passwordChangeSuccessAnimation) passwordChangeSuccessAnimation.classList.remove('show');
            if(createUserSuccessAnimation) createUserSuccessAnimation.classList.remove('show');
        }

        function getStatusColorClass(status, type = 'badge') {
             const baseBadgeClasses = "px-2 py-1 text-[11px] sm:px-2.5 sm:py-1.5 sm:text-xs rounded-full font-semibold leading-none inline-block";
             const baseProgressClasses = "h-2.5 rounded-full";

            let colorClasses = {};
            
            // נרמול ל-lowercase לבדיקה גמישה יותר
            const s = status.toLowerCase();

            if (s === 'office') {
                colorClasses = { badge: 'bg-green-100 text-green-800', progress: 'bg-green-500' };
            } else if (s.includes('home')) {
                colorClasses = { badge: 'bg-blue-100 text-blue-800', progress: 'bg-blue-500' };
            } else if (s.includes('sick') || s.includes('off') || s.includes('vacation') || s.includes('leave')) {
                colorClasses = { badge: 'bg-red-100 text-red-800', progress: 'bg-red-500' };
            } else if (s.includes('half')) {
                colorClasses = { badge: 'bg-yellow-100 text-yellow-800', progress: 'bg-yellow-500' };
            } else if (s.includes('trip') || s.includes('conference') || s.includes('university')) {
                colorClasses = { badge: 'bg-purple-100 text-purple-800', progress: 'bg-purple-500' };
            } else if (s === '---') {
                return "text-gray-400 dark:text-gray-500"; 
            } else {
                // [NEW] Default color for custom types added by admin
                colorClasses = { badge: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300', progress: 'bg-gray-500' };
            }

            return type === 'badge' ? `${baseBadgeClasses} ${colorClasses.badge}` : `${baseProgressClasses} ${colorClasses.progress}`;
        }

        // New function to determine the date to display (Smart & Dynamic)
        function getEffectiveCurrentDate() {
            const now = new Date();
            const todayIndex = now.getDay();

            // בדיקה: האם היום הנוכחי הוא יום עבודה מוגדר?
            // globalWorkDays הוא המערך מההגדרות (למשל [0,1,2,3,4])
            if (globalWorkDays.includes(todayIndex)) {
                return now; // אם עובדים היום, תראה את השבוע הנוכחי
            }

            // אם לא עובדים היום (למשל סופ"ש), נקפוץ ליום העבודה הבא
            // (לוגיקה פשוטה: מוסיף יום אחד, אם אנחנו בסוף השבוע זה בדרך כלל יעביר לראשון)
            // במקרה הפשוט נשאיר את זה כפי שהיה - נקפוץ לראשון הבא אם זה סופ"ש
            if (todayIndex === 5) { // Friday
                now.setDate(now.getDate() + 2);
            } else if (todayIndex === 6) { // Saturday
                now.setDate(now.getDate() + 1);
            }
            return now;
        }
        
        // --- Modal Logic ---
        let confirmCallback = null;
        function showConfirmationModal(title, body, onConfirm) {
            // [FIX] Add guard against accidental calls with no arguments to prevent showing on page load
            if (!title || !body || typeof onConfirm !== 'function') {
                console.error('showConfirmationModal was called incorrectly. Aborting.', { title, body, onConfirm });
                return;
            }
            modalTitle.textContent = title;
            modalBody.innerHTML = body.replace(/\n/g, '<br>'); // Support newlines in modal body
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }
        modalCancel.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        modalConfirm.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            if(confirmCallback) confirmCallback();
        });

        // --- פונקציית התראה יפה (Branded) ---
        function showNotification(title, message, type = 'success') {
            const modal = document.getElementById('notification-modal');
            const titleEl = document.getElementById('notif-title');
            const msgEl = document.getElementById('notif-message');
            const iconContainer = document.getElementById('notif-icon-container');
            const closeBtn = document.getElementById('notif-close-btn'); // הכפתור הגרדיאנטי

            if (!modal) return;

            titleEl.textContent = title;
            msgEl.textContent = message;

            // הגדרת אייקון וצבע רקע לאייקון בלבד (הכפתור נשאר סגול/ורוד)
            if (type === 'error') {
                iconContainer.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 dark:bg-red-900/30 mb-6";
                iconContainer.innerHTML = `<svg class="h-8 w-8 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else {
                // Success
                iconContainer.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 dark:bg-green-900/30 mb-6";
                iconContainer.innerHTML = `<svg class="h-8 w-8 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
            }

            animateModalOpen('notification-modal');
            closeBtn.onclick = () => animateModalClose('notification-modal');
        }


        // --- Auth Logic ---
        // --- Auth Logic המתוקן (מונע לאגים בטעינה) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 1. משתמש מחובר - לא מעלימים את הלודינג עדיין!
                
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                try {
                    // 2. טוענים את כל המידע הכבד בזמן שהלודינג עדיין מסתובב
                    currentUserProfile = await loadProfileData(user.uid);
                    
                    // [חדש] הפעלת סנכרון בזמן אמת לפרופיל
                    setupUserProfileListener(user.uid);
                    
                    await loadGroups();
    
                    currentDate = getEffectiveCurrentDate(); 
                    tlToolDate = getEffectiveCurrentDate(); 
                    
                    document.body.classList.remove('bg-[#020617]');
                    document.body.classList.add('bg-white');
    
                    if (currentUserProfile && currentUserProfile.darkMode) {
                        document.documentElement.classList.add('dark');
                        darkModeToggle.checked = true;
                        updateExportMonthColors(true);
                        updateStatusBar(true, false); 
                    } else {
                        document.documentElement.classList.remove('dark');
                        darkModeToggle.checked = false;
                        updateExportMonthColors(false);
                        updateStatusBar(false, false);
                    }
    
                    setDefaultTab(); 
                    refreshViews(); // זה בונה את הטבלה
                    moveActiveIndicator(); 
                    
                    // === התיקון הקריטי: הפעלת המאזינים מיד בטעינה ===
                    
                    // 1. הפעלת המאזין לבקשות שלי (בודק אם אושר/נדחה -> מדליק נקודה)
                    loadMyRequests(); 

                    // 2. [תיקון] הפעלת המאזין למנהלים (הפונקציה החדשה במקום הישנה)
                    if (currentUserProfile.isTL || currentUserProfile.isSuperAdmin) {
                        loadManagerInbox(); // <--- זה השם החדש של הפונקציה!
                    }
                    // ================================================= 

                } catch (error) {
                    console.error("Error loading initial data:", error);
                } finally {
                    // 3. רק עכשיו, כשהכל מוכן ויציב, מעלימים את הלודינג באלגנטיות
                    setTimeout(() => {
                        const spinner = document.getElementById('loading-spinner');
                        if (spinner) spinner.classList.add('fade-out');
                    }, 500); // השהייה קטנה של חצי שנייה לוודא שהדפדפן סיים לצייר
                }

            } else {
                // === [התיקון כאן] חלק ההתנתקות ===
                
                // 1. הסתרת הספינר
                const spinner = document.getElementById('loading-spinner');
                if (spinner) spinner.style.display = 'none';

                // 2. ניקוי מאזינים
                if (teamViewUnsubscribe) teamViewUnsubscribe();
                if (updateWeekUnsubscribe) updateWeekUnsubscribe();
                if (statisticsUnsubscribe) statisticsUnsubscribe();
                if (pendingUsersUnsubscribe) pendingUsersUnsubscribe();
                if (myRequestsUnsubscribe) myRequestsUnsubscribe();
                if (userProfileUnsubscribe) userProfileUnsubscribe();
                if (incomingRequestsUnsubscribe) incomingRequestsUnsubscribe();
                
                currentUser = null;
                currentUserProfile = null;
                
                // 3. החלפת מסכים (הסתרת אפליקציה, הצגת מסך כניסה)
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                
                // 4. איפוס הטפסים
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('company-register-form').classList.add('hidden');
                
                // 5. אנימציית כניסה יפה
                const loginCard = document.getElementById('login-card');
                if (loginCard) {
                    loginCard.classList.remove('hidden');
                    loginCard.classList.add('opacity-0', 'translate-y-10');
                    setTimeout(() => {
                        loginCard.classList.remove('opacity-0', 'translate-y-10');
                    }, 100);
                }
                
                // 6. איפוס צבעי רקע
                document.documentElement.classList.remove('dark'); 
                document.body.classList.remove('bg-white');
                document.body.classList.add('bg-[#020617]');
                updateStatusBar(false, true); 

                // ============================================================
                // לוגיקה חדשה: זיהוי כניסה מאתר הנחיתה לפתיחת "צור ארגון"
                // ============================================================
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'create-org') {
                    // מנקים את ה-URL כדי שריענון לא יפתח את זה שוב סתם
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // מחכים שנייה שהאנימציה של הכניסה תסתיים ואז מדמים לחיצה
                    setTimeout(() => {
                        const createOrgLink = document.getElementById('show-company-register');
                        if (createOrgLink) {
                            console.log("Auto-opening Create Organization screen...");
                            createOrgLink.click();
                        }
                    }, 500);
                }
            }
        });

        // --- לוגיקה לכפתור הצג/הסתר סיסמה ---
        const togglePassBtn = document.getElementById('toggle-password-btn');
        const passInput = document.getElementById('login-password');
        const eyeOpen = document.getElementById('eye-open');
        const eyeClosed = document.getElementById('eye-closed');

        if (togglePassBtn && passInput) {
            togglePassBtn.addEventListener('click', () => {
                const isPassword = passInput.type === 'password';
                
                // 1. החלפת סוג השדה
                passInput.type = isPassword ? 'text' : 'password';
                
                // 2. החלפת האייקונים (התיקון כאן)
                if (isPassword) {
                    // עכשיו הסיסמה גלויה (Text) -> נציג עין רגילה (בלי קו)
                    eyeOpen.classList.remove('hidden'); 
                    eyeClosed.classList.add('hidden');
                } else {
                    // עכשיו הסיסמה מוסתרת (Password) -> נציג עין עם קו
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                }
                
                // 3. החזרת הפוקוס לשדה כדי שאפשר יהיה להמשיך להקליד
                passInput.focus();
            });
        }

        // --- 1. Login Form Logic (Clean & Fixed) ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.classList.remove('fade-out');
                spinner.style.display = 'flex';
            }

            // לוקחים רק אימייל (כי מחקנו את היוזרניים)
            const email = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;

            try {
                // התחברות ישירה לפיירבייס
                await signInWithEmailAndPassword(auth, email, password);
                // אם הצליח -> ה-onAuthStateChanged יטפל בשאר
            } catch (error) {
                // אם נכשל, מסתירים את הלודינג
                if (spinner) spinner.classList.add('fade-out');
                
                console.error("Login failed:", error);
                
                // בדיקה מיוחדת: אולי המשתמש ממתין לאישור (Pending)?
                // ננסה לבדוק בטבלת pendingUsers
                let isPending = false;
                try {
                    const pendingQuery = query(collection(db, "pendingUsers"), where("email", "==", email));
                    const pendingSnapshot = await getDocs(pendingQuery);
                    if (!pendingSnapshot.empty) {
                        isPending = true;
                    }
                } catch(err) { console.log("Pending check skipped"); }

                if (isPending) {
                    // === הצגת הודעת Pending מעוצבת ===
                    loginError.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-4 space-y-3">
                            <div class="relative flex items-center justify-center">
                                <div class="absolute inset-0 bg-yellow-500/20 blur-xl rounded-full"></div>
                                <div class="relative flex items-center justify-center w-14 h-14 bg-yellow-500/10 rounded-full border border-yellow-500/20 text-yellow-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="text-center">
                                <span class="block text-yellow-400 font-medium text-lg tracking-wide not-italic">Approval Pending</span>
                                <span class="block text-gray-500 text-sm mt-1 font-normal not-italic">Waiting for admin confirmation</span>
                            </div>
                        </div>
                    `;
                    loginError.classList.remove('hidden');
                } else {
                    // === הודעת שגיאה רגילה (סיסמה לא נכונה וכו') ===
                    let msg = "Invalid email or password.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        msg = "Incorrect email or password.";
                    } else if (error.code === 'auth/too-many-requests') {
                        msg = "Too many failed attempts. Please try again later.";
                    }
                    
                    loginError.textContent = msg;
                    loginError.classList.remove('hidden');
                }
            }
        });
        
        // --- לוגיקת הרשמה לעובד (Join Team) ---
        let pendingRegistrationCompanyId = null; // משתנה זמני לשמירת ה-ID שנמצא

        // 1. בדיקת הקוד ומעבר לשלב הפרטים
        const verifyCodeBtn = document.getElementById('verify-code-btn');
        const orgCodeInput = document.getElementById('org-code-input');
        const orgCodeError = document.getElementById('org-code-error');
        
        // --- לוגיקה לתיבות ה-OTP (הקוביות) ---
        const otpInputs = document.querySelectorAll('.otp-input');
        const hiddenOrgInput = document.getElementById('org-code-input');

        if (otpInputs.length > 0) {
            otpInputs.forEach((input, index) => {
                // 1. מעבר אוטומטי בהקלדה
                input.addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase();
                    e.target.value = value; // Force uppercase view
                    
                    if (value.length === 1) {
                        // Move to next input if exists
                        if (index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    }
                    updateHiddenInput();
                });

                // 2. מחיקה וחזרה אחורה (Backspace)
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value) {
                        if (index > 0) {
                            otpInputs[index - 1].focus();
                        }
                    }
                    // אפשרות לנווט עם חיצים
                    if (e.key === 'ArrowLeft' && index > 0) otpInputs[index - 1].focus();
                    if (e.key === 'ArrowRight' && index < otpInputs.length - 1) otpInputs[index + 1].focus();
                });

                // 3. הדבקה (Paste) של קוד מלא
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text').toUpperCase().trim();
                    if (!text) return;

                    // פיזור הטקסט בין הקוביות
                    otpInputs.forEach((inp, i) => {
                        if (text[i]) {
                            inp.value = text[i];
                        }
                    });
                    
                    // מיקוד על הקובייה האחרונה שמולאה
                    const focusIndex = Math.min(text.length, otpInputs.length) - 1;
                    if (focusIndex >= 0) otpInputs[focusIndex].focus();
                    
                    updateHiddenInput();
                });
            });
        }

        // פונקציה שמאחדת את כל הקוביות לאינפוט הנסתר
        function updateHiddenInput() {
            let code = '';
            otpInputs.forEach(input => {
                code += input.value;
            });
            if (hiddenOrgInput) {
                hiddenOrgInput.value = code;
                
                // הסתרת שגיאות אם המשתמש התחיל להקליד מחדש
                if(orgCodeError) orgCodeError.classList.add('hidden');
            }
        }

        // Helper: focus first OTP input if present
        function focusFirstOtp() {
            if (otpInputs && otpInputs.length > 0) {
                try { otpInputs[0].focus(); } catch (e) { /* ignore */ }
            }
        }

        if (verifyCodeBtn) {
            verifyCodeBtn.addEventListener('click', async () => {
                const code = orgCodeInput.value.trim();
                if (code.length < 6) {
                    orgCodeError.textContent = "Please enter a valid 6-character code.";
                    orgCodeError.classList.remove('hidden');
                    return;
                }

                verifyCodeBtn.disabled = true;
                verifyCodeBtn.textContent = "Verifying...";
                orgCodeError.classList.add('hidden');

                try {
                    // חיפוש הקוד בטבלה הציבורית
                    const codeDocRef = doc(db, "public_company_codes", code);
                    const codeSnap = await getDoc(codeDocRef);

                    if (codeSnap.exists()) {
                        const data = codeSnap.data();
                        pendingRegistrationCompanyId = data.companyId; // שמירת ה-ID להמשך
                        
                        // הצגת שם החברה למשתמש
                        document.getElementById('org-name-display').textContent = data.companyName;

                        // [תיקון] טעינת הקבוצות ישירות מהמסמך הציבורי (בלי הרשאות מיוחדות)
                        const groups = data.groups || ["General"];
                        const groupSelect = document.getElementById('register-group');
                        groupSelect.innerHTML = '';
                        groups.forEach(g => {
                            const opt = document.createElement('option');
                            opt.value = g;
                            opt.textContent = g;
                            groupSelect.appendChild(opt);
                        });

                        // מעבר לשלב הבא
                        document.getElementById('reg-step-code').classList.add('hidden');
                        document.getElementById('reg-step-details').classList.remove('hidden');
                        
                    } else {
                        orgCodeError.textContent = "Invalid code. Please check with your manager.";
                        orgCodeError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Code verification error:", error);
                    orgCodeError.textContent = "Error verifying code. Try again.";
                    orgCodeError.classList.remove('hidden');
                } finally {
                    verifyCodeBtn.disabled = false;
                    verifyCodeBtn.textContent = "Next";
                }
            });
        }

        // כפתור "Change" לחזרה אחורה
        const changeCodeBtn = document.getElementById('change-code-btn');
        if (changeCodeBtn) {
            changeCodeBtn.addEventListener('click', () => {
                document.getElementById('reg-step-details').classList.add('hidden');
                document.getElementById('reg-step-code').classList.remove('hidden');
                pendingRegistrationCompanyId = null;
                
                // ניקוי ה-OTP inputs
                otpInputs.forEach(input => {
                    input.value = '';
                });
                updateHiddenInput();
                // הבהרת פוקוס כדי שהמשתמש יכול להקליד מיד
                focusFirstOtp();
            });
        }

        // 2. שליחת הטופס הסופי (עדכון)
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // משתמשים באלמנטים שכבר הגדרנו למעלה או מחדש
            const regError = document.getElementById('register-error');
            const regSuccess = document.getElementById('register-success');
            
            regError.classList.add('hidden');
            
            const fullName = document.getElementById('register-fullname').value;
            const email = document.getElementById('register-email').value;
            const group = document.getElementById('register-group').value;

            if (!pendingRegistrationCompanyId) {
                regError.textContent = "Session expired. Please enter code again.";
                regError.classList.remove('hidden');
                return;
            }

            try {
                await addDoc(collection(db, "pendingUsers"), {
                    fullName,
                    email,
                    group,
                    companyId: pendingRegistrationCompanyId, // <--- הקסם קורה כאן! הוספנו את ה-ID
                    status: 'pending',
                    timestamp: Timestamp.now()
                });
                
                regSuccess.textContent = "Request sent! Please wait for admin approval.";
                regSuccess.classList.remove('hidden');
                registerForm.reset();
                
                // החזרה למסך הראשון אחרי כמה שניות
                setTimeout(() => {
                    document.getElementById('reg-step-details').classList.add('hidden');
                    document.getElementById('reg-step-code').classList.remove('hidden');
                    regSuccess.classList.add('hidden');
                    pendingRegistrationCompanyId = null;
                    
                    // ניקוי ה-OTP inputs
                    otpInputs.forEach(input => {
                        input.value = '';
                    });
                    updateHiddenInput();
                    
                    // חזרה ללוגין
                    showLoginLink.click();
                }, 2000);

            } catch (error) {
                console.error("Error sending registration request:", error);
                regError.textContent = "Failed to send request. Please try again.";
                regError.classList.remove('hidden');
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            hideAllMessages();
            // כאשר מציגים את טופס ההרשמה, נתמקד בתיבת ה-OTP הראשונה
            try { if (typeof focusFirstOtp === 'function') focusFirstOtp(); } catch (e) {}
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            hideAllMessages();
        });

        showForgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordModal.classList.remove('hidden');
            hideAllMessages();
        });

        forgotCancelBtn.addEventListener('click', () => {
            forgotPasswordModal.classList.add('hidden');
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            const email = document.getElementById('forgot-email').value;
            try {
                await sendPasswordResetEmail(auth, email);
                forgotSuccess.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-gray-500 mr-2 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                        </svg>
                        <div>
                            Password reset link sent! Check your inbox.
                            <p class="text-xs text-gray-500 mt-1">
                                Also, please check your spam folder.
                            </p>
                        </div>
                    </div>`;
                forgotSuccess.classList.remove('hidden');
            } catch (error) {
                console.error("Error sending password reset email:", error);
                forgotError.textContent = "Could not send reset link. Is the email correct?";
                forgotError.classList.remove('hidden');
            }
        });


        // --- Week Navigation ---
        function navigateWeek(direction) {
            currentDate.setDate(currentDate.getDate() + 7 * direction);
            refreshViews();
        }
        
        function navigateTlToolWeek(direction) {
            tlToolDate.setDate(tlToolDate.getDate() + 7 * direction);
            setupBulkUpdateView();
        }

        function refreshViews() {
            if (currentUser) {
                // Clear cache to force fresh user data on manual refresh
                allUsersCache = [];
                setupTeamViewTab();
                setupUpdateTab(currentUser.uid);
                setupStatisticsTab();
                setupAdminTabs(); // This now handles TL and Super Admin
            }
        }
        
        function setDefaultTab() {
            // אתחול כל הטאבים לצבעים רגילים
            Object.values(tabs).forEach(t => {
                if(t) {
                    t.classList.remove('active');
                    t.classList.remove('text-indigo-600', 'dark:text-fuchsia-400');
                    t.classList.add('text-gray-500', 'dark:text-gray-400');
                }
            });
            Object.values(contents).forEach(c => c && c.classList.add('hidden'));
            
            // הגדרת הטאב הפעיל (Team View) עם צבעים מתאימים
            tabs.display.classList.add('active');
            tabs.display.classList.remove('text-gray-500', 'dark:text-gray-400');
            contents.display.classList.remove('hidden');
            moveActiveIndicator();
        }

        teamViewPrevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        teamViewNextWeekBtn.addEventListener('click', () => navigateWeek(1));
        updateViewPrevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        updateViewNextWeekBtn.addEventListener('click', () => navigateWeek(1));
        statsViewPrevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        statsViewNextWeekBtn.addEventListener('click', () => navigateWeek(1));
        tlViewPrevWeekBtn.addEventListener('click', () => navigateTlToolWeek(-1));
        tlViewNextWeekBtn.addEventListener('click', () => navigateTlToolWeek(1));

        // --- Tab Navigation Logic ---
        function moveActiveIndicator() {
            const activeTab = document.querySelector('.tab-btn.active');
            const indicator = document.getElementById('active-tab-indicator');
            if (activeTab && indicator) {
                indicator.style.width = `${activeTab.offsetWidth}px`;
                indicator.style.left = `${activeTab.offsetLeft}px`;
            }
        }
        window.addEventListener('resize', moveActiveIndicator);

        Object.keys(tabs).forEach(key => {
            if(tabs[key]) {
                tabs[key].addEventListener('click', () => {
                    // הסר את מחלקת active מכל הטאבים והחזר צבעים רגילים
                    Object.values(tabs).forEach(t => {
                        if(t) {
                            t.classList.remove('active');
                            // וודא שהטאב הלא-אקטיבי מקבל צבעים רגילים
                            t.classList.remove('text-indigo-600', 'dark:text-fuchsia-400');
                            t.classList.add('text-gray-500', 'dark:text-gray-400');
                        }
                    });
                    Object.values(contents).forEach(c => c && c.classList.add('hidden'));
                    
                    // הוסף active לטאב הנוכחי והסר צבעים רגילים
                    tabs[key].classList.add('active');
                    tabs[key].classList.remove('text-gray-500', 'dark:text-gray-400');
                    contents[key].classList.remove('hidden');
                    moveActiveIndicator();
                    
                    // Trigger animation for Statistics tab
                    if (key === 'statistics') {
                        statisticsTabVisited = true; // Mark as visited
                        setTimeout(() => {
                            animateProgressCircles();
                        }, 150);
                    }
                    
                    // Setup Planner tab
                    if (key === 'calendar') {
                        setupPlannerTab();
                    }
                    
                    // Load data for Requests tab
                    if (key === 'requests') {
                        // 1. הסתרת הנקודה ועדכון זמן בדיקה (כמו מקודם)
                        const dot = document.getElementById('requests-notification-dot');
                        if(dot) dot.classList.add('hidden');
                        
                        if (currentUser) {
                            // מחיקת הקוד הישן:
                            // const nowMs = Date.now();
                            // if(currentUserProfile) currentUserProfile.lastRequestsCheckMs = nowMs;
                            // updateDoc(userRef, { lastRequestsCheckMs: nowMs }).catch(console.error);

                            // === [החלף בקוד החדש הזה] ===
                            // כיבוי הנורה האדומה בשרת
                            const userRef = doc(db, "users", currentUser.uid);
                            
                            // עדכון מקומי מהיר (כדי שהנקודה תיעלם מיד)
                            if(currentUserProfile) currentUserProfile.hasUnreadRequestUpdates = false;
                            
                            // עדכון בשרת (כדי שייעלם בכל המכשירים האחרים)
                            updateDoc(userRef, { hasUnreadRequestUpdates: false }).catch(console.error);
                            // ============================
                        }

                        // 2. ניהול תצוגת מנהל/עובד
                        const subNav = document.getElementById('requests-sub-nav');
                        const viewPersonal = document.getElementById('view-personal-requests');
                        const viewTeam = document.getElementById('view-team-requests');
                        
                        // תמיד טוענים את האישי
                        // loadMyRequests(); // כבר נטען בטעינת האפליקציה - אין צורך לטעון שוב
                        viewPersonal.classList.remove('hidden');
                        viewTeam.classList.add('hidden');

                        if (currentUserProfile && (currentUserProfile.isTL || currentUserProfile.isSuperAdmin)) {
                            // מנהל: הצג סרגל ניווט עליון
                            subNav.classList.remove('hidden');
                            subNav.classList.add('flex'); // חשוב ל-flexbox
                            
                            // טעינת משתמשים חדשים ממתינים לבאדג' (ללא בקשות צוות)
                            loadPendingRegistrations();
                            
                            // הגדרת מאזינים לכפתורי המשנה (Sub-tabs)
                            setupRequestSubTabs();
                            
                            // === [התיקון כאן] ===
                            // אנחנו מדמים לחיצה על "My Personal" כדי לאפס את העיצוב של הכפתורים
                            // שיתאים לתוכן שמוצג כרגע
                            const btnPersonal = document.getElementById('sub-req-personal');
                            if (btnPersonal) {
                                btnPersonal.click(); 
                            }
                            // ====================
                        } else {
                            // --- לוגיקה לעובד רגיל ---
                            const subNav = document.getElementById('requests-sub-nav');
                            const newRequestBtn = document.getElementById('new-request-btn');
                            
                            // הסתרת סרגל הניווט של המנהלים
                            if(subNav) {
                                subNav.classList.add('hidden');
                                subNav.classList.remove('flex');
                            }
                            
                            // [תיקון] הצגת כפתור "New Request" לעובד רגיל
                            if (newRequestBtn) {
                                newRequestBtn.classList.remove('hidden', 'md:flex'); // איפוס הגדרות מנהלים
                                newRequestBtn.classList.add('flex'); // הצגה תמיד
                            }
                        }
                    }
                    
                    // Scroll the clicked tab into view (centered on mobile)
                    tabs[key].scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest', 
                        inline: 'center' 
                    });
                });
            }
        });

        // Function to animate progress circles in Statistics tab
        function animateProgressCircles() {
            const container = document.getElementById('statistics-container');
            if (!container) return;
            
            const circles = container.querySelectorAll('.progress-circle-fill');
            const percentages = container.querySelectorAll('.progress-circle-percentage');
            
            if (circles.length === 0) return;
            
            circles.forEach((circle, index) => {
                const targetOffset = parseFloat(circle.getAttribute('data-target-offset'));
                const circumference = 2 * Math.PI * 42;
                const targetPercentage = ((circumference - targetOffset) / circumference * 100).toFixed(1);
                
                // Reset to start position first
                circle.style.strokeDashoffset = circumference;
                if (percentages[index]) {
                    percentages[index].textContent = '0%';
                }
                
                // Small delay then animate
                setTimeout(() => {
                    // Animate the circle
                    circle.style.strokeDashoffset = targetOffset;
                    
                    // Animate the percentage text
                    let currentPercentage = 0;
                    const duration = 1200; // 1.2 seconds
                    const steps = 60;
                    const increment = parseFloat(targetPercentage) / steps;
                    const stepDuration = duration / steps;
                    
                    const intervalId = setInterval(() => {
                        currentPercentage += increment;
                        if (currentPercentage >= targetPercentage) {
                            currentPercentage = targetPercentage;
                            clearInterval(intervalId);
                        }
                        if (percentages[index]) {
                            percentages[index].textContent = Math.round(currentPercentage) + '%';
                        }
                    }, stepDuration);
                }, 50);
            });
        }

        // --- Event Listener for Group Filter ---
        // New function to handle group filter change and save preference
        async function handleGroupFilterChange() {
            if (currentUser && currentUserProfile) {
                const selectedGroup = groupFilter.value;
                
                // עדכון לוקאלי מיידי כדי שהלוגיקה תעבוד
                currentUserProfile.teamViewFilter = selectedGroup; 

                // שמירה בשרת (כדי שבכניסה הבאה זה ייזכר)
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { teamViewFilter: selectedGroup });
                } catch (error) {
                    console.error("Failed to save group filter preference:", error);
                }
                
                // ניקוי המטמון של המשתמשים כדי שנביא רק את המשתמשים של הקבוצה החדשה
                allUsersCache = []; 
                
                // טעינה מחדש של הטאב - עכשיו זה ימשוך רק את הנתונים הרלוונטיים
                setupTeamViewTab(); 
            }
        }
        groupFilter.addEventListener('change', handleGroupFilterChange);

        // New function to handle STATS group filter change and save preference
        async function handleStatsGroupFilterChange() {
            if (currentUser && currentUserProfile) {
                const selectedGroup = statsGroupFilter.value;
                
                // עדכון לוקאלי
                currentUserProfile.statsViewFilter = selectedGroup; 

                // שמירה בשרת
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { statsViewFilter: selectedGroup });
                } catch (error) {
                    console.error("Failed to save stats filter preference:", error);
                }
                
                // ניקוי המטמון כדי שנביא נתונים חדשים
                allUsersCache = []; 
                
                // איפוס פילטר העובד הבודד כשמחליפים קבוצה
                if (statsEmployeeFilter) statsEmployeeFilter.value = 'all';

                // טעינה מחדש של הטאב
                setupStatisticsTab(); 
            }
        }

        if (statsGroupFilter) statsGroupFilter.addEventListener('change', handleStatsGroupFilterChange);
        if (statsEmployeeFilter) statsEmployeeFilter.addEventListener('change', setupStatisticsTab);
        userSearchInput.addEventListener('input', renderUserManagementList);
        userGroupFilter.addEventListener('change', renderUserManagementList);

        // --- Status Bar Update Function ---
        function updateStatusBar(isDarkMode, isLoginPage = false) {
            const themeColorMeta = document.getElementById('meta-theme-color');
            let colorToSet;

            if (isLoginPage) {
                // צבע מסך ההתחברות (כחול כהה עמוק)
                colorToSet = '#020617';
            } else {
                // צבע בתוך האפליקציה (בהיר או כהה)
                colorToSet = isDarkMode ? '#111827' : '#ffffff';
            }

            if (themeColorMeta) {
                themeColorMeta.setAttribute('content', colorToSet);
            }
            
            // For Capacitor apps (mobile wrappers)
            if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.StatusBar) {
                const { StatusBar } = window.Capacitor.Plugins;
                // בתוך Capacitor אנחנו צריכים להתאים גם את צבע האייקונים (Style)
                if (isLoginPage) {
                    StatusBar.setBackgroundColor({ color: '#020617' });
                    StatusBar.setStyle({ style: 'DARK' }); // טקסט לבן על רקע כהה
                } else if (isDarkMode) {
                    StatusBar.setBackgroundColor({ color: '#111827' });
                    StatusBar.setStyle({ style: 'DARK' }); // טקסט לבן על רקע כהה
                } else {
                    StatusBar.setBackgroundColor({ color: '#ffffff' });
                    StatusBar.setStyle({ style: 'LIGHT' }); // טקסט שחור על רקע לבן
                }
            }
        }

        // --- Dark Mode Logic ---
        darkModeToggle.addEventListener('change', async () => {
            if (!currentUser) return;
            const isEnabled = darkModeToggle.checked;
            document.documentElement.classList.toggle('dark', isEnabled);
            
            // [שינוי] עדכון הסטטוס בר (אנחנו לא בלוגין, לכן false)
            updateStatusBar(isEnabled, false);
            
            // Update export month text and buttons colors for dark mode
            updateExportMonthColors(isEnabled);
            
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { darkMode: isEnabled });
                currentUserProfile.darkMode = isEnabled; // Update local state
            } catch (error) {
                console.error("Failed to save dark mode preference:", error);
                // Optionally revert the toggle if save fails
                document.documentElement.classList.toggle('dark', !isEnabled);
                darkModeToggle.checked = !isEnabled;
                updateExportMonthColors(!isEnabled);
            }
        });

        // Helper function to update export month colors
        function updateExportMonthColors(isDark) {
            const exportMonthText = document.getElementById('export-month-text');
            const prevBtn = document.getElementById('prev-month-btn');
            const nextBtn = document.getElementById('next-month-btn');
            
            if (exportMonthText) {
                exportMonthText.style.setProperty('color', isDark ? '#ffffff' : '#111827', 'important');
            }
            if (prevBtn) {
                prevBtn.style.setProperty('color', isDark ? '#d1d5db' : '#4b5563', 'important');
            }
            if (nextBtn) {
                nextBtn.style.setProperty('color', isDark ? '#d1d5db' : '#4b5563', 'important');
            }
        }

        // --- Groups Logic ---
        async function loadGroups() {
            // אם אין משתמש או אין לו חברה, נטען ברירת מחדל
            if (!currentUserProfile || !currentUserProfile.companyId) {
                availableGroups = ["Management", "General"];
                // [ADD] ברירת מחדל למקרה שאין פרופיל
                globalAttendanceOptions = ["Office", "Home", "Vacation", "Sick"];
                populateGroupSelects();
                return;
            }

            // [שינוי] קריאה מהמסמך של החברה בתוך קולקציית companies
            const companyRef = doc(db, "companies", currentUserProfile.companyId);
            try {
                const docSnap = await getDoc(companyRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.groups) availableGroups = data.groups;
                    // [חדש] טעינת ימי העבודה
                    if (data.workDays) globalWorkDays = data.workDays;
                    
                    // [ADD] טעינת סוגי הנוכחות מהדאטהבייס
                    if (data.attendanceTypes && Array.isArray(data.attendanceTypes)) {
                        globalAttendanceOptions = data.attendanceTypes;
                    }
                    
                    // [חדש] טעינת הסלוגן - ברירת מחדל: שם החברה
                    const slogan = data.slogan || data.name || "";
                    updateSloganUI(slogan);
                    
                    // מילוי האינפוט בטאב הניהול (אם קיים)
                    const sloganInput = document.getElementById('company-slogan-input');
                    if(sloganInput) sloganInput.value = slogan;
                }
            } catch (e) {
                console.error("Could not load company settings:", e);
            }
            populateGroupSelects();
            populateManageGroupsList(); // עדכון רשימת הניהול
            renderManageAttendanceTypes(); // [ADD] פונקציה חדשה שנוסיף בהמשך
            renderColorPalette('admin-color-palette', 'new-attendance-color', 0); // הפעלת פלטת הצבעים
        }

        function populateGroupSelects() {
            const groupSelects = [
                document.getElementById('group'),
                document.getElementById('register-group'),
                document.getElementById('new-user-group'),
                document.getElementById('user-group-filter'),
                document.getElementById('sa-edit-group'),
            ];
            
            groupSelects.forEach(select => {
                if (select) {
                    const currentVal = select.value;
                    // For filters, keep the 'All Groups' option
                    if(select.id === 'user-group-filter') {
                        select.innerHTML = '<option value="all">All Groups</option>';
                    } else {
                        select.innerHTML = '';
                    }

                    availableGroups.forEach(groupName => {
                        const option = document.createElement('option');
                        option.value = groupName;
                        option.textContent = groupName;
                        select.appendChild(option);
                    });
                    if (availableGroups.includes(currentVal) || currentVal === 'all') {
                        select.value = currentVal;
                    }
                }
            });
        }
        
        function populateManageGroupsList() {
            manageGroupsList.innerHTML = ''; // Clear existing list
            manageGroupsError.classList.add('hidden');
            let draggedItemName = null;

            availableGroups.forEach((groupName, index) => {
                const groupElement = document.createElement('div');
                groupElement.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                groupElement.dataset.groupName = groupName;
                groupElement.draggable = true;

                // Drag & Drop event listeners
                groupElement.addEventListener('dragstart', e => {
                    draggedItemName = groupName;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', groupName);
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                });

                groupElement.addEventListener('dragend', e => {
                    e.target.classList.remove('dragging');
                    document.querySelectorAll('.drag-over-indicator').forEach(el => el.classList.remove('drag-over-indicator'));
                    draggedItemName = null;
                });
                
                groupElement.addEventListener('dragenter', e => {
                    if (groupName !== draggedItemName) {
                        document.querySelectorAll('.drag-over-indicator').forEach(el => el.classList.remove('drag-over-indicator'));
                        e.currentTarget.classList.add('drag-over-indicator');
                    }
                });

                groupElement.addEventListener('dragover', e => {
                    e.preventDefault(); // Necessary to allow dropping
                });


                groupElement.addEventListener('drop', e => {
                    e.preventDefault();
                    e.currentTarget.classList.remove('drag-over-indicator');
                    const targetGroupName = e.currentTarget.dataset.groupName;
                    const draggedName = e.dataTransfer.getData('text/plain');

                    if (draggedName && draggedName !== targetGroupName) {
                        const fromIndex = availableGroups.indexOf(draggedName);
                        const toIndex = availableGroups.indexOf(targetGroupName);
                        
                        if (fromIndex !== -1 && toIndex !== -1) {
                            let newOrder = [...availableGroups];
                            const [movedItem] = newOrder.splice(fromIndex, 1);
                            newOrder.splice(toIndex, 0, movedItem);
                            saveGroups(newOrder);
                        }
                    }
                });

                const leftSide = document.createElement('div');
                leftSide.className = 'flex items-center';

                const dragHandle = document.createElement('span');
                dragHandle.className = 'cursor-move mr-3 text-gray-400 hover:text-gray-600';
                dragHandle.title = 'Drag to reorder';
                dragHandle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>`;
                leftSide.appendChild(dragHandle);

                const groupText = document.createElement('span');
                groupText.textContent = groupName;
                leftSide.appendChild(groupText);
                groupElement.appendChild(leftSide);


                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'flex items-center space-x-2';

                // Up Arrow
                if (index > 0) {
                    const upBtn = document.createElement('button');
                    upBtn.title = 'Move up';
                    upBtn.innerHTML = `<svg class="w-5 h-5 text-gray-500 hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>`;
                    upBtn.onclick = () => {
                        const newOrder = [...availableGroups];
                        [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]]; // Swap
                        saveGroups(newOrder);
                    };
                    buttonsContainer.appendChild(upBtn);
                }

                // Down Arrow
                if (index < availableGroups.length - 1) {
                    const downBtn = document.createElement('button');
                    downBtn.title = 'Move down';
                    downBtn.innerHTML = `<svg class="w-5 h-5 text-gray-500 hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                    downBtn.onclick = () => {
                        const newOrder = [...availableGroups];
                        [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]]; // Swap
                        saveGroups(newOrder);
                    };
                    buttonsContainer.appendChild(downBtn);
                }

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg class="w-5 h-5 text-red-500 hover:text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                deleteBtn.onclick = async () => {
                    manageGroupsError.classList.add('hidden'); // Hide previous errors
                    
                    try {
                        const q = query(collection(db, "users"), where("group", "==", groupName));
                        const querySnapshot = await getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            manageGroupsError.textContent = `Cannot delete "${groupName}" because it contains ${querySnapshot.size} member(s). Please reassign them first.`;
                            manageGroupsError.classList.remove('hidden');
                            return; // Stop execution
                        }
                        
                        // If group is empty, proceed with confirmation
                        showConfirmationModal('Delete Group', `Are you sure you want to delete the group "${groupName}"? It is empty and this action cannot be undone.`, () => {
                            const updatedGroups = availableGroups.filter(g => g !== groupName);
                            saveGroups(updatedGroups);
                        });

                    } catch (error) {
                        console.error("Error checking group members:", error);
                        manageGroupsError.textContent = "Could not verify group members. Please try again.";
                        manageGroupsError.classList.remove('hidden');
                    }
                };
                buttonsContainer.appendChild(deleteBtn);
                
                groupElement.appendChild(buttonsContainer);
                manageGroupsList.appendChild(groupElement);
            });
        }

        async function saveGroups(newGroupOrder) {
            if (!currentUserProfile || !currentUserProfile.companyId) {
                alert("Error: No company ID found associated with your profile.");
                return;
            }

            const companyRef = doc(db, "companies", currentUserProfile.companyId);

            try {
                // שלב 1: שליפת קוד החברה (כדי שנוכל לעדכן גם את המסמך הציבורי)
                const companySnap = await getDoc(companyRef);
                if (!companySnap.exists()) {
                    throw new Error("Company document not found");
                }
                const companyData = companySnap.data();
                const companyCode = companyData.companyCode; // השגת הקוד (למשל ABC123)

                // שלב 2: הכנת עדכון כפול (Batch)
                const batch = writeBatch(db);

                // א. עדכון המסמך הפרטי (עבור המשתמשים המחוברים)
                batch.set(companyRef, { groups: newGroupOrder }, { merge: true });

                // ב. עדכון המסמך הציבורי (עבור משתמשים שנרשמים)
                // אנו בודקים שיש קוד, למקרה שזו חברה ישנה מאוד
                if (companyCode) {
                    const publicCodeRef = doc(db, "public_company_codes", companyCode);
                    batch.set(publicCodeRef, { groups: newGroupOrder }, { merge: true });
                }

                // ביצוע העדכון
                await batch.commit();
                
                // עדכון ה-UI
                availableGroups = newGroupOrder; 
                populateGroupSelects();
                populateManageGroupsList();
                refreshViews(); 
            } catch (error) {
                console.error("Error saving group order:", error);
                // הצגת שגיאה למשתמש
                if (typeof manageGroupsError !== 'undefined') {
                    manageGroupsError.textContent = "Failed to save new order.";
                    manageGroupsError.classList.remove('hidden');
                }
            }
        }

        manageGroupsBtn.addEventListener('click', () => {
            populateManageGroupsList();
            manageGroupsModal.classList.remove('hidden');
        });

        manageGroupsClose.addEventListener('click', () => {
            manageGroupsModal.classList.add('hidden');
        })

        addGroupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addGroupError.classList.add('hidden');
            const newGroupName = document.getElementById('new-group-name').value;
            
            if (newGroupName && newGroupName.trim() !== '') {
                const trimmedName = newGroupName.trim();
                if (availableGroups.some(g => g.toLowerCase() === trimmedName.toLowerCase())) {
                    addGroupError.textContent = "This group already exists.";
                    addGroupError.classList.remove('hidden');
                    return;
                }
                const updatedGroups = [...availableGroups, trimmedName];
                await saveGroups(updatedGroups);
                addGroupForm.reset();
            }
        });


        // --- Profile Tab Logic ---
        async function loadProfileData(userId) {
            const userRef = doc(db, "users", userId);
            let docSnap = await getDoc(userRef);

            // המתנה למקרה שהדאטהבייס מתעדכן לאט
            if (!docSnap.exists()) {
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                docSnap = await getDoc(userRef); 
            }

            if (docSnap.exists()) {
                // --- טעינת פרופיל רגילה (נשאר אותו דבר) ---
                const data = docSnap.data();
                
                if (document.getElementById('full-name')) document.getElementById('full-name').value = data.fullName || '';
                if (document.getElementById('email')) document.getElementById('email').value = data.email || '';
                if (document.getElementById('group')) document.getElementById('group').value = data.group || '';
                
                let roleText = 'Employee';
                if(data.isSuperAdmin) roleText = 'Super Admin';
                else if (data.isTL) roleText = 'Team Leader';
                if (document.getElementById('role-display')) document.getElementById('role-display').textContent = roleText;

                if (data.companyId) {
                    
                    // === הוסף את השורה הזו כאן: ===
                    // בדיקה והחלפת קוד יומית (רצה ברקע)
                    checkAndRotateDailyCode(data.companyId); 
                    // ==============================

                    const orgContainer = document.getElementById('org-code-display-container');
                    const orgCodeSpan = document.getElementById('settings-org-code');
                    const revealBtn = document.getElementById('reveal-code-btn');
                    const eyeOff = document.getElementById('icon-eye-off');
                    const eyeOn = document.getElementById('icon-eye-on');

                    if (orgContainer && orgCodeSpan) {
                        orgContainer.classList.remove('hidden');
                        try {
                            const companyRef = doc(db, "companies", data.companyId);
                            const companySnap = await getDoc(companyRef);
                            
                            if (companySnap.exists()) {
                                const realCode = companySnap.data().companyCode || "N/A";
                                
                                // 1. שמירת הקוד האמיתי ב-DATA ATTRIBUTE והסתרה ויזואלית
                                orgCodeSpan.dataset.realCode = realCode;
                                orgCodeSpan.innerText = "******"; // מצב התחלתי מוסתר
                                
                                // איפוס כפתור העין
                                eyeOff.classList.remove('hidden');
                                eyeOn.classList.add('hidden');

                                // 2. לוגיקה לכפתור החשיפה (Airport Effect)
                                if (revealBtn) {
                                    // הסרת מאזינים ישנים כדי למנוע כפילויות (חשוב ב-SPA)
                                    const newBtn = revealBtn.cloneNode(true);
                                    revealBtn.parentNode.replaceChild(newBtn, revealBtn);
                                    
                                    newBtn.addEventListener('click', () => {
                                        const isHidden = orgCodeSpan.innerText.includes('*');
                                        const iconOff = newBtn.querySelector('#icon-eye-off');
                                        const iconOn = newBtn.querySelector('#icon-eye-on');

                                        if (isHidden) {
                                            // הפעלת האנימציה לחשיפה
                                            animateCodeReveal(orgCodeSpan, realCode);
                                            iconOff.classList.add('hidden');
                                            iconOn.classList.remove('hidden');
                                        } else {
                                            // הסתרה מחדש (ללא אנימציה או עם אנימציה מהירה לכוכביות)
                                            orgCodeSpan.innerText = "******";
                                            iconOff.classList.remove('hidden');
                                            iconOn.classList.add('hidden');
                                        }
                                    });
                                }
                                
                                // 3. לוגיקה לכפתור ההעתקה (מעתיק את הקוד האמיתי גם אם מוסתר)
                                const copyBtn = document.getElementById('copy-org-code-btn');
                                if (copyBtn) {
                                    copyBtn.onclick = () => {
                                        navigator.clipboard.writeText(realCode); // מעתיק את הקוד האמיתי תמיד
                                        
                                        // אנימציה קטנה לכפתור
                                        const originalText = copyBtn.textContent;
                                        copyBtn.textContent = "Copied!";
                                        copyBtn.classList.add('bg-green-500', 'text-white');
                                        
                                        setTimeout(() => {
                                            copyBtn.textContent = originalText;
                                            copyBtn.classList.remove('bg-green-500', 'text-white');
                                        }, 2000);
                                    };
                                }
                            }
                        } catch (e) { console.error("Error fetching org code", e); }
                    }
                }
                return data;

            } else {
                // --- תרחיש PENDING (ממתין לאישור) ---
                const currentUserEmail = auth.currentUser ? auth.currentUser.email : null;
                
                await signOut(auth); // מנתקים אותו

                if (currentUserEmail) {
                    try {
                        const pendingQ = query(collection(db, "pendingUsers"), where("email", "==", currentUserEmail));
                        const pendingSnap = await getDocs(pendingQ);
                        
                        if (!pendingSnap.empty) {
                            setTimeout(() => {
                                const loginError = document.getElementById('login-error');
                                if (loginError) {
                                    // === העיצוב החדש והעדין ===
                                    loginError.innerHTML = `
                                        <div class="flex flex-col items-center justify-center py-4 space-y-3">
                                            <div class="relative flex items-center justify-center">
                                                <div class="absolute inset-0 bg-yellow-500/20 blur-xl rounded-full"></div>
                                                
                                                <div class="relative flex items-center justify-center w-14 h-14 bg-yellow-500/10 rounded-full border border-yellow-500/20 text-yellow-400">
                                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            
                                            <div class="text-center">
                                                <span class="block text-yellow-400 font-medium text-lg tracking-wide not-italic">Approval Pending</span>
                                                <span class="block text-gray-500 text-sm mt-1 font-normal not-italic">Waiting for admin confirmation</span>
                                            </div>
                                        </div>
                                    `;
                                    loginError.classList.remove('hidden');
                                }
                            }, 600);
                        } else {
                             // לא נמצא (כנראה נדחה או נמחק)
                             setTimeout(() => {
                                const loginError = document.getElementById('login-error');
                                if(loginError) {
                                    loginError.textContent = "Account setup incomplete. Please contact support.";
                                    loginError.classList.remove('hidden');
                                }
                             }, 600);
                        }
                    } catch (e) {
                        console.error("Error checking pending status", e);
                    }
                }
                return null;
            }
        }

        // --- סנכרון פרופיל בזמן אמת ---
        function setupUserProfileListener(userId) {
            if (userProfileUnsubscribe) userProfileUnsubscribe();

            const userRef = doc(db, "users", userId);
            
            userProfileUnsubscribe = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // עדכון אגרסיבי של האובייקט הגלובלי
                    if (currentUserProfile) {
                        // === [הוסף את השורה הזו כאן!] ===
                        // זה התיקון: מעדכנים את המשתנה המקומי בערך החדש שהגיע מהשרת
                        currentUserProfile.hasUnreadRequestUpdates = data.hasUnreadRequestUpdates;
                        // ================================

                        currentUserProfile.lastRequestsCheckMs = data.lastRequestsCheckMs;
                        // תמיכה לאחור
                        if (!data.lastRequestsCheckMs && data.lastRequestsCheck) {
                            currentUserProfile.lastRequestsCheck = data.lastRequestsCheck;
                        }
                    } else {
                        // אם הפרופיל היה ריק מסיבה כלשהי
                        currentUserProfile = data;
                    }
                    
                    // הפעלת בדיקה מיד כשיש עדכון מדפדפן אחר
                    checkNotificationDot();
                }
            });
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            if (!currentUser) return;

            const newEmail = document.getElementById('email').value.trim();
            // מחקנו את קריאת ה-username מכאן

            // בדיקה אם האימייל השתנה (דורש אימות מחדש)
            if (newEmail !== currentUserProfile.email) {
                showReauthModal(newEmail);
                return; 
            }

            // שמירה רגילה
            saveProfileDetails();
        });

        async function saveProfileDetails(newEmail = null) {
            const userRef = doc(db, "users", currentUser.uid);
            
            // איסוף הנתונים ללא שם משתמש
            const dataToUpdate = {
                fullName: document.getElementById('full-name').value,
                group: document.getElementById('group').value,
                email: newEmail || currentUserProfile.email,
            };

            try {
                // עדכון הדאטהבייס
                await updateDoc(userRef, dataToUpdate);
                
                // עדכון המצב המקומי
                currentUserProfile.fullName = dataToUpdate.fullName;
                currentUserProfile.group = dataToUpdate.group;
                if(newEmail) currentUserProfile.email = newEmail;

                showSuccessAnimation(profileSuccessAnimation);
                refreshViews();
            } catch (error) {
                console.error("Error updating profile: ", error);
                alert(`Failed to save profile: ${error.message}`)
            }
        }

        // Re-authentication for sensitive operations
        let emailToUpdate = '';
        function showReauthModal(newEmail) {
            emailToUpdate = newEmail;
            reauthModal.classList.remove('hidden');
            reauthError.classList.add('hidden');
            reauthForm.reset();
        }
        reauthCancel.addEventListener('click', () => reauthModal.classList.add('hidden'));

        reauthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('reauth-password').value;
            const credential = EmailAuthProvider.credential(currentUser.email, password);

            try {
                await reauthenticateWithCredential(currentUser, credential);
                await updateEmail(currentUser, emailToUpdate);
                await saveProfileDetails(emailToUpdate);
                reauthModal.classList.add('hidden');
            } catch (error) {
                console.error("Re-authentication failed: ", error);
                reauthError.textContent = `Error: ${error.message}`;
                reauthError.classList.remove('hidden');
            }
        });


        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;

            if (newPassword !== confirmPassword) {
                passwordChangeError.textContent = "Passwords do not match.";
                passwordChangeError.classList.remove('hidden');
                return;
            }
            if (newPassword.length < 6) {
                 passwordChangeError.textContent = "Password must be at least 6 characters long.";
                passwordChangeError.classList.remove('hidden');
                return;
            }

            try {
                await updatePassword(currentUser, newPassword);
                showSuccessAnimation(passwordChangeSuccessAnimation);
                changePasswordForm.reset();
            } catch (error) {
                console.error("Error changing password: ", error);
                passwordChangeError.textContent = `Error: ${error.message}`;
                passwordChangeError.classList.remove('hidden');
            }
        });

        // --- Update Week Tab Logic ---
        function getWeekId(d) {
            const date = new Date(d.getTime());
            date.setHours(0, 0, 0, 0);
            // Set to the Sunday of the current week
            date.setDate(date.getDate() - date.getDay());
            
            const year = date.getFullYear();
            // Calculate week number
            const firstDayOfYear = new Date(year, 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            const weekNo = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);

            return `${year}-W${String(weekNo).padStart(2, '0')}`;
        }

        // ============================================================
        //  L O U L Y   T E A M   C A L E N D A R   L O G I C
        // ============================================================

        // משתני לוח השנה
        let plannerDate = new Date();
        let plannerUnsubscribe = null;

        // פונקציית עזר: מציאת כל השבועות בחודש
        function getWeeksInMonth(year, month) {
            const weeks = new Set();
            const date = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            while (date <= lastDay) {
                weeks.add(getWeekId(date)); 
                date.setDate(date.getDate() + 1);
            }
            return Array.from(weeks);
        }

        // פונקציית שליפת נתונים
        async function fetchMonthlyAttendance(weekIds, targetGroup = 'all') {
            const dataMap = {}; 
            
            if (!currentUserProfile || !currentUserProfile.companyId) return dataMap;

            const promises = weekIds.map(weekId => {
                // בניית אילוצים לשאילתה
                const constraints = [
                    where("companyId", "==", currentUserProfile.companyId),
                    where("weekId", "==", weekId)
                ];

                // --- החיסכון בכסף קורה כאן! ---
                // אם נבחרה קבוצה ספציפית, השרת יחזיר רק מסמכים שלה
                if (targetGroup && targetGroup !== 'all') {
                    constraints.push(where("group", "==", targetGroup));
                }

                const q = query(collection(db, "attendance"), ...constraints);
                return getDocs(q);
            });
            
            try {
                const snapshots = await Promise.all(promises);
                snapshots.forEach((snap, index) => {
                    const currentWeekId = weekIds[index];
                    snap.forEach(doc => {
                        const d = doc.data();
                        dataMap[`${currentWeekId}_${d.userId}`] = d.days;
                    });
                });
            } catch (e) {
                console.error("Fetch error:", e);
                // טיפול במקרה שחסר אינדקס (Firebase יבקש ליצור אותו)
                if (e.code === 'failed-precondition') {
                    alert("System Notice: Please create the missing Index using the link in the console (F12) to enable Group filtering.");
                }
                throw e; 
            }
            
            return dataMap;
        }

        // ============================================================
        //  OPTIMIZED CALENDAR LOGIC (Cache Implementation)
        // ============================================================

        // משתנים גלובליים לניהול הזיכרון
        let currentMonthData = {}; // כאן נשמור את הנתונים כדי לא לפנות לשרת סתם
        let lastLoadedMonth = null; // כדי לדעת אם החלפנו חודש
        let selectedCategories = new Set(['all']); 

        // פונקציה פנימית לעדכון רשימת העובדים
        function updateEmployeeList() {
            const pEmployee = document.getElementById('planner-employee-filter');
            const pGroup = document.getElementById('planner-group-filter');
            if (!pEmployee) return;
            
            const selectedGroup = pGroup ? pGroup.value : 'all';
            const currentSelection = pEmployee.value;

            pEmployee.innerHTML = '<option value="all">All Employees</option>';
            let users = allUsersCache || [];
            
            if (selectedGroup !== 'all') {
                users = users.filter(u => u.group === selectedGroup);
            }

            users.sort((a, b) => (a.fullName || "").localeCompare(b.fullName || ""));

            users.forEach(user => {
                const opt = document.createElement('option');
                opt.value = user.id;
                opt.textContent = user.fullName || user.email;
                pEmployee.appendChild(opt);
            });

            if (currentSelection && currentSelection !== 'all') {
                const exists = Array.from(pEmployee.options).some(o => o.value === currentSelection);
                if(exists) pEmployee.value = currentSelection;
            }
        }

        // --- פונקציה חדשה: בניית המקרא (Legend) ---
        function renderPlannerLegend() {
            const legendContainer = document.getElementById('planner-legend');
            if (!legendContainer) return;
            
            legendContainer.innerHTML = '';
            
            if (typeof globalAttendanceOptions !== 'undefined') {
                globalAttendanceOptions.forEach(opt => {
                    const name = typeof opt === 'string' ? opt : opt.name;
                    const color = typeof opt === 'object' ? opt.color : getStatusHexColor(name);
                    
                    const item = document.createElement('div');
                    item.className = "flex items-center mr-4 mb-2";
                    item.innerHTML = `
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color};"></span>
                        <span class="text-xs text-gray-600 dark:text-gray-300">${name}</span>
                    `;
                    legendContainer.appendChild(item);
                });
            }
        }

        // פונקציית עזר ליצירת כפתור מעוצב (קפסולה)
        function createFilterChip(label, value, color, isSelected) {
            const btn = document.createElement('button');
            btn.dataset.value = value;
            
            // עיצוב משודרג לקפסולות
            let baseClasses = "px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-200 border shadow-sm flex items-center gap-2 ";
            
            if (isSelected) {
                // מצב נבחר: צבע מלא, צללית זוהרת
                btn.style.backgroundColor = color;
                btn.style.borderColor = color;
                btn.style.color = 'white'; 
                // אייקון וי קטן ליד השם
                btn.innerHTML = `<span>${label}</span><svg class="w-3 h-3 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                
                // אפקט לחיצה
                btn.classList.add('transform', 'scale-105', 'ring-2', 'ring-offset-2', 'dark:ring-offset-gray-900');
                btn.style.setProperty('--tw-ring-color', color + '80'); // 50% opacity ring
            } else {
                // מצב לא נבחר: רקע לבן נקי (בולט על הרקע האפור של המגש)
                btn.style.backgroundColor = document.documentElement.classList.contains('dark') ? '#1f2937' : 'white';
                btn.style.borderColor = 'transparent'; // ללא מסגרת בולטת במצב רגיל
                btn.style.color = document.documentElement.classList.contains('dark') ? '#d1d5db' : '#4b5563';
                
                // אינדיקטור צבע קטן (עיגול) ליד השם
                if (value !== 'all') {
                    btn.innerHTML = `<span class="w-2 h-2 rounded-full" style="background-color: ${color};"></span><span>${label}</span>`;
                } else {
                    btn.textContent = label;
                }
                
                // הוספת הברקה במעבר עכבר
                btn.classList.add('hover:bg-white', 'hover:shadow-md', 'dark:hover:bg-gray-700');
            }
            
            btn.className = baseClasses + " select-none";
            return btn;
        }

        // פונקציית שינוי פילטר (עובדת על הזיכרון בלבד)
        function toggleCategoryFilter(value) {
            if (value === 'all') {
                selectedCategories.clear();
                selectedCategories.add('all');
            } else {
                selectedCategories.delete('all');
                if (selectedCategories.has(value)) {
                    selectedCategories.delete(value);
                    if (selectedCategories.size === 0) selectedCategories.add('all');
                } else {
                    selectedCategories.add(value);
                }
            }
            // בנייה מחדש של הכפתורים (לצורך ויזואלי)
            setupPlannerTab(); 
            
            // חשוב: setupPlannerTab קורא ל-loadMonthDataAndRender, 
            // אבל בגלל ה-IF שם, הוא יראה שלא החלפנו חודש וישתמש בזיכרון!
        }

        // משתנה גלובלי לוודא שהאנימציה קורית רק פעם אחת
        let hasShownPinchHint = false;

        function triggerPinchAnimation() {
            // אם כבר הראינו את הרמז, או שאנחנו לא במובייל - לא לעשות כלום
            if (hasShownPinchHint || window.innerWidth > 768) return;
            
            const container = document.getElementById('planner-scroll-container');
            if (!container) return;

            hasShownPinchHint = true; // מסמנים שהראינו

            // יצירת האלמנטים של האנימציה
            const hintLayer = document.createElement('div');
            hintLayer.className = 'pinch-hint-layer';
            
            const fingerLeft = document.createElement('div');
            fingerLeft.className = 'pinch-finger finger-left';
            
            const fingerRight = document.createElement('div');
            fingerRight.className = 'pinch-finger finger-right';
            
            hintLayer.appendChild(fingerLeft);
            hintLayer.appendChild(fingerRight);
            
            // הוספה לקונטיינר (חייב להיות relative כדי שה-absolute יעבוד בפנים)
            // נוודא שהקונטיינר relative
            if (getComputedStyle(container).position === 'static') {
                container.style.position = 'relative';
            }
            container.appendChild(hintLayer);

            // מחיקת האלמנטים בסיום האנימציה (אחרי 1.6 שניות)
            setTimeout(() => {
                if (hintLayer.parentNode) {
                    hintLayer.parentNode.removeChild(hintLayer);
                }
            }, 1600);
        }

        // 4. פונקציית Pinch-to-Zoom למובייל
        function setupCalendarPinchZoom() {
            const container = document.getElementById('planner-scroll-container');
            const grid = document.getElementById('planner-inner-grid');
            
            if (!container || !grid) return;

            // --- תוספת חדשה: הפעלת אנימציית הרמז בנגיעה הראשונה ---
            container.addEventListener('touchstart', () => {
                // אם הגריד עדיין מכווץ, נפעיל את הרמז
                if (!grid.classList.contains('expanded')) {
                    triggerPinchAnimation();
                }
            }, { once: true, passive: true }); // once: true מבטיח שזה יקרה רק פעם אחת לאלמנט הזה
            // -------------------------------------------------------

            let initialDistance = 0;
            let isPinching = false;

            // פונקציה לחישוב מרחק בין שתי אצבעות
            const getDistance = (touches) => {
                return Math.hypot(
                    touches[0].pageX - touches[1].pageX,
                    touches[0].pageY - touches[1].pageY
                );
            };

            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    isPinching = true;
                    initialDistance = getDistance(e.touches);
                }
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!isPinching || e.touches.length !== 2) return;

                const currentDistance = getDistance(e.touches);
                const diff = currentDistance - initialDistance;

                // רגישות הצביטה (50 פיקסלים)
                if (diff > 50) { 
                    // Pinch Out (Expand) -> כמו מחשב
                    grid.classList.add('expanded');
                    // מוסיף min-width כדי לאפשר גלילה
                    grid.style.minWidth = '800px'; 
                    isPinching = false; // Reset to prevent flickering
                    
                    // אופציונלי: אם המשתמש הצליח להרחיב, נסמן שכבר הראינו רמז (למקרה שלא הספיק להופיע)
                    hasShownPinchHint = true;
                } else if (diff < -50) {
                    // Pinch In (Shrink) -> כמו אייפון
                    grid.classList.remove('expanded');
                    // מסיר min-width כדי שייכנס למסך
                    grid.style.minWidth = '100%';
                    isPinching = false;
                }
            }, { passive: true });

            container.addEventListener('touchend', () => {
                isPinching = false;
            });
        }

        // 5. פונקציית אתחול הטאב
        window.setupPlannerTab = async function() {
            // --- בדיקת חסימה ---
            const isAllowed = await enforceCompanyStatus('planner-grid');
            if (!isAllowed) return; // עצור הכל אם חסום
            // -------------------

            const pGroup = document.getElementById('planner-group-filter');
            const pEmployee = document.getElementById('planner-employee-filter');
            const chipsContainer = document.getElementById('planner-category-chips');
            
            // --- 1. בניית כפתורי קטגוריות ---
            if (chipsContainer) {
                chipsContainer.innerHTML = '';
                // כפתור הכל
                const allBtn = createFilterChip('All', 'all', '#6b7280', selectedCategories.has('all'));
                allBtn.onclick = () => toggleCategoryFilter('all');
                chipsContainer.appendChild(allBtn);

                // שאר הכפתורים
                if (typeof globalAttendanceOptions !== 'undefined') {
                    globalAttendanceOptions.forEach(opt => {
                        const name = typeof opt === 'string' ? opt : opt.name;
                        const color = typeof opt === 'object' ? opt.color : getStatusHexColor(name);
                        
                        const btn = createFilterChip(name, name, color, selectedCategories.has(name));
                        btn.onclick = () => toggleCategoryFilter(name);
                        chipsContainer.appendChild(btn);
                    });
                }
            }

            // --- 2. אתחול דרופ-דאונים ---
            let safeGroups = typeof availableGroups !== 'undefined' ? availableGroups : ["General"];
            
            if (pGroup && pGroup.options.length <= 1) {
                pGroup.innerHTML = '<option value="all">All Groups</option>';
                safeGroups.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g; opt.textContent = g;
                    pGroup.appendChild(opt);
                });

                // === [התיקון החדש] ===
                // אם למשתמש יש קבוצה מוגדרת (והוא TL/Admin), נבחר אותה כברירת מחדל
                if (currentUserProfile && currentUserProfile.group) {
                    // בודקים אם הקבוצה קיימת ברשימה כדי למנוע שגיאות
                    if (safeGroups.includes(currentUserProfile.group)) {
                        pGroup.value = currentUserProfile.group;
                    }
                }
                // =====================

                // בעת שינוי קבוצה - קריאה לשרת (forceRefresh = true)
                // כי אם שיניתי קבוצה, אני בהכרח צריך נתונים חדשים מהשרת
                pGroup.onchange = () => { 
                    updateEmployeeList(); 
                    loadMonthDataAndRender(true); // <--- השינוי: מעבירים true כדי להכריח שליפה מהשרת
                };
            }

            if (pEmployee) {
                pEmployee.onchange = () => renderPlannerGrid();
            }
            
            // --- 3. טעינה ראשונית ---
            updateEmployeeList();
            renderPlannerLegend();
            
            // כאן אנחנו קוראים לטעינה מהשרת (כי זו כניסה ראשונה לטאב)
            loadMonthDataAndRender();
            
            // --- 4. הפעלת מאזיני Pinch-to-Zoom ---
            setupCalendarPinchZoom();
        }

        // פונקציה שמחליטה מתי לגשת לשרת
        async function loadMonthDataAndRender(forceRefresh = false) {
            const grid = document.getElementById('planner-grid');
            const monthTitle = document.getElementById('planner-month-year');
            
            // קריאת הפילטר הנוכחי
            const selectedGroup = document.getElementById('planner-group-filter')?.value || 'all';

            // מפתח מטמון משופר שכולל גם את הקבוצה!
            // כך אם נעבור קבוצה, המערכת תדע שצריך למשוך מחדש
            const currentCacheKey = `${plannerDate.getFullYear()}-${plannerDate.getMonth()}-${selectedGroup}`;
            
            monthTitle.textContent = plannerDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // שימוש במטמון אם לא השתנה כלום
            if (!forceRefresh && lastLoadedMonth === currentCacheKey && Object.keys(currentMonthData).length > 0) {
                renderPlannerGrid();
                return;
            }

            // --- גישה לשרת (רק אם החודש או הקבוצה השתנו) ---
            grid.innerHTML = '<div class="col-span-7 p-8 text-center text-gray-500 flex justify-center"><svg class="animate-spin h-5 w-5 mr-3 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Fetching team data...</div>';
            
            try {
                const year = plannerDate.getFullYear();
                const month = plannerDate.getMonth();
                const relevantWeeks = getWeeksInMonth(year, month);
                
                // שליפה מהשרת עם הסינון!
                currentMonthData = await fetchMonthlyAttendance(relevantWeeks, selectedGroup);
                lastLoadedMonth = currentCacheKey; // עדכון מפתח המטמון

                renderPlannerGrid();

            } catch (error) {
                console.error("Error loading month data:", error);
                grid.innerHTML = `<div class="col-span-7 p-4 text-center text-red-500">Connection Error</div>`;
            }
        }

        // פונקציה לפתיחת המודל של "הצג עוד"
        function openMoreEventsModal(dateString, events) {
            const modal = document.getElementById('planner-more-modal');
            const title = document.getElementById('planner-more-title');
            const list = document.getElementById('planner-more-list');
            
            if (!modal || !title || !list) return;

            // 1. עדכון הכותרת
            title.textContent = dateString;

            // 2. ניקוי ובניית הרשימה
            list.innerHTML = '';
            
            events.forEach(evt => {
                const item = document.createElement('div');
                // עיצוב זהה לשורה בלוח שנה, רק גדול יותר
                item.className = "flex items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors border border-transparent hover:border-gray-100 dark:hover:border-gray-600";
                
                // רקע עדין לצבע
                const bgStyle = `background-color: ${evt.color}15;`; // 15 = שקיפות מאוד נמוכה
                
                item.innerHTML = `
                    <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 shrink-0" style="${bgStyle}">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${evt.color};"></span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-gray-900 dark:text-white truncate">${evt.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${evt.status}</p>
                    </div>
                `;
                list.appendChild(item);
            });

            // 3. הצגת המודל
            modal.classList.remove('hidden');
        }

        // 5. הפונקציה הראשית: ציור לוח השנה (לחיצה על כל התא פותחת את המודל)
        function renderPlannerGrid() {
            const grid = document.getElementById('planner-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            const year = plannerDate.getFullYear();
            const month = plannerDate.getMonth();
            
            // --- קריאת הפילטרים ---
            const selectedGroup = document.getElementById('planner-group-filter')?.value || 'all';
            const selectedEmployee = document.getElementById('planner-employee-filter')?.value || 'all';
            let usersToShow = allUsersCache || [];
            
            if (selectedGroup !== 'all') usersToShow = usersToShow.filter(u => u.group === selectedGroup);
            if (selectedEmployee !== 'all') usersToShow = usersToShow.filter(u => u.id === selectedEmployee);
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            // תאים ריקים
            for (let i = 0; i < firstDayOfMonth; i++) {
                const cell = document.createElement('div');
                cell.className = 'planner-day-cell other-month';
                grid.appendChild(cell);
            }
            // ימי החודש
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDayDate = new Date(year, month, day);
                const dayOfWeek = currentDayDate.getDay(); 
                const isToday = (day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear());
                
                const cell = document.createElement('div');
                cell.className = `planner-day-cell ${isToday ? 'today' : ''}`;
                cell.innerHTML = `<div class="planner-day-number">${day}</div>`;
                
                if (typeof globalWorkDays !== 'undefined' && globalWorkDays.includes(dayOfWeek)) {
                    const weekId = getWeekId(currentDayDate);
                    let eventsToShow = [];
                    
                    usersToShow.forEach(user => {
                        const key = `${weekId}_${user.id || user.uid}`;
                        const userWeekData = currentMonthData[key]; 
                        
                        if (userWeekData && userWeekData[dayOfWeek]) {
                            const status = userWeekData[dayOfWeek];
                            if (!status || status === '---') return;
                            if (!selectedCategories.has('all') && !selectedCategories.has(status)) return;
                            eventsToShow.push({
                                name: user.fullName || user.username,
                                status: status,
                                color: getStatusHexColor(status)
                            });
                        }
                    });
                    // --- כאן השינוי הגדול: אם יש אירועים, התא כולו הופך ללחיץ ---
                    if (eventsToShow.length > 0) {
                        // 1. הוספת סמן יד ועיצוב לחיץ
                        cell.classList.add('cursor-pointer', 'hover:bg-purple-50', 'dark:hover:bg-gray-700', 'transition-colors');
                        cell.title = "Click to view full list"; // Tooltip
                        // 2. אירוע הלחיצה על כל הקובייה
                        cell.onclick = () => {
                            const dateStr = currentDayDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                            openMoreEventsModal(dateStr, eventsToShow);
                        };
                        // מיון והצגה
                        eventsToShow.sort((a,b) => a.name.localeCompare(b.name));
                        const maxItems = 4;
                        
                        // 1. יצירת אלמנטים למצב "רחב" (כמו שהיה קודם)
                        eventsToShow.slice(0, maxItems).forEach(evt => {
                            const row = document.createElement('div');
                            row.className = 'planner-event-row'; 
                            row.style.backgroundColor = evt.color + '20'; 
                            const isDark = document.documentElement.classList.contains('dark');
                            row.style.color = isDark ? '#fff' : '#000';
                            
                            row.innerHTML = `
                                <span class="planner-dot" style="background-color: ${evt.color}"></span>
                                <span class="truncate">${evt.name}</span>
                            `;
                            // אין צורך ב-onclick כאן כי התא כולו לחיץ
                            cell.appendChild(row);
                        });

                        if (eventsToShow.length > maxItems) {
                            const more = document.createElement('div');
                            more.className = 'text-[10px] text-gray-500 font-bold pl-1 mt-1';
                            more.textContent = `+${eventsToShow.length - maxItems} more`;
                            cell.appendChild(more);
                        }

                        // --- [חדש] יצירת קונטיינר נקודות למצב "מכווץ" (מובייל) ---
                        const dotsContainer = document.createElement('div');
                        dotsContainer.className = 'mobile-dots-container';
                        
                        // מציגים עד 5 נקודות כדי לא להעמיס
                        eventsToShow.slice(0, 5).forEach(evt => {
                            const dot = document.createElement('div');
                            // נקודה קטנה ויפה
                            dot.style.cssText = `width: 6px; height: 6px; border-radius: 50%; background-color: ${evt.color};`;
                            dotsContainer.appendChild(dot);
                        });
                        
                        // אם יש יותר מ-5, נוסיף נקודה אפורה פלוס
                        if (eventsToShow.length > 5) {
                            const plusDot = document.createElement('div');
                            plusDot.style.cssText = `width: 6px; height: 6px; border-radius: 50%; background-color: #9ca3af;`; // Gray
                            dotsContainer.appendChild(plusDot);
                        }
                        
                        cell.appendChild(dotsContainer);
                    }
                } else {
                    cell.classList.add('bg-gray-50', 'dark:bg-gray-800/50');
                }
                grid.appendChild(cell);
            }
        }

        // ניווט חודשים - רק זה יגרום לקריאה לשרת
        document.getElementById('planner-prev-month').addEventListener('click', () => {
            plannerDate.setMonth(plannerDate.getMonth() - 1);
            loadMonthDataAndRender(); // קריאה לשרת כי החודש השתנה
        });
        document.getElementById('planner-next-month').addEventListener('click', () => {
            plannerDate.setMonth(plannerDate.getMonth() + 1);
            loadMonthDataAndRender(); // קריאה לשרת כי החודש השתנה
        });

        // --- Request Management Logic ---
        
        let requestRangeStart = null;
        let requestRangeEnd = null;
        let currentCalDate = new Date();
        let historyUnsubscribe = null;
        let currentAdminAction = null;

        // פונקציה חכמה שממירה כל דבר לתאריך תקין ולא קורסת
        function getSafeDateString(val) {
            try {
                if (!val) return "N/A"; // אם אין ערך
                if (val.toDate && typeof val.toDate === 'function') {
                    return val.toDate().toLocaleDateString(); // אם זה Timestamp של Firebase
                }
                if (val instanceof Date) {
                    return val.toLocaleDateString(); // אם זה כבר תאריך רגיל
                }
                // ניסיון להמיר מחרוזת או מספר
                return new Date(val).toLocaleDateString();
            } catch (e) {
                console.warn("Date error:", e);
                return "Invalid Date";
            }
        }
        
        // --- לוגיקה לפתיחה/סגירה עם אנימציה חלקה ונעילת גלילה ---

        function animateModalOpen(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('.modal-content');
            
            // 1. נעילת גלילה הרמטית (מונע מהרקע לזוז)
            document.documentElement.style.overflow = 'hidden'; // קריטי לאייפון
            document.body.style.overflow = 'hidden';
            
            // 2. הסרת ההסתרה (אבל עדיין שקוף)
            modal.classList.remove('hidden');
            
            // 3. טריק ה-Double RAF: מבטיח שהדפדפן צייר את האלמנט השקוף *לפני* שמתחילים לשנות אותו
            // זה מונע את ה"קפיצה" השחורה ומחליק את הכניסה
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // הנפשת הרקע (Fade In)
                    modal.classList.remove('opacity-0');
                    
                    // הנפשת התוכן (Scale Up + Fade In)
                    content.classList.remove('scale-90', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                });
            });
        }

        function animateModalClose(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('.modal-content');
            
            // 1. החזרת המצב השקוף והמוקטן (מתחיל את אנימציית היציאה)
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-90', 'opacity-0');
            
            // 2. שחרור הגלילה מיד (או אפשר לחכות לסוף האנימציה, אבל עדיף מיד לחוויה זריזה)
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            
            // 3. המתנה לסיום האנימציה לפני הסתרה מלאה
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // תואם ל-duration-300 ב-CSS
        }

        // פתיחת מודל בקשה חדשה
        if (document.getElementById('new-request-btn')) {
            document.getElementById('new-request-btn').addEventListener('click', () => {
                // איפוס
                requestRangeStart = null;
                requestRangeEnd = null;
                currentCalDate = new Date(); // תמיד מתחילים מהחודש הנוכחי
                renderCalendar();
                updateRequestSummary();
                
                // מילוי הדרופדאון מהגדרות החברה
                const typeSelect = document.getElementById('request-type-select');
                typeSelect.innerHTML = '';
                globalAttendanceOptions.forEach(opt => {
                    const name = typeof opt === 'string' ? opt : opt.name;
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    typeSelect.appendChild(option);
                });
                // ברירת מחדל חכמה: חפש את Vacation או קח את השני ברשימה (בדרך כלל לא Office)
                const defaultType = globalAttendanceOptions.find(o => (typeof o === 'string' ? o : o.name).toLowerCase().includes('vacation'));
                if(defaultType) typeSelect.value = typeof defaultType === 'string' ? defaultType : defaultType.name;

                // [שינוי] שימוש בפונקציית האנימציה
                animateModalOpen('request-modal');
            });
        }

        if (document.getElementById('close-request-modal')) {
            document.getElementById('close-request-modal').addEventListener('click', () => {
                // [שינוי] שימוש בפונקציית האנימציה
                animateModalClose('request-modal');
            });
        }

        // --- לוגיקת לוח שנה (Flight Booking Style) ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthYear = document.getElementById('cal-month-year');
            if (!grid || !monthYear) return;
            
            grid.innerHTML = '';
            
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            
            monthYear.textContent = currentCalDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay(); // 0 = Sun
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // תאים ריקים להתחלה
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'cal-day empty';
                grid.appendChild(empty);
            }
            
            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'cal-day';
                cell.textContent = d;
                
                // תאריך מלא להשוואה
                const thisDate = new Date(year, month, d);
                thisDate.setHours(0,0,0,0);
                
                // סימון ימים נבחרים
                if (requestRangeStart && thisDate.getTime() === requestRangeStart.getTime()) {
                    cell.classList.add('selected', 'range-start');
                }
                if (requestRangeEnd && thisDate.getTime() === requestRangeEnd.getTime()) {
                    cell.classList.add('selected', 'range-end');
                }
                if (requestRangeStart && requestRangeEnd && thisDate > requestRangeStart && thisDate < requestRangeEnd) {
                    cell.classList.add('in-range');
                }
                
                // קליק על יום
                cell.addEventListener('click', () => {
                    handleDateSelection(thisDate);
                });
                
                grid.appendChild(cell);
            }
        }

        function handleDateSelection(date) {
            if (!requestRangeStart || (requestRangeStart && requestRangeEnd)) {
                // התחלה חדשה
                requestRangeStart = date;
                requestRangeEnd = null;
            } else if (date < requestRangeStart) {
                // אם לחץ על תאריך לפני ההתחלה - זה הופך להתחלה החדשה
                requestRangeStart = date;
            } else {
                // בחירת תאריך סיום
                requestRangeEnd = date;
            }
            renderCalendar();
            updateRequestSummary();
        }

        if (document.getElementById('cal-prev')) {
            document.getElementById('cal-prev').addEventListener('click', () => {
                currentCalDate.setMonth(currentCalDate.getMonth() - 1);
                renderCalendar();
            });
        }
        
        if (document.getElementById('cal-next')) {
            document.getElementById('cal-next').addEventListener('click', () => {
                currentCalDate.setMonth(currentCalDate.getMonth() + 1);
                renderCalendar();
            });
        }

        function updateRequestSummary() {
            const startEl = document.getElementById('display-start-date');
            const endEl = document.getElementById('display-end-date');
            const countEl = document.getElementById('total-days-count');
            const btn = document.getElementById('submit-request-btn');
            
            if (!startEl || !endEl || !countEl || !btn) return;
            
            if (requestRangeStart) {
                startEl.textContent = requestRangeStart.toLocaleDateString();
                startEl.classList.add('text-gray-900', 'dark:text-white');
            } else {
                startEl.textContent = "Select start";
            }
            
            if (requestRangeEnd) {
                endEl.textContent = requestRangeEnd.toLocaleDateString();
                endEl.classList.add('text-gray-900', 'dark:text-white');
                
                // חישוב ימי עבודה בטווח
                let count = 0;
                let loopDate = new Date(requestRangeStart);
                while (loopDate <= requestRangeEnd) {
                    if (globalWorkDays.includes(loopDate.getDay())) {
                        count++;
                    }
                    loopDate.setDate(loopDate.getDate() + 1);
                }
                countEl.textContent = count;
                btn.disabled = false;
            } else {
                endEl.textContent = "Select end";
                countEl.textContent = "0";
                
                // Reset mobile counter
                const mobileCountEl = document.getElementById('mobile-total-days');
                if(mobileCountEl) mobileCountEl.textContent = "0";
                
                btn.disabled = true;
            }
        }

        // --- שליחת הבקשה ---
        if (document.getElementById('submit-request-btn')) {
            document.getElementById('submit-request-btn').addEventListener('click', async () => {
                if (!requestRangeStart || !requestRangeEnd) return;
                
                const btn = document.getElementById('submit-request-btn');
                btn.disabled = true;
                btn.textContent = "Sending...";
                
                try {
                    const type = document.getElementById('request-type-select').value;
                    
                    // --- חישוב מספר ימי העבודה לשמירה ---
                    let totalDuration = 0;
                    let loopDate = new Date(requestRangeStart);
                    // יוצרים עותק של תאריך הסיום כדי לא לשבש לוגיקה אחרת
                    const loopEnd = new Date(requestRangeEnd);
                    
                    while (loopDate <= loopEnd) {
                        // בודק אם היום הנוכחי הוא יום עבודה לפי ההגדרות
                        if (globalWorkDays.includes(loopDate.getDay())) {
                            totalDuration++;
                        }
                        loopDate.setDate(loopDate.getDate() + 1);
                    }
                    // -------------------------------------
                    
                    await addDoc(collection(db, "requests"), {
                        userId: currentUser.uid,
                        userName: currentUserProfile.fullName,
                        userEmail: currentUserProfile.email,
                        group: currentUserProfile.group,
                        companyId: currentUserProfile.companyId,
                        startDate: Timestamp.fromDate(requestRangeStart),
                        endDate: Timestamp.fromDate(requestRangeEnd),
                        type: type,
                        duration: totalDuration, // <--- הנה השדה החדש שנוסף!
                        status: 'pending',
                        createdAt: Timestamp.now()
                    });
                    
                    // [שינוי] שימוש בפונקציית האנימציה
                    animateModalClose('request-modal');
                    showConfirmationModal('Request Sent', 'Your request has been sent to your team leader.', ()=>{});
                    // loadMyRequests(); // ⚠️ לא צריך - onSnapshot יעדכן אוטומטית!
                } catch (error) {
                    console.error("Error sending request:", error);
                    alert("Failed to send request.");
                } finally {
                    btn.textContent = "Send Request";
                }
            });
        }

        // --- Sub-tabs למנהלים (My Personal / Team Inbox) ---
        // --- Sub-tabs למנהלים (My Personal / Team Inbox) - עם הסתרת כפתור יצירה ---
        function setupRequestSubTabs() {
            const btnPersonal = document.getElementById('sub-req-personal');
            const btnTeam = document.getElementById('sub-req-team');
            const viewPersonal = document.getElementById('view-personal-requests');
            const viewTeam = document.getElementById('view-team-requests');
            const newRequestBtn = document.getElementById('new-request-btn'); // הכפתור שאנחנו רוצים להסתיר

            // פונקציה לעיצוב הכפתור הפעיל
            const setActive = (isPersonal) => {
                const baseClasses = "flex-1 py-3 rounded-xl text-base sm:text-lg transition-all duration-200"; 
                
                const activeClass = `${baseClasses} font-bold shadow-md bg-white dark:bg-gray-600 text-gray-900 dark:text-white transform scale-[1.02]`;
                const inactiveClass = `${baseClasses} font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200`;

                if (isPersonal) {
                    // --- מצב אישי (My Personal) ---
                    viewPersonal.classList.remove('hidden');
                    viewTeam.classList.add('hidden');
                    
                    btnPersonal.className = activeClass;
                    btnTeam.className = inactiveClass + " flex items-center justify-center gap-2";

                    // טיפול בכפתור New Request: הצג תמיד
                    if (newRequestBtn) {
                        newRequestBtn.classList.remove('hidden', 'md:flex'); // איפוס הגדרות הסתרה
                        newRequestBtn.classList.add('flex'); // וודא שמוצג
                    }

                } else {
                    // --- מצב צוות (Team Inbox) ---
                    viewPersonal.classList.add('hidden');
                    viewTeam.classList.remove('hidden');
                    
                    btnTeam.className = activeClass + " flex items-center justify-center gap-2"; 
                    btnPersonal.className = inactiveClass;

                    // טעינת נתוני הצוות רק כשלוחצים על הכפתור (lazy loading)
                    loadManagerInbox();

                    // טיפול בכפתור New Request: הסתר במובייל, הצג במחשב
                    if (newRequestBtn) {
                        newRequestBtn.classList.remove('flex'); // הסרת התצוגה הרגילה
                        newRequestBtn.classList.add('hidden', 'md:flex'); // מוסתר בברירת מחדל (מובייל), גמיש במסכים בינוניים+ (מחשב)
                    }
                }
            };

            if(btnPersonal) btnPersonal.onclick = () => setActive(true);
            if(btnTeam) btnTeam.onclick = () => setActive(false);
            
            const groupFilter = document.getElementById('team-filter-group');
            if (groupFilter && groupFilter.options.length <= 1) {
                availableGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupFilter.appendChild(option);
                });
            }
        }        // --- טעינת הבקשות שלי ועדכון משתנה ההתראה ---
        // --- טעינת הבקשות שלי (My Personal) - עם Pagination חכמה ---
        function loadMyRequests() {
            const list = document.getElementById('my-requests-list');
            
            // --- Guard Clause: אם הרשימה לא קיימת, עצור הכל ---
            if (!list) return;
            // --------------------------------------------------
            
            const showMoreBtn = document.getElementById('show-more-requests-btn');
            
            if (myRequestsUnsubscribe) myRequestsUnsubscribe();

            // Skeleton Loading רק אם הרשימה ריקה לגמרי (טעינה ראשונה)
            if (list.children.length === 0 || list.innerHTML.includes('Loading')) {
                list.innerHTML = '<div class="animate-pulse flex space-x-4"><div class="h-16 w-full bg-gray-100 dark:bg-gray-800 rounded-xl"></div></div>';
            }
            
            // --- השינוי המרכזי: הוספת limit לשאילתה עם +1 לזיהוי אם יש עוד נתונים ---
            const q = query(collection(db, "requests"), 
                where("userId", "==", currentUser.uid),
                orderBy("createdAt", "desc"),
                limit(currentRequestsLimit + 1) // טוען X+1 מסמכים כדי לזהות אם יש עוד
            );
            
            myRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                list.innerHTML = '';
                
                // --- ניהול מצב הכפתור מחדש בכל טעינה ---
                if (showMoreBtn) {
                    // איפוס הכפתור למצב "רגיל" (למקרה שהוא היה ב-Loading)
                    showMoreBtn.disabled = false;
                    showMoreBtn.innerHTML = `
                        <span class="mr-2">Load previous requests</span>
                        <svg class="w-4 h-4 transition-transform group-hover:translate-y-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    `;

                    // האם להציג אותו בכלל?
                    if (snapshot.size > currentRequestsLimit) {
                        showMoreBtn.classList.remove('hidden');
                    } else {
                        // הגענו לסוף ההיסטוריה
                        showMoreBtn.classList.add('hidden');
                    }
                }
                // ----------------------------------------
                
                if(snapshot.empty) {
                    list.innerHTML = '<div class="text-center py-8"><p class="text-gray-400 text-sm">No request history found.</p></div>';
                    if(showMoreBtn) showMoreBtn.classList.add('hidden');
                    maxMyRequestTime = 0;
                    checkNotificationDot();
                    return;
                }
                
                let tempMaxTime = 0;

                let index = 0; // מונה לחישוב המיקום

                snapshot.docs.forEach((doc, docIndex) => {
                    // דלג על הפריט הנוסף אם הוא מעבר לגבול
                    if (docIndex >= currentRequestsLimit) return;
                    
                    const data = doc.data();
                    
                    // --- קוד חישוב תאריכים ועיצוב (המקורי) ---
                    const start = getSafeDateString(data.startDate);
                    const end = getSafeDateString(data.endDate);
                    
                    if (data.status !== 'pending') {
                        let t = 0;
                        if (data.updatedAtMs) t = data.updatedAtMs;
                        else if (data.updatedAt && data.updatedAt.toDate) t = data.updatedAt.toDate().getTime();
                        if (t > tempMaxTime) tempMaxTime = t;
                    }

                    let statusBadge = '';
                    if(data.status === 'pending') {
                        statusBadge = `<span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full border border-yellow-200 shadow-sm flex items-center gap-1.5"><span class="w-1.5 h-1.5 bg-yellow-500 rounded-full animate-pulse"></span> Pending</span>`;
                    } else if(data.status === 'approved') {
                        statusBadge = `<span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-bold rounded-full border border-green-200 shadow-sm">Approved</span>`;
                    } else if(data.status === 'rejected') {
                        statusBadge = `<span class="px-3 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full border border-red-200 shadow-sm">Rejected</span>`;
                    }

                    let actionButton = '';
                    if (data.status === 'pending') {
                        actionButton = `<button class="cancel-my-request-btn text-xs bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-3 py-1 rounded-full font-medium transition-colors" data-id="${doc.id}">Cancel</button>`;
                    }
                    
                    const durationText = data.duration ? `• ${data.duration} Days` : '';
                    
                    // --- יצירת האלמנט עם אפקט ה-Sticky ---
                    const item = document.createElement('div');
                    
                    // 1. מחזירים את העיצוב המקורי (בלי התיקייה הכהה)
                    item.className = "p-4 bg-gray-50 dark:bg-gray-700/90 backdrop-blur-sm rounded-lg border dark:border-gray-600 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8 transition-all shadow-sm hover:shadow-md origin-top";
                    
                    // 2. הגדרות ה-Sticky (הקסם קורה כאן)
                    item.style.position = 'sticky';
                    item.style.top = '10px'; // עצירה ב-10 פיקסל (מתחת לקצה)
                    item.style.zIndex = index + 1; // שומר על הסדר (הכי חדש למעלה או למטה לפי המיון)
                    
                    // תיקון קטן: צללית חזקה יותר כדי להבדיל בין הכרטיסים כשהם אחד על השני
                    item.style.boxShadow = "0 -4px 10px -2px rgba(0,0,0,0.05), 0 4px 6px -1px rgba(0,0,0,0.1)";

                    // 3. תוכן הכרטיס (המקורי שלך)
                    item.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center justify-between sm:justify-start mb-1">
                                <p class="font-extrabold text-lg bg-gradient-to-r from-purple-600 to-pink-500 bg-clip-text text-transparent drop-shadow-sm">${data.type}</p>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2 font-medium">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                ${start} - ${end} <span class="text-gray-400 font-normal ml-1">${durationText}</span>
                            </div>
                            ${data.managerNote ? `<div class="mt-2 text-xs bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-300 p-2 rounded border-l-2 border-blue-400 inline-block"><span class="font-bold">Manager Note:</span> ${data.managerNote}</div>` : ''}
                        </div>
                        <div class="mt-1 sm:mt-0 flex items-center gap-3 justify-end">
                            ${actionButton} ${statusBadge}
                        </div>
                    `;
                    list.appendChild(item);
                    index++;
                });
                
                // --- הפעלת אפקט הגלגל ---
                initRolodexEffect('my-requests-list'); 
                // -----------------------

                maxMyRequestTime = tempMaxTime;
                checkNotificationDot();

                // --- הוסף את זה מיד אחרי סיום הלולאה בתוך loadMyRequests ---
                document.querySelectorAll('.cancel-my-request-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const reqId = e.target.dataset.id;
                        showConfirmationModal(
                            'Cancel Request',
                            'Are you sure you want to cancel this pending request?',
                            async () => {
                                try {
                                    // מחיקת הבקשה מהדאטהבייס
                                    await deleteDoc(doc(db, "requests", reqId));
                                    // אין צורך לרענן ידנית - ה-Listener יעדכן את המסך לבד
                                    showConfirmationModal('Cancelled', 'Your request has been cancelled.', () => {});
                                } catch (error) {
                                    console.error("Error cancelling request:", error);
                                    showConfirmationModal('Error', 'Failed to cancel request.', () => {});
                                }
                            }
                        );
                    });
                });

            }, (error) => {
                console.error("Error loading requests:", error);
                list.innerHTML = `<p class="text-red-500 text-sm">Sync error.</p>`;
            });
        }

        // --- טעינת בקשות משתמשים חדשים (Pending Registrations) ---
        function loadPendingRegistrations() {
            const section = document.getElementById('pending-registrations-section');
            const container = document.getElementById('pending-users-container');
            const actions = document.getElementById('pending-actions-container');
            
            if (pendingUsersUnsubscribe) pendingUsersUnsubscribe();

            // שאילתה בסיסית
            let q = query(
                collection(db, "pendingUsers"), 
                where("status", "==", "pending"),
                where("companyId", "==", currentUserProfile.companyId)
            );

            // סינון לקבוצה אם זה לא סופר אדמין
            if (!currentUserProfile.isSuperAdmin) {
                const userGroup = currentUserProfile.group;
                if (userGroup) {
                    const groupsToQuery = ["DT", "DV", "FW"].includes(userGroup) ? ["DT", "DV", "FW"] : [userGroup];
                    q = query(
                        collection(db, "pendingUsers"), 
                        where("status", "==", "pending"), 
                        where("companyId", "==", currentUserProfile.companyId),
                        where("group", "in", groupsToQuery)
                    );
                }
            }

            pendingUsersUnsubscribe = onSnapshot(q, (snapshot) => {
                pendingUsersSnapshot = snapshot;
                
                // === [התיקון] קריאה לפונקציה המרכזית במקום עדכון מקומי ===
                updateTeamInboxBadge(); 
                // ========================================================

                if (snapshot.empty) {
                    section.classList.add('hidden');
                    return;
                }

                // יש נתונים - מציגים את הסקשן
                section.classList.remove('hidden');
                actions.classList.remove('hidden');
                container.innerHTML = '';

                snapshot.forEach(doc => {
    const data = doc.data();
    
    // יצירת אלמנט עוטף (במקום string html שהיה במקור, אנחנו יוצרים אלמנטים כדי שיהיה קל לנהל)
    const card = document.createElement('div');
    // זה העיצוב המקורי: אפור בהיר, בורדר, פריסה לרוחב
    card.className = "p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4";
    
    card.innerHTML = `
        <div>
            <p class="font-bold text-gray-800 dark:text-gray-200">${data.fullName}</p>
            <p class="text-sm text-gray-600 dark:text-gray-400">${data.email}</p>
            <p class="text-sm text-gray-500 dark:text-gray-500">Group: ${data.group}</p>
        </div>
        <div class="flex items-center space-x-2">
            <button class="approve-user-btn btn btn-success text-sm py-2 px-3" data-doc-id="${doc.id}">Approve</button>
            <button class="reject-user-btn btn btn-danger text-sm py-2 px-3" data-doc-id="${doc.id}">Reject</button>
        </div>
    `;
    container.appendChild(card);
});

                // חיבור כפתורי ה-Approve All ו-Reject All
                const approveBtn = document.getElementById('approve-all-btn');
                const rejectBtn = document.getElementById('reject-all-btn');
                // שימוש ב-cloneNode כדי לנקות מאזינים ישנים
                if (approveBtn) {
                    const newBtn = approveBtn.cloneNode(true);
                    approveBtn.parentNode.replaceChild(newBtn, approveBtn);
                    newBtn.addEventListener('click', handleApproveAll);
                }
                if (rejectBtn) {
                    const newBtn = rejectBtn.cloneNode(true);
                    rejectBtn.parentNode.replaceChild(newBtn, rejectBtn);
                    newBtn.addEventListener('click', handleRejectAll);
                }

            }, (error) => {
                console.error("Error loading pending users:", error);
            });
        }

        // --- טעינת Team Inbox (מנהלים) - שאילתות דינמיות עם Server-Side Filtering ---
        async function loadManagerInbox() {
            // --- בדיקת חסימה ---
            const isAllowed = await enforceCompanyStatus('team-requests-list');
            if (!isAllowed) return; // עצור הכל אם חסום
            // -------------------

            const listContainer = document.getElementById('team-requests-list');
            const showMoreBtn = document.getElementById('show-more-team-btn');
            const statusSelect = document.getElementById('req-filter-status');
            
            // קריאת הסטטוס הנוכחי מהדרופדאון (ברירת מחדל: pending)
            const currentStatusFilter = statusSelect ? statusSelect.value : 'pending';
            
            let hasMoreRequestsOnServer = false;
            
            // מילוי דרופדאון הקבוצות
            const groupSelect = document.getElementById('req-filter-group');
            if (groupSelect && groupSelect.options.length <= 1) { // מילוי רק אם ריק
                const currentVal = groupSelect.value;
                groupSelect.innerHTML = '<option value="all">All Groups</option>';
                availableGroups.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g; opt.textContent = g;
                    groupSelect.appendChild(opt);
                });
                groupSelect.value = currentVal;
            }

            let currentPendingRequests = [];

            // פונקציית הסינון המקומי (רק לשם ולקבוצה, הסטטוס כבר מסונן מהשרת)
            const applyFilters = () => {
                const searchInput = document.getElementById('req-search');
                const term = searchInput ? searchInput.value.toLowerCase() : '';
                const groupVal = groupSelect ? groupSelect.value : 'all';

                // ניהול כפתור "הצג עוד"
                if (showMoreBtn) {
                    // אם אנחנו ב-Pending - תמיד מסתירים (כי טענו את כולם)
                    if (currentStatusFilter === 'pending') {
                        showMoreBtn.classList.add('hidden');
                    } 
                    // בסטטוסים אחרים - לפי בדיקת השרת
                    else if (hasMoreRequestsOnServer) {
                        showMoreBtn.classList.remove('hidden');
                        // איפוס טקסט
                        showMoreBtn.disabled = false;
                        showMoreBtn.innerHTML = `<span class="mr-2">Load older requests</span><svg class="w-4 h-4 transition-transform group-hover:translate-y-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                    } else {
                        showMoreBtn.classList.add('hidden');
                    }
                }

                let filtered = managerRequestsCache.filter(req => {
                    const matchesSearch = (req.userName || '').toLowerCase().includes(term);
                    const matchesGroup = groupVal === 'all' || req.group === groupVal;
                    // אין צורך לסנן סטטוס כאן! הוא כבר הגיע מסונן מהשרת
                    return matchesSearch && matchesGroup;
                });
                
                // מיון
                filtered.sort((a, b) => {
                    const timeA = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : 0;
                    const timeB = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : 0;
                    return timeB - timeA;
                });
                
                // ניהול כותרות וכפתורים
                const headerEl = document.getElementById('leave-requests-header');
                const actionsEl = document.getElementById('leave-requests-actions');
                
                // --- Guard Clauses: בדיקה שהאלמנטים קיימים ---
                if (!headerEl || !actionsEl) {
                    renderManagerList(filtered);
                    return;
                }
                // ----------------------------------------------------
                
                // עדכון לרשימת ה-Pending הגלובלית לצורך כפתורי אישור גורף
                currentPendingRequests = filtered.filter(r => r.status === 'pending');
                
                if (filtered.length > 0) {
                    headerEl.classList.remove('hidden');
                    // מציגים כפתורי פעולה רק אם אנחנו באמת ב-Pending
                    if (currentStatusFilter === 'pending' && currentPendingRequests.length > 0) {
                        actionsEl.classList.remove('hidden');
                        actionsEl.classList.add('flex'); 
                    } else {
                        actionsEl.classList.add('hidden');
                        actionsEl.classList.remove('flex');
                    }
                } else {
                    headerEl.classList.add('hidden');
                }
                
                renderManagerList(filtered);
            };

            // חיבור מאזינים
            const searchInput = document.getElementById('req-search');
            if(searchInput) searchInput.oninput = applyFilters;
            if(groupSelect) groupSelect.onchange = applyFilters;
            
            // --- חיבור מחדש של המאזין הקריטי לסטטוס ---
            if(statusSelect) {
                statusSelect.onchange = () => {
                    currentTeamLimit = 5; // איפוס מונה
                    loadManagerInbox(); // טעינה מחודשת מהשרת
                };
            }

            // כפתורי אישור/דחייה גורפים
            const approveAllBtn = document.getElementById('req-approve-all-btn');
            const rejectAllBtn = document.getElementById('req-reject-all-btn');

            if (approveAllBtn) {
                const newBtn = approveAllBtn.cloneNode(true);
                approveAllBtn.parentNode.replaceChild(newBtn, approveAllBtn);
                newBtn.addEventListener('click', () => {
                    if (currentPendingRequests.length === 0) return;
                    showConfirmationModal('Approve All Requests', `Approve ${currentPendingRequests.length} requests?`, async () => {
                        for (const req of currentPendingRequests) await handleRequestAction(req.id, 'approve');
                    });
                });
            }

            if (rejectAllBtn) {
                const newBtn = rejectAllBtn.cloneNode(true);
                rejectAllBtn.parentNode.replaceChild(newBtn, rejectAllBtn);
                newBtn.addEventListener('click', () => {
                    if (currentPendingRequests.length === 0) return;
                    showConfirmationModal('Reject All Requests', `Reject ${currentPendingRequests.length} requests?`, async () => {
                        for (const req of currentPendingRequests) await handleRequestAction(req.id, 'reject');
                    });
                });
            }

            if (incomingRequestsUnsubscribe) incomingRequestsUnsubscribe();

            // === בניית השאילתה הדינמית (הלב של השינוי) ===
            
            let q;
            const baseRef = collection(db, "requests");

            if (currentStatusFilter === 'pending') {
                console.log("📡 Fetching ALL Pending requests (No Limit)");
                // מקרה 1: PENDING - מביאים את כולם ללא הגבלה
                q = query(baseRef, 
                    where("companyId", "==", currentUserProfile.companyId),
                    where("status", "==", "pending"),
                    orderBy("createdAt", "desc")
                );
            } else {
                console.log(`📡 Fetching ${currentStatusFilter} requests with limit ${currentTeamLimit}`);
                // מקרה 2: היסטוריה / הכל - משתמשים ב-Limit
                
                let constraints = [
                    where("companyId", "==", currentUserProfile.companyId),
                    orderBy("createdAt", "desc"),
                    limit(currentTeamLimit + 1) // +1 לבדיקה האם יש עוד
                ];

                // הוספת סינון סטטוס רק אם זה לא "all"
                if (currentStatusFilter !== 'all') {
                    constraints.splice(1, 0, where("status", "==", currentStatusFilter));
                }

                q = query(baseRef, ...constraints);
            }

            incomingRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                managerRequestsCache = [];
                
                console.log(`📥 Data received! Docs count: ${snapshot.size}`);
                
                // בדיקת "האם יש עוד" רלוונטית רק אם אנחנו לא ב-Pending
                if (currentStatusFilter !== 'pending') {
                    hasMoreRequestsOnServer = snapshot.size > currentTeamLimit;
                    if (hasMoreRequestsOnServer) {
                        console.log(`👉 There are more requests on server (Got ${snapshot.size}, wanted ${currentTeamLimit}). Button will show.`);
                    } else {
                        console.log(`✅ All requests loaded. No more data on server.`);
                    }
                } else {
                    hasMoreRequestsOnServer = false; // ב-Pending תמיד הבאנו הכל
                    console.log(`✅ Loaded all ${snapshot.size} pending requests.`);
                }

                // חיתוך התוצאה (רק אם יש לימיט)
                let docsToProcess = snapshot.docs;
                if (currentStatusFilter !== 'pending' && hasMoreRequestsOnServer) {
                    docsToProcess = snapshot.docs.slice(0, currentTeamLimit);
                }

                docsToProcess.forEach(doc => {
                    const data = doc.data();
                    if (!currentUserProfile.isSuperAdmin && data.group !== currentUserProfile.group) return;
                    managerRequestsCache.push({ id: doc.id, ...data });
                });

                updateTeamInboxBadge();
                applyFilters();
                
                // הפעלת אפקט הגלגל
                setTimeout(() => {
                     initRolodexEffect('team-requests-list');
                }, 100);
            });

            // --- מאזין לכפתור "Load older requests" ---
            if (showMoreBtn) {
                showMoreBtn.onclick = () => {
                    showMoreBtn.disabled = true;
                    showMoreBtn.innerHTML = `
                        <span class="mr-2">Loading...</span>
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    `;
                    currentTeamLimit += 5;
                    loadManagerInbox(); // טוען מחדש עם לימיט גדול יותר
                };
            }
        }

        // --- פונקציית הרינדור (רשימה עם הערות נפתחות - Expandable) ---
        // --- פונקציית הרינדור המעודכנת (תיקון רוחב כפתורים במובייל) ---
        function renderManagerList(requests) {
            const listContainer = document.getElementById('team-requests-list');
            const emptyState = document.getElementById('team-requests-empty');
            
            // --- [תיקון 1] שומר סף: אם הרשימה לא קיימת בדף, צא מיד ---
            if (!listContainer || !emptyState) return;
            // --------------------------------------------------------
            
            const tableHeaders = document.querySelector('.hidden.md\\:grid.grid-cols-12');
            if (tableHeaders) tableHeaders.classList.add('hidden');
            
            listContainer.innerHTML = '';
            
            if (requests.length === 0) {
                listContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            listContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');

            requests.forEach(req => {
                const start = getSafeDateString(req.startDate);
                const end = getSafeDateString(req.endDate);
                const isPending = req.status === 'pending';
                const safeNote = req.managerNote ? req.managerNote.replace(/"/g, '&quot;') : '';
                
                const el = document.createElement('div');
                // שמרנו על העיצוב האפור-בהיר והמסגרת
                el.className = "p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-3 transition-all hover:shadow-sm";
                
                if (isPending) {
                    el.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="font-bold text-gray-800 dark:text-gray-200 text-md">${req.userName}</p>
                                <span class="text-[10px] bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 px-1.5 py-0.5 rounded text-gray-500 dark:text-gray-300 font-medium">${req.group}</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                <span class="font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500">${req.type}</span> 
                                <span class="mx-1">•</span> 
                                ${start} - ${end}
                            </p>
                            ${req.managerNote ? `<p class="text-xs text-blue-500 mt-1 italic">Note: ${safeNote}</p>` : ''}
                        </div>
                        
                        <div class="flex items-center space-x-2 mt-3 sm:mt-0">
                            <button class="btn btn-success text-sm py-2 px-3 shadow-sm btn-approve" data-id="${req.id}">Approve</button>
                            <button class="btn btn-danger text-sm py-2 px-3 shadow-sm btn-reject" data-id="${req.id}">Reject</button>
                        </div>
                    `;
                } else {
                    // (חלק ההיסטוריה נשאר אותו דבר)
                    let statusBadge = req.status === 'approved' 
                        ? `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-bold rounded-full border border-green-200">Approved</span>`
                        : `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full border border-red-200">Rejected</span>`;

                    el.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="font-bold text-gray-700 dark:text-gray-300 text-md">${req.userName}</p>
                                <span class="text-[10px] border border-gray-300 dark:border-gray-600 px-1.5 py-0.5 rounded text-gray-500 dark:text-gray-400">${req.group}</span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                <span class="font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500">${req.type}</span> • ${start} - ${end}
                            </p>
                            ${req.managerNote ? `<p class="text-xs text-gray-400 mt-1 italic">Note: ${safeNote}</p>` : ''}
                        </div>
                        <div class="mt-2 sm:mt-0">
                            ${statusBadge}
                        </div>
                    `;
                }
                
                listContainer.appendChild(el);
            });

            document.querySelectorAll('.btn-approve').forEach(b => {
                b.onclick = () => openActionModal(b.dataset.id, 'approve');
            });
            document.querySelectorAll('.btn-reject').forEach(b => {
                b.onclick = () => openActionModal(b.dataset.id, 'reject');
            });
            
            initRolodexEffect('team-requests-list'); // <--- כאן
        }

        // --- Alias for compatibility ---
        function renderManagerGrid(requests) {
            renderManagerList(requests);
        }


        // --- טעינת בקשות צוות (למנהלים) ---
        function loadIncomingRequests() {
            const panel = document.getElementById('tl-requests-panel');
            const pendingList = document.getElementById('incoming-requests-list');
            
            panel.classList.remove('hidden');
            
            // ניקוי האזנה קודמת אם קיימת
            if (incomingRequestsUnsubscribe) incomingRequestsUnsubscribe();

            const q = query(collection(db, "requests"), 
                where("companyId", "==", currentUserProfile.companyId),
                where("status", "==", "pending"),
                orderBy("createdAt", "desc")
            );
            
            incomingRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                pendingList.innerHTML = '';
                
                // סינון ידני לקבוצה (אם המשתמש הוא TL ולא סופר אדמין)
                const relevantDocs = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    if (currentUserProfile.isSuperAdmin) return true;
                    return data.group === currentUserProfile.group;
                });

                // --- עדכון המשתנה הגלובלי לניהול הנקודה ---
                hasPendingIncomingRequests = (relevantDocs.length > 0);
                checkNotificationDot(); // עדכון המוח
                // -----------------------------------------

                if (relevantDocs.length === 0) {
                    pendingList.innerHTML = '<p class="text-gray-400 text-sm italic">No pending requests.</p>';
                    return;
                }

                relevantDocs.forEach(docSnap => {
                    const data = docSnap.data();
                    const start = getSafeDateString(data.startDate);
                    const end = getSafeDateString(data.endDate);
                    
                    const el = document.createElement('div');
                    el.className = "p-4 bg-white dark:bg-gray-800 rounded-lg border-l-4 border-l-purple-500 shadow-sm border border-gray-200 dark:border-gray-700";
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-bold text-gray-900 dark:text-white">${data.userName}</p>
                                <p class="text-xs text-gray-500">${data.group}</p>
                            </div>
                            <span class="text-sm font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500 px-2">${data.type}</span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                            <b>${start}</b> - <b>${end}</b>
                        </p>
                        <div class="flex gap-2 justify-end">
                            <button class="reject-req-btn text-xs px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 rounded transition font-medium" data-id="${docSnap.id}">Reject</button>
                            <button class="approve-req-btn text-xs px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white font-bold rounded shadow transition" data-id="${docSnap.id}">Approve</button>
                        </div>
                    `;
                    pendingList.appendChild(el);
                });

                document.querySelectorAll('.approve-req-btn').forEach(btn => {
                    btn.addEventListener('click', () => openActionModal(btn.dataset.id, 'approve'));
                });
                document.querySelectorAll('.reject-req-btn').forEach(btn => {
                    btn.addEventListener('click', () => openActionModal(btn.dataset.id, 'reject'));
                });
            }, (error) => {
                console.error("Error loading incoming requests:", error);
                pendingList.innerHTML = '<p class="text-red-500 text-sm">Error loading requests.</p>';
            });

            setupAdminTabsInternal();
        }

        // ניהול הטאבים הפנימיים (Pending / History)
        function setupAdminTabsInternal() {
            const btnPending = document.getElementById('view-pending-btn');
            const btnHistory = document.getElementById('view-history-btn');
            const viewPending = document.getElementById('requests-pending-view');
            const viewHistory = document.getElementById('requests-history-view');

            btnPending.onclick = () => {
                viewPending.classList.remove('hidden');
                viewHistory.classList.add('hidden');
                btnPending.classList.add('bg-white', 'dark:bg-gray-600', 'shadow-sm', 'text-gray-800', 'dark:text-white');
                btnPending.classList.remove('text-gray-500', 'dark:text-gray-400');
                btnHistory.classList.remove('bg-white', 'dark:bg-gray-600', 'shadow-sm', 'text-gray-800', 'dark:text-white');
                btnHistory.classList.add('text-gray-500', 'dark:text-gray-400');
            };

            btnHistory.onclick = () => {
                viewPending.classList.add('hidden');
                viewHistory.classList.remove('hidden');
                btnHistory.classList.add('bg-white', 'dark:bg-gray-600', 'shadow-sm', 'text-gray-800', 'dark:text-white');
                btnHistory.classList.remove('text-gray-500', 'dark:text-gray-400');
                btnPending.classList.remove('bg-white', 'dark:bg-gray-600', 'shadow-sm', 'text-gray-800', 'dark:text-white');
                btnPending.classList.add('text-gray-500', 'dark:text-gray-400');
                loadRequestsHistory(); // טעינת היסטוריה כשלוחצים
            };
            
            // מילוי פילטר הסוגים
            const typeFilter = document.getElementById('history-filter-type');
            if (typeFilter && typeFilter.options.length <= 1) {
                globalAttendanceOptions.forEach(opt => {
                    const name = typeof opt === 'string' ? opt : opt.name;
                    const op = document.createElement('option');
                    op.value = name;
                    op.textContent = name;
                    typeFilter.appendChild(op);
                });
            }
            
            // האזנה לשינוי בפילטרים
            const statusFilter = document.getElementById('history-filter-status');
            if (statusFilter) statusFilter.addEventListener('change', loadRequestsHistory);
            if (typeFilter) typeFilter.addEventListener('change', loadRequestsHistory);
        }

        // --- טעינת היסטוריית בקשות למנהל ---
        function loadRequestsHistory() {
            const historyList = document.getElementById('requests-history-list');
            const statusFilter = document.getElementById('history-filter-status');
            const typeFilter = document.getElementById('history-filter-type');

            if (!historyList) return;

            const statusValue = statusFilter ? statusFilter.value : 'all';
            const typeValue = typeFilter ? typeFilter.value : 'all';

            historyList.innerHTML = '<p class="text-gray-500 text-sm italic">Loading history...</p>';

            // זו השאילתה שדורשת את האינדקס החדש!
            let q = query(collection(db, "requests"), 
                where("companyId", "==", currentUserProfile.companyId),
                orderBy("createdAt", "desc")
            );

            if (historyUnsubscribe) historyUnsubscribe();

            historyUnsubscribe = onSnapshot(q, (snapshot) => {
                historyList.innerHTML = '';
                
                const filteredDocs = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    
                    // 1. מנהל רגיל רואה רק את העובדים שלו
                    if (!currentUserProfile.isSuperAdmin && data.group !== currentUserProfile.group) return false;
                    
                    // 2. סינונים מהדרופדאון
                    if (statusValue !== 'all' && data.status !== statusValue) return false;
                    if (typeValue !== 'all' && data.type !== typeValue) return false;
                    
                    // 3. בהיסטוריה מציגים רק מה שטופל (לא Pending)
                    if (data.status === 'pending') return false;

                    return true;
                });

                if (filteredDocs.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-500 text-sm italic">No history found.</p>';
                    return;
                }

                filteredDocs.forEach(docSnap => {
                    const data = docSnap.data();
                    const start = data.startDate.toDate().toLocaleDateString();
                    const end = data.endDate.toDate().toLocaleDateString();
                    
                    let statusColor = data.status === 'approved' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
                    let icon = data.status === 'approved' ? '✅' : '❌';

                    const item = document.createElement('div');
                    item.className = "p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 text-sm mb-2";
                    item.innerHTML = `
                        <div class="flex justify-between">
                            <span class="font-bold text-gray-900 dark:text-white">${data.userName}</span>
                            <span class="text-xs px-2 py-0.5 rounded ${statusColor} font-bold capitalize flex items-center gap-1">${icon} ${data.status}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <span class="font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500 text-sm">${data.type}</span> 
                            • ${start} - ${end}
                        </div>
                        ${data.managerNote ? `<div class="text-xs text-gray-400 mt-1 italic border-l-2 border-gray-300 pl-2">"${data.managerNote}"</div>` : ''}
                    `;
                    historyList.appendChild(item);
                });
            }, (error) => {
                console.error("Error loading history:", error);
                // הודעה ברורה אם חסר אינדקס
                historyList.innerHTML = '<p class="text-red-500 text-sm">Error: Index missing. Check console.</p>';
            });
        }

        // --- לוגיקת המודל לאישור/דחייה עם הערה ---
        const actionModal = document.getElementById('action-note-modal');
        const actionNoteInput = document.getElementById('action-note-input');

        function openActionModal(reqId, actionType) {
            currentAdminAction = { id: reqId, type: actionType };
            
            const title = document.getElementById('action-note-title');
            const confirmBtn = document.getElementById('action-note-confirm');
            
            if (actionType === 'approve') {
                title.textContent = "Approve Request";
                confirmBtn.textContent = "Approve";
                confirmBtn.className = "px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-bold shadow-lg";
                if (actionNoteInput) actionNoteInput.placeholder = "Optional: e.g. Approved, have fun!";
            } else {
                title.textContent = "Reject Request";
                confirmBtn.textContent = "Reject";
                confirmBtn.className = "px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold shadow-lg";
                if (actionNoteInput) actionNoteInput.placeholder = "Optional: e.g. Too many people off this week.";
            }
            
            if (actionNoteInput) actionNoteInput.value = ''; // איפוס
            actionModal.classList.remove('hidden');
        }

        if (document.getElementById('action-note-cancel')) {
            document.getElementById('action-note-cancel').addEventListener('click', () => {
                actionModal.classList.add('hidden');
                currentAdminAction = null;
            });
        }

        if (document.getElementById('action-note-confirm')) {
            document.getElementById('action-note-confirm').addEventListener('click', () => {
                if (currentAdminAction) {
                    const note = actionNoteInput ? actionNoteInput.value.trim() : '';
                    handleRequestAction(currentAdminAction.id, currentAdminAction.type, note);
                    actionModal.classList.add('hidden');
                }
            });
        }

        // הפונקציה המעודכנת לטיפול בבקשה (כולל ההערה)
        async function handleRequestAction(reqId, action, note = "") {
            const reqRef = doc(db, "requests", reqId);
            const reqSnap = await getDoc(reqRef);
            if (!reqSnap.exists()) return;
            const data = reqSnap.data();

            const batch = writeBatch(db);

            // [תיקון] שימוש במספר (Milliseconds) לסנכרון מושלם
            const updateData = {
                status: action === 'reject' ? 'rejected' : 'approved',
                managerNote: note,
                updatedAtMs: Date.now() // <--- מספר פשוט, לא אובייקט
            };

            if (action === 'reject') {
                batch.update(reqRef, updateData);
            } else if (action === 'approve') {
                const start = data.startDate.toDate();
                const end = data.endDate.toDate();
                const type = data.type;
                const userId = data.userId;
                const userGroup = data.group || 'General'; // לוקחים מהבקשה עצמה

                const updatesByWeek = {};
                let loopDate = new Date(start);
                while (loopDate <= end) {
                    const dayIndex = loopDate.getDay();
                    if (globalWorkDays.includes(dayIndex)) {
                        const weekId = getWeekId(loopDate);
                        if (!updatesByWeek[weekId]) updatesByWeek[weekId] = {};
                        updatesByWeek[weekId][dayIndex] = type;
                    }
                    loopDate.setDate(loopDate.getDate() + 1);
                }

                for (const [weekId, dayUpdates] of Object.entries(updatesByWeek)) {
                    const attendanceRef = doc(db, "attendance", `${weekId}_${userId}`);
                    
                    // נסיון לקרוא מסמך קיים - אם נכשל (עובד חדש או שגיאת הרשאות), נשתמש בברירת מחדל
                    let daysArray = Array(7).fill("Office");
                    try {
                        const docSnap = await getDoc(attendanceRef);
                        if (docSnap.exists()) {
                            daysArray = docSnap.data().days;
                        }
                    } catch (error) {
                        console.log("Could not read existing attendance, using defaults:", error.code);
                    }
                    
                    Object.keys(dayUpdates).forEach(index => {
                        daysArray[index] = dayUpdates[index];
                    });

                    // === התיקון: שימוש ב-companyId של המנהל וב-group מהבקשה ===
                    batch.set(attendanceRef, { 
                        userId, 
                        weekId, 
                        days: daysArray,
                        companyId: currentUserProfile.companyId, // <--- המנהל והעובד באותה חברה!
                        group: userGroup // <--- מהבקשה המקורית
                    }, { merge: true });
                }

                batch.update(reqRef, updateData);
            }
            
            // הסרנו את העדכון של hasUnreadRequestUpdates כי זה גורם לשגיאת הרשאות
            // העובד יקבל עדכון דרך ה-realtime listener של הבקשה שלו

            await batch.commit();
            showConfirmationModal(
                action === 'approve' ? 'Approved' : 'Rejected', 
                action === 'approve' ? 'Request approved and attendance updated!' : 'Request has been rejected.', 
                ()=>{}
            );
        }

        async function setupUpdateTab(userId) {
            // Cleanup previous listener if exists
            if (updateWeekUnsubscribe) {
                updateWeekUnsubscribe();
                updateWeekUnsubscribe = null;
            }

            const weekDatesTitle = document.getElementById('week-dates-title');
            const mainTitle = document.getElementById('update-week-main-title'); // Get the new element
            const attendanceDaysContainer = document.getElementById('attendance-days-container');
            
            // --- Guard Clause ---
            if (!attendanceDaysContainer || !weekDatesTitle) return;
            // --------------------
            
            // --- חישוב טווח תאריכים דינמי ---
            const displayDate = new Date(currentDate);
            const dayOfWeek = displayDate.getDay();
            const sundayAnchor = new Date(displayDate);
            sundayAnchor.setDate(displayDate.getDate() - dayOfWeek);
            
            const minDay = globalWorkDays.length > 0 ? Math.min(...globalWorkDays) : 0;
            const maxDay = globalWorkDays.length > 0 ? Math.max(...globalWorkDays) : 6;

            const rangeStartDate = new Date(sundayAnchor);
            rangeStartDate.setDate(sundayAnchor.getDate() + minDay);

            const rangeEndDate = new Date(sundayAnchor);
            rangeEndDate.setDate(sundayAnchor.getDate() + maxDay);

            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            weekDatesTitle.textContent = `Week of ${rangeStartDate.toLocaleDateString('en-US', options)} - ${rangeEndDate.toLocaleDateString('en-US', options)}`;
            
            const startDate = sundayAnchor; // לשימוש בלולאות
            // --------------------------------
            
            // Check if it's the current week
            const isCurrentWeek = getWeekId(currentDate) === getWeekId(getEffectiveCurrentDate());

            if (isCurrentWeek) {
                mainTitle.classList.remove('return-to-today-btn', 'animated-gradient-text');
            } else {
                mainTitle.classList.add('return-to-today-btn', 'animated-gradient-text');
            }
            
            attendanceDaysContainer.innerHTML = '';
            
            // [תיקון] לולאה דינמית שרצה על כל ימי השבוע אך מדלגת על ימים שאינם פעילים
            let dayCounter = 0;
            for (let i = 0; i < 7; i++) {
                // אם היום לא מוגדר כיום עבודה בחברה, מדלגים עליו
                if (!globalWorkDays.includes(i)) continue;
                
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                const dateString = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric'});

                // [תיקון] חילוץ השם מתוך אובייקט או שימוש בסטרינג ישן
                const selectOptions = globalAttendanceOptions.map(opt => {
                    const val = typeof opt === 'object' ? opt.name : opt;
                    return `<option value="${val}">${val}</option>`;
                }).join('');
                
                let buttonHtml = '';
                const doubleChevronSvg = `<div class="animated-chevron pointer-events-none"></div>`;
                const isLastWorkDay = (dayCounter === globalWorkDays.length - 1);

                if (!isLastWorkDay) { // כל ימי העבודה חוץ מהאחרון - draggable
                    buttonHtml = `
                    <button type="button" draggable="true" class="apply-down-btn p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500 transition-transform" data-day-index="${dayCounter}" title="Drag down to apply status">
                        ${doubleChevronSvg}
                    </button>`;
                } else { // היום האחרון - drop target
                    buttonHtml = `
                    <div class="apply-down-btn p-2 rounded-md flex items-center justify-center w-9 h-9" data-day-index="${dayCounter}" title="Drop here to apply status">
                        <div class="w-2.5 h-2.5 bg-gray-300 dark:bg-gray-500 rounded-full"></div>
                    </div>`;
                }


                const dayHtml = `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center">
                        <div class="font-medium text-gray-800">
                            ${dayName} <span class="text-sm text-gray-500">${dateString}</span>
                        </div>
                        <div class="sm:col-span-2 flex items-center space-x-2">
                            <select id="day-${dayCounter}" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">${selectOptions}</select>
                            ${buttonHtml}
                        </div>
                    </div>`;
                attendanceDaysContainer.insertAdjacentHTML('beforeend', dayHtml);
                dayCounter++;
            }

            initializeUpdateWeekDragDrop();

            const weekId = getWeekId(currentDate);
            const attendanceRef = doc(db, "attendance", `${weekId}_${userId}`);
            
            // Set up realtime listener for user's own attendance
            updateWeekUnsubscribe = onSnapshot(attendanceRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let dayCounter = 0;
                    for (let i = 0; i < 7; i++) {
                        if (!globalWorkDays.includes(i)) continue;
                        const selectElement = document.getElementById(`day-${dayCounter}`);
                        if (selectElement && data.days && data.days[i]) {
                            selectElement.value = data.days[i];
                        }
                        dayCounter++;
                    }
                } else {
                    // Set defaults if no document exists
                    let dayCounter = 0;
                    for (let i = 0; i < 7; i++) {
                        if (!globalWorkDays.includes(i)) continue;
                        const selectElement = document.getElementById(`day-${dayCounter}`);
                        if (selectElement) {
                            selectElement.value = "Office";
                        }
                        dayCounter++;
                    }
                }
            }, (error) => {
                console.error("Error in Update Week realtime listener:", error);
            });
        }

        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            if (!currentUser) return;
            
            const weekId = getWeekId(currentDate);
            const attendanceRef = doc(db, "attendance", `${weekId}_${currentUser.uid}`);
            
            const daysData = Array(7).fill(null); // יוצרים מערך של 7 ימים
            let dayCounter = 0;
            for (let i = 0; i < 7; i++) {
                if (!globalWorkDays.includes(i)) continue;
                const value = document.getElementById(`day-${dayCounter}`)?.value || "Office";
                daysData[i] = value;
                dayCounter++;
            }
            
            try {
                await setDoc(attendanceRef, { 
                    days: daysData,
                    weekId: weekId,
                    userId: currentUser.uid,
                    companyId: currentUserProfile.companyId, // <--- הוספנו את זה! חובה לאבטחה
                    group: currentUserProfile.group // <--- הוספת שדה הקבוצה (חובה לסינון!)
                }, { merge: true }); // הוספתי merge ליתר ביטחון
                showSuccessAnimation(weekSuccessAnimation);
                // refreshViews() removed - realtime listeners will update automatically
            } catch (error) {
                console.error("Error saving week: ", error);
            }
        });
        
        // --- Helper: Cached Users Fetching ---
        // --- Helper: Cached Users Fetching with Server-Side Filtering ---
        async function getCachedUsers(targetGroup = 'all') {
            // אם כבר יש לנו נתונים במטמון, נבדוק אם הם מתאימים למה שביקשנו
            if (allUsersCache && allUsersCache.length > 0) {
                // אם ביקשנו "הכל", והמטמון מלא - מצוין.
                // אם ביקשנו קבוצה ספציפית, נבדוק אם המטמון מכיל רק אותה או את הכל.
                // לצורך הפשטות והחיסכון: אם משנים פילטר, אנחנו מנקים את המטמון ב-handleGroupFilterChange
                // אז אם הגענו לפה עם מטמון, נשתמש בו.
                const usersMap = {};
                allUsersCache.forEach(user => { usersMap[user.id] = user; });
                return usersMap;
            }

            console.log(`📡 Fetching users from Firestore (Filter: ${targetGroup})...`);
            
            const usersCol = collection(db, "users");
            let q;
            
            // בניית שאילתה חכמה
            const constraints = [];
            
            // 1. תמיד לסנן לפי חברה
            if (currentUserProfile && currentUserProfile.companyId) {
                constraints.push(where("companyId", "==", currentUserProfile.companyId));
            }
            
            // 2. חיסכון בקריאות: אם נבחרה קבוצה ספציפית, נביא רק את העובדים שלה!
            if (targetGroup && targetGroup !== 'all') {
                constraints.push(where("group", "==", targetGroup));
            }

            q = query(usersCol, ...constraints);

            const userSnapshot = await getDocs(q);
            
            const usersMap = {};
            allUsersCache = []; 

            userSnapshot.forEach(doc => {
                const userData = doc.data();
                usersMap[doc.id] = userData;
                allUsersCache.push({ id: doc.id, ...userData });
            });

            return usersMap;
        }
        
        // --- Team View Tab Logic (Optimized for Reads) ---
        async function setupTeamViewTab() {
            // --- בדיקת חסימה ---
            const isAllowed = await enforceCompanyStatus('team-view-container');
            if (!isAllowed) return; // עצור הכל אם חסום
            // -------------------

            // Cleanup previous listener if exists
            if (teamViewUnsubscribe) {
                teamViewUnsubscribe();
                teamViewUnsubscribe = null;
            }

            const container = document.getElementById('team-view-container');
            // --- Guard Clause ---
            if (!container) return;
            // --------------------
            
            const teamWeekTitle = document.getElementById('team-week-dates-title');
            const mainTitle = document.getElementById('team-view-main-title');
            
            // --- קביעת קבוצת הסינון (הלוגיקה החדשה) ---
            // 1. האם יש בחירה שמורה בפרופיל?
            // 2. אם לא (משתמש חדש) -> קח את הקבוצה שאליה הוא רשום.
            // 3. ברירת מחדל סופית -> 'all'
            
            let activeFilter = 'all';
            
            if (currentUserProfile) {
                if (currentUserProfile.teamViewFilter) {
                    // יש העדפה שמורה - נשתמש בה
                    activeFilter = currentUserProfile.teamViewFilter;
                } else if (currentUserProfile.group) {
                    // אין העדפה (פעם ראשונה) - נשתמש בקבוצה של העובד כברירת מחדל
                    activeFilter = currentUserProfile.group;
                    // אופציונלי: לשמור את זה כברירת מחדל בזיכרון המקומי כבר עכשיו
                    currentUserProfile.teamViewFilter = activeFilter;
                }
            }

            // עדכון הדרופ-דאון שיראה את מה שנבחר בפועל
            if (groupFilter) {
                // קודם ממלאים את האפשרויות כדי שנוכל לבחור
                groupFilter.innerHTML = '<option value="all">All Groups</option>';
                availableGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupFilter.appendChild(option);
                });
                
                // בחירת הערך הנכון
                groupFilter.value = activeFilter;
            }

            container.innerHTML = '<div class="text-center py-10"><svg class="animate-spin h-8 w-8 mx-auto text-purple-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-gray-500">Loading team data...</p></div>';
            
            // --- חישוב טווח תאריכים דינמי לפי ימי עבודה ---
            const displayDate = new Date(currentDate);
            const dayOfWeek = displayDate.getDay();
            
            // 1. מציאת יום ראשון של השבוע הנוכחי (העוגן)
            const sundayAnchor = new Date(displayDate);
            sundayAnchor.setDate(displayDate.getDate() - dayOfWeek);

            // 2. מציאת היום הראשון והאחרון מתוך הגדרות המערכת
            const minDay = globalWorkDays.length > 0 ? Math.min(...globalWorkDays) : 0;
            const maxDay = globalWorkDays.length > 0 ? Math.max(...globalWorkDays) : 6;

            // 3. חישוב תאריך התחלה (היום הפעיל הראשון)
            const rangeStartDate = new Date(sundayAnchor);
            rangeStartDate.setDate(sundayAnchor.getDate() + minDay);

            // 4. חישוב תאריך סיום (היום הפעיל האחרון)
            const rangeEndDate = new Date(sundayAnchor);
            rangeEndDate.setDate(sundayAnchor.getDate() + maxDay);

            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            teamWeekTitle.textContent = `Week of ${rangeStartDate.toLocaleDateString('en-US', options)} - ${rangeEndDate.toLocaleDateString('en-US', options)}`;
            
            const startDate = sundayAnchor; // משתנה לשימוש בלולאות
            // ----------------------------------------------------
            
            const isCurrentWeek = getWeekId(currentDate) === getWeekId(getEffectiveCurrentDate());
            if (isCurrentWeek) {
                mainTitle.classList.remove('return-to-today-btn', 'animated-gradient-text');
            } else {
                mainTitle.classList.add('return-to-today-btn', 'animated-gradient-text');
            }
            
            try {
                // 1. שליפת משתמשים - חכמה וחסכונית!
                // מעבירים את הפילטר כדי להביא רק את מי שצריך
                const users = await getCachedUsers(activeFilter);

                const weekId = getWeekId(currentDate);
                
                // Function to render the table
                const renderTable = (attendances) => {
                    console.log('📊 renderTable called with attendances:', attendances);
                    console.log('📊 Attendance keys:', Object.keys(attendances));
                    
                    const groupedUsers = {};
                    Object.keys(users).forEach(uid => {
                        const user = users[uid];
                        const groupKey = user.group;
                        if (!groupedUsers[groupKey]) groupedUsers[groupKey] = [];
                        groupedUsers[groupKey].push({ ...user, uid });
                    });
                    
                    console.log('📊 Users object keys:', Object.keys(users));
                    console.log('📊 First user UID example:', Object.keys(users)[0]);
                    
                    container.innerHTML = ''; 
                    
                    if (Object.keys(groupedUsers).length === 0) {
                          container.innerHTML = '<div class="text-center py-10 text-gray-500">No team data found for this selection.</div>';
                          return;
                    }
                    
                    const isCurrentUserTL = currentUserProfile && (currentUserProfile.isTL || currentUserProfile.isSuperAdmin);

                    const dayHeaders = [];
                    // חישוב "היום האמיתי" לצורך השוואה
                    const realNow = new Date();
                    realNow.setHours(0,0,0,0);

                    // לולאה רגילה על 7 ימים
                    for (let i = 0; i < 7; i++) {
                        // 1. דינמיות: אם היום לא מוגדר כיום עבודה בחברה - דלג עליו!
                        // (זה יסתיר את שישי/שבת או כל יום חופש אחר שבחרת)
                        if (!globalWorkDays.includes(i)) continue;
                        
                        const dayDate = new Date(startDate);
                        dayDate.setDate(startDate.getDate() + i);
                        dayDate.setHours(0,0,0,0);
                        
                        const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'short' });
                        const dateString = `${String(dayDate.getDate()).padStart(2,'0')}/${String(dayDate.getMonth()+1).padStart(2,'0')}`;

                        // 2. תיקון הבאג: בדיקה פשוטה וישירה
                        // האם התאריך של העמודה הזו == התאריך של היום במחשב?
                        const isToday = dayDate.getTime() === realNow.getTime();

                        const classes = ['py-3','px-2','text-left','text-[11px]','sm:text-xs','font-semibold','text-gray-600','uppercase','tracking-wider','w-20','sm:w-24'];
                        
                        // אם זה היום - תן לו את מחלקת הצבע המיוחדת
                        if (isToday) classes.push('day-header-today');

                        dayHeaders.push(`<th class="${classes.join(' ')}">${dayName}<br>${dateString}</th>`);
                    }
                    
                    const actionsHeader = isCurrentUserTL ? `<th class="py-3 px-2 text-left text-[11px] sm:text-xs font-semibold text-gray-600 uppercase tracking-wider w-20 sm:w-24">Actions</th>` : '';

                    // כדי לשמור על סדר הקבוצות, נעבור על הרשימה הגלובלית
                    const groupsToRender = (activeFilter === 'all') ? availableGroups : [activeFilter];

                    groupsToRender.forEach(groupName => {
                        if (!groupedUsers[groupName]) return;

                        let tableHtml = `
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">${groupName}</h3>
                                <div class="shadow-sm border border-gray-200 rounded-lg overflow-x-auto">
                                    <table class="bg-white divide-y divide-gray-200 table-fixed min-w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="py-3 px-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-32 sm:w-36 sticky-col">Employee</th>
                                                ${dayHeaders.join('')}
                                                ${actionsHeader}
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">`;

                        groupedUsers[groupName].sort((a, b) => {
                            if (a.isTL !== b.isTL) return b.isTL - a.isTL;
                            return (a.fullName || a.email).localeCompare(b.fullName || b.email);
                        }).forEach(user => {
                            const userAttendance = attendances[user.uid] || Array(7).fill('---');
                            console.log(`📊 Rendering user ${user.fullName} (${user.uid}):`, userAttendance);
                            const rowClass = user.isTL ? 'bg-gray-50' : '';
                            
                            // [תיקון] בניית תאים רק לימי העבודה הפעילים
                            let attendanceCells = '';
                            for (let i = 0; i < 7; i++) {
                                if (!globalWorkDays.includes(i)) continue;
                                const status = userAttendance[i] || '---';
                                
                                let spanContent = '';
                                if (status === '---') {
                                    // סטטוס ריק - אפור ופשוט
                                    spanContent = `<span class="text-gray-400 dark:text-gray-500 font-normal">---</span>`;
                                } else {
                                    // סטטוס קיים - שימוש ב-CSS הנקי החדש
                                    // 1. קודם ננסה להשיג את צבע ה-HEX אם הוא שמור באובייקט הסטטוסים הגלובלי
                                    // (זה רלוונטי אם הוספת סטטוסים חדשים באדמין)
                                    let colorInput = status; 
                                    const foundType = globalAttendanceOptions.find(t => (t.name || t) === status);
                                    if (foundType && typeof foundType === 'object') {
                                        colorInput = foundType.color; // מעביר את ה-HEX
                                    }

                                    // 2. קבלת מחלקות ה-Tailwind המתאימות לצבע הזה
                                    const classes = getTailwindClasses(colorInput);
                                    
                                    // 3. יצירת האלמנט - שים לב: אין כאן style="", רק classes!
                                    spanContent = `<span class="status-pill ${classes}">${status}</span>`;
                                }
                                
                                attendanceCells += `<td class="py-3 px-2 text-left">${spanContent}</td>`;
                            }
                            
                            const nameFontWeight = user.isTL ? 'font-bold' : 'font-medium';
                            
                            const actionsCell = isCurrentUserTL ? `<td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm"><button class="edit-btn theme-link hover:underline" data-uid="${user.uid}" data-name="${user.fullName || user.email}" data-group="${user.group || 'General'}">Edit</button></td>` : '';

                            tableHtml += `
                                <tr class="${rowClass}">
                                    <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm ${nameFontWeight} text-gray-900 truncate sticky-col">${user.fullName || user.email}</td>
                                    ${attendanceCells}
                                    ${actionsCell}
                                </tr>`;
                        });

                        tableHtml += `</tbody></table></div></div>`;
                        container.insertAdjacentHTML('beforeend', tableHtml);
                    });
                };

                // 2. בניית השאילתה - Server Side Filtering!
                const attendanceCol = collection(db, "attendance");
                const constraints = [
                    where("weekId", "==", weekId),
                    where("companyId", "==", currentUserProfile.companyId)
                ];

                // === הקסם: אם נבחרה קבוצה, מוסיפים תנאי לשאילתה ===
                if (activeFilter !== 'all') {
                    constraints.push(where("group", "==", activeFilter));
                }
                // ===================================================

                const q = query(attendanceCol, ...constraints);
                
                console.log('🔐 Current user profile:', {
                    uid: currentUserProfile.uid || currentUser.uid,
                    isTL: currentUserProfile.isTL,
                    isSuperAdmin: currentUserProfile.isSuperAdmin,
                    companyId: currentUserProfile.companyId
                });
                console.log('🔍 Query constraints:', constraints);
                
                // פתרון זמני: טען את כל הנתונים בפעם אחת במקום realtime listener
                async function loadAllAttendance() {
                    try {
                        console.log('📥 Loading all attendance records...');
                        const snapshot = await getDocs(q);
                        console.log('📊 Loaded docs count:', snapshot.size);
                        const attendances = {};
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            attendances[data.userId] = data.days;
                            console.log(`📊 User ${data.userId} attendance:`, data.days);
                        });
                        console.log('📊 Total attendances loaded:', Object.keys(attendances).length);
                        renderTable(attendances);
                    } catch (error) {
                        console.error("Error loading attendance:", error);
                    }
                }
                
                // קריאה ראשונית
                loadAllAttendance();
                
                // עדיין שומרים על realtime listener אבל כאופציה
                teamViewUnsubscribe = onSnapshot(q, (snapshot) => {
                    console.log('📊 Team View Listener triggered. Docs count:', snapshot.size);
                    const attendances = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        attendances[data.userId] = data.days;
                        console.log(`📊 User ${data.userId} attendance:`, data.days);
                    });
                    console.log('📊 Total attendances loaded:', Object.keys(attendances).length);
                    renderTable(attendances);
                }, (error) => {
                    console.error("Error in Team View realtime listener:", error);
                    // הודעה ידידותית למקרה שחסר אינדקס
                    if (error.code === 'failed-precondition') {
                         const errorMessage = `<div class="bg-blue-50 border border-blue-400 text-blue-800 px-4 py-3 rounded-lg relative text-center" role="alert"><strong class="font-bold">System Optimization</strong><p class="block mt-1 text-sm">We've upgraded the system to be faster! Please ask your Admin to click the link in the developer console (F12) to create the new database index.</p></div>`;
                         container.innerHTML = errorMessage;
                    } else {
                         container.innerHTML = '<p class="text-red-500">Error loading data.</p>';
                    }
                });

            } catch (error) {
                console.error("Error fetching team view: ", error);
                const errorMessage = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert"><strong class="font-bold">Action Required!</strong><p class="block sm:inline">To enable this view, a database index must be created. Please open the developer console (F12), find the error message from Firebase, and click the link to create the index. This is a one-time setup.</p></div>`;
                container.innerHTML = errorMessage;
            }
        }

        // --- Statistics Tab Logic ---
        // --- Statistics Tab Logic (Optimized) ---
        async function setupStatisticsTab() {
            // --- בדיקת חסימה ---
            const isAllowed = await enforceCompanyStatus('statistics-container');
            if (!isAllowed) return; // עצור הכל אם חסום
            // -------------------

            // Cleanup previous listener if exists
            if (statisticsUnsubscribe) {
                statisticsUnsubscribe();
                statisticsUnsubscribe = null;
            }

            const container = document.getElementById('statistics-container');
            // --- Guard Clause ---
            if (!container) return;
            // --------------------
            
            const statsWeekTitle = document.getElementById('stats-week-dates-title');
            const mainTitle = document.getElementById('statistics-main-title');
            
            // --- לוגיקת בחירת קבוצת ברירת המחדל (כמו ב-Team View) ---
            let activeFilter = 'all';
            
            if (currentUserProfile) {
                if (currentUserProfile.statsViewFilter) {
                    activeFilter = currentUserProfile.statsViewFilter;
                } else if (currentUserProfile.group) {
                    activeFilter = currentUserProfile.group;
                    // שמירה לוקאלית זמנית
                    currentUserProfile.statsViewFilter = activeFilter;
                }
            }

            // עדכון הדרופ-דאון
            if (statsGroupFilter) {
                statsGroupFilter.innerHTML = '<option value="all">All Groups</option>';
                availableGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    statsGroupFilter.appendChild(option);
                });
                statsGroupFilter.value = activeFilter;
            }

            container.innerHTML = '<div class="text-center py-10 col-span-full"><svg class="animate-spin h-8 w-8 mx-auto text-purple-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-gray-500">Loading statistics...</p></div>';

            // --- חישוב טווח תאריכים דינמי ---
            const displayDate = new Date(currentDate);
            const dayOfWeek = displayDate.getDay();
            const sundayAnchor = new Date(displayDate);
            sundayAnchor.setDate(displayDate.getDate() - dayOfWeek);

            const minDay = globalWorkDays.length > 0 ? Math.min(...globalWorkDays) : 0;
            const maxDay = globalWorkDays.length > 0 ? Math.max(...globalWorkDays) : 6;

            const rangeStartDate = new Date(sundayAnchor);
            rangeStartDate.setDate(sundayAnchor.getDate() + minDay);

            const rangeEndDate = new Date(sundayAnchor);
            rangeEndDate.setDate(sundayAnchor.getDate() + maxDay);

            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            statsWeekTitle.textContent = `Week of ${rangeStartDate.toLocaleDateString('en-US', options)} - ${rangeEndDate.toLocaleDateString('en-US', options)}`;
            
            const startDate = sundayAnchor;
            // --------------------------------
            
            const isCurrentWeek = getWeekId(currentDate) === getWeekId(getEffectiveCurrentDate());
            if (isCurrentWeek) {
                mainTitle.classList.remove('return-to-today-btn', 'animated-gradient-text');
            } else {
                mainTitle.classList.add('return-to-today-btn', 'animated-gradient-text');
            }

            try {
                // 1. שליפת משתמשים חכמה - רק של הקבוצה הרלוונטית!
                const allUsers = await getCachedUsers(activeFilter);
                
                const weekId = getWeekId(currentDate);
                const mergedGroupName = "DT, DV, FW";
                const groupsToMerge = ["DT", "DV", "FW"];

                // Function to render statistics
                const renderStatistics = (attendances) => {
                    // Filter users for employee dropdown based on selected group
                    const selectedGroup = statsGroupFilter ? statsGroupFilter.value : 'all';
                    const usersInSelectedGroup = Object.entries(allUsers).filter(([uid, user]) => {
                         if (selectedGroup === 'all') return true;
                        let userGroup = user.group;
                        if (groupsToMerge.includes(userGroup)) userGroup = mergedGroupName;
                        return userGroup === selectedGroup;
                    });

                    // Populate employee filter
                    const currentEmployee = statsEmployeeFilter ? statsEmployeeFilter.value : 'all';
                    if (statsEmployeeFilter) {
                        statsEmployeeFilter.innerHTML = '<option value="all">All Employees</option>';
                        usersInSelectedGroup.sort(([, a], [, b]) => (a.fullName || a.email).localeCompare(b.fullName || b.email))
                            .forEach(([uid, user]) => {
                            const option = document.createElement('option');
                            option.value = uid;
                            option.textContent = user.fullName || user.email;
                            statsEmployeeFilter.appendChild(option);
                        });
                         // Try to keep the selection if possible
                        if (statsEmployeeFilter.querySelector(`option[value="${currentEmployee}"]`)) {
                            statsEmployeeFilter.value = currentEmployee;
                        } else {
                            statsEmployeeFilter.value = 'all';
                        }
                    }

                    // Final filter based on both group and employee
                    const selectedEmployee = statsEmployeeFilter ? statsEmployeeFilter.value : 'all';
                    const finalFilteredUserIds = usersInSelectedGroup
                        .map(([uid]) => uid)
                        .filter(uid => selectedEmployee === 'all' || uid === selectedEmployee);

                    const totalUsersInFilter = finalFilteredUserIds.length;
                    if (totalUsersInFilter === 0) {
                        container.innerHTML = '<div class="text-center py-10 col-span-full text-gray-500">No data found for this selection.</div>';
                        return;
                    }
                    
                    // Calculate stats
                    const workDaysCount = globalWorkDays.length;
                    const dailyStats = Array.from({ length: 7 }, () => ({}));
                    const weeklyStats = {};
                    let totalSlots = 0;
                    
                    finalFilteredUserIds.forEach(uid => {
                        const userAttendance = attendances[uid] || Array(7).fill(null); // Default to null
                        for (let i = 0; i < 7; i++) {
                            if (!globalWorkDays.includes(i)) continue;
                            const status = userAttendance[i];
                            // Daily
                            if (!dailyStats[i][status]) dailyStats[i][status] = 0;
                            dailyStats[i][status]++;
                            // Weekly
                            if(!weeklyStats[status]) weeklyStats[status] = 0;
                            weeklyStats[status]++;
                        }
                        totalSlots += workDaysCount;
                    });
                    
                    container.innerHTML = '';
                    
                    // [MODIFICATION 3] Render Weekly Summary Card with circular progress indicators
                    const weeklySummaryCard = document.createElement('div');
                    weeklySummaryCard.className = "weekly-summary-card p-6 rounded-lg col-span-full";
                    let weeklyHtml = '<h3 class="weekly-summary-title font-bold text-xl mb-4">Weekly Summary</h3>';
                    const sortedWeekly = Object.keys(weeklyStats).sort((a,b) => weeklyStats[b] - weeklyStats[a]);
                    if(sortedWeekly.length === 0){
                        weeklyHtml += '<p class="text-sm text-gray-500 dark:text-gray-400">No data reported for this week.</p>';
                    } else {
                        weeklyHtml += '<div class="progress-circles-container">';
                        sortedWeekly.forEach(status => {
                            const count = weeklyStats[status];
                            const percentage = ((count / totalSlots) * 100).toFixed(1);
                            const circumference = 2 * Math.PI * 42; // radius = 42
                            const offset = circumference - (percentage / 100) * circumference;
                            
                            // [תיקון] שימוש בצבע המדויק מהפונקציה החדשה
                            const color = getStatusHexColor(status);
                            
                            weeklyHtml += `
                                <div class="progress-circle-item">
                                    <div class="progress-circle">
                                        <svg viewBox="0 0 100 100">
                                            <circle class="progress-circle-bg" cx="50" cy="50" r="42"></circle>
                                            <circle class="progress-circle-fill" cx="50" cy="50" r="42"
                                                stroke="${color}"
                                                stroke-dasharray="${circumference}"
                                                stroke-dashoffset="${circumference}"
                                                data-target-offset="${offset}"></circle>
                                        </svg>
                                        <div class="progress-circle-text">
                                            <div class="progress-circle-percentage">0%</div>
                                        </div>
                                    </div>
                                    <div class="progress-circle-label">${status}</div>
                                    <div class="progress-circle-count">${count}/${totalSlots} slots</div>
                                </div>
                            `;
                        });
                        weeklyHtml += '</div>';
                    }
                    weeklySummaryCard.innerHTML = weeklyHtml;
                    container.appendChild(weeklySummaryCard);

                    // Trigger animation if Statistics tab has been visited
                    if (statisticsTabVisited) {
                        setTimeout(() => {
                            animateProgressCircles();
                        }, 100);
                    }

                    // Render Daily Cards
                     const dailyCardsContainer = document.createElement('div');
                     dailyCardsContainer.className = "mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 col-span-full";
                    
                    let dayCounter = 0;
                    for (let i = 0; i < 7; i++) {
                        if (!globalWorkDays.includes(i)) continue;
                        
                        const dayDate = new Date(startDate);
                        dayDate.setDate(startDate.getDate() + i);
                        const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                        const dateString = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        
                        const statsForDay = dailyStats[i];
                        let statsHtml = '';

                        // Sort statuses by count
                        const sortedStatuses = Object.keys(statsForDay).sort((a, b) => statsForDay[b] - statsForDay[a]);

                        if (sortedStatuses.length === 0) {
                            statsHtml = '<p class="text-sm text-gray-500">No data reported.</p>';
                        } else {
                            sortedStatuses.forEach(status => {
                                const count = statsForDay[status];
                                const percentage = ((count / totalUsersInFilter) * 100).toFixed(1);
                                
                                // [תיקון] שימוש בצבע המדויק לפס ההתקדמות
                                const barColor = getStatusHexColor(status);

                                statsHtml += `
                                    <div class="mb-3">
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">${status}</span>
                                            <span class="text-sm font-medium text-gray-500 daily-percentage" data-target="${percentage}">0% (${count}/${totalUsersInFilter})</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                            <div class="daily-progress-bar h-2.5 rounded-full" 
                                                 style="width: 0%; background-color: ${barColor}; transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);" 
                                                 data-target-width="${percentage}">
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        
                        const dayCardHtml = `
                            <div class="day-card bg-gray-50 p-4 rounded-lg border">
                                <h4 class="font-bold text-lg text-gray-800">${dayName}</h4>
                                <p class="text-sm text-gray-500 mb-4">${dateString}</p>
                                ${statsHtml}
                            </div>
                        `;
                        dailyCardsContainer.insertAdjacentHTML('beforeend', dayCardHtml);
                        dayCounter++;
                    }
                    container.appendChild(dailyCardsContainer);
                    
                    // Set up Intersection Observer for daily cards animation (always, not just when visited)
                    setTimeout(() => {
                        setupDailyCardsObserver();
                    }, 150);
                };

                // 2. בניית השאילתה - Server Side Filtering!
                const attendanceCol = collection(db, "attendance");
                const constraints = [
                    where("weekId", "==", weekId),
                    where("companyId", "==", currentUserProfile.companyId)
                ];

                // === הקסם: סינון גם בסטטיסטיקות ===
                if (activeFilter !== 'all') {
                    constraints.push(where("group", "==", activeFilter));
                }
                // ===================================
                
                const q = query(attendanceCol, ...constraints);
                
                statisticsUnsubscribe = onSnapshot(q, (snapshot) => {
                    const attendances = {};
                    snapshot.forEach(doc => {
                        attendances[doc.data().userId] = doc.data().days;
                    });
                    renderStatistics(attendances);
                }, (error) => {
                    console.error("Error in Statistics realtime listener:", error);
                    container.innerHTML = '<p class="text-red-500 col-span-full">Failed to load statistics.</p>';
                });

            } catch(error) {
                 console.error("Error fetching statistics: ", error);
                 container.innerHTML = '<p class="text-red-500 col-span-full">Failed to load statistics.</p>';
            }
        }

        // Function to set up Intersection Observer for daily statistics cards
        function setupDailyCardsObserver() {
            const cards = document.querySelectorAll('.day-card');
            
            const observerOptions = {
                root: null, // viewport
                rootMargin: '0px',
                threshold: 0.2 // trigger when 20% of card is visible
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !entry.target.dataset.animated) {
                        // Mark as animated so it only happens once
                        entry.target.dataset.animated = 'true';
                        
                        // Animate all progress bars in this card
                        const progressBars = entry.target.querySelectorAll('.daily-progress-bar');
                        const percentageTexts = entry.target.querySelectorAll('.daily-percentage');
                        
                        setTimeout(() => {
                            progressBars.forEach((bar, index) => {
                                const targetWidth = parseFloat(bar.getAttribute('data-target-width'));
                                bar.style.width = targetWidth + '%';
                                
                                // Animate percentage text
                                if (percentageTexts[index]) {
                                    const targetPercentage = parseFloat(percentageTexts[index].getAttribute('data-target'));
                                    let currentPercentage = 0;
                                    const duration = 1200;
                                    const steps = 60;
                                    const increment = targetPercentage / steps;
                                    const stepDuration = duration / steps;
                                    
                                    const intervalId = setInterval(() => {
                                        currentPercentage += increment;
                                        if (currentPercentage >= targetPercentage) {
                                            currentPercentage = targetPercentage;
                                            clearInterval(intervalId);
                                        }
                                        // Keep the count text intact
                                        const fullText = percentageTexts[index].textContent;
                                        const countPart = fullText.substring(fullText.indexOf('('));
                                        percentageTexts[index].textContent = currentPercentage.toFixed(1) + '% ' + countPart;
                                    }, stepDuration);
                                }
                            });
                        }, 100);
                        
                        // Stop observing this card
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);
            
            // Observe all cards
            cards.forEach(card => observer.observe(card));
        }


        // --- פונקציה לרוטציה יומית של קוד החברה ---
        async function checkAndRotateDailyCode(companyId) {
            if (!companyId) return;

            try {
                const companyRef = doc(db, "companies", companyId);
                const companySnap = await getDoc(companyRef);

                if (!companySnap.exists()) return;

                const data = companySnap.data();
                const lastRotation = data.lastCodeRotationDate; // תאריך הרוטציה האחרון שנשמר
                
                // קבלת התאריך של היום כמחרוזת פשוטה (למשל: "Sun Dec 07 2025")
                const todayStr = new Date().toDateString();

                // אם התאריך של היום זהה לתאריך האחרון שנשמר - סיימנו, הקוד כבר מעודכן
                if (lastRotation === todayStr) {
                    return; 
                }

                // --- אם הגענו לפה, צריך להחליף קוד! ---
                console.log("Rotating company code for a new day...");

                const oldCode = data.companyCode;
                
                // 1. יצירת קוד חדש
                const generateOrgCode = () => {
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                    let result = '';
                    for (let i = 0; i < 6; i++) {
                        result += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    return result;
                };
                const newCode = generateOrgCode();

                const batch = writeBatch(db);

                // 2. מחיקת הקוד הישן מהטבלה הציבורית (כדי שאף אחד לא יוכל להשתמש בו יותר)
                if (oldCode) {
                    const oldPublicRef = doc(db, "public_company_codes", oldCode);
                    batch.delete(oldPublicRef);
                }

                // 3. הוספת הקוד החדש לטבלה הציבורית
                const newPublicRef = doc(db, "public_company_codes", newCode);
                batch.set(newPublicRef, {
                    companyId: companyId,
                    companyName: data.name,
                    groups: data.groups || ["General"]
                });

                // 4. עדכון מסמך החברה עם הקוד החדש והתאריך של היום
                batch.update(companyRef, {
                    companyCode: newCode,
                    lastCodeRotationDate: todayStr
                });

                await batch.commit();
                console.log(`Code rotated successfully! New code: ${newCode}`);
                
                // עדכון התצוגה למשתמש אם הוא נמצא כרגע בטאב הפרופיל
                const codeDisplay = document.getElementById('settings-org-code');
                if (codeDisplay) {
                    codeDisplay.dataset.realCode = newCode;
                    // אם הקוד היה גלוי, נעדכן אותו ויזואלית, אחרת נשאיר כוכביות
                    if (!codeDisplay.innerText.includes('*')) {
                        codeDisplay.innerText = newCode;
                    }
                }

            } catch (error) {
                console.error("Error rotating daily code:", error);
            }
        }


        // --- Admin/TL/SuperAdmin Tools Logic ---
        async function setupAdminTabs() {
            const mobileTlLink = document.getElementById('mobile-tl-link');
            const mobileSaLink = document.getElementById('mobile-sa-link');
            const mobileStatsLink = document.getElementById('mobile-stats-link');
            
            // [חדש] תופסים את הקישור של הלוח שנה במובייל
            const mobileCalendarLink = document.getElementById('mobile-calendar-link'); 
            
            const mobileAdminTabs = document.getElementById('mobile-admin-tabs');
            const tlNotificationDot = document.getElementById('tl-notification-dot');
            const calendarTab = document.getElementById('tab-calendar'); 
            
            // --- Guard Clause: אם אנחנו במסך לוגין/טעינה, יציאה מהירה ---
            if (!tabs || !tabs.tlTools || !currentUserProfile) return;
            // ------------------------------------------------------------------

            // קבלת הרשאות בצורה בטוחה
            const isTL = currentUserProfile && currentUserProfile.isTL;
            const isSuperAdmin = currentUserProfile && currentUserProfile.isSuperAdmin;

            // --- ניהול הופעת לוח השנה (במחשב ובמובייל) ---
            if (isTL || isSuperAdmin) {
                // 1. טיפול בטאב העליון (מחשב)
                if(calendarTab) {
                    calendarTab.classList.remove('hidden'); 
                    calendarTab.classList.add('hidden', 'sm:block'); // מוסתר במובייל, מוצג במחשב
                }
                // 2. טיפול בתפריט ההמבורגר (מובייל) - הצגה למנהלים
                if(mobileCalendarLink) {
                    mobileCalendarLink.classList.remove('hidden');
                }
            } else {
                // עובד רגיל: הסתרה מוחלטת
                if(calendarTab) {
                    calendarTab.classList.remove('sm:block');
                    calendarTab.classList.add('hidden');
                }
                if(mobileCalendarLink) {
                    mobileCalendarLink.classList.add('hidden');
                }
            }

            // --- לוגיקה ל-Super Admin ---
            if (isSuperAdmin) {
                if(tabs.tlTools) tabs.tlTools.classList.add('hidden', 'sm:block'); 
                if(tabs.superAdmin) tabs.superAdmin.classList.add('hidden', 'sm:block');
                if(tabs.statistics) {
                    tabs.statistics.classList.remove('hidden'); 
                    tabs.statistics.classList.add('hidden', 'sm:block');
                }
                if(mobileStatsLink) mobileStatsLink.classList.remove('hidden');
                if(mobileTlLink) mobileTlLink.classList.remove('hidden');
                if(mobileSaLink) mobileSaLink.classList.remove('hidden');
                if(manageGroupsBtn) manageGroupsBtn.classList.remove('hidden');
                
                await setupSuperAdminPanel();

            } 
            // --- לוגיקה ל-Team Leader ---
            else if (isTL) {
                if(tabs.tlTools) tabs.tlTools.classList.add('hidden', 'sm:block');
                if(tabs.statistics) {
                    tabs.statistics.classList.remove('hidden');
                    tabs.statistics.classList.add('hidden', 'sm:block');
                }
                if(mobileStatsLink) mobileStatsLink.classList.remove('hidden');
                
                if(tabs.superAdmin) {
                    tabs.superAdmin.classList.remove('sm:block');
                    tabs.superAdmin.classList.add('hidden');
                }
                if(mobileSaLink) mobileSaLink.classList.add('hidden');
                if(manageGroupsBtn) manageGroupsBtn.classList.remove('hidden');
                if(mobileTlLink) mobileTlLink.classList.remove('hidden');

            } 
            // --- לוגיקה לעובד רגיל ---
            else {
                if(tabs.tlTools) {
                    tabs.tlTools.classList.remove('sm:block');
                    tabs.tlTools.classList.add('hidden');
                }
                if(tabs.statistics) {
                    tabs.statistics.classList.remove('sm:block');
                    tabs.statistics.classList.add('hidden');
                }
                if(mobileStatsLink) mobileStatsLink.classList.add('hidden');
                if(tabs.superAdmin) {
                    tabs.superAdmin.classList.remove('sm:block');
                    tabs.superAdmin.classList.add('hidden');
                }
                
                // הסתרת כל כלי הניהול
                if(manageGroupsBtn) manageGroupsBtn.classList.add('hidden');
                if(tlNotificationDot) tlNotificationDot.classList.add('hidden');
                if(mobileTlLink) mobileTlLink.classList.add('hidden');
                if(mobileSaLink) mobileSaLink.classList.add('hidden');
                
                return; // יציאה מוקדמת
            }

            // === התיקון כאן: בדיקה שהאלמנטים קיימים לפני שנוגעים בהם ===
            
            const select = document.getElementById('tl-status-select');
            if (select) { // <--- בדיקה קריטית
                select.innerHTML = globalAttendanceOptions.map(opt => {
                    const val = typeof opt === 'object' ? opt.name : opt;
                    return `<option value="${val}">${val}</option>`;
                }).join('');
            }
            
            const tlGroupFilter = document.getElementById('tl-group-filter');
            if (tlGroupFilter) { // <--- בדיקה קריטית
                tlGroupFilter.innerHTML = '<option value="all">All Groups</option>';
                availableGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    tlGroupFilter.appendChild(option);
                });
            }
            
            setupBulkUpdateView();

            // Cleanup previous listener if exists
            if (pendingUsersUnsubscribe) {
                pendingUsersUnsubscribe();
                pendingUsersUnsubscribe = null;
            }

            const pendingContainer = document.getElementById('pending-users-container');
            const actionsContainer = document.getElementById('pending-actions-container');
            
            // --- הוספנו בדיקת בטיחות ---
            if (pendingContainer && actionsContainer) {
                pendingContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Loading pending requests...</p>';
                actionsContainer.classList.add('hidden');
            }

            let q = query(
                collection(db, "pendingUsers"), 
                where("status", "==", "pending"),
                where("companyId", "==", currentUserProfile.companyId)
            );

            if (!isSuperAdmin) {
                 const userGroup = currentUserProfile.group;
                if (userGroup) {
                    const groupsToQuery = ["DT", "DV", "FW"].includes(userGroup) ? ["DT", "DV", "FW"] : [userGroup];
                    q = query(
                        collection(db, "pendingUsers"), 
                        where("status", "==", "pending"), 
                        where("companyId", "==", currentUserProfile.companyId),
                        where("group", "in", groupsToQuery)
                    );
                }
            }
            
            // Set up realtime listener for pending users
            pendingUsersUnsubscribe = onSnapshot(q, (querySnapshot) => {
                pendingUsersSnapshot = querySnapshot; // Cache for bulk actions
                
                // [תיקון] הסרת הנקודה מטאב ה-TL Tools לחלוטין (הועברה ל-Requests)
                const tlNotificationDot = document.getElementById('tl-notification-dot');
                if (tlNotificationDot) {
                    tlNotificationDot.classList.add('hidden'); // מוודאים שהיא כבויה תמיד
                }

                // [חשוב] עדכון הנורה בטאב ה-Requests (המיקום החדש)
                // זה מבטיח שאם נכנס משתמש חדש בזמן שאתה ב-TL Tools, הנורה ב-Requests תתעדכן
                updateTeamInboxBadge();
                
                const pendingContainer = document.getElementById('pending-users-container');
                const actionsContainer = document.getElementById('pending-actions-container');
                
                // הגנה נוספת: אם הקונטיינר הראשי לא קיים, אין טעם להמשיך
                if (!pendingContainer || !actionsContainer) return;

                if (querySnapshot.empty) {
                    pendingContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No pending registration requests.</p>';
                    actionsContainer.classList.add('hidden');
                } else {
                    let html = '<div class="space-y-4">';
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        html += `
                            <div class="p-4 bg-gray-50 rounded-lg border flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div>
                                    <p class="font-bold text-gray-800">${data.fullName}</p>
                                    <p class="text-sm text-gray-600">${data.email}</p>
                                    <p class="text-sm text-gray-500">Group: ${data.group}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="approve-user-btn btn btn-success text-sm py-2 px-3" data-doc-id="${doc.id}">Approve</button>
                                    <button class="reject-user-btn btn btn-danger text-sm py-2 px-3" data-doc-id="${doc.id}">Reject</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    pendingContainer.innerHTML = html;

                    // Show and set up bulk action buttons
                    actionsContainer.innerHTML = `
                        <div class="flex space-x-2">
                            <button id="approve-all-btn" class="btn btn-success text-xs py-2 px-3">Approve All</button>
                            <button id="reject-all-btn" class="btn btn-danger text-xs py-2 px-3">Reject All</button>
                        </div>
                    `;
                    actionsContainer.classList.remove('hidden');
                    
                    // Remove old listeners first to avoid duplicates
                    const approveBtn = document.getElementById('approve-all-btn');
                    const rejectBtn = document.getElementById('reject-all-btn');
                    if (approveBtn) approveBtn.addEventListener('click', handleApproveAll);
                    if (rejectBtn) rejectBtn.addEventListener('click', handleRejectAll);
                }
            }, (error) => {
                console.error("Error in Pending Users realtime listener:", error);
                pendingContainer.innerHTML = '<p class="text-red-500">Failed to load pending requests.</p>';
            });
            
            setupRemoveUserTool();
        }
        
        async function handleApproveAll() {
            if (!pendingUsersSnapshot || pendingUsersSnapshot.empty) return;
            
            // --- בדיקת הרשאה להוספת משתמש (בודקים רק פעם אחת לפני שמתחילים) ---
            const allowed = await canAddUser();
            if (!allowed) return;
            // -------------------------------------------------------------------------------
            
            showConfirmationModal('Approve All Users', `Are you sure you want to approve all ${pendingUsersSnapshot.size} pending requests?`, async () => {
                let successCount = 0;
                let errorCount = 0;
                let errors = [];

                for (const docSnap of pendingUsersSnapshot.docs) {
                    const { fullName, email, group } = docSnap.data();
                    try {
                        await createUserByAdmin(fullName, email, group);
                        successCount++;
                    } catch (error) {
                        errorCount++;
                        errors.push(`- ${email}: ${error.message}`);
                        console.error(`Failed to approve ${email}:`, error);
                    }
                }

                // After attempting to create all users, delete all original pending docs in a batch
                const batch = writeBatch(db);
                pendingUsersSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                let resultMessage = `${successCount} user(s) approved successfully.`;
                if (errorCount > 0) {
                    resultMessage += `\n\n${errorCount} user(s) failed:\n${errors.join('\n')}`;
                }

                showConfirmationModal('Bulk Approval Complete', resultMessage, () => {});
                refreshViews();
            });
        }

        async function handleRejectAll() {
            if (!pendingUsersSnapshot || pendingUsersSnapshot.empty) return;

            showConfirmationModal('Reject All Users', `Are you sure you want to reject all ${pendingUsersSnapshot.size} pending requests?`, async () => {
                try {
                    const batch = writeBatch(db);
                    pendingUsersSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    showConfirmationModal('Success', 'All pending requests have been rejected.', () => {});
                    refreshViews();
                } catch (error) {
                    console.error("Error rejecting all users:", error);
                    showConfirmationModal('Error', 'Failed to reject all requests.', () => {});
                }
            });
        }

        function setupBulkUpdateView() {
            const tlWeekDatesTitle = document.getElementById('tl-week-dates-title');
            const tlDaySelect = document.getElementById('tl-day');

            // --- Guard Clause ---
            if (!tlWeekDatesTitle || !tlDaySelect) return;
            // --------------------

            // --- חישוב טווח תאריכים דינמי (TL Tools) ---
            const displayDate = new Date(tlToolDate);
            const dayOfWeek = displayDate.getDay();
            const sundayAnchor = new Date(displayDate);
            sundayAnchor.setDate(displayDate.getDate() - dayOfWeek);
            
            const minDay = globalWorkDays.length > 0 ? Math.min(...globalWorkDays) : 0;
            const maxDay = globalWorkDays.length > 0 ? Math.max(...globalWorkDays) : 6;

            const rangeStartDate = new Date(sundayAnchor);
            rangeStartDate.setDate(sundayAnchor.getDate() + minDay);

            const rangeEndDate = new Date(sundayAnchor);
            rangeEndDate.setDate(sundayAnchor.getDate() + maxDay);

            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            tlWeekDatesTitle.textContent = `Week of ${rangeStartDate.toLocaleDateString('en-US', options)} - ${rangeEndDate.toLocaleDateString('en-US', options)}`;
            
            const startDate = sundayAnchor;
            // --------------------------------
            
            tlDaySelect.innerHTML = '';
            for (let i = 0; i < 7; i++) { // [תיקון] שינוי ל-7
                if (!globalWorkDays.includes(i)) continue; // סינון
                
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                const dateString = dayDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${dayName} (${dateString})`;
                tlDaySelect.appendChild(option);
            }
        }
        
        appContainer.addEventListener('click', e => {
            const target = e.target;

            // Handler for pending user buttons
            const pendingContainer = target.closest('#pending-users-container');
            if (pendingContainer) {
                 const docId = target.dataset.docId;
                if (!docId) return;
                if (target.classList.contains('approve-user-btn')) {
                    showConfirmationModal('Approve User', 'Are you sure you want to approve this user? An account will be created for them.', () => handleApproveUser(docId));
                } else if (target.classList.contains('reject-user-btn')) {
                    showConfirmationModal('Reject User', 'Are you sure you want to reject this registration request?', () => handleRejectUser(docId));
                }
            }
        });

        async function handleApproveUser(docId) {
            // --- בדיקת הרשאה להוספת משתמש ---
            const allowed = await canAddUser();
            if (!allowed) return;
            // --------------------------------------
            
            const pendingDocRef = doc(db, "pendingUsers", docId);
            try {
                const pendingDoc = await getDoc(pendingDocRef);
                if (!pendingDoc.exists()) throw new Error("Request not found.");

                const { fullName, email, group } = pendingDoc.data();
                await createUserByAdmin(fullName, email, group);
                await deleteDoc(pendingDocRef);

                showConfirmationModal('Success', 'User approved and created successfully!', () => {});
                refreshViews();

            } catch (error) {
                console.error("Error approving user:", error);
                let userMessage = `Failed to approve user: ${error.message}`;
                 if (error.code === 'auth/email-already-in-use' || (error.message && error.message.includes('email-already-in-use'))) {
                       userMessage = `Failed to approve user: The email address is already in use. Please reject this request and ask the user to sign in.`;
                 }
                showConfirmationModal('Error', userMessage, () => {});
            }
        }

        async function handleRejectUser(docId) {
             const pendingDocRef = doc(db, "pendingUsers", docId);
             try {
                await deleteDoc(pendingDocRef);
                showConfirmationModal('Success', 'Request rejected.', () => {});
                setupAdminTabs();
             } catch (error) {
                console.error("Error rejecting user:", error);
                showConfirmationModal('Error', 'Failed to reject request.', () => {});
             }
        }
        
        // הסרת מאזינים קודמים כדי למנוע כפילויות
        const newTlForm = tlForm.cloneNode(true);
        tlForm.parentNode.replaceChild(newTlForm, tlForm);

        newTlForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. קריאת הערכים מהטופס
            const dayIndex = parseInt(document.getElementById('tl-day').value);
            const status = document.getElementById('tl-status-select').value;
            const group = document.getElementById('tl-group-filter').value;
            const btn = bulkUpdateButton;
            
            // הגנות בסיסיות
            if (isNaN(dayIndex) || !status) {
                alert("Please select a day and status");
                return;
            }

            // שינוי כפתור ל"טוען"
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Updating...";

            try {
                // 2. שליפת כל העובדים הרלוונטיים (לפי הקבוצה שנבחרה)
                let usersToUpdate = [];
                
                // שליפת כל המשתמשים בחברה
                const usersRef = collection(db, "users");
                let qUsers = query(usersRef, where("companyId", "==", currentUserProfile.companyId));
                
                // סינון לקבוצה ספציפית אם צריך
                if (group !== 'all') {
                    qUsers = query(usersRef, where("companyId", "==", currentUserProfile.companyId), where("group", "==", group));
                }
                
                const usersSnap = await getDocs(qUsers);
                usersSnap.forEach(doc => usersToUpdate.push({ id: doc.id, ...doc.data() }));

                if (usersToUpdate.length === 0) {
                    alert("No users found in this group.");
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }

                // 3. שליפת מסמכי הנוכחות הקיימים לשבוע הזה (כדי לא לדרוס ימים אחרים!)
                const targetDate = typeof tlToolDate !== 'undefined' ? tlToolDate : new Date();
                const weekId = getWeekId(targetDate);
                
                const attendanceRef = collection(db, "attendance");
                const qAttendance = query(attendanceRef, 
                    where("companyId", "==", currentUserProfile.companyId),
                    where("weekId", "==", weekId)
                );
                
                const attendanceSnap = await getDocs(qAttendance);
                const existingAttendanceMap = {};
                attendanceSnap.forEach(doc => {
                    existingAttendanceMap[doc.data().userId] = doc.data();
                });

                // 4. הכנת ה-Batch (שמירה מרוכזת)
                const batch = writeBatch(db);
                let updateCount = 0;

                usersToUpdate.forEach(user => {
                    const docId = `${weekId}_${user.id}`;
                    const docRef = doc(db, "attendance", docId);
                    
                    // בדיקה: האם כבר יש מסמך?
                    let daysArray;

                    if (existingAttendanceMap[user.id]) {
                        // יש מסמך - לוקחים את המערך הקיים
                        daysArray = [...existingAttendanceMap[user.id].days];
                    } else {
                        // אין מסמך - יוצרים מערך חדש נקי
                        daysArray = Array(7).fill("Office"); // ברירת מחדל לכל השבוע
                    }

                    // עדכון היום הספציפי
                    daysArray[dayIndex] = status;

                    // הכנת המידע לשמירה
                    const dataToSave = {
                        days: daysArray,
                        userId: user.id,
                        weekId: weekId,
                        companyId: currentUserProfile.companyId,
                        group: user.group || 'General',
                        lastUpdated: new Date()
                    };

                    // שימוש ב-set דורס או יוצר. merge מבטיח שאם נוספו שדות אחרים הם יישמרו.
                    batch.set(docRef, dataToSave, { merge: true });
                    updateCount++;
                });

                // 5. ביצוע השמירה בפועל
                await batch.commit();
                
                // סיום והודעה למשתמש
                if (typeof showConfirmationModal === 'function') {
                    showConfirmationModal('Success', `Updated ${updateCount} employees successfully!`, () => {});
                } else {
                    alert(`Success! Updated ${updateCount} employees.`);
                }
                
                // רענון התצוגה
                refreshViews();

            } catch (error) {
                console.error("Bulk update failed:", error);
                alert("Error: " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        async function createUserByAdmin(fullName, email, group) {
             const defaultPassword = '123456';
             const tempAppName = `temp-app-${Date.now()}`;
             const tempApp = initializeApp(firebaseConfig, tempAppName);
             const tempAuth = getAuth(tempApp);
             
             let newUserUid = null;

             try {
                // נסיון ליצור משתמש ב-Auth
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, defaultPassword);
                newUserUid = userCredential.user.uid;
             } catch(error) {
                // אם השגיאה היא שהמייל כבר קיים - זה בסדר! אנחנו צריכים למצוא אותו.
                // אבל מכיוון שאי אפשר לחפש UID לפי אימייל מהקליינט, ננסה גישה אחרת:
                // במקרה הזה, אנחנו ננסה ליצור את הדוקומנט ב-Firestore ע"י חיפוש ב-pendingUsers
                // אבל הדרך הכי נקייה כאן היא להודיע למנהל.
                
                if (error.code === 'auth/email-already-in-use') {
                    // כאן השינוי: במקום לקרוס, נזרוק שגיאה ספציפית שהמנהל יבין
                    // או שנתעלם וננסה ליצור ב-Firestore אם יש לנו דרך להשיג את ה-UID (אין לנו בצד לקוח ללא לוגין)
                    // לכן הפתרון הנכון הוא להודיע למנהל שהמשתמש קיים.
                    console.warn("User already exists in Auth, trying to proceed...");
                    throw new Error("This email is already registered in the system. Please ask the user to login, or delete the old user from the Authentication tab in Firebase Console.");
                }
                throw error;
             } finally {
                   try { await deleteApp(tempApp); } catch (e) { console.error(e); }
             }

             // אם הצלחנו ליצור או שהשגנו UID, יוצרים את המסמך ב-Firestore
             if (newUserUid) {
                const userRef = doc(db, "users", newUserUid);
                const companyRef = doc(db, "companies", currentUserProfile.companyId);

                const batch = writeBatch(db); // שימוש ב-Batch כדי שזה יקרה יחד

                // 1. יצירת המשתמש
                batch.set(userRef, {
                    email: email,
                    fullName: fullName,
                    group: group,
                    companyId: currentUserProfile.companyId,
                    isTL: false,
                    isSuperAdmin: false,
                    darkMode: true,
                    teamViewFilter: group,
                    statsViewFilter: group,
                    createdBy: currentUser.uid 
                });

                // 2. עדכון המונה בחברה (+1)
                batch.update(companyRef, {
                    currentUsersCount: increment(1)
                });

                await batch.commit(); // שליחת הכל יחד
             }
             return true;
        }
        
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // --- בדיקת הרשאה להוספת משתמש ---
            const allowed = await canAddUser();
            if (!allowed) return;
            // --------------------------------------
            
            hideAllMessages();
            const fullName = document.getElementById('new-user-fullname').value;
            const email = document.getElementById('new-user-email').value;
            const group = document.getElementById('new-user-group').value;

            try {
                await createUserByAdmin(fullName, email, group);
                showSuccessAnimation(createUserSuccessAnimation);
                createUserForm.reset();
                refreshViews(); 

            } catch (error) {
                console.error("Error creating new user:", error);
                let userMessage = `Error: ${error.message}`;
                if (error.code === 'auth/email-already-in-use' || (error.message && error.message.includes('email-already-in-use'))) {
                    userMessage = `Error: The email address ${email} is already in use.`;
                }
                createUserError.textContent = userMessage;
                createUserError.classList.remove('hidden');
            }
        });
        
        async function setupRemoveUserTool() {
            removeUserGroupFilter.innerHTML = `<option value="all">All Groups</option>`;
            availableGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                removeUserGroupFilter.appendChild(option);
            });
            
            await populateRemoveUserSelect(); // Initial population
            removeUserGroupFilter.addEventListener('change', populateRemoveUserSelect);
        }

        async function populateRemoveUserSelect() {
            const selectedGroup = removeUserGroupFilter.value;
            let usersQuery = query(collection(db, "users"), where("companyId", "==", currentUserProfile.companyId));
            if (selectedGroup !== 'all') {
                usersQuery = query(collection(db, "users"), where("companyId", "==", currentUserProfile.companyId), where("group", "==", selectedGroup));
            }

            const snapshot = await getDocs(usersQuery);
            removeUserSelect.innerHTML = '<option value="">-- Select a user --</option>';
            snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(user => user.id !== currentUser.uid) // Can't delete yourself
                .filter(user => !user.isSuperAdmin || currentUserProfile.isSuperAdmin) // TLs cannot see Super Admins
                .sort((a,b) => (a.fullName || "").localeCompare(b.fullName || ""))
                .forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.fullName} (${user.email})`;
                    removeUserSelect.appendChild(option);
                });
        }
        
        removeUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userIdToRemove = removeUserSelect.value;
            if (!userIdToRemove) return;
            const userName = removeUserSelect.options[removeUserSelect.selectedIndex].text;

            showConfirmationModal(
                'Confirm User Deletion',
                `Are you sure you want to permanently delete ${userName}? This action is irreversible and will delete all their data.`,
                () => handleDeleteUser(userIdToRemove)
            );
        });
        
        async function handleDeleteUser(userId, fromAdminPanel = false) {
             try {
                const batch = writeBatch(db);
                
                // 1. מחיקת המשתמש
                const userRef = doc(db, "users", userId);
                batch.delete(userRef);

                // 2. הורדת המונה בחברה (-1)
                const companyRef = doc(db, "companies", currentUserProfile.companyId);
                batch.update(companyRef, {
                    currentUsersCount: increment(-1)
                });

                // 3. מחיקת הנוכחות (נוסיף ל-Batch)
                const attendanceQuery = query(
                    collection(db, "attendance"), 
                    where("userId", "==", userId),
                    where("companyId", "==", currentUserProfile.companyId)
                );
                const attendanceSnapshot = await getDocs(attendanceQuery);
                attendanceSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit(); // בום! הכל נמחק והתעדכן יחד

                // Remove from local cache if deleted from admin panel
                if(fromAdminPanel) {
                    allUsersCache = allUsersCache.filter(user => user.id !== userId);
                    renderUserManagementList();
                }

                showConfirmationModal('User Data Deleted', 'User data has been deleted from the database. \nIMPORTANT: Please also delete the user from the Firebase Authentication tab to fully remove them.', () => {});
                
                // Refresh main views if not called from admin panel (e.g. from TL tools)
                if (!fromAdminPanel) {
                    refreshViews();
                }

             } catch (error) {
                console.error("Error deleting user:", error);
                showConfirmationModal('Error', `Failed to delete user data: ${error.message}`, () => {});
             }
        }
        
        // --- Edit Employee Modal Logic ---
        document.getElementById('team-view-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const userId = e.target.dataset.uid;
                const userName = e.target.dataset.name;
                const userGroup = e.target.dataset.group || 'General';
                openEditModal(userId, userName, userGroup);
            }
        });
        
        async function openEditModal(userId, userName, userGroup) {
            console.log("Opening edit modal for:", userId, "name:", userName, "group:", userGroup);
            editModalTitle.textContent = `Editing attendance for: ${userName}`;
            editModalBody.innerHTML = '<p>Loading attendance...</p>';
            editEmployeeModal.dataset.editingUid = userId;
            editEmployeeModal.dataset.editingGroup = userGroup || 'General'; // שמירת הקבוצה עם ברירת מחדל
            
            const displayDate = new Date(currentDate);
            const dayOfWeek = displayDate.getDay();
            const startDate = new Date(displayDate);
            startDate.setDate(displayDate.getDate() - dayOfWeek);
            
            let formHtml = '';
            let dayCounter = 0;
            for (let i = 0; i < 7; i++) {
                // [תיקון] מדלגים על ימים שאינם פעילים
                if (!globalWorkDays.includes(i)) continue;
                
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                
                // [תיקון] חילוץ השם מתוך אובייקט או שימוש בסטרינג ישן
                const selectOptions = globalAttendanceOptions.map(opt => {
                    const val = typeof opt === 'object' ? opt.name : opt;
                    return `<option value="${val}">${val}</option>`;
                }).join('');
                
                formHtml += `
                    <div class="grid grid-cols-3 gap-4 items-center">
                         <label class="font-medium text-gray-800" for="edit-day-${dayCounter}">${dayName}</label>
                         <select id="edit-day-${dayCounter}" data-day-index="${i}" class="col-span-2 form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">${selectOptions}</select>
                    </div>
                `;
                dayCounter++;
            }
            editModalBody.innerHTML = formHtml;
            
            const weekId = getWeekId(currentDate);
            const attendanceRef = doc(db, "attendance", `${weekId}_${userId}`);
            
            // נסיון לקרוא נוכחות קיימת - אם אין, נשתמש בברירת מחדל
            try {
                const docSnap = await getDoc(attendanceRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let dayCounter = 0;
                    for (let i = 0; i < 7; i++) {
                        if (!globalWorkDays.includes(i)) continue;
                        if (data.days && data.days[i]) {
                            const elem = document.getElementById(`edit-day-${dayCounter}`);
                            if (elem) elem.value = data.days[i];
                        }
                        dayCounter++;
                    }
                } else {
                    // If no attendance doc exists, pre-fill with defaults
                    let dayCounter = 0;
                    for (let i = 0; i < 7; i++) {
                        if (!globalWorkDays.includes(i)) continue;
                        const elem = document.getElementById(`edit-day-${dayCounter}`);
                        if (elem) elem.value = "Office";
                        dayCounter++;
                    }
                }
            } catch (error) {
                // אם יש שגיאת הרשאות או המסמך לא קיים - פשוט נשתמש בברירת מחדל
                console.log("Could not load existing attendance (probably new user), using defaults");
                let dayCounter = 0;
                for (let i = 0; i < 7; i++) {
                    if (!globalWorkDays.includes(i)) continue;
                    const elem = document.getElementById(`edit-day-${dayCounter}`);
                    if (elem) elem.value = "Office";
                    dayCounter++;
                }
            }
            
            editEmployeeModal.classList.remove('hidden');
        }
        
        editModalCancel.addEventListener('click', () => {
            editEmployeeModal.classList.add('hidden');
        });

        editModalSave.addEventListener('click', async () => {
            const userId = editEmployeeModal.dataset.editingUid;
            if (!userId) return;

            const weekId = getWeekId(currentDate);
            const attendanceRef = doc(db, "attendance", `${weekId}_${userId}`);
            const daysData = Array(7).fill(null); // יוצרים מערך של 7 ימים
            let dayCounter = 0;
            for (let i = 0; i < 7; i++) {
                if (!globalWorkDays.includes(i)) continue;
                const elem = document.getElementById(`edit-day-${dayCounter}`);
                if (elem) {
                    daysData[i] = elem.value;
                }
                dayCounter++;
            }

            try {
                // לוקחים את הקבוצה מה-dataset שמורה במודל
                const userGroup = editEmployeeModal.dataset.editingGroup || 'General';
                
                console.log("Saving attendance for:", userId, "companyId:", currentUserProfile.companyId, "group:", userGroup);
                
                // Use setDoc here which creates or overwrites.
                await setDoc(attendanceRef, { 
                    days: daysData,
                    weekId: weekId,
                    userId: userId,
                    companyId: currentUserProfile.companyId, // <--- המנהל והעובד באותה חברה!
                    group: userGroup // <--- מה-dataset של הכפתור
                }, { merge: true }); // merge מאפשר ליצור או לעדכן
                
                console.log("Attendance saved successfully!");
                editEmployeeModal.classList.add('hidden');
                // refreshViews() removed - realtime listeners will update automatically
            } catch (error) {
                console.error("Error saving employee week:", error);
                console.error("Error code:", error.code);
                console.error("Error message:", error.message);
                showConfirmationModal('Error', `Failed to save changes: ${error.message}`, () => {});
            }
        });

        // --- Super Admin Panel Logic ---
        async function setupSuperAdminPanel() {
            populateGroupSelects(); 
            loadWorkDaysUI(); // <--- טעינת UI של ימי עבודה
            
            // --- בדיקת סטטוס הפעלה והצגת פאנל מתאים ---
            checkCompanyActivationStatus();
            // -----------------------------------------------
            
            // [תיקון אבטחה] שליפת משתמשים אך ורק מהחברה הנוכחית
            try {
                if (!currentUserProfile || !currentUserProfile.companyId) {
                    allUsersCache = [];
                    renderUserManagementList();
                    return;
                }

                const usersRef = collection(db, "users");
                const q = query(usersRef, where("companyId", "==", currentUserProfile.companyId));
                const snapshot = await getDocs(q);
                allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserManagementList();
            } catch (error) {
                console.error('Error loading users for super admin panel:', error);
                allUsersCache = [];
                renderUserManagementList();
            }
        }

        // --- Work Days Configuration Logic ---
        const workDaysForm = document.getElementById('work-days-form');
        const workDaysSuccess = document.getElementById('work-days-success');
        const workDaysSuccessAnimation = document.getElementById('work-days-success-animation');

        // פונקציה לטעינת הצ'קבוקסים לפי המצב הקיים
        function loadWorkDaysUI() {
            const checkboxes = document.querySelectorAll('input[name="workday"]');
            checkboxes.forEach(cb => {
                cb.checked = globalWorkDays.includes(parseInt(cb.value));
            });
        }

        // --- בדיקת סטטוס הפעלה והצגת הפאנל המתאים ---
        async function checkCompanyActivationStatus() {
            if (!currentUserProfile || !currentUserProfile.companyId) return;

            const companyRef = doc(db, "companies", currentUserProfile.companyId);
            const snap = await getDoc(companyRef);
            
            if (snap.exists()) {
                const data = snap.data();
                const isActivated = data.isActivated || false;
                const maxUsers = data.maxUsers || 10;
                
                // ספירת משתמשים קיימים
                const usersQuery = query(collection(db, "users"), where("companyId", "==", currentUserProfile.companyId));
                const usersSnap = await getDocs(usersQuery);
                const currentCount = usersSnap.size;

                const activationPanel = document.getElementById('activation-panel');
                const usagePanel = document.getElementById('usage-panel');
                
                if (!isActivated) {
                    // מצב נעול
                    if(activationPanel) activationPanel.classList.remove('hidden');
                    if(usagePanel) usagePanel.classList.add('hidden');
                } else {
                    // מצב פעיל - הצג בר שימוש
                    if(activationPanel) activationPanel.classList.add('hidden');
                    if(usagePanel) {
                        usagePanel.classList.remove('hidden');
                        const percent = Math.min((currentCount / maxUsers) * 100, 100);
                        document.getElementById('usage-bar').style.width = `${percent}%`;
                        document.getElementById('usage-text').textContent = `${currentCount} / ${maxUsers} Users`;
                        
                        // שינוי צבע אם מתקרבים לגבול
                        if (percent >= 90) {
                            document.getElementById('usage-bar').classList.remove('bg-purple-600');
                            document.getElementById('usage-bar').classList.add('bg-red-500');
                        }
                    }
                }
            }
        }

        // --- לוגיקה לטופס השחרור (Unlock) ---
        const activationForm = document.getElementById('activation-form');
        const activationInputs = document.querySelectorAll('.activation-otp');

        if (activationInputs.length > 0) {
            // 1. לוגיקת מעבר בין הקוביות
            activationInputs.forEach((input, index) => {
                // מעבר אוטומטי בהקלדה
                input.addEventListener('input', (e) => {
                    // הביטוי הזה [^a-zA-Z0-9] אומר: תמחק כל מה ש*לא* אות (גדולה/קטנה) או מספר
                    const value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    e.target.value = value;
                    
                    if (value.length === 1) {
                        if (index < activationInputs.length - 1) {
                            activationInputs[index + 1].focus();
                        }
                    }
                });

                // מחיקה (Backspace)
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value) {
                        if (index > 0) activationInputs[index - 1].focus();
                    }
                    if (e.key === 'ArrowLeft' && index > 0) activationInputs[index - 1].focus();
                    if (e.key === 'ArrowRight' && index < activationInputs.length - 1) activationInputs[index + 1].focus();
                });

                // הדבקה (Paste)
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text').trim().toUpperCase();
                    if (!text) return;

                    activationInputs.forEach((inp, i) => {
                        if (text[i]) inp.value = text[i];
                    });
                    // פוקוס על האחרון
                    const focusIndex = Math.min(text.length, activationInputs.length) - 1;
                    if (focusIndex >= 0) activationInputs[focusIndex].focus();
                });
            });
        }

        // 2. לוגיקת השליחה (איסוף המספרים)
        if (activationForm) {
            activationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // איסוף הקוד מכל הקוביות
                let inputCode = '';
                document.querySelectorAll('.activation-otp').forEach(input => {
                    inputCode += input.value;
                });

                const btn = activationForm.querySelector('button');
                
                if (inputCode.length < 6) {
                    showNotification("Incomplete Code", "Please enter the full 6-digit code.", "error");
                    return;
                }
                
                btn.disabled = true;
                const originalText = btn.textContent;
                btn.textContent = "Checking...";

                try {
                    const companyRef = doc(db, "companies", currentUserProfile.companyId);
                    const snap = await getDoc(companyRef);
                    
                    if (snap.exists()) {
                        const data = snap.data();
                        // השוואה לקוד שנשמר בדאטהבייס
                        if (data.activationCode === inputCode) {
                            await updateDoc(companyRef, { isActivated: true });
                            
                            showNotification("Unlocked!", "Company unlocked successfully! You can now add employees.", "success");
                            checkCompanyActivationStatus(); // רענון התצוגה (יעלים את הפאנל האדום)
                        } else {
                            showNotification("Access Denied", "The code you entered is incorrect. Please try again.", "error");
                            // ניקוי הקוביות
                            activationInputs.forEach(inp => inp.value = '');
                            activationInputs[0].focus();
                        }
                    }
                } catch (error) {
                    console.error("Activation error:", error);
                    showNotification("System Error", "Could not verify code. Please check your connection.", "error");
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            });
        }

        // --- Upgrade Limit Logic (Manual Input + Gradient) ---
        const upgradeBtn = document.getElementById('upgrade-limit-btn');
        const upgradeModal = document.getElementById('upgrade-modal');
        const upgradeInput = document.getElementById('upgrade-amount-input');
        const upgradePlus = document.getElementById('upgrade-plus');
        const upgradeMinus = document.getElementById('upgrade-minus');
        const upgradeConfirm = document.getElementById('upgrade-confirm');
        const upgradeCancel = document.getElementById('upgrade-cancel');

        if (upgradeBtn) {
            // פתיחת המודל
            upgradeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                // שליפת הכמות הנוכחית של המשתמשים בחברה (אם קיים בפרופיל) או ברירת מחדל
                let startVal = 15;
                
                upgradeInput.value = startVal;
                animateModalOpen('upgrade-modal');
                
                // פוקוס למובייל - כדי שאפשר יהיה להקליד ישר
                setTimeout(() => upgradeInput.select(), 100);
            });

            // כפתור פלוס
            if (upgradePlus) {
                upgradePlus.addEventListener('click', () => {
                    let val = parseInt(upgradeInput.value) || 0;
                    upgradeInput.value = val + 5; // קפיצות של 5
                });
            }

            // כפתור מינוס
            if (upgradeMinus) {
                upgradeMinus.addEventListener('click', () => {
                    let val = parseInt(upgradeInput.value) || 0;
                    if (val > 5) {
                        upgradeInput.value = val - 5;
                    } else {
                        upgradeInput.value = 1;
                    }
                });
            }
            
            // ולידציה להקלדה ידנית
            if (upgradeInput) {
                upgradeInput.addEventListener('input', (e) => {
                    // מניעת תווים לא חוקיים
                    let val = e.target.value.replace(/[^0-9]/g, '');
                    e.target.value = val;
                });
                
                // כשיוצאים מהשדה, אם הוא ריק או 0, נחזיר ל-1
                upgradeInput.addEventListener('blur', (e) => {
                    let val = parseInt(e.target.value);
                    if (isNaN(val) || val < 1) {
                        e.target.value = 1;
                    }
                });
            }

            // סגירה
            if (upgradeCancel) {
                upgradeCancel.addEventListener('click', () => {
                    animateModalClose('upgrade-modal');
                });
            }

            // 5. אישור ושליחה
            if (upgradeConfirm) {
                upgradeConfirm.addEventListener('click', async () => {
                    const desiredAmount = upgradeInput.value;
                    const btnContent = upgradeConfirm.innerHTML;
                    
                    // חיווי טעינה על הכפתור
                    upgradeConfirm.disabled = true;
                    upgradeConfirm.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

                    try {
                        // שליפת פרטים
                        let companyName = "My Company";
                        let companyId = "Unknown";
                        
                        if (currentUserProfile && currentUserProfile.companyId) {
                            companyId = currentUserProfile.companyId;
                            const docSnap = await getDoc(doc(db, "companies", companyId));
                            if (docSnap.exists()) {
                                companyName = docSnap.data().name;
                            }
                        }

                        // בניית המייל
                        const recipient = "louly.deliable@gmail.com";
                        const subject = `Upgrade Request: ${companyName} (${desiredAmount} Users)`;
                        
                        const body = `Hello Louly Team,

I would like to request an upgrade for my organization.

Organization Name: ${companyName}
Organization ID: ${companyId}
Current Admin: ${currentUserProfile.email}

Requested Max Users: ${desiredAmount}

Please let me know the pricing and next steps.

Best regards,
${currentUserProfile.fullName || 'Admin'}`;

                        // פתיחת המייל
                        window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                        
                        // סגירת המודל אחרי שנייה
                        setTimeout(() => {
                            animateModalClose('upgrade-modal');
                            upgradeConfirm.disabled = false;
                            upgradeConfirm.innerHTML = btnContent;
                        }, 1000);

                    } catch (err) {
                        console.error("Error:", err);
                        animateModalClose('upgrade-modal');
                        // שימוש במודל השגיאה החדש שלנו!
                        showNotification("Error", "Could not open email client.", "error");
                        upgradeConfirm.disabled = false;
                        upgradeConfirm.innerHTML = btnContent;
                    }
                });
            }
        }

        // --- פונקציה להצגת מודל החסימה החדש ---
        function showLimitError(title, message) {
            const modal = document.getElementById('limit-modal');
            if (!modal) return;
            
            document.getElementById('limit-modal-title').textContent = title;
            document.getElementById('limit-modal-body').innerHTML = message;
            
            // אנימציית כניסה
            modal.classList.remove('hidden');
            const content = modal.querySelector('.modal-content');
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }

        // --- לוגיקה לכפתור המעבר ל-Settings ---
        const limitRedirectBtn = document.getElementById('limit-redirect-btn');
        if (limitRedirectBtn) {
            limitRedirectBtn.addEventListener('click', () => {
                document.getElementById('limit-modal').classList.add('hidden');
                
                // מעבר לטאב ההגדרות (Super Admin / Settings)
                const settingsTab = document.getElementById('tab-super-admin');
                if (settingsTab) {
                    settingsTab.click(); // מדמה לחיצה אמיתית על הטאב
                }
            });
        }

        // --- הפונקציה המעודכנת לבדיקת הרשאת הוספה ---
        async function canAddUser() {
            if (!currentUserProfile || !currentUserProfile.companyId) return false;
            
            const companyRef = doc(db, "companies", currentUserProfile.companyId);
            const snap = await getDoc(companyRef);
            
            if (!snap.exists()) return false;
            
            const data = snap.data();
            
            // 1. בדיקה אם החברה הופעלה (Trial Mode)
            if (!data.isActivated) {
                showLimitError(
                    'Account Locked', 
                    'Your account is in Trial Mode.<br>Please enter the activation code in the <b>Settings</b> tab to unlock adding employees.'
                );
                return false;
            }
            
            // 2. בדיקה אם הגיעו למקסימום משתמשים
            const maxUsers = data.maxUsers || 10;
            // ספירה בזמן אמת מהדאטהבייס
            const usersQuery = query(collection(db, "users"), where("companyId", "==", currentUserProfile.companyId));
            const usersSnap = await getDocs(usersQuery);
            
            if (usersSnap.size >= maxUsers) {
                showLimitError(
                    'Limit Reached', 
                    `You have reached the maximum limit of <b>${maxUsers}</b> users.<br>Please upgrade your plan in the <b>Settings</b> tab to add more.`
                );
                return false;
            }
            
            return true;
        }

        // --- פונקציה לבדיקת סטטוס והצגת מסך חסימה ---
        // פונקציה לבדיקת חסימה (BLOCKED) והצגת מסך "Account Blocked"
        async function enforceCompanyStatus(containerId) {
            if (!currentUserProfile || !currentUserProfile.companyId) return false;

            const companyRef = doc(db, "companies", currentUserProfile.companyId);
            const snap = await getDoc(companyRef);

            if (snap.exists()) {
                const data = snap.data();
                
                // --- השינוי כאן: בודקים רק אם הוא BLOCKED ---
                if (data.isBlocked === true) {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-20 text-center animate-in fade-in zoom-in duration-300">
                                <div class="w-24 h-24 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mb-6">
                                    <svg class="w-12 h-12 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                </div>
                                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Account Blocked</h2>
                                <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto mb-8">
                                    This account has been suspended by the administrator.
                                    Please contact support to resolve this issue.
                                </p>
                            </div>
                        `;
                    }
                    return false; // עצור הכל
                }
            }
            return true; // הכל תקין, תמשיך
        }

        // שמירת ימי העבודה
        if (workDaysForm) {
            workDaysForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedDays = Array.from(document.querySelectorAll('input[name="workday"]:checked'))
                    .map(cb => parseInt(cb.value))
                    .sort((a, b) => a - b); // לוודא שהם מסודרים

                if (selectedDays.length === 0) {
                    alert("Please select at least one working day.");
                    return;
                }

                try {
                    const companyRef = doc(db, "companies", currentUserProfile.companyId);
                    await updateDoc(companyRef, { workDays: selectedDays });
                    
                    globalWorkDays = selectedDays;
                    
                    // הפעלת האנימציה החדשה
                    showSuccessAnimation(workDaysSuccessAnimation);
                    
                    refreshViews(); // רענון כל הטבלאות
                } catch (error) {
                    console.error("Error saving work days:", error);
                    alert("Failed to save settings.");
                }
            });
        }

        function updateSloganUI(text) {
            const headerSlogan = document.getElementById('header-slogan');
            if (headerSlogan) {
                // אם ריק, שים רווח בלתי נראה כדי לשמור על גובה קבוע
                if (!text || text.trim() === '') {
                    headerSlogan.innerHTML = '&nbsp;'; // רווח בלתי נראה
                    headerSlogan.classList.remove('hidden'); // תמיד מוצג
                } else {
                    headerSlogan.textContent = text;
                    headerSlogan.classList.remove('hidden');
                }
            }
        }

        // --- Slogan Configuration Logic ---
        if (sloganForm) {
            sloganForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newSlogan = document.getElementById('company-slogan-input').value.trim();

                try {
                    const companyRef = doc(db, "companies", currentUserProfile.companyId);
                    // עדכון שדה slogan במסמך החברה
                    await updateDoc(companyRef, { slogan: newSlogan });
                    
                    // עדכון מיידי של התצוגה למעלה
                    updateSloganUI(newSlogan);
                    
                    // הפעלת אנימציית ההצלחה
                    showSuccessAnimation(sloganSuccessAnimation);
                    
                } catch (error) {
                    console.error("Error saving slogan:", error);
                    alert("Failed to save branding settings.");
                }
            });
        }

        // --- [NEW] Logic for Managing Attendance Types ---

        const manageAttendanceList = document.getElementById('manage-attendance-list');
        const addAttendanceTypeForm = document.getElementById('add-attendance-type-form');

        function renderManageAttendanceTypes() {
            if (!manageAttendanceList) return;
            manageAttendanceList.innerHTML = '';

            globalAttendanceOptions.forEach(typeObj => {
                const name = typeof typeObj === 'string' ? typeObj : typeObj.name;
                const color = typeof typeObj === 'object' ? typeObj.color : '#9ca3af';
                const textColor = getContrastYIQ(color);

                const tag = document.createElement('div');
                // שימוש ב-Style ישיר
                tag.style.backgroundColor = color;
                tag.style.color = textColor;
                tag.className = "flex items-center px-3 py-1 rounded-full border border-black/10 text-sm font-bold shadow-sm";
                
                const span = document.createElement('span');
                span.textContent = name;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = "ml-2 opacity-60 hover:opacity-100 font-bold focus:outline-none";
                removeBtn.innerHTML = "&times;";
                removeBtn.onclick = () => removeAttendanceType(name);

                tag.appendChild(span);
                tag.appendChild(removeBtn);
                manageAttendanceList.appendChild(tag);
            });
        }

        async function saveAttendanceTypes(newTypes) {
            if (!currentUserProfile || !currentUserProfile.companyId) return;
            
            try {
                const companyRef = doc(db, "companies", currentUserProfile.companyId);
                await updateDoc(companyRef, { attendanceTypes: newTypes });
                
                globalAttendanceOptions = newTypes;
                renderManageAttendanceTypes();
                refreshViews(); // מרענן את כל הדרופ-דאונים באפליקציה
                
            } catch (error) {
                console.error("Error saving attendance types:", error);
                alert("Failed to save changes.");
            }
        }

        // פונקציה מעודכנת למחיקת קטגוריה - עם מודל מעוצב במקום הודעת דפדפן
        async function removeAttendanceType(typeToRemove) {
            // שימוש במודל המותאם אישית שלך
            showConfirmationModal(
                'Remove Category', // כותרת
                `Are you sure you want to remove the category "${typeToRemove}"?\nNote: Existing attendance records with this status will remain unchanged.`, // תוכן ההודעה
                async () => {
                    // הפעולה שתתבצע רק לאחר לחיצה על Confirm
                    const newList = globalAttendanceOptions.filter(t => (t.name || t) !== typeToRemove);
                    await saveAttendanceTypes(newList);
                }
            );
        }

        if (addAttendanceTypeForm) {
            addAttendanceTypeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const inputName = document.getElementById('new-attendance-type');
                const inputColor = document.getElementById('new-attendance-color');
                
                const val = inputName.value.trim();
                const color = inputColor ? inputColor.value : '#10b981';
                
                // בדיקה אם קיים
                const exists = globalAttendanceOptions.some(t => (t.name || t) === val);

                if (val && !exists) {
                    const newList = [...globalAttendanceOptions, { name: val, color: color }];
                    await saveAttendanceTypes(newList);
                    inputName.value = '';
                } else if (exists) {
                    alert("This type already exists.");
                }
            });
        }

        function renderUserManagementList() {
            const searchTerm = userSearchInput.value.toLowerCase();
            const groupFilterVal = userGroupFilter.value;

            const filteredUsers = allUsersCache.filter(user => {
                const nameMatch = (user.fullName || '').toLowerCase().includes(searchTerm);
                const emailMatch = (user.email || '').toLowerCase().includes(searchTerm);
                const groupMatch = groupFilterVal === 'all' || user.group === groupFilterVal;
                return (nameMatch || emailMatch) && groupMatch;
            });

            if (filteredUsers.length === 0) {
                userManagementContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No users found.</p>';
                return;
            }

            let tableHtml = `
                <div class="shadow-sm border border-gray-200 dark:border-gray-700 rounded-lg overflow-x-auto relative" style="isolation: isolate;">
                    <table class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700 min-w-max md:w-full table-auto">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th class="sticky-col py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Name</th>
                                <th class="py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Email</th>
                                <th class="py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Group</th>
                                <th class="py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Role</th>
                                <th class="py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            `;

            filteredUsers.sort((a,b) => (a.fullName || "").localeCompare(b.fullName || "")).forEach(user => {
                let role = 'Employee';
                if (user.isSuperAdmin) role = 'Super Admin';
                else if (user.isTL) role = 'Team Leader';

                tableHtml += `
                    <tr>
                        <td class="sticky-col py-3 px-2 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100">${user.fullName}</td>
                        <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm text-gray-500 dark:text-gray-400">${user.email}</td>
                        <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm text-gray-500 dark:text-gray-400">${user.group}</td>
                        <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm font-medium ${user.isSuperAdmin ? 'text-red-600' : (user.isTL ? 'theme-purple-text-dark' : 'text-gray-500 dark:text-gray-400')}">${role}</td>
                        <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm">
                            <button class="sa-edit-user-btn theme-link hover:underline font-medium mr-3" data-uid="${user.id}">Edit</button>
                            <button class="sa-delete-user-btn text-red-600 hover:underline font-medium" data-uid="${user.id}" data-name="${user.fullName}">Delete</button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table></div>`;
            userManagementContainer.innerHTML = tableHtml;
        }

        userManagementContainer.addEventListener('click', e => {
            if (e.target.classList.contains('sa-edit-user-btn')) {
                const userId = e.target.dataset.uid;
                openSuperAdminEditModal(userId);
            }
            if (e.target.classList.contains('sa-delete-user-btn')) {
                const userId = e.target.dataset.uid;
                const userName = e.target.dataset.name;
                 showConfirmationModal(
                     'Confirm User Deletion',
                     `Are you sure you want to permanently delete ${userName}? This action is irreversible and will delete all their data.`,
                     () => handleDeleteUser(userId, true) // Pass true to signify it's from the admin panel
                 );
            }
        });
        
        function openSuperAdminEditModal(userId) {
            const user = allUsersCache.find(u => u.id === userId);
            if (!user) return;

            superAdminEditForm.dataset.editingUid = userId;
            document.getElementById('sa-modal-title').textContent = `Edit User: ${user.fullName}`;
            document.getElementById('sa-edit-fullname').value = user.fullName;
            document.getElementById('sa-edit-email').value = user.email;
            document.getElementById('sa-edit-group').value = user.group;

            if (user.isSuperAdmin) {
                document.getElementById('sa-role-superadmin').checked = true;
            } else if (user.isTL) {
                document.getElementById('sa-role-tl').checked = true;
            } else {
                document.getElementById('sa-role-employee').checked = true;
            }
            
            superAdminEditModal.classList.remove('hidden');
        }

        superAdminEditCancel.addEventListener('click', () => {
            superAdminEditModal.classList.add('hidden');
        });
        
        document.getElementById('sa-email-info-btn').addEventListener('click', (e) => {
             e.preventDefault();
             showConfirmationModal('Action Not Allowed', 'Changing a user\'s email address requires server-side logic (Cloud Functions) with Admin SDK privileges and is not supported in this client-only app.', ()=>{});
        });

        superAdminEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = superAdminEditForm.dataset.editingUid;
            if (!userId) return;
            
            const selectedRole = document.querySelector('input[name="sa-role"]:checked').value;
            const dataToUpdate = {
                fullName: document.getElementById('sa-edit-fullname').value,
                group: document.getElementById('sa-edit-group').value,
                isTL: selectedRole === 'tl' || selectedRole === 'superadmin',
                isSuperAdmin: selectedRole === 'superadmin'
            };

            try {
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, dataToUpdate);
                
                // Update local cache to reflect changes immediately
                const userIndex = allUsersCache.findIndex(u => u.id === userId);
                if (userIndex > -1) {
                    allUsersCache[userIndex] = { ...allUsersCache[userIndex], ...dataToUpdate };
                }
                
                superAdminEditModal.classList.add('hidden');
                renderUserManagementList(); // Re-render the list with updated data
                refreshViews(); // Refresh other views like team view if group changed

            } catch (error) {
                console.error("Error updating user:", error);
                alert(`Failed to update user: ${error.message}`);
            }
        });
        
        // --- [NEW] Click listener for the main title in Update Week tab ---
        document.getElementById('update-week-main-title').addEventListener('click', () => {
            const titleEl = document.getElementById('update-week-main-title');
            if (titleEl.classList.contains('return-to-today-btn')) {
                currentDate = getEffectiveCurrentDate();
                refreshViews();
            }
        });
        document.getElementById('team-view-main-title').addEventListener('click', () => {
            const titleEl = document.getElementById('team-view-main-title');
            if (titleEl.classList.contains('return-to-today-btn')) {
                currentDate = getEffectiveCurrentDate();
                refreshViews();
            }
        });
        document.getElementById('statistics-main-title').addEventListener('click', () => {
            const titleEl = document.getElementById('statistics-main-title');
            if (titleEl.classList.contains('return-to-today-btn')) {
                currentDate = getEffectiveCurrentDate();
                refreshViews();
            }
        });

        // --- Export Statistics to PDF (Dynamic & Fixed) ---
        async function exportPDFForMonth(selectedMonthValue, monthName) {
            const button = document.getElementById('export-stats-pdf-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            try {
                const { jsPDF } = window.jspdf;
                const groupFilter = document.getElementById('stats-group-filter');
                const employeeFilter = document.getElementById('stats-employee-filter');
                
                const selectedGroup = groupFilter.value;
                const selectedGroupText = groupFilter.options[groupFilter.selectedIndex].text;
                const selectedEmployee = employeeFilter.value;
                const selectedEmployeeText = employeeFilter.options[employeeFilter.selectedIndex].text;

                // חישוב תאריכים
                const [selectedYear, selectedMonthStr] = selectedMonthValue.split('-').map(Number);
                const currentMonth = selectedMonthStr - 1; 
                const currentYear = selectedYear;

                // 1. זיהוי דינמי של כל הקטגוריות הקיימות במערכת
                // אנחנו הופכים את האובייקטים למערך של שמות (Strings)
                const activeCategories = globalAttendanceOptions.map(opt => (typeof opt === 'string' ? opt : opt.name));

                // שליפת משתמשים (מסונן לפי חברה)
                const usersCol = collection(db, "users");
                const qUsers = query(usersCol, where("companyId", "==", currentUserProfile.companyId));
                const userSnapshot = await getDocs(qUsers);
                
                const allUsers = {};
                userSnapshot.forEach(doc => {
                    allUsers[doc.id] = doc.data();
                });

                // סינון משתמשים לפי בחירה בדרופדאון
                let filteredUsers = Object.entries(allUsers);
                if (selectedGroup !== 'all') {
                    filteredUsers = filteredUsers.filter(([uid, user]) => user.group === selectedGroup);
                }
                if (selectedEmployee !== 'all') {
                    filteredUsers = filteredUsers.filter(([uid]) => uid === selectedEmployee);
                }
                
                filteredUsers.sort(([, a], [, b]) => (a.fullName || a.email).localeCompare(b.fullName || b.email));

                // שליפת נתוני נוכחות - שתי שיטות משולבות:
                // 1. מסמכים עם companyId (חדשים)
                // 2. מסמכים לפי userId (ישנים - fallback)
                let allAttendanceDocs = [];
                
                try {
                    // ניסיון לשלוף לפי companyId (מסמכים חדשים)
                    const attendanceCol = collection(db, "attendance");
                    const companyQuery = query(attendanceCol, where("companyId", "==", currentUserProfile.companyId));
                    const companySnapshot = await getDocs(companyQuery);
                    allAttendanceDocs = companySnapshot.docs;
                    console.log(`Fetched ${allAttendanceDocs.length} attendance records with companyId`);
                    
                    // אם יש עובדים מסוננים, ננסה לשלוף גם מסמכים ישנים לפי userId
                    for (const [uid] of filteredUsers) {
                        const userQuery = query(attendanceCol, where("userId", "==", uid));
                        try {
                            const userSnapshot = await getDocs(userQuery);
                            userSnapshot.docs.forEach(doc => {
                                // הוסף רק אם עוד לא קיים (למנוע כפילויות)
                                if (!allAttendanceDocs.find(d => d.id === doc.id)) {
                                    allAttendanceDocs.push(doc);
                                }
                            });
                        } catch (err) {
                            console.log(`Could not fetch attendance for user ${uid}:`, err.code);
                        }
                    }
                    
                    console.log(`Total attendance records for PDF: ${allAttendanceDocs.length}`);
                } catch (error) {
                    console.error("Error fetching attendance for PDF:", error);
                    alert("Could not fetch attendance records. Please try again.");
                    throw error;
                }
                
                // אתחול אובייקט הסטטיסטיקות - בצורה דינמית!
                const monthlyStats = {};
                const weeklyTrends = {}; 
                
                filteredUsers.forEach(([uid, user]) => {
                    monthlyStats[uid] = {
                        name: user.fullName || user.email,
                        group: user.group || 'Unknown',
                        isTL: user.isTL || false,
                        totalWorkDays: 0,
                        counts: {} // כאן נשמור את הספירה לכל קטגוריה דינמית
                    };
                    // איפוס מונים לכל קטגוריה קיימת
                    activeCategories.forEach(cat => {
                        monthlyStats[uid].counts[cat] = 0;
                    });
                    // מונה מיוחד לסטטוסים שנמחקו או לא קיימים יותר
                    monthlyStats[uid].counts['Other'] = 0;
                });

                // --- מעבר על כל הרשומות וחישוב יום-יום ---
                allAttendanceDocs.forEach(doc => {
                    try {
                        const data = doc.data();
                        const userId = data.userId;
                        const weekId = data.weekId;
                    
                    if (!monthlyStats[userId]) return; // דלג אם המשתמש סונן החוצה

                    const weekIdMatch = weekId.match(/^(\d{4})-W(\d{2})$/);
                    if (!weekIdMatch) return;
                    
                    const weekYear = parseInt(weekIdMatch[1]);
                    const weekNum = parseInt(weekIdMatch[2]);
                    
                    // חישוב תאריך יום ראשון של השבוע
                    const simpleDate = new Date(weekYear, 0, 1 + (weekNum - 1) * 7);
                    const dayOfWeek = simpleDate.getDay();
                    const weekStart = new Date(simpleDate);
                    weekStart.setDate(simpleDate.getDate() - dayOfWeek);

                    // בדיקה האם השבוע חופף לחודש (לצורך אתחול טרנדים)
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    const monthStart = new Date(currentYear, currentMonth, 1);
                    const monthEnd = new Date(currentYear, currentMonth + 1, 0);
                    
                    if (weekEnd >= monthStart && weekStart <= monthEnd) {
                        if (!weeklyTrends[weekId]) {
                            weeklyTrends[weekId] = { weekNum: weekNum, counts: {} };
                            activeCategories.forEach(cat => weeklyTrends[weekId].counts[cat] = 0);
                        }
                    }

                    const days = data.days || [];
                    
                    // **התיקון הגדול: לולאה על כל יום בנפרד**
                    days.forEach((status, index) => {
                        if (!status || status === '---') return;

                        // חישוב התאריך המדויק של היום הספציפי
                        const specificDayDate = new Date(weekStart);
                        specificDayDate.setDate(weekStart.getDate() + index);

                        // בדיקה: האם היום הזה נופל בחודש הנבחר?
                        if (specificDayDate.getMonth() === currentMonth && specificDayDate.getFullYear() === currentYear) {
                            
                            monthlyStats[userId].totalWorkDays++;
                            
                            // ספירה דינמית
                            if (activeCategories.includes(status)) {
                                monthlyStats[userId].counts[status]++;
                                if (weeklyTrends[weekId]) {
                                    weeklyTrends[weekId].counts[status]++;
                                }
                            } else {
                                // אם הסטטוס לא ברשימה (אולי נמחק), נכניס ל-Other
                                monthlyStats[userId].counts['Other']++;
                            }
                        }
                    });
                    } catch (error) {
                        // דילוג על מסמכים שלא ניתן לקרוא (שגיאות הרשאות)
                        console.log("Skipped attendance doc due to permissions:", error.code);
                    }
                });

                // חישוב סה"כ כללי (Aggregates) לכל קטגוריה
                const aggregateStats = {};
                activeCategories.forEach(cat => aggregateStats[cat] = 0);
                aggregateStats['Other'] = 0;

                Object.values(monthlyStats).forEach(stats => {
                    activeCategories.forEach(cat => {
                        aggregateStats[cat] += stats.counts[cat];
                    });
                    aggregateStats['Other'] += stats.counts['Other'];
                });

                // --- בניית ה-HTML ל-PDF ---
                const pdfContent = document.createElement('div');
                pdfContent.style.padding = '20px';
                pdfContent.style.backgroundColor = 'white';
                pdfContent.style.width = '1000px'; // רוחב קבוע ל-Canvas
                
                pdfContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="font-size: 26px; font-weight: bold; color: #1428a0; margin-bottom: 5px;">Company Attendance Report</h1>
                        <h2 style="font-size: 22px; font-weight: 600; color: #333; margin-bottom: 5px;">${monthName}</h2>
                        <div style="font-size: 12px; color: #888;">
                            <span><strong>Filter:</strong> ${selectedGroupText}</span>
                        </div>
                    </div>
                `;

                // חלק 1: כרטיסי סיכום (KPI) - דינמיים לפי הנתונים הכי נפוצים
                // נמצא את 4 הקטגוריות עם המספרים הכי גבוהים
                const sortedCategories = activeCategories.sort((a,b) => aggregateStats[b] - aggregateStats[a]);
                const topCategories = sortedCategories.slice(0, 4); 
                const totalDays = Object.values(aggregateStats).reduce((a, b) => a + b, 0);

                let kpiHTML = `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">`;
                
                // כרטיס סה"כ
                kpiHTML += `
                    <div style="background: linear-gradient(45deg, #a855f7 0%, #ec4899 100%); padding: 15px; border-radius: 10px; text-align: center; color: white; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px; font-weight: bold;">Total Work Days</div>
                        <div style="font-size: 30px; font-weight: 900;">${totalDays}</div>
                    </div>`;

                // 3 הכרטיסים הבאים הם הטופ קטגוריות
                topCategories.slice(0, 3).forEach((cat, index) => {
                    const count = aggregateStats[cat];
                    const pct = totalDays > 0 ? ((count / totalDays) * 100).toFixed(1) : 0;
                    const color = getStatusHexColor(cat); // שימוש בצבע האמיתי שלך!
                    
                    kpiHTML += `
                        <div style="background: ${color}; padding: 15px; border-radius: 10px; text-align: center; color: white; opacity: 0.9;">
                            <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">${cat}</div>
                            <div style="font-size: 28px; font-weight: bold;">${count}</div>
                            <div style="font-size: 11px;">${pct}%</div>
                        </div>`;
                });
                kpiHTML += `</div>`;
                pdfContent.innerHTML += kpiHTML;

                // חלק 2: גרפים
                const chartsSection = document.createElement('div');
                chartsSection.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;';
                
                const pieCanvas = document.createElement('canvas');
                const barCanvas = document.createElement('canvas');
                pieCanvas.style.cssText = barCanvas.style.cssText = 'background: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                
                chartsSection.appendChild(pieCanvas);
                chartsSection.appendChild(barCanvas);
                pdfContent.appendChild(chartsSection);

                // הכנת הנתונים לגרף - רק קטגוריות שיש בהן נתונים (>0)
                const nonEmptyCats = activeCategories.filter(cat => aggregateStats[cat] > 0);
                const chartLabels = nonEmptyCats;
                const chartData = nonEmptyCats.map(cat => aggregateStats[cat]);
                const chartColors = nonEmptyCats.map(cat => getStatusHexColor(cat));

                // Pie Chart
                new Chart(pieCanvas.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: chartColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: false,
                        plugins: {
                            title: { display: true, text: 'Distribution' },
                            legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } }
                        }
                    }
                });

                // Bar Chart (Weekly Trend for Top 2 categories)
                const top2 = topCategories.slice(0, 2); // לרוב Office ו-Home
                const sortedWeeks = Object.entries(weeklyTrends).sort((a, b) => a[1].weekNum - b[1].weekNum);
                const weekLabels = sortedWeeks.map(([weekId]) => weekId);
                
                const datasets = top2.map(cat => ({
                    label: cat,
                    data: sortedWeeks.map(([, data]) => data.counts[cat]),
                    borderColor: getStatusHexColor(cat),
                    backgroundColor: getStatusHexColor(cat) + '33', // הוספת שקיפות לרקע
                    tension: 0.3,
                    fill: true
                }));

                new Chart(barCanvas.getContext('2d'), {
                    type: 'line',
                    data: { labels: weekLabels, datasets: datasets },
                    options: {
                        responsive: false,
                        plugins: { title: { display: true, text: 'Weekly Trends' } }
                    }
                });

                // המתן לרינדור הגרפים
                await new Promise(resolve => setTimeout(resolve, 500));

                // חלק 3: הטבלה המפורטת (דינמית לגמרי!)
                const tableSection = document.createElement('div');
                tableSection.style.cssText = 'margin-top: 20px; page-break-before: always;';
                
                // בניית כותרות הטבלה הדינמיות
                let thHTML = '';
                activeCategories.forEach(cat => {
                    // השארת גובה ותצוגה נורמלית
                    thHTML += `<th style="border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 10px; height: 40px;">${cat}</th>`;
                });

                let tableHTML = `
                    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Detailed Report</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                        <thead>
                            <tr style="background-color: #1f2937; color: white;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Employee</th>
                                ${thHTML}
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                Object.entries(monthlyStats).forEach(([uid, stats], index) => {
                    const rowBg = index % 2 === 0 ? '#f9fafb' : 'white';
                    let tds = '';
                    
                    // יצירת תא לכל קטגוריה עבור העובד
                    activeCategories.forEach(cat => {
                        const count = stats.counts[cat];
                        const cellBg = count > 0 ? getStatusHexColor(cat) + '15' : 'transparent'; // רקע עדין אם יש ערך
                        const val = count > 0 ? count : ''; // אל תציג 0 כדי למנוע עומס
                        tds += `<td style="border: 1px solid #ddd; padding: 6px; text-align: center; background-color: ${cellBg};">${val}</td>`;
                    });

                    tableHTML += `
                        <tr style="background-color: ${rowBg};">
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${stats.name}</td>
                            ${tds}
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;">${stats.totalWorkDays}</td>
                        </tr>
                    `;
                });

                // --- קוד חדש: בניית שורת הסיכום הכללי ---
                let totalRowTds = '';
                let grandTotalWorkDays = 0;

                // מעבר על כל הקטגוריות הפעילות
                activeCategories.forEach(cat => {
                    const count = aggregateStats[cat]; // משתמשים בנתונים שחושבו ב-aggregateStats
                    grandTotalWorkDays += count;
                    // רקע מודגש ואפור כדי להבליט שזו שורת סיכום
                    totalRowTds += `<td style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; background-color: #f0f4f8;">${count}</td>`;
                });

                // הוספת שורת הסיכום לטבלה
                tableHTML += `
                    <tr style="background-color: #e2e8f0; font-size: 11px;">
                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; text-align: left; background-color: #e2e8f0;">TOTAL</td>
                        ${totalRowTds}
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold; background-color: #f0f4f8;">${grandTotalWorkDays}</td>
                    </tr>
                    </tbody>
                    </table>
                `;

                // --- סיום הקוד של הטבלה: ---
                tableSection.innerHTML = tableHTML;
                pdfContent.appendChild(tableSection);

                // --- יצירת ה-PDF (אותו קוד טכני כמו קודם) ---
                const htmlElement = document.documentElement;
                const hadDarkClass = htmlElement.classList.contains('dark');
                if (hadDarkClass) htmlElement.classList.remove('dark');
                
                pdfContent.style.position = 'absolute';
                pdfContent.style.left = '-9999px';
                document.body.appendChild(pdfContent);

                await new Promise(resolve => setTimeout(resolve, 1000)); // המתנה לרינדור מלא

                const canvas = await html2canvas(pdfContent, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: 1000,
                    windowWidth: 1000
                });

                document.body.removeChild(pdfContent);
                if (hadDarkClass) htmlElement.classList.add('dark');

                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 190;
                const pageHeight = 277;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 10;

                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight + 10;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const filename = `Attendance_Report_${selectedMonthValue}.pdf`;
                pdf.save(filename);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // --- Export Statistics to Excel ---
        async function exportExcelForMonth(monthlyStats, aggregateStats, selectedGroupText, selectedEmployeeText, monthName, currentYear, currentMonth) {
            try {
                // Prepare data for Excel
                const excelData = [];
                
                // Add header row
                excelData.push([
                    'Employee',
                    'Group',
                    'Office',
                    'Remote',
                    'Day Off',
                    'Vacation',
                    'Sick',
                    'Half Day Off',
                    'Business Trip',
                    'Conference',
                    'University',
                    'Reserved Duty',
                    'Team Event',
                    'Holiday',
                    'Not Set',
                    'Total Work Days',
                    'Office %'
                ]);

                // Add employee data rows
                Object.entries(monthlyStats).forEach(([uid, stats]) => {
                    const total = stats.totalWorkDays;
                    const officePercent = total > 0 ? ((stats.office / total) * 100).toFixed(1) : 0;
                    
                    excelData.push([
                        stats.name,
                        stats.group,
                        stats.office,
                        stats.homeFull,
                        stats.dayOff,
                        stats.vacation,
                        stats.sick,
                        stats.halfDayOff,
                        stats.businessTrip,
                        stats.conference,
                        stats.university,
                        stats.reservedDuty,
                        stats.teamEvent,
                        stats.holiday,
                        stats.notSet,
                        total,
                        officePercent + '%'
                    ]);
                });

                // Add summary row
                const grandTotal = Object.values(monthlyStats).reduce((sum, stats) => sum + stats.totalWorkDays, 0);
                const avgOfficePercent = grandTotal > 0 ? ((aggregateStats.totalOffice / grandTotal) * 100).toFixed(1) : 0;
                
                excelData.push([
                    'TOTAL',
                    '',
                    aggregateStats.totalOffice,
                    aggregateStats.totalHome,
                    aggregateStats.totalDayOff,
                    aggregateStats.totalVacation,
                    aggregateStats.totalSick,
                    '',
                    aggregateStats.totalBusinessTrip,
                    '',
                    '',
                    '',
                    '',
                    '',
                    aggregateStats.totalOther,
                    grandTotal,
                    avgOfficePercent + '%'
                ]);

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                // Set column widths
                const colWidths = [
                    { wch: 20 }, // Employee
                    { wch: 12 }, // Group
                    { wch: 8 },  // Office
                    { wch: 8 },  // Remote
                    { wch: 10 }, // Day Off
                    { wch: 10 }, // Vacation
                    { wch: 8 },  // Sick
                    { wch: 12 }, // Half Day Off
                    { wch: 14 }, // Business Trip
                    { wch: 12 }, // Conference
                    { wch: 12 }, // University
                    { wch: 14 }, // Reserved Duty
                    { wch: 12 }, // Team Event
                    { wch: 10 }, // Holiday
                    { wch: 10 }, // Not Set
                    { wch: 14 }, // Total Work Days
                    { wch: 10 }  // Office %
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Monthly Statistics');

                // Generate filename
                const groupName = selectedGroupText.replace(/[^a-z0-9]/gi, '_');
                const employeeName = selectedEmployeeText.replace(/[^a-z0-9]/gi, '_');
                const dateStr = `${currentYear}_${String(currentMonth + 1).padStart(2, '0')}`;
                const excelFilename = `Monthly_Analytics_${groupName}_${employeeName}_${dateStr}.xlsx`;

                // Save Excel file
                XLSX.writeFile(wb, excelFilename);

            } catch (error) {
                console.error('Error generating Excel:', error);
                alert('Failed to generate Excel: ' + error.message);
            }
        }

        // --- Drag and Drop for Update Week ---
        function initializeUpdateWeekDragDrop() {
            const container = document.getElementById('attendance-days-container');
            let sourceIndex = null;
            let lastHoveredElement = null;

            // Cleanup function to reset states
            const cleanup = () => {
                if (lastHoveredElement) {
                    lastHoveredElement.classList.remove('drag-over-animated');
                }
                document.querySelectorAll('.dragging-item').forEach(el => el.classList.remove('dragging-item'));
                sourceIndex = null;
                lastHoveredElement = null;
            };

            // This function is called on drop/touchend to perform the cascade
            const performCascadeUpdate = (targetIndex) => {
                if (sourceIndex === null || targetIndex === null || sourceIndex >= targetIndex) return;

                // Cascade the value down from the source to the target
                for (let i = sourceIndex + 1; i <= targetIndex; i++) {
                    const valueFromAbove = document.getElementById(`day-${i - 1}`).value;
                    const currentSelect = document.getElementById(`day-${i}`);
                    if (currentSelect) {
                        currentSelect.value = valueFromAbove;
                    }
                }
            };

            const handleMove = (x, y) => {
                const targetElement = document.elementFromPoint(x, y)?.closest('.apply-down-btn');
                
                // If not hovering over a valid target anymore, remove animation from last hovered
                if (lastHoveredElement && lastHoveredElement !== targetElement) {
                    lastHoveredElement.classList.remove('drag-over-animated');
                    lastHoveredElement = null;
                }

                // If hovering over a new, valid target
                if (targetElement) {
                    const targetIndex = parseInt(targetElement.dataset.dayIndex, 10);
                    if (sourceIndex !== null && targetIndex > sourceIndex) {
                        targetElement.classList.add('drag-over-animated');
                        lastHoveredElement = targetElement;
                    }
                }
            };

            // --- Mouse Events ---
            container.addEventListener('dragstart', (e) => {
                const target = e.target.closest('.apply-down-btn');
                if (target && target.draggable) {
                    sourceIndex = parseInt(target.dataset.dayIndex, 10);
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', sourceIndex);
                    setTimeout(() => { target.classList.add('dragging-item'); }, 0);
                } else {
                    e.preventDefault();
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                handleMove(e.clientX, e.clientY);
            });
            
            container.addEventListener('dragend', cleanup);

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                if (lastHoveredElement) {
                    const targetIndex = parseInt(lastHoveredElement.dataset.dayIndex, 10);
                    performCascadeUpdate(targetIndex);
                }
                cleanup();
            });

            // --- Touch Events ---
            container.addEventListener('touchstart', (e) => {
                const target = e.target.closest('.apply-down-btn');
                if (target && target.draggable) {
                    sourceIndex = parseInt(target.dataset.dayIndex, 10);
                    target.classList.add('dragging-item');
                    // Prevent page scroll while dragging the icon
                    e.preventDefault();
                }
            }, { passive: false });

            container.addEventListener('touchmove', (e) => {
                if (sourceIndex === null) return;
                e.preventDefault();
                const touch = e.touches[0];
                handleMove(touch.clientX, touch.clientY);
            }, { passive: false });

            container.addEventListener('touchend', (e) => {
                if (sourceIndex === null) return;
                if (lastHoveredElement) {
                    const targetIndex = parseInt(lastHoveredElement.dataset.dayIndex, 10);
                    performCascadeUpdate(targetIndex);
                }
                cleanup();
            });
        }

        // -----------------------------------------------------------
        //  L O G I C   F O R   C R E A T E   O R G A N I Z A T I O N
        // -----------------------------------------------------------
        
        const showCompanyRegisterLink = document.getElementById('show-company-register');
        const companyRegisterForm = document.getElementById('company-register-form');
        const backToLoginFromCompany = document.getElementById('back-to-login-from-company');
        const companyRegisterError = document.getElementById('company-register-error');

        // מעבר למסך הרשמת חברה
        if (showCompanyRegisterLink) {
            showCompanyRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                
                // הסתרת הטפסים האחרים
                loginForm.classList.add('hidden');
                registerForm.classList.add('hidden');
                hideAllMessages();

                // הצגת טופס החברה
                const companyForm = document.getElementById('company-register-form');
                companyForm.classList.remove('hidden');
                
                // טריק קטן להפעלת אנימציית ה-CSS
                // אנחנו נותנים לדפדפן רגע "לצייר" את הטופס המוסתר ואז מסירים את ה-Opacity/Translate
                setTimeout(() => {
                    companyForm.classList.remove('opacity-0', 'translate-y-10');
                    // איפוס השלבים למצב התחלתי במקרה שנכנסו ויצאו קודם
                    resetCompanyFormSteps();
                }, 50);
            });

        // פונקציית עזר לאיפוס הטופס לכניסה חוזרת
        function resetCompanyFormSteps() {
            // הסתרת כל השלבים חוץ מהראשון
            for(let i=2; i<=4; i++) {
                const step = document.getElementById(`comp-step-${i}`);
                step.classList.add('hidden', 'opacity-0', 'translate-y-8');
                step.classList.remove('translate-y-0');
            }
            const step1 = document.getElementById('comp-step-1');
            step1.classList.remove('hidden', 'opacity-0', '-translate-y-8');
            step1.classList.add('translate-y-0');
            updateDots(1);
        }
        }

        // חזרה למסך כניסה - עם אנימציה ותיקון לפעם הבאה
        // חזרה למסך כניסה - תיקון אנימציה חלקה
        if (backToLoginFromCompany) {
            backToLoginFromCompany.addEventListener('click', (e) => {
                e.preventDefault();
                
                // 1. אנימציית יציאה לטופס החברה
                companyRegisterForm.classList.add('opacity-0', 'translate-y-10');
                
                // 2. המתנה שהטופס ייעלם ואז החלפה לטופס הלוגין
                setTimeout(() => {
                    // הסתרת טופס החברה
                    companyRegisterForm.classList.add('hidden');
                    
                    // הכנת טופס הלוגין לאנימציה (שמים אותו במצב שקוף ומוזז למטה)
                    loginForm.classList.add('opacity-0', 'translate-y-10'); 
                    loginForm.classList.remove('hidden'); // הופכים אותו לקיים בדף
                    
                    // ביצוע האנימציה (הופכים אותו לנראה ורגיל)
                    // requestAnimationFrame מבטיח שהדפדפן יראה את המצב השקוף לפני שהוא משנה אותו
                    requestAnimationFrame(() => {
                        loginForm.classList.remove('opacity-0', 'translate-y-10');
                    });
                    
                    hideAllMessages();
                }, 700); // תואם ל-duration-700 ב-CSS
            });
        }

        // שליחת טופס יצירת חברה
        if (companyRegisterForm) {
            companyRegisterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (companyRegisterError) companyRegisterError.classList.add('hidden');
                
                // --- [תיקון] הצגת מסך הטעינה מיד בלחיצה ---
                const spinner = document.getElementById('loading-spinner');
                if (spinner) {
                    spinner.classList.remove('fade-out');
                    spinner.style.display = 'flex';
                }
                // ------------------------------------------
                
                const companyName = document.getElementById('new-company-name').value.trim();
                const adminName = document.getElementById('new-company-admin-name').value;
                const email = document.getElementById('new-company-email').value;
                const password = document.getElementById('new-company-password').value;

                // נרמול השם ל-ID (אותיות קטנות)
                const normalizedName = companyName.toLowerCase();

                if (password.length < 6) {
                    if (companyRegisterError) {
                        companyRegisterError.textContent = "Password must be at least 6 characters.";
                        companyRegisterError.classList.remove('hidden');
                    }
                    return;
                }

                try {
                    // 1. יצירת היוזר ב-Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // --- פונקציה לייצור קוד רנדומלי ---
                    const generateOrgCode = () => {
                        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // בלי I, O, 1, 0 למניעת בלבול
                        let result = '';
                        for (let i = 0; i < 6; i++) {
                            result += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        return result;
                    };
                    
                    const orgCode = generateOrgCode();

                    // --- יצירת קוד הפעלה סודי (אותיות ומספרים) ---
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // הסרתי I, O, 1, 0 למניעת בלבול
                    let secretActivationCode = '';
                    for (let i = 0; i < 6; i++) {
                        secretActivationCode += chars.charAt(Math.floor(Math.random() * chars.length));
                    }

                    // 2. הכנת פעולת כתיבה אטומית (Batch Write)
                    // זה מבטיח שאם אחד נכשל - הכל נכשל, ולא יווצר מצב של חצי עבודה
                    const batch = writeBatch(db);

                    // א. הכנת מסמך החברה הפרטי (עם ID אוטומטי)
                    const newCompanyRef = doc(collection(db, "companies"));
                    batch.set(newCompanyRef, {
                        name: companyName,
                        adminEmail: email,
                        // [FIX] הוספת שדה adminUid חיונית להרשאות עריכה
                        adminUid: user.uid,
                        companyCode: orgCode, // הקוד לעובדים
                        
                        // === שדות שליטה ===
                        activationCode: secretActivationCode, // הקוד שאתה תשלח למנהל
                        isActivated: false, // נעול להוספת עובדים (דורש קוד)
                        isBlocked: false,   // המשתמש *לא* חסום לצפייה בנתונים
                        maxUsers: 10, // מגבלה התחלתית (תוכל לשנות ידנית במסוף פיירבייס ל-50 או 100 לחברות גדולות)
                        currentUsersCount: 1, // התחלה מ-1 כי המנהל הוא משתמש
                        // ==================
                        
                        createdAt: Timestamp.now(),
                        groups: ["Management", "General", "R&D", "Sales"],
                        workDays: [0, 1, 2, 3, 4], // Default Sun-Thu
                        // [ADD] הוספת שדה סוגי נוכחות עם ברירת המחדל הקצרה
                        attendanceTypes: ["Office", "Home", "Vacation", "Sick", "Holiday", "Army"]
                    });

                    // ב. הכנת מסמך השם הציבורי (כדי לתפוס אותו)
                    const publicNameRef = doc(db, "public_company_names", normalizedName);
                    batch.set(publicNameRef, {
                        taken: true,
                        companyId: newCompanyRef.id // קישור אופציונלי למזהה האמיתי
                    });
                    
                    // ג. שמירת הקוד בטבלה ציבורית נפרדת לחיפוש מהיר בהרשמה
                    // זה מאפשר למשתמשים למצוא את ה-ID של החברה לפי הקוד מבלי לקרוא את כל החברות
                    const publicCodeRef = doc(db, "public_company_codes", orgCode);
                    batch.set(publicCodeRef, {
                        companyId: newCompanyRef.id,
                        companyName: companyName,
                        // [תיקון] שומרים את הקבוצות גם פה כדי שמי שנרשם יוכל לראות אותן
                        groups: ["Management", "General", "R&D", "Sales"] 
                    });

                    // ד. הכנת מסמך המשתמש
                    const newUserRef = doc(db, "users", user.uid);
                    batch.set(newUserRef, {
                        fullName: adminName,
                        email: email,
                        group: "Management",
                        companyId: newCompanyRef.id,
                        isSuperAdmin: true,
                        isTL: true,
                        username: email.split('@')[0],
                        darkMode: true, // Changed from false to true as default
                        teamViewFilter: 'all'
                    });

                    // 3. ביצוע כל הכתיבות בבת אחת
                    await batch.commit();

                    // [NEW] במקום לסיים, אנו מפעילים את אשף ההגדרות
                    // מסתירים את טופס ההרשמה
                    companyRegisterForm.classList.add('hidden');
                    authContainer.classList.add('hidden'); // מחביא את כל מסך הלוגין
                    appContainer.classList.remove('hidden'); // מציג את האפליקציה (ברקע)

                    // מפעיל את האשף מעל האפליקציה
                    startSetupWizard(newCompanyRef.id);

                    // המשתמש יועבר לוגית ע"י onAuthStateChanged, אבל האשף יסתיר את הדשבורד עד שיסיים.
                    
                } catch (error) {
                    // --- [תיקון] אם נכשלנו, להעלים את הספינר ---
                    const spinner = document.getElementById('loading-spinner');
                    if (spinner) spinner.classList.add('fade-out');
                    // -------------------------------------------

                    console.error("Error creating company:", error);
                    let msg = error.message;
                    if (msg.includes("email-already-in-use")) msg = "Email already registered.";
                    if (companyRegisterError) {
                        companyRegisterError.textContent = msg;
                        companyRegisterError.classList.remove('hidden');
                    }
                }
            });
        }

        // ========================================================================
        //  HELPER FUNCTIONS FOR CUSTOM COLORS
        // ========================================================================

        // פונקציה לחישוב צבע טקסט (שחור או לבן) לפי בהירות הרקע
        function getContrastYIQ(hexcolor){
            if(!hexcolor) return 'black';
            hexcolor = hexcolor.replace("#", "");
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        // פונקציה שמחזירה את ה-Style המלא לתגית - גרסת ניאון זוהרת
        function getStatusStyle(statusName) {
            // 1. נסה למצוא את הצבע ברשימה הגלובלית המעודכנת
            let foundType = globalAttendanceOptions.find(opt => 
                (typeof opt === 'string' ? opt : opt.name) === statusName
            );
            
            // ברירת מחדל
            let textColor = '#9ca3af'; // אפור בהיר

            if (foundType && typeof foundType === 'object') {
                textColor = foundType.color;
            } else {
                // Fallback לצבעים אם אין הגדרה מותאמת אישית
                if(statusName === 'Office') { textColor = '#10b981'; } // ירוק
                else if(statusName.includes('Home')) { textColor = '#3b82f6'; } // כחול
                else if(statusName === 'Vacation') { textColor = '#f43f5e'; } // ורוד
                else if(statusName === 'Sick') { textColor = '#ef4444'; } // אדום
                else if(statusName === '---') { textColor = '#6b7280'; } // אפור
            }

            if (statusName === '---') {
                return 'background-color: transparent; color: #6b7280; font-weight: normal;'; 
            }

            // --- תיקון ניאון סופי ---
            return `
                background-color: ${textColor}10;  /* רקע כמעט שקוף (רק 6% צבע) כדי למנוע את המראה ה"בוצי" */
                color: ${textColor};               /* הטקסט נשאר בצבע המלא והחזק */
                border: 1px solid ${textColor}80;  /* מסגרת חזקה (50% שקיפות) שנותנת את קו המתאר */
                box-shadow: 0 0 12px ${textColor}40, inset 0 0 5px ${textColor}10; /* הילה חיצונית רכה + הילה פנימית עדינה */
                font-weight: 700;                  /* מודגש */
                text-shadow: 0 0 1px ${textColor}; /* חידוד קל לטקסט */
            `;
        }

        // ========================================================================
        //  SETUP WIZARD LOGIC - 4 Steps with Groups + UI Sync Fix
        // ========================================================================

        // --- Wizard Logic Variables ---
        let currentWizardStep = 1;
        let wizardCompanyId = null; 
        let wizardAttendanceOptions = [
            { name: "Office", color: "#10b981" },     // ירוק אמרלד
            { name: "Home-full", color: "#3b82f6" },  // כחול
            { name: "Vacation", color: "#f43f5e" },   // ורוד/אדום
            { name: "Sick", color: "#ef4444" },       // אדום
            { name: "Team Event", color: "#a855f7" }  // סגול - הוחלף ל-Team Event
        ];
        let wizardGroups = ["Management", "General", "R&D", "Sales"]; // Default groups

        window.startSetupWizard = function(companyId) {
            wizardCompanyId = companyId;
            currentWizardStep = 1;
            
            // Reset UI
            document.getElementById('setup-wizard-overlay').classList.remove('hidden');
            
            // Set default workdays (Sun-Thu)
            const dayCheckboxes = document.querySelectorAll('input[name="wiz-workday"]');
            dayCheckboxes.forEach(cb => {
                const val = parseInt(cb.value);
                cb.checked = (val >= 0 && val <= 4);
            });
            
            // Render Lists
            renderWizardTypes();
            renderWizardGroups();
            renderColorPalette('wizard-color-palette', 'wiz-new-color', 4); // הפעלת פלטת הצבעים באשף
            
            // Hide Back button initially
            const prevBtn = document.getElementById('wiz-prev-btn');
            if(prevBtn) {
                prevBtn.classList.add('opacity-0', 'pointer-events-none');
            }
            
            updateWizardUI();
        };

        window.updateWizardUI = function() {
            // 1. איפוס כל השלבים
            document.querySelectorAll('.wizard-step').forEach(el => {
                // הסרת Active מבטלת את האנימציה כדי שנוכל להפעיל אותה מחדש
                el.classList.remove('active', 'prev');
            });

            // 2. טיפול בכיוון האנימציה (היסטוריה)
            // כל השלבים שלפני הנוכחי מקבלים את המחלקה 'prev' (זזים שמאלה)
            for (let i = 1; i < currentWizardStep; i++) {
                const step = document.getElementById(`wizard-step-${i}`);
                if(step) step.classList.add('prev');
            }

            // 3. הפעלת השלב הנוכחי עם השהיה מזערית כדי לאפשר ל-CSS להתאפס
            const currentStepEl = document.getElementById(`wizard-step-${currentWizardStep}`);
            if (currentStepEl) {
                // שימוש ב-requestAnimationFrame מבטיח שהדפדפן יזהה את השינוי
                requestAnimationFrame(() => {
                    currentStepEl.classList.add('active');
                });
            }

            // --- עדכון ה-UI של הבר והטקסטים (ללא שינוי) ---
            const progressMap = { 1: '25%', 2: '50%', 3: '75%', 4: '100%' };
            const titleMap = { 
                1: 'Work Days', 
                2: 'Organize Teams', 
                3: 'Attendance Types', 
                4: 'Branding' 
            };
            
            const progBar = document.getElementById('wizard-progress-bar');
            if(progBar) progBar.style.width = progressMap[currentWizardStep];
            
            const progText = document.getElementById('wizard-progress-text');
            if(progText) progText.textContent = `${currentWizardStep}/4`;
            
            const stepTitle = document.getElementById('wizard-step-title');
            if(stepTitle) stepTitle.textContent = titleMap[currentWizardStep];

            // Buttons Logic
            const prevBtn = document.getElementById('wiz-prev-btn');
            const nextBtn = document.getElementById('wiz-next-btn');
            
            if(prevBtn) {
                // שימוש ב-opacity לאנימציה במקום visibility
                if (currentWizardStep === 1) {
                    prevBtn.classList.add('opacity-0', 'pointer-events-none');
                } else {
                    prevBtn.classList.remove('opacity-0', 'pointer-events-none');
                    prevBtn.classList.add('transition-opacity', 'duration-300');
                }
                
                prevBtn.onclick = () => {
                    if (currentWizardStep > 1) {
                        currentWizardStep--;
                        updateWizardUI();
                    }
                };
            }
            
            if(nextBtn) {
                // שינוי טקסט עם אנימציה קטנה (אופציונלי, כאן פשוט נחליף טקסט)
                nextBtn.textContent = currentWizardStep === 4 ? 'Finish & Launch 🚀' : 'Next Step';
                nextBtn.onclick = handleWizardNext;
            }
        };

        window.handleWizardNext = async function() {
            if (currentWizardStep < 4) {
                currentWizardStep++;
                updateWizardUI();
            } else {
                await saveWizardSettings();
            }
        };

        // --- Wizard: Attendance Types Logic ---
        window.renderWizardTypes = function() {
            const list = document.getElementById('wiz-types-list');
            list.innerHTML = '';
            
            wizardAttendanceOptions.forEach(typeObj => {
                // תמיכה לאחור במקרה שיש סטרינגים ישנים
                const name = typeof typeObj === 'string' ? typeObj : typeObj.name;
                const color = typeof typeObj === 'object' ? typeObj.color : '#cccccc';
                const textColor = getContrastYIQ(color);
                
                const tag = document.createElement('div');
                // שימוש ב-inline style עבור הצבע הנבחר
                tag.style.backgroundColor = color;
                tag.style.color = textColor;
                
                tag.className = `flex items-center justify-between gap-2 px-3 py-1.5 rounded-full text-sm font-bold shadow-sm transition-transform hover:scale-105 cursor-default border border-white/20`;
                
                tag.innerHTML = `
                    <span>${name}</span>
                    <button onclick="removeWizardType('${name}')" 
                        class="ml-1 w-5 h-5 flex items-center justify-center rounded-full bg-black/20 hover:bg-black/40 text-current transition-colors focus:outline-none"
                        title="Remove">
                        &times;
                    </button>
                `;
                list.appendChild(tag);
            });
        };

        window.addWizardType = function() {
            const inputName = document.getElementById('wiz-new-type');
            const inputColor = document.getElementById('wiz-new-color');
            
            const val = inputName.value.trim();
            const color = inputColor ? inputColor.value : '#a855f7';

            if (val && !wizardAttendanceOptions.some(t => (t.name || t) === val)) {
                wizardAttendanceOptions.push({ name: val, color: color });
                renderWizardTypes();
                inputName.value = '';
                inputName.focus();
            }
        };

        window.removeWizardType = function(typeName) {
            wizardAttendanceOptions = wizardAttendanceOptions.filter(t => (t.name || t) !== typeName);
            renderWizardTypes();
        };

        // --- Wizard: Groups Logic ---
        window.renderWizardGroups = function() {
            const list = document.getElementById('wiz-groups-list');
            list.innerHTML = '';
            wizardGroups.forEach(group => {
                const tag = document.createElement('div');
                tag.className = "flex items-center bg-gray-700/50 border border-gray-600 text-white px-3 py-1.5 rounded-lg text-sm";
                tag.innerHTML = `
                    <span>${group}</span>
                    <button onclick="removeWizardGroup('${group}')" class="ml-2 text-gray-400 hover:text-red-400 hover:bg-gray-700 rounded-full w-5 h-5 flex items-center justify-center">&times;</button>
                `;
                list.appendChild(tag);
            });
        };

        window.addWizardGroup = function() {
            const input = document.getElementById('wiz-new-group');
            const val = input.value.trim();
            if (val && !wizardGroups.includes(val)) {
                wizardGroups.push(val);
                renderWizardGroups();
                input.value = '';
                input.focus();
            }
        };

        window.removeWizardGroup = function(group) {
            wizardGroups = wizardGroups.filter(g => g !== group);
            renderWizardGroups();
        };

        async function saveWizardSettings() {
            const btn = document.getElementById('wiz-next-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Setting up...";

            if (!wizardCompanyId) {
                // Fallback attempt
                if (currentUserProfile && currentUserProfile.companyId) {
                    wizardCompanyId = currentUserProfile.companyId;
                } else {
                    alert("Error: Missing Company ID. Please refresh.");
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }
            }

            try {
                // 1. איסוף ימים
                const selectedDays = Array.from(document.querySelectorAll('input[name="wiz-workday"]:checked'))
                    .map(cb => parseInt(cb.value)).sort((a,b) => a-b);
                
                const sloganInput = document.getElementById('wiz-slogan');
                const slogan = sloganInput ? sloganInput.value.trim() : "";

                // 2. שמירה לדאטהבייס
                const companyRef = doc(db, "companies", wizardCompanyId);
                
                // עדכון חברה באמצעות batch
                const batch = writeBatch(db);
                
                batch.update(companyRef, {
                    workDays: selectedDays,
                    attendanceTypes: wizardAttendanceOptions,
                    groups: wizardGroups,
                    slogan: slogan
                });
                
                await batch.commit();

                // 3. [CRITICAL FIX] עדכון המצב הגלובלי באפליקציה מיד!
                globalWorkDays = selectedDays;
                globalAttendanceOptions = wizardAttendanceOptions;
                availableGroups = wizardGroups;
                updateSloganUI(slogan);

                // 4. [CRITICAL FIX] קריאה לפונקציות הרינדור של ה-Admin UI
                // זה מה שיתקן את הבאג שהרשימה לא מתעדכנת עד ריפרש
                populateGroupSelects();
                populateManageGroupsList(); 
                renderManageAttendanceTypes();
                loadWorkDaysUI(); 

                // 5. סגירה
                const overlay = document.getElementById('setup-wizard-overlay');
                overlay.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('opacity-0');
                    refreshViews();
                }, 500);

            } catch (error) {
                console.error("Wizard Save Error:", error);
                alert(`Failed to save settings: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

// פונקציה שמחזירה את קוד הצבע (HEX) המדויק לכל סטטוס
function getStatusHexColor(statusName) {
    // 1. נסה למצוא צבע מותאם אישית ברשימה הגלובלית
    const found = globalAttendanceOptions.find(opt => (typeof opt === 'string' ? opt : opt.name) === statusName);
    
    if (found && typeof found === 'object' && found.color) {
        return found.color;
    }

    // 2. צבעי ברירת מחדל (אם לא נמצא צבע מותאם)
    switch(statusName) {
        case 'Office': return '#10b981';      // Green
        case 'Home-full': return '#3b82f6';   // Blue
        case 'Vacation': return '#f43f5e';    // Rose
        case 'Sick': return '#ef4444';        // Red
        case 'Half day off': return '#eab308'; // Yellow
        case 'Army': return '#16a34a';        // Green-600
        case 'Business trip': return '#a855f7'; // Purple
        case 'try me': return '#a855f7';      // Purple
        default: return '#6b7280';            // Gray
    }
}

// --- פונקציית האנימציה של שדה התעופה (Hacker Effect) ---
function animateCodeReveal(element, targetText) {
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; // תווים רנדומליים
    let iteration = 0;
    
    clearInterval(element.dataset.interval); // ניקוי אנימציה קודמת אם יש

    element.dataset.interval = setInterval(() => {
        element.innerText = targetText
            .split("")
            .map((letter, index) => {
                // אם הגענו לאיטרציה של האות הזו, מקבעים אותה
                if(index < iteration) {
                    return targetText[index];
                }
                // אחרת, מציגים אות רנדומלית
                return letters[Math.floor(Math.random() * 36)];
            })
            .join("");

        // סיום האנימציה
        if(iteration >= targetText.length) { 
            clearInterval(element.dataset.interval);
        }
        
        iteration += 1 / 3; // מהירות האנימציה (ככל שהמספר קטן יותר, זה איטי יותר)
    }, 30); // קצב רענון (ms)
}

// פונקציה שממירה HEX למשתני CSS של HSL
function getHSLStyle(hex) {
    // הסרת הסולמית
    hex = hex.replace(/^#/, '');
    
    // המרה ל-RGB
    let bigint = parseInt(hex, 16);
    let r = (bigint >> 16) & 255;
    let g = (bigint >> 8) & 255;
    let b = bigint & 255;

    // המרה ל-HSL
    r /= 255, g /= 255, b /= 255;
    let max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;

    if (max === min) {
        h = s = 0; // אפור
    } else {
        let d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
    }

    // החזרת מחרוזת CSS Variables
    // מעגלים את המספרים כדי שיהיו נקיים
    return `--pill-h: ${(h * 360).toFixed(0)}; --pill-s: ${(s * 100).toFixed(0)}%; --pill-l: ${(l * 100).toFixed(0)}%;`;
}

// הוספת מאזין לכפתור "Show More" בבקשות
const showMoreBtn = document.getElementById('show-more-requests-btn');
if (showMoreBtn) {
    showMoreBtn.addEventListener('click', () => {
        // 1. שינוי עיצוב למצב "טוען"
        showMoreBtn.disabled = true; // מונע לחיצה כפולה
        showMoreBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Loading...</span>
        `;

        // 2. הגדלת הלימיט וטעינה
        currentRequestsLimit += 5;
        
        // קריאה לפונקציה (היא תאפס את הכפתור חזרה ברגע שהנתונים יגיעו)
        loadMyRequests();
    });
}

// --- אפקט ה-Rolodex (גלגל תיקיות) ---
function initRolodexEffect(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    let cardsData = [];

    const recaptulatePositions = () => {
        const cards = Array.from(container.children).filter(el => 
            el.tagName === 'DIV' && el.style.position === 'sticky'
        );
        cardsData = cards.map(card => ({
            element: card,
            originalTop: card.offsetTop
        }));
    };

    const handleScroll = () => {
        const scrollTop = container.scrollTop;

        cardsData.forEach((item) => {
            const card = item.element;
            const distanceStuck = scrollTop - item.originalTop;

            if (distanceStuck > 0) {
                // --- כרטיס במצב דביק ---

                // 1. הקטנה מהירה יותר ליותר דרמה
                const scale = Math.max(0.85, 1 - (distanceStuck * 0.0015));
                
                // 2. אפקט כהות מהיר יותר
                const brightness = Math.max(0.7, 1 - (distanceStuck * 0.005));
                
                // 3. הזזה כלפי מעלה ליותר עומק
                const translateY = -distanceStuck * 0.05;
                
                // 4. טשטוש מינימלי
                const blur = Math.min(2, distanceStuck * 0.005);

                card.style.transform = `scale(${scale}) translateY(${translateY}px)`;
                card.style.filter = `blur(${blur}px) brightness(${brightness})`;
                
                // ביטול צללית רק כשזה ממש רחוק
                if (distanceStuck > 300) {
                    card.style.boxShadow = 'none';
                } else {
                    card.style.boxShadow = 'none'; // אפשר לבטל צללית ברגע שזה נדבק למראה נקי יותר
                }

            } else {
                card.style.transform = 'scale(1) translateY(0px)';
                card.style.filter = 'none';
                card.style.boxShadow = "0 1px 2px 0 rgba(0, 0, 0, 0.05)";
            }
        });
    };

    setTimeout(() => {
        recaptulatePositions();
        handleScroll();
    }, 100);

    container.removeEventListener('scroll', handleScroll);
    container.addEventListener('scroll', handleScroll);
}

    </script>

    <script>
      let deferredPrompt;
      const installButton = document.getElementById('install-pwa-button');

      window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later.
        deferredPrompt = e;
        // Update UI notify the user they can install the PWA
        installButton.style.display = 'block';
      });

      installButton.addEventListener('click', async () => {
        // hide our user interface that shows our A2HS button
        installButton.style.display = 'none';
        // Show the prompt
        deferredPrompt.prompt();
        // Wait for the user to respond to the prompt
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        // We've used the prompt, and can't use it again, throw it away
        deferredPrompt = null;
      });

      // Service Worker registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('SW registered'))
            .catch(err => console.log('SW registration failed', err));
        });
      }

            
        </script>

    <!-- Setup Wizard Modal -->
    <div id="setup-wizard-overlay" class="fixed inset-0 z-[9999] hidden flex items-center justify-center glass-overlay p-4">
        <div class="glass-card w-full max-w-2xl p-8 relative overflow-hidden flex flex-col min-h-[550px]">
            
            <div class="absolute -top-20 -left-20 w-60 h-60 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
            <div class="absolute -bottom-20 -right-20 w-60 h-60 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>

            <div class="relative z-10 mb-8">
                <div class="flex justify-between mb-2 text-xs font-bold text-gray-400 uppercase tracking-widest">
                    <span id="wizard-step-title">Welcome</span>
                    <span id="wizard-progress-text">1/4</span>
                </div>
                <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden">
                    <div id="wizard-progress-bar" class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-500" style="width: 25%"></div>
                </div>
            </div>

            <div id="wizard-step-1" class="wizard-step active z-10 flex-1 flex flex-col">
                <h2 class="text-3xl font-bold text-white mb-2">Setting the Rhythm</h2>
                <p class="text-gray-400 mb-8">Which days does your team work? This sets up the calendar view.</p>
                
                <div class="flex flex-wrap gap-3 justify-center mb-8">
                    <label class="cursor-pointer group">
                        <input type="checkbox" name="wiz-workday" value="0" class="glass-checkbox sr-only">
                        <div class="w-14 h-14 flex items-center justify-center rounded-2xl border border-gray-600 bg-gray-800/50 text-gray-400 font-bold transition-all group-hover:bg-gray-700/50">Sun</div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="checkbox" name="wiz-workday" value="1" class="glass-checkbox sr-only">
                        <div class="w-14 h-14 flex items-center justify-center rounded-2xl border border-gray-600 bg-gray-800/50 text-gray-400 font-bold transition-all group-hover:bg-gray-700/50">Mon</div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="checkbox" name="wiz-workday" value="2" class="glass-checkbox sr-only">
                        <div class="w-14 h-14 flex items-center justify-center rounded-2xl border border-gray-600 bg-gray-800/50 text-gray-400 font-bold transition-all group-hover:bg-gray-700/50">Tue</div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="checkbox" name="wiz-workday" value="3" class="glass-checkbox sr-only">
                        <div class="w-14 h-14 flex items-center justify-center rounded-2xl border border-gray-600 bg-gray-800/50 text-gray-400 font-bold transition-all group-hover:bg-gray-700/50">Wed</div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="checkbox" name="wiz-workday" value="4" class="glass-checkbox sr-only">
                        <div class="w-14 h-14 flex items-center justify-center rounded-2xl border border-gray-600 bg-gray-800/50 text-gray-400 font-bold transition-all group-hover:bg-gray-700/50">Thu</div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="checkbox" name="wiz-workday" value="5" class="glass-checkbox sr-only">
                        <div class="w-14 h-14 flex items-center justify-center rounded-2xl border border-gray-600 bg-gray-800/50 text-gray-400 font-bold transition-all group-hover:bg-gray-700/50">Fri</div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="checkbox" name="wiz-workday" value="6" class="glass-checkbox sr-only">
                        <div class="w-14 h-14 flex items-center justify-center rounded-2xl border border-gray-600 bg-gray-800/50 text-gray-400 font-bold transition-all group-hover:bg-gray-700/50">Sat</div>
                    </label>
                </div>
            </div>

            <div id="wizard-step-2" class="wizard-step z-10 flex-1 flex flex-col">
                <h2 class="text-3xl font-bold text-white mb-2">Organize Teams</h2>
                <p class="text-gray-400 mb-6">Create groups/departments (e.g. R&D, Sales, Marketing).</p>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="wiz-new-group" class="glass-input flex-1 rounded-xl px-4 py-3 outline-none" placeholder="e.g. Marketing">
                    <button type="button" onclick="addWizardGroup()" class="px-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold transition-colors">Add</button>
                </div>

                <div id="wiz-groups-list" class="flex flex-wrap gap-3 overflow-y-auto max-h-48 p-1">
                </div>
            </div>

            <div id="wizard-step-3" class="wizard-step z-10 flex-1 flex flex-col">
                <h2 class="text-3xl font-bold text-white mb-2">Define Statuses</h2>
                <p class="text-gray-400 mb-6">Create types and pick their colors for the dashboard.</p>

                <div class="flex flex-col gap-4 mb-6">
                    <div class="flex gap-2 items-center">
                        <input type="text" id="wiz-new-type" class="glass-input flex-1 rounded-xl px-4 py-3 outline-none" placeholder="e.g. Offsite">
                        <button type="button" onclick="addWizardType()" class="px-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold transition-colors">Add</button>
                    </div>
                    
                    <div id="wizard-color-palette" class="flex flex-wrap gap-3 justify-center bg-black/20 p-3 rounded-xl">
                    </div>
                    <input type="hidden" id="wiz-new-color" value="#a855f7">
                </div>

                <div id="wiz-types-list" class="flex flex-wrap gap-3 overflow-y-auto max-h-48 p-1 custom-scrollbar">
                </div>
            </div>

            <div id="wizard-step-4" class="wizard-step z-10 flex-1 flex flex-col">
                <h2 class="text-3xl font-bold text-white mb-2">Make it Yours</h2>
                <p class="text-gray-400 mb-8">Add a motivating slogan to appear under your logo.</p>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Company Slogan</label>
                        <input type="text" id="wiz-slogan" class="glass-input w-full rounded-xl px-4 py-4 text-lg outline-none" placeholder="e.g. Stay Hungry, Stay Foolish">
                    </div>
                </div>
            </div>

            <div class="relative z-10 flex justify-between items-center mt-auto pt-8 border-t border-gray-700/50">
                <button type="button" id="wiz-prev-btn" class="text-gray-400 hover:text-white font-medium px-4 py-2 transition-opacity duration-300">← Back</button>
                <button type="button" id="wiz-next-btn" class="btn btn-primary px-8 py-3 rounded-xl shadow-lg shadow-purple-500/20">Next Step</button>
            </div>
        </div>
    </div>

    <div id="limit-modal" class="modal-overlay hidden z-[9000] flex items-center justify-center p-4 backdrop-blur-sm bg-black/40 transition-opacity duration-300">
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform scale-100 transition-all border border-gray-100 dark:border-gray-700 p-6 text-center">
            
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 dark:bg-red-900/30 mb-6">
                <svg class="h-8 w-8 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
            
            <h3 id="limit-modal-title" class="text-xl font-bold text-gray-900 dark:text-white mb-2">Limit Reached</h3>
            <p id="limit-modal-body" class="text-gray-500 dark:text-gray-300 text-sm mb-8 leading-relaxed">
                You need to upgrade your plan to perform this action.
            </p>
            
            <div class="flex gap-3">
                <button onclick="document.getElementById('limit-modal').classList.add('hidden')" class="flex-1 py-3 px-4 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold rounded-xl transition-colors hover:bg-gray-200 dark:hover:bg-gray-600">
                    Cancel
                </button>
                <button id="limit-redirect-btn" class="flex-[1.5] py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold rounded-xl shadow-lg hover:shadow-purple-500/30 transition-transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                    <span>Go to Settings</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                </button>
            </div>
        </div>
    </div>

</body>
</html>