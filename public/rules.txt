rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================
    // ğŸ›¡ï¸ ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (Helpers) - ×”××•×— ×©×œ ×”××‘×˜×—×”
    // ==========================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function getMyData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function myCompanyId() {
      return getMyData().get('companyId', '');
    }

    function isManager() {
      let data = getMyData();
      return data.get('isTL', false) == true || data.get('isSuperAdmin', false) == true;
    }

    function existingDocInMyCompany() {
      return resource.data.get('companyId', '') == myCompanyId();
    }

    function writingToMyCompany() {
      return request.resource.data.companyId == myCompanyId();
    }

    // ğŸ”¥ ×¤×•× ×§×¦×™×™×ª ×”×‘×¨×–×œ 1: ×‘×“×™×§×” ×”×× ×”×—×‘×¨×” ×—×¡×•××” ×‘×©×¨×ª ğŸ”¥
    // ×ª×•×§×Ÿ: ×”×›×œ ×‘×©×•×¨×” ××—×ª ×œ×œ× ××©×ª× ×™×
    function isCompanyBlocked(companyId) {
      return companyId != null && 
             companyId != '' && 
             exists(/databases/$(database)/documents/companies/$(companyId)) &&
             get(/databases/$(database)/documents/companies/$(companyId)).data.get('isBlocked', false) == true;
    }

    // ğŸ”¥ ×¤×•× ×§×¦×™×™×ª ×”×‘×¨×–×œ 2: ×‘×“×™×§×” ×”×× ×™×© ××§×•× ×‘×—×‘×¨×” ğŸ”¥
    // ×ª×•×§×Ÿ: ×”×•×¡×¨ ×”-if ×•×”-let, ×”×›×œ × ×“×—×¡ ×œ×‘×™×˜×•×™ ××—×“ ×©××—×–×™×¨ ×××ª/×©×§×¨
    function hasUserQuota(companyId) {
      return companyId != null && 
             companyId != '' &&
             exists(/databases/$(database)/documents/companies/$(companyId)) &&
             get(/databases/$(database)/documents/companies/$(companyId)).data.get('currentUsersCount', 0) < 
             get(/databases/$(database)/documents/companies/$(companyId)).data.get('maxUsers', 10);
    }

    // ==========================================================
    // 1. ××©×ª××©×™× (Users)
    // ==========================================================
    match /users/{userId} {
      allow read: if isSignedIn() && (
        request.auth.uid == userId || 
        existingDocInMyCompany()
      ) 
      && (request.auth.uid == userId || !isCompanyBlocked(resource.data.get('companyId', '')));
      
      allow create: if isSignedIn() && (
        request.auth.uid == userId || 
        (
          isManager() && 
          writingToMyCompany() &&
          !isCompanyBlocked(request.resource.data.companyId) &&
          hasUserQuota(request.resource.data.companyId)
        )
      );
      
      allow update: if isSignedIn() && (
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['companyId', 'isTL', 'isSuperAdmin'])) || 
        (isManager() && existingDocInMyCompany() && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['companyId']) || writingToMyCompany()))
      )
      && !isCompanyBlocked(resource.data.get('companyId', ''));
      
      allow delete: if isSignedIn() && isManager() && existingDocInMyCompany() && !isCompanyBlocked(resource.data.get('companyId', ''));
    }

    // ==========================================================
    // 2. × ×•×›×—×•×ª (Attendance)
    // ==========================================================
    match /attendance/{docId} {
      // âœ… ×ª×™×§×•×Ÿ: ×× ×”×œ×™× ×™×›×•×œ×™× ×œ×§×¨×•× ×”×›×œ ×‘×œ×™ ×ª× ××™× ××¡×•×‘×›×™×
      allow read: if isSignedIn() && isManager();
      
      // âœ… ×¢×•×‘×“×™× ×¨×’×™×œ×™× ×™×›×•×œ×™× ×œ×§×¨×•× ×¨×§ ××ª ×©×œ×”× (×× ×”××¡××š ×§×™×™×)
      allow read: if isSignedIn() && 
                     resource != null && 
                     resource.data.userId == request.auth.uid &&
                     !isCompanyBlocked(resource.data.get('companyId', ''));

      allow create: if isSignedIn() && (
        (request.resource.data.userId == request.auth.uid && writingToMyCompany()) || 
        (isManager() && writingToMyCompany())
      )
      && !isCompanyBlocked(request.resource.data.companyId);

      allow update: if isSignedIn() && (
        (request.resource.data.userId == request.auth.uid && existingDocInMyCompany()) || 
        (isManager() && existingDocInMyCompany())
      )
      && !isCompanyBlocked(resource.data.get('companyId', ''));
      
      allow delete: if isSignedIn() && (
        (resource.data.userId == request.auth.uid) || 
        (isManager() && existingDocInMyCompany())
      )
      && !isCompanyBlocked(resource.data.get('companyId', ''));
    }

    // ==========================================================
    // 3. ×‘×§×©×•×ª ×—×•×¤×©×” (Requests)
    // ==========================================================
    match /requests/{requestId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        (isManager() && existingDocInMyCompany())
      )
      && !isCompanyBlocked(resource.data.get('companyId', ''));

      allow create: if isSignedIn() && 
                    request.resource.data.userId == request.auth.uid && 
                    writingToMyCompany()
                    && !isCompanyBlocked(request.resource.data.companyId);
      
      allow update: if isSignedIn() && (
        (resource.data.userId == request.auth.uid && resource.data.status == 'pending') ||
        (isManager() && existingDocInMyCompany())
      )
      && !isCompanyBlocked(resource.data.get('companyId', ''));
      
      allow delete: if isSignedIn() && (
        (resource.data.userId == request.auth.uid && resource.data.status == 'pending') || 
        (isManager() && existingDocInMyCompany())
      )
      && !isCompanyBlocked(resource.data.get('companyId', ''));
    }

    // ==========================================================
    // 4. ××©×ª××©×™× ×××ª×™× ×™× (Pending Users)
    // ==========================================================
    match /pendingUsers/{docId} {
      allow create: if true;
      
      allow read: if isSignedIn() && isManager() && existingDocInMyCompany() && !isCompanyBlocked(resource.data.get('companyId', ''));
      
      allow update, delete: if isSignedIn() && isManager() && existingDocInMyCompany() && !isCompanyBlocked(resource.data.get('companyId', ''));
    }

// ==========================================================
    // 5. × ×™×”×•×œ ×—×‘×¨×•×ª (Companies) - ×ª×™×§×•×Ÿ ×œ×§×¨×™×¡×ª ×”×•×¡×¤×ª ×¢×•×‘×“
    // ==========================================================
    match /companies/{companyId} {
      allow create: if isSignedIn();
      
      allow read: if isSignedIn() && (
        resource.id == myCompanyId() || resource.data.adminUid == request.auth.uid
      );

      allow update: if isSignedIn() && (
        resource.id == myCompanyId() || resource.data.adminUid == request.auth.uid
      )
      // 1. ×—×¡×™××” ××•×—×œ×˜×ª: ××¡×•×¨ ×œ××©×ª××© ×œ×©× ×•×ª ××ª ×”×¡×˜×˜×•×¡×™× ×”×§×¨×™×˜×™×™× ×”××œ×•
      && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isBlocked', 'maxUsers'])
      
      // 2. ×œ×•×’×™×§×” ×œ××•× ×” ×”××©×ª××©×™× (currentUsersCount):
      // ×× ×—× ×• ×××¤×©×¨×™× ×œ×¢×“×›×Ÿ ××•×ª×•, ××‘×œ ×¨×§ ×‘×¦×¢×“×™× ×©×œ 1 (×¤×œ×•×¡ ××• ××™× ×•×¡)
      // ×–×” ××•× ×¢ ××”××©×ª××© ×œ××¤×¡ ××ª ×”××•× ×” ×œ-0 ×‘×–×“×•×Ÿ
      && (
        // ××¤×©×¨×•×ª ×': ×œ× × ×’×¢×• ×‘××•× ×” ×‘×›×œ×œ
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['currentUsersCount'])
        ||
        // ××¤×©×¨×•×ª ×‘': × ×’×¢×• ×‘××•× ×”, ××‘×œ ×”×—×™×©×•×‘ ×ª×§×™×Ÿ (×”×•×¡×™×¤×• 1 ××• ×”×•×¨×™×“×• 1)
        (
          request.resource.data.get('currentUsersCount', 0) == resource.data.get('currentUsersCount', 0) + 1 ||
          request.resource.data.get('currentUsersCount', 0) == resource.data.get('currentUsersCount', 0) - 1
        )
      );
    }

    // ==========================================================
    // 6. ×§×‘×¦×™× ×¦×™×‘×•×¨×™×™× (Public)
    // ==========================================================
    match /public_company_codes/{code} {
      allow read: if true; 
      allow create: if isSignedIn();
      
      allow update, delete: if isSignedIn() && isManager() && existingDocInMyCompany() && !isCompanyBlocked(resource.data.get('companyId', ''));
    }
    
    match /public_company_names/{name} {
      allow read: if true;
      allow create: if isSignedIn();
    }

    match /config/{docId} {
      allow read: if true;
      allow write: if false; 
    }
  }
}