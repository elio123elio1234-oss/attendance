
<!DOCTYPE html>
<html lang="en" class="bg-white dark:bg-gray-900 min-h-screen">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Samsung Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- [תיקון 3] הסתרת פסי גלילה בכל האפליקציה --- */

        html, body {
            -webkit-text-size-adjust: 100%; /* מונע מדפדפנים לשנות את גודל הטקסט */
            text-size-adjust: 100%;         /* תקן עתידי לאותה מטרה */
        }
        
        /* --- [תיקון 2] הסתרת פסי גלילה בכל האפליקציה (כולל body) --- */
        html, body {
            scrollbar-width: none; /* For Firefox */
            -ms-overflow-style: none;  /* For Internet Explorer and Edge */
        }
        html::-webkit-scrollbar,
        body::-webkit-scrollbar { /* הכלל הוחל גם על body */
            display: none; /* For WebKit browsers */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Clean white background */
            overflow-x: hidden; /* <-- הוספה חשובה: מונע בכוח גלילה אופקית */
        }

        /* Force pure white only on the root document elements. Avoid overriding
           Tailwind utility classes used for table headers and TL rows. */
        html, body {
            background-color: #ffffff !important;
        }

        /* --- Dark mode: set dark backgrounds for main containers and body --- */
        .dark body,
        .dark #app-container,
        .dark #auth-container {
            background-color: #111827 !important; /* Tailwind gray-900 */
            color: #f9fafb !important; /* Tailwind gray-50 */
        }
        
        /* Remove gray panels by making them transparent in dark mode */
        .dark #app-container .bg-white,
        .dark #auth-container .bg-white,
        .dark #app-container .p-6, 
        .dark #app-container .p-8,
        .dark #auth-container .p-6, 
        .dark #auth-container .p-8,
        .dark #app-container .overflow-x-auto, 
        .dark #auth-container .overflow-x-auto {
            background-color: transparent !important;
            color: #f9fafb !important;
        }

        /* --- Make app look like a clean white page (no boxed white cards) --- */
        /* Remove the boxed white panels, shadows and rounded corners that create
           the separate "card" rectangles on main pages. Scoped to the main
           containers so modals and inputs keep their intended styles. */
        #auth-container .w-full.max-w-md.bg-white,
        #auth-container .rounded-xl,
        #auth-container .shadow-lg,
        #app-container .rounded-xl,
        #app-container .shadow-md,
        #app-container .bg-white {
            background-color: transparent !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            border: none !important;
        }

        /* Keep inputs and small white elements intact by limiting the scope above.
           Also ensure loading overlay matches the new white background. */
        #loading-spinner {
            background-color: #ffffff;
        }

        /* --- Mobile: reduce side padding and allow full-width containers --- */
        @media (max-width: 640px) {
            /* Remove large side gaps for mobile devices */
            #app-container, #auth-container {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                max-width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                overflow-x: hidden !important; /* Prevent page from scrolling horizontally */
            }

            /* Ensure inner 'card' wrappers expand to full width when we removed their borders */
            #auth-container > div.w-full.max-w-md,
            #app-container > div {
                width: 100% !important;
                max-width: 100% !important;
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }

            /* Remove heavy padding on common padding utilities inside containers so tables reach edges */
            #app-container .p-6, #app-container .p-8,
            #auth-container .p-6, #auth-container .p-8 {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }

            /* Tables and overflow wrappers should use full width */
            #app-container .overflow-x-auto, #auth-container .overflow-x-auto,
            #app-container .overflow-auto, #auth-container .overflow-auto {
                padding-left: 0 !important;
                padding-right: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                width: 100% !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            /* Reduce table cell horizontal padding on mobile (improves fit).
               Allow wrapping of long status labels so they don't overflow
               into the next day's cell. We keep nowrap removed so labels
               can wrap gracefully; use text-overflow/ellipsis only when
               explicit truncation is desired on larger screens. */
            #app-container table td, #app-container table th,
            #auth-container table td, #auth-container table th {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                white-space: normal !important; /* allow wrapping on phones */
                word-break: break-word !important;
                overflow-wrap: anywhere !important;
            }

            /* Tabs and nav should use more horizontal space */
            nav#main-nav {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
            /* Team View: allow tables to bleed near screen edges on phones */
            #content-display, #content-display .bg-white, #team-view-container {
                width: 98vw !important; /* nearly full viewport width */
                max-width: 98vw !important;
                margin-left: calc((100vw - 98vw) / -2) !important; /* shift to the left so it sits closer to the screen edge */
                margin-right: calc((100vw - 98vw) / -2) !important; /* shift to the right symmetrically */
                padding-left: 0.25rem !important; /* keep a tiny inner gutter */
                padding-right: 0.25rem !important;
            }
            /* Make any tables inside team view expand to full available width.
               Also allow horizontal scroll if content still doesn't fit. */
            #team-view-container table {
                width: 100% !important;
                min-width: 100% !important;
                table-layout: auto !important; /* allow columns to size to content */
            }
            /* Remove inner card padding only for the team view card to maximize space */
            #content-display > div.bg-white {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
        }


        
        /* --- New Gradient Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            background-size: 200% auto;
            border: none;
        }
        .btn:hover {
            background-position: right center; /* change the direction of the change here */
            box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.2);
        }
        .btn-primary {
            /* [MODIFICATION] New multi-color gradient for the sign-in button */
            background-image: linear-gradient(to right, #ec4899 0%, #a855f7 33%, #4ade80 66%, #3b82f6 100%);
        }
        .btn-danger {
            background-image: linear-gradient(to right, #ef4444 0%, #db2777 51%, #ef4444 100%);
        }
        .btn-success {
             background-image: linear-gradient(to right, #22c55e 0%, #15803d 51%, #22c55e 100%);
        }

        /* --- Animated Gradient Logo Text --- */
        .animated-gradient-text {
            background: linear-gradient(90deg, #1428a0, #ec4899, #a855f7, #4ade80, #1428a0);
            background-size: 300% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-flow 15s ease-in-out infinite;
        }
        @keyframes gradient-flow {
            0% { background-position: 200% 50%; }
            50% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        /* --- Samsung SVG Logo Color --- */
        .samsung-logo-svg {
            fill: #1428a0;
        }
        .dark .samsung-logo-svg {
            fill: #8ab4f8; /* A lighter, more accessible blue for dark backgrounds */
        }


        /* --- New Theme Colors & Links --- */
        .theme-purple-bg { background-color: #ede9fe; } /* violet-100 */
        .theme-purple-border { border-color: #c4b5fd; } /* violet-300 */
        .theme-purple-text { color: #7c3aed; } /* violet-600 */
        .theme-purple-text-dark { color: #5b21b6; } /* violet-700 */
        .theme-link {
            font-weight: 500; 
            background-image: linear-gradient(to right, #f472b6, #86efac, #c084fc);
            background-size: 150% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: all .3s ease-in-out;
        }
        .theme-link:hover {
            color: transparent;
            transform: scale(1.05);
            background-position: right center;
        }

        /* --- [שינוי] Tab Animation Styles --- */
        .tab-btn {
            transition: color 0.3s ease-in-out, transform 0.1s ease-out;
            position: relative;
            z-index: 1;
        }
        .tab-btn.active {
            font-weight: 700;
            /* שימוש במשתני CSS כדי לשלוט בצבע הגרדיאנט דרך JS */
            --tab-active-start: #a855f7;
            --tab-active-end: #ec4899;
            background-image: linear-gradient(to right, var(--tab-active-start), var(--tab-active-end));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px; /* מכסה את הקו האפור */
            left: 0;
            right: 0;
            height: 2px;
            background-color: #fdf2f8;
            z-index: 2;
        }
        .dark .tab-btn.active::after {
            background-color: #111827; /* תואם לרקע של dark mode */
        }
        .tab-btn.active:hover {
            color: transparent;
        }
        #active-tab-indicator {
            position: absolute;
            bottom: 0;
            height: 100%;
            background-color: #fdf2f8; /* pink-50 */
            border-bottom: 2px solid #ec4899; /* pink-500 */
            border-radius: 0.375rem; /* rounded-md */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        /* Highlight today's header in the Team View table */
        .day-header-today {
            font-weight: 800; /* extra-bold for clear emphasis */
            color: #111827 !important; /* gray-900 in light mode */
        }
        .dark .day-header-today {
            color: #f9fafb !important; /* gray-50 in dark mode */
        }

        /* Gentle slow blink for Sunday when today is Fri/Sat - smooth opacity transition only */
        @keyframes slow-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .sun-blink {
            font-weight: 700; /* Keep bold always */
            animation: slow-blink 3s ease-in-out infinite;
        }

        /* --- [חדש] סגנון עבור חלקיקי ניצוצות --- */
        .sparkle-particle {
            position: fixed;
            z-index: 9999;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 1;
            transition: transform 0.8s cubic-bezier(0.1, 0.8, 0.7, 1), opacity 0.8s ease-out;
        }
        
        .form-input:focus {
            border-color: #8b5cf6; /* violet-500 */
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
            outline: none;
        }
        
        #auth-container .form-input {
            border-width: 2px;
            border-radius: 0.5rem; /* Ensure radius is always present */
        }

        #auth-container .form-input:focus {
            border: 2px solid transparent;
            background: 
                linear-gradient(white, white) padding-box, 
                linear-gradient(to right, #a7f3d0, #fbcfe8, #ddd6fe) border-box;
            background-size: 200% auto;
            animation: gradient-border-flow 3s linear infinite;
            box-shadow: 0 0 8px rgba(221, 214, 254, 0.5); 
        }

        @keyframes gradient-border-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Hide Tab Scrollbar --- */
        nav::-webkit-scrollbar {
            display: none;
        }
        nav {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

/* --- הסתרת פסי גלילה בטבלאות --- */
        .overflow-x-auto::-webkit-scrollbar {
            display: none;
        }
        .overflow-x-auto {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;     /* Firefox */
        }

        /* --- New Loading Spinner --- */
        #loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f4f5fa; 
            z-index: 100;
        }
        .quantum-spinner {
            width: 70px;
            height: 70px;
            position: relative;
        }
        .quantum-spinner .dot {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #a855f7;
            animation: quantum-orbit 2s linear infinite;
        }
        .quantum-spinner .dot:nth-child(1) {
            top: 0; left: 50%; transform: translateX(-50%);
            animation-delay: -1.8s;
        }
        .quantum-spinner .dot:nth-child(2) {
            top: 50%; right: 0; transform: translateY(-50%);
            animation-delay: -1.4s;
            background: #ec4899;
        }
        .quantum-spinner .dot:nth-child(3) {
            bottom: 0; left: 50%; transform: translateX(-50%);
            animation-delay: -1.0s;
            background: #4ade80;
        }
        .quantum-spinner .dot:nth-child(4) {
            top: 50%; left: 0; transform: translateY(-50%);
            animation-delay: -0.6s;
            background: #3b82f6;
        }
        .quantum-spinner .center-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 15px;
            height: 15px;
            background: linear-gradient(to right, #a855f7, #ec4899);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: quantum-pulse 2s ease-in-out infinite;
        }
        @keyframes quantum-orbit {
            0% { transform: rotate(0deg) translateX(30px) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(30px) rotate(-360deg); }
        }
        @keyframes quantum-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(0.8); }
        }

        .weekly-summary-card {
            background-color: #f9fafb; /* gray-50 - same as other statistics cards */
            border: 1px solid #e5e7eb; /* gray-200 border like other cards */
            position: relative;
            border-radius: 0.75rem; /* rounded-xl - 12px */
        }
        /* Dark mode version */
        .dark .weekly-summary-card {
            background-color: rgba(31, 41, 55, 0.5); /* darker background */
            border: 1px solid rgba(255, 255, 255, 0.1); /* subtle border in dark mode */
        }

        /* Circular Progress Indicators */
        .progress-circles-container {
            display: flex;
            gap: 2rem;
            overflow-x: auto;
            padding: 1rem 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db transparent; /* gray-300 */
        }
        
        /* Mobile: tighter spacing between circles */
        @media (max-width: 640px) {
            .progress-circles-container {
                gap: 0.5rem;
            }
        }
        
        .progress-circles-container::-webkit-scrollbar {
            height: 8px;
        }
        .progress-circles-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .progress-circles-container::-webkit-scrollbar-thumb {
            background: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        .progress-circles-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* gray-400 */
        }
        .progress-circle-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            flex-shrink: 0;
        }
        .progress-circle {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .progress-circle svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .progress-circle-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        .dark .progress-circle-bg {
            stroke: #374151;
        }
        .progress-circle-fill {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .progress-circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .progress-circle-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .dark .progress-circle-percentage {
            color: #f3f4f6;
        }
        .progress-circle-label {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            text-align: center;
            max-width: 120px;
            overflow-wrap: break-word;
        }
        .dark .progress-circle-label {
            color: #9ca3af;
        }
        .progress-circle-count {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .dark .progress-circle-count {
            color: #9ca3af;
        }

        /* --- [NEW] Return to today button styles --- */
        @keyframes slow-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.95; }
        }
        .return-to-today-btn {
            cursor: pointer;
            animation: gradient-flow 15s ease-in-out infinite, slow-pulse 3s ease-in-out infinite;
            display: inline-block;
            transition: transform 0.3s ease;
        }
        .return-to-today-btn:hover {
            transform: scale(1.05);
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            overflow-y: auto; /* Allow scrolling for tall modals */
        }
        .modal-overlay.z-60 {
            z-index: 60;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* More rounded */
            max-width: 500px;
            width: 90%;
            margin: 2rem 0; /* Add some margin for scrolling */
        }
        @media (min-width: 640px) {
            .modal-content {
                padding: 2rem;
            }
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .dragging {
            opacity: 0.5;
            background: #eef2ff;
            border: 1px dashed #1428a0;
        }
        .drag-over-indicator {
            border-top: 2px solid #1428a0 !important;
            background-color: #ebf0ff;
        }

        .sticky-col {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            left: 0;
            z-index: 20;
            isolation: isolate;
        }

        /* Light Mode - Sticky Header: gray background with dark text */
        thead th.sticky-col {
            background-color: #f9fafb !important; /* bg-gray-50 */
            color: #4b5563 !important; /* text-gray-600 */
            z-index: 30; /* Header above rows */
        }

        /* Light Mode - ALL headers should have light background */
        thead th {
            background-color: #f9fafb !important; /* bg-gray-50 */
            color: #4b5563 !important; /* text-gray-600 */
        }

        /* Light Mode - Email column only should be black */
        tbody tr td:nth-child(2) {
            color: #111827 !important; /* text-gray-900 - black text for emails */
        }

        /* Light Mode - Group column should be black */
        tbody tr td:nth-child(3) {
            color: #111827 !important; /* text-gray-900 - black text for groups */
        }

        /* Light Mode - Sticky Rows: white background with dark text */
        tbody tr td.sticky-col {
            background-color: #ffffff !important;
            color: #111827 !important; /* text-gray-900 */
        }

        /* Light Mode - TL rows with gray background */
        tbody tr.bg-gray-50 td.sticky-col {
            background-color: #f9fafb !important; /* bg-gray-50 */
            color: #111827 !important; /* text-gray-900 */
        }
        
        /* Ensure table wrapper has proper z-index context */
        .overflow-x-auto {
            position: relative;
            z-index: 1;
            isolation: isolate;
        }

        /* Team View - tighter weekday columns on larger screens */
        #team-view-container table th,
        #team-view-container table td {
            padding-left: 0.5rem !important; /* default reduced padding */
            padding-right: 0.5rem !important;
        }

        /* Slightly smaller weekday labels and tighter spacing for desktop/tablet */
        @media (min-width: 641px) {
            #team-view-container table th.weekday, #team-view-container table th.day {
                padding-left: 0.4rem !important;
                padding-right: 0.4rem !important;
                font-size: 0.85rem !important;
                letter-spacing: -0.2px !important;
            }
            #team-view-container table td {
                padding-left: 0.4rem !important;
                padding-right: 0.4rem !important;
            }
        }

        /* Mobile: allow day columns to expand slightly when content is long
           to avoid overlapping the next day's ellipse. We keep a sensible
           min-width but allow flexing by using percentage widths and
           letting table-layout be auto for phones. */
        @media (max-width: 640px) {
            /* Keep employee name column larger to avoid squeezing names */
            #team-view-container table thead th:nth-child(1),
            #team-view-container table tbody td:nth-child(1) {
                min-width: 120px !important;
                width: 28% !important;
            }

            /* Prefer single-line day cells on phones by increasing min-width.
               This keeps row height consistent. If the viewport is too narrow,
               horizontal scroll will appear on the table. */
            #team-view-container table thead th:nth-child(n+2),
            #team-view-container table tbody td:nth-child(n+2) {
                min-width: 92px !important; /* wider baseline to keep statuses single-line */
                width: auto !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                text-align: center !important;
                white-space: nowrap !important; /* prefer single-line */
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            /* Keep status-label single-line on phones (no wrapping) */
            #team-view-container table tbody td .status-label {
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: inline-block !important;
                max-width: 100% !important;
            }
        }

        /* Force weekday columns (columns 2..6) to be narrow so more days fit across */
        @media (min-width: 641px) {
            /* Keep the first column (Employee) wide - usually nth-child(1) */
            #team-view-container table thead th:nth-child(1),
            #team-view-container table tbody td:nth-child(1) {
                width: 180px !important;
                min-width: 140px !important;
                max-width: 260px !important;
                padding-left: 0.6rem !important;
                padding-right: 0.6rem !important;
            }

            /* Days: 2..6  (Monday..Friday) - make compact */
            #team-view-container table thead th:nth-child(2),
            #team-view-container table thead th:nth-child(3),
            #team-view-container table thead th:nth-child(4),
            #team-view-container table thead th:nth-child(5),
            #team-view-container table thead th:nth-child(6),
            #team-view-container table tbody td:nth-child(2),
            #team-view-container table tbody td:nth-child(3),
            #team-view-container table tbody td:nth-child(4),
            #team-view-container table tbody td:nth-child(5),
            #team-view-container table tbody td:nth-child(6) {
                width: 56px !important;
                min-width: 56px !important;
                max-width: 72px !important;
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
                text-align: center !important;
                overflow: hidden !important;
                white-space: nowrap !important;
                text-overflow: ellipsis !important;
            }

            /* Make the status badges fit and truncate if needed */
            #team-view-container table tbody td span {
                display: inline-block !important;
                max-width: 100% !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
            }
        }

        /* Ensure clean overlay in dark mode */
        .dark .sticky-col {
            background-blend-mode: normal;
        }

        /* --- Drag and Drop Styles --- */
        .drag-over-animated {
            background: linear-gradient(135deg, #4ade80, #ec4899, #a855f7, #4ade80);
            background-size: 300% 300%;
            animation: drag-over-flow 1.5s ease infinite;
            transform: scale(1.2);
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        @keyframes drag-over-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .dragging-item {
            opacity: 0.4;
            cursor: grabbing;
        }

        /* --- [NEW/CORRECTED] Drag Handle Animation --- */
        /* [FIX] Changed keyframe 'to' position from -100% to -200% for a seamless loop */
        @keyframes flow-down {
            from { background-position: 0 0; }
            to { background-position: 0 -200%; }
        }
        .animated-chevron {
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            background: linear-gradient(180deg, #a855f7, #ec4899, #4ade80, #a855f7);
            background-size: 100% 200%;
            animation: flow-down 3s linear infinite;

            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='3' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 13l-7 7-7-7m14-8l-7 7-7-7' /%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='3' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 13l-7 7-7-7m14-8l-7 7-7-7' /%3E%3C/svg%3E");
            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
        }
        
        /* --- [חדש] Success Animation --- */
        .success-animation-container {
            width: 40px;
            height: 40px;
            display: none;
            margin-left: 1rem;
            vertical-align: middle;
        }

        .success-animation-container.show {
            display: inline-block;
        }

        .success-animation-container svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .success-animation-container .circle-bg {
            stroke-width: 3;
            stroke: #e5e7eb; /* gray-200 */
            fill: none;
        }
        .dark .success-animation-container .circle-bg {
            stroke: #4b5563; /* gray-600 */
        }

        .success-animation-container .circle-progress,
        .success-animation-container .checkmark {
            stroke-width: 3;
            stroke: #22c55e; /* green-500 */
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .success-animation-container.show .circle-progress {
            stroke-dasharray: 151;
            stroke-dashoffset: 151;
            animation: circle-progress 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .success-animation-container.show .checkmark {
            stroke-dasharray: 30;
            stroke-dashoffset: 30;
            animation: checkmark 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.7s forwards;
        }

        @keyframes circle-progress {
            to {
                stroke-dashoffset: 0;
            }
        }

        @keyframes checkmark {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* --- Dark Mode Styles --- */
        /* Add smooth transition for background color changes */
        .bg-white, .bg-gray-50, .bg-gray-100 {
            transition: background-color 0.2s ease-in-out;
        }
        .dark body { background-color: #111827; } /* gray-900 */
        .dark #auth-container .bg-white { background-color: transparent; }
        .dark .text-gray-800, .dark .text-gray-900 { color: #f9fafb; } /* gray-50 */
        .dark .text-gray-700 { color: #d1d5db; } /* gray-300 */
        .dark #active-tab-indicator {
            background-color: #111827 !important;
        }
        .dark .text-gray-600 { color: #9ca3af; } /* gray-400 */
        .dark .text-gray-500 { color: #6b7280; } /* gray-500 */
        .dark .bg-white { background-color: transparent; }
        .dark .bg-gray-50 { background-color: rgba(255, 255, 255, 0.03); } /* Very subtle light */
        .dark .bg-gray-100 { background-color: rgba(255, 255, 255, 0.05); } 
        .dark .bg-gray-200 { background-color: rgba(255, 255, 255, 0.08); }
        .dark .border-b, .dark .border, .dark .theme-purple-border { border-color: rgba(255, 255, 255, 0.1); }
        .dark .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: rgba(255, 255, 255, 0.1); }
        .dark .form-input {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: #f9fafb;
        }
        .dark .form-input::placeholder { color: #9ca3af; } /* gray-400 */
        .dark .form-input:focus {
            border-color: #a78bfa; /* violet-400 */
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.2);
            background-color: rgba(255, 255, 255, 0.08);
        }
        /* Fix for select dropdowns in dark mode */
        .dark select.form-input {
            background-color: #1f2937; /* gray-800 */
            color: #f9fafb; /* gray-50 */
        }
        .dark select.form-input option {
            background-color: #1f2937; /* gray-800 */
            color: #f9fafb; /* gray-50 */
        }
        .dark #auth-container .form-input:focus {
            background: linear-gradient(#111827, #111827) padding-box, linear-gradient(to right, #a7f3d0, #fbcfe8, #ddd6fe) border-box;
        }
        .dark #active-tab-indicator {
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom-color: #f472b6;
        }
        .dark #loading-spinner { background-color: #111827; }
        .dark .modal-content { background-color: #111827; }
        .dark .modal-overlay { background-color: rgba(0, 0, 0, 0.8); }
        .dark #modal-cancel, .dark #edit-modal-cancel, .dark #reauth-cancel, .dark #manage-groups-close, .dark #super-admin-edit-cancel, .dark #forgot-cancel { 
            background-color: rgba(255, 255, 255, 0.1);
            color: #f9fafb;
        }
        .dark #modal-cancel:hover, .dark #edit-modal-cancel:hover, .dark #reauth-cancel:hover, .dark #manage-groups-close:hover, .dark #super-admin-edit-cancel:hover, .dark #forgot-cancel:hover { 
            background-color: rgba(255, 255, 255, 0.15); 
        }

        /* Team View Table Dark Mode Fixes */
        /* Header styles - using the same color as TL rows for better hierarchy */
        .dark thead tr {
            background-color: rgb(55, 65, 81) !important; /* Same as TL rows */
        }
        
        .dark thead th {
            background-color: rgb(55, 65, 81) !important; /* Same as TL rows */
            color: #ffffff !important; /* White text */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600 !important; /* Make headers more prominent */
        }

        .dark thead th.sticky-col {
            background-color: rgb(55, 65, 81) !important; /* Match other headers in dark mode */
            color: #ffffff !important; /* White text */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Regular row styles */
        .dark tbody tr {
            background-color: #111827 !important;
        }

        .dark tbody tr td {
            background-color: #111827 !important;
            color: #9ca3af !important; /* text-gray-400 */
        }

        .dark tbody tr td.sticky-col {
            background-color: #111827 !important;
            color: #f3f4f6 !important; /* text-gray-100 */
        }

        .dark tbody tr td.font-medium {
            color: #f3f4f6 !important; /* text-gray-100 for bold items */
        }

        /* TL row styles - using rgb instead of hex for exact color matching */
        .dark tbody tr.bg-gray-50 {
            background-color: rgb(55, 65, 81) !important; /* Solid color for TL rows */
        }

        .dark tbody tr.bg-gray-50 td {
            background-color: rgb(55, 65, 81) !important;
        }

        .dark tbody tr.bg-gray-50 td.sticky-col {
            background-color: rgb(55, 65, 81) !important;
        }

        /* Ensure table borders are consistent */
        .dark table {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        .dark .divide-y > :not([hidden]) ~ :not([hidden]) {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        .dark .bg-green-100 { background-color: rgba(16, 185, 129, 0.1); color: #34d399; }
        .dark .bg-blue-100 { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; }
        .dark .bg-red-100 { background-color: rgba(239, 68, 68, 0.1); color: #f87171; }
        .dark .bg-yellow-100 { background-color: rgba(245, 158, 11, 0.1); color: #fbbf24; }
        .dark .bg-purple-100 { background-color: rgba(139, 92, 246, 0.1); color: #a78bfa; }
        .dark .bg-indigo-100 { background-color: rgba(99, 102, 241, 0.1); color: #818cf8; }
        .dark .text-red-700 { color: #f87171; }
        .dark .weekly-summary-card { 
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark .weekly-summary-card::before { background: linear-gradient(to right, rgba(236, 72, 153, 0.3), rgba(74, 222, 128, 0.3), rgba(96, 165, 250, 0.3), rgba(167, 139, 250, 0.3)); }

        /* Weekly Summary Title Colors */
        .weekly-summary-title {
            color: #000000 !important; /* Black in light mode */
        }
        .dark .weekly-summary-title {
            color: #ffffff !important; /* White in dark mode */
        }

    </style>
</head>
<body class="min-h-screen bg-white dark:bg-gray-900">

    <!-- Loading Spinner -->
    <div id="loading-spinner">
        <!-- [MODIFICATION 2] New Spinner -->
        <div class="quantum-spinner">
            <div class="center-dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 sm:p-8">
            <div class="text-center mb-8">
                <!-- ================================================================== -->
                <!-- מיקום 1: מסך הכניסה                                                     -->
                <!-- שנה את הערך "h-12" כדי לשלוט בגובה הלוגו. למשל: h-10, h-14, h-16 -->
                <!-- ================================================================== -->
                <svg class="samsung-logo-svg inline-block h-12" viewBox="0 0 837.6507 222.51334" xmlns="http://www.w3.org/2000/svg">
                    <g transform="matrix(1.3333333,0,0,-1.3333333,0,222.51333)">
                        <g transform="translate(558.9328,88.5098)">
                            <path d="m 0,0 v -11.358 h 7.982 v -11.269 c 0.025,-1.007 -0.03,-2.093 -0.203,-2.962 -0.317,-2.102 -2.314,-5.681 -7.98,-5.681 -5.632,0 -7.593,3.579 -7.933,5.681 -0.143,0.869 -0.204,1.955 -0.204,2.962 v 35.593 c 0,1.259 0.085,2.637 0.352,3.68 0.387,1.897 2.068,5.638 7.743,5.638 5.957,0 7.444,-3.944 7.785,-5.638 0.224,-1.122 0.237,-3.004 0.237,-3.004 V 9.32 h 19.613 v 2.555 c 0,0 0.089,2.666 -0.149,5.154 C 25.769,31.638 13.732,36.26 -0.07,36.26 c -13.827,0 -25.62,-4.665 -27.338,-19.231 -0.155,-1.332 -0.392,-3.728 -0.392,-5.154 v -32.742 c 0,-1.426 0.046,-2.53 0.31,-5.136 1.28,-14.207 13.593,-19.243 27.365,-19.243 13.857,0 26.085,5.036 27.387,19.243 0.231,2.606 0.255,3.71 0.286,5.136 V 0 Z m -135.235,34.165 h -19.696 v -57.613 c 0.031,-1.004 0,-2.132 -0.173,-2.959 -0.411,-1.934 -2.05,-5.656 -7.484,-5.656 -5.364,0 -7.046,3.722 -7.426,5.656 -0.197,0.827 -0.222,1.955 -0.197,2.959 v 57.613 h -19.69 V -21.66 c -0.025,-1.439 0.088,-4.379 0.173,-5.149 1.359,-14.547 12.824,-19.27 27.14,-19.27 14.344,0 25.802,4.723 27.186,19.27 0.109,0.77 0.252,3.71 0.167,5.149 z m -180.97,0 -9.825,-60.876 -9.819,60.876 h -31.771 l -1.685,-77.878 h 19.464 l 0.527,72.094 13.392,-72.094 h 19.748 l 13.404,72.094 0.529,-72.094 h 19.513 l -1.742,77.878 z m -117.631,0 -14.426,-77.878 h 21.037 l 10.871,72.094 10.61,-72.094 h 20.891 l -14.366,77.878 z m 367.435,-62.701 -18.34,62.701 h -28.9 v -77.066 h 19.118 l -1.11,64.707 19.696,-64.707 h 27.717 v 77.066 h -19.243 z m -176.838,42.433 c -0.346,1.538 -0.246,3.172 -0.067,4.026 0.557,2.493 2.232,5.212 7.058,5.212 4.498,0 7.135,-2.804 7.135,-7.012 v -4.762 h 19.2 v 5.428 c 0,16.78 -15.044,19.416 -25.936,19.416 -13.718,0 -24.921,-4.522 -26.967,-17.148 -0.541,-3.436 -0.675,-6.486 0.186,-10.378 3.336,-15.743 30.743,-20.31 34.721,-30.266 0.702,-1.886 0.501,-4.291 0.143,-5.708 -0.596,-2.591 -2.339,-5.197 -7.506,-5.197 -4.846,0 -7.763,2.786 -7.763,6.985 l -0.006,7.474 h -20.666 v -5.941 c 0,-17.215 13.484,-22.409 28.007,-22.409 13.909,0 25.397,4.753 27.24,17.637 0.879,6.657 0.216,10.993 -0.137,12.626 -3.22,16.147 -32.431,21.004 -34.642,30.017 m -253.273,0.191 c -0.377,1.57 -0.289,3.227 -0.079,4.091 0.532,2.481 2.217,5.248 7.128,5.248 4.555,0 7.237,-2.831 7.237,-7.073 v -4.82 h 19.425 v 5.471 c 0,16.941 -15.274,19.641 -26.285,19.641 -13.833,0 -25.136,-4.592 -27.204,-17.309 -0.566,-3.491 -0.663,-6.562 0.155,-10.497 3.372,-15.922 31.05,-20.526 35.077,-30.601 0.754,-1.873 0.526,-4.278 0.152,-5.75 -0.639,-2.618 -2.396,-5.261 -7.606,-5.261 -4.865,0 -7.775,2.834 -7.775,7.091 l -0.027,7.494 h -20.898 v -5.955 c 0,-17.412 13.675,-22.648 28.311,-22.648 14.071,0 25.626,4.795 27.511,17.828 0.937,6.718 0.234,11.09 -0.082,12.748 -3.287,16.345 -32.823,21.186 -35.04,30.302" />
                        </g>
                    </g>
                </svg>
                <p class="animated-gradient-text text-lg font-bold tracking-widest -mt-1">        R&D CENTER ISRAEL</p>
            </div>
            
            <!-- Login Form -->
            <form id="login-form">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Employee Attendance</h2>
                <p class="text-center text-gray-500 mb-6">Sign in to continue</p>
                <div class="mb-4">
                    <label for="login-identifier" class="block text-gray-700 text-sm font-bold mb-2">Email or Username</label>
                    <input type="text" id="login-identifier" class="form-input shadow-sm appearance-none border rounded-lg w-full py-[11px] px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline transition duration-150 ease-in-out" required>
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="login-password" class="form-input shadow-sm appearance-none border rounded-lg w-full py-[11px] px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline transition duration-150 ease-in-out" required>
                </div>
                <div class="flex justify-end mb-6">
                    <a href="#" id="show-forgot-password" class="text-sm theme-link hover:underline">Forgot Password?</a>
                </div>
                <p id="login-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                <button type="submit" class="w-full btn btn-primary focus:outline-none focus:shadow-outline">Sign In</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? <a href="#" id="show-register" class="theme-link hover:underline">Request Access</a>
                </p>
                <div class="text-center mt-6">
                    <a href="#" id="show-about" class="text-sm text-gray-400 hover:text-gray-600">About</a>
                    <div id="about-content" class="hidden mt-4 text-left text-sm text-gray-600 bg-gray-50 p-4 rounded-lg">
                        <p class="font-semibold">© Elio El Hassrouny</p>
                        <p class="mt-2">This application helps Samsung employees and team leaders track weekly attendance. It provides an easy way to update statuses, view team schedules, and manage attendance data efficiently.</p>
                        <p class="text-center text-gray-500 text-xs mt-4">Version 1.0.0</p>
                    </div>
                </div>
            </form>

            <!-- Registration Form -->
            <form id="register-form" class="hidden">
                 <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Request Access</h2>
                <p class="text-center text-gray-500 mb-6">Your request will be sent to an administrator for approval.</p>
                 <div class="mb-4">
                    <label for="register-fullname" class="block text-gray-700 text-sm font-bold mb-2">Full Name</label>
                    <input type="text" id="register-fullname" class="form-input shadow-sm appearance-none border rounded-lg w-full py-3 px-4" required>
                </div>
                <div class="mb-4">
                    <label for="register-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="register-email" class="form-input shadow-sm appearance-none border rounded-lg w-full py-3 px-4" required>
                </div>
                 <div class="mb-6">
                    <label for="register-group" class="block text-gray-700 text-sm font-bold mb-2">Group</label>
                    <select id="register-group" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-3 px-4">
                    </select>
                </div>
                <p id="register-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                <p id="register-success" class="text-green-600 text-sm italic mb-4 hidden">Your request has be
en sent for approval!</p>
                <button type="submit" class="w-full btn btn-primary">Send Request</button>
                 <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? <a href="#" id="show-login" class="theme-link hover:underline">Sign In</a>
                </p>
            </form>
        </div>
        <!-- [MODIFICATION] Install PWA button moved here and restyled -->
        <div class="mt-6 text-center">
            <button id="install-pwa-button" class="btn btn-primary" style="display: none;">
                Install App
            </button>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden max-w-[98%] mx-auto p-3 sm:p-4 lg:p-6">
        <header class="flex justify-between items-center mb-6 pb-4 border-b">
            <div class="flex flex-col items-start">
                  <!-- ================================================================== -->
                  <!-- מיקום 2: מסך האפליקציה                                                -->
                  <!-- שנה את הערך "h-12" כדי לשלוט בגובה הלוגו. למשל: h-10, h-14, h-16 -->
                  <!-- ================================================================== -->
                  <svg class="samsung-logo-svg h-12" viewBox="0 0 837.6507 222.51334" xmlns="http://www.w3.org/2000/svg">
                    <g transform="matrix(1.3333333,0,0,-1.3333333,0,222.51333)">
                        <g transform="translate(558.9328,88.5098)">
                            <path d="m 0,0 v -11.358 h 7.982 v -11.269 c 0.025,-1.007 -0.03,-2.093 -0.203,-2.962 -0.317,-2.102 -2.314,-5.681 -7.98,-5.681 -5.632,0 -7.593,3.579 -7.933,5.681 -0.143,0.869 -0.204,1.955 -0.204,2.962 v 35.593 c 0,1.259 0.085,2.637 0.352,3.68 0.387,1.897 2.068,5.638 7.743,5.638 5.957,0 7.444,-3.944 7.785,-5.638 0.224,-1.122 0.237,-3.004 0.237,-3.004 V 9.32 h 19.613 v 2.555 c 0,0 0.089,2.666 -0.149,5.154 C 25.769,31.638 13.732,36.26 -0.07,36.26 c -13.827,0 -25.62,-4.665 -27.338,-19.231 -0.155,-1.332 -0.392,-3.728 -0.392,-5.154 v -32.742 c 0,-1.426 0.046,-2.53 0.31,-5.136 1.28,-14.207 13.593,-19.243 27.365,-19.243 13.857,0 26.085,5.036 27.387,19.243 0.231,2.606 0.255,3.71 0.286,5.136 V 0 Z m -135.235,34.165 h -19.696 v -57.613 c 0.031,-1.004 0,-2.132 -0.173,-2.959 -0.411,-1.934 -2.05,-5.656 -7.484,-5.656 -5.364,0 -7.046,3.722 -7.426,5.656 -0.197,0.827 -0.222,1.955 -0.197,2.959 v 57.613 h -19.69 V -21.66 c -0.025,-1.439 0.088,-4.379 0.173,-5.149 1.359,-14.547 12.824,-19.27 27.14,-19.27 14.344,0 25.802,4.723 27.186,19.27 0.109,0.77 0.252,3.71 0.167,5.149 z m -180.97,0 -9.825,-60.876 -9.819,60.876 h -31.771 l -1.685,-77.878 h 19.464 l 0.527,72.094 13.392,-72.094 h 19.748 l 13.404,72.094 0.529,-72.094 h 19.513 l -1.742,77.878 z m -117.631,0 -14.426,-77.878 h 21.037 l 10.871,72.094 10.61,-72.094 h 20.891 l -14.366,77.878 z m 367.435,-62.701 -18.34,62.701 h -28.9 v -77.066 h 19.118 l -1.11,64.707 19.696,-64.707 h 27.717 v 77.066 h -19.243 z m -176.838,42.433 c -0.346,1.538 -0.246,3.172 -0.067,4.026 0.557,2.493 2.232,5.212 7.058,5.212 4.498,0 7.135,-2.804 7.135,-7.012 v -4.762 h 19.2 v 5.428 c 0,16.78 -15.044,19.416 -25.936,19.416 -13.718,0 -24.921,-4.522 -26.967,-17.148 -0.541,-3.436 -0.675,-6.486 0.186,-10.378 3.336,-15.743 30.743,-20.31 34.721,-30.266 0.702,-1.886 0.501,-4.291 0.143,-5.708 -0.596,-2.591 -2.339,-5.197 -7.506,-5.197 -4.846,0 -7.763,2.786 -7.763,6.985 l -0.006,7.474 h -20.666 v -5.941 c 0,-17.215 13.484,-22.409 28.007,-22.409 13.909,0 25.397,4.753 27.24,17.637 0.879,6.657 0.216,10.993 -0.137,12.626 -3.22,16.147 -32.431,21.004 -34.642,30.017 m -253.273,0.191 c -0.377,1.57 -0.289,3.227 -0.079,4.091 0.532,2.481 2.217,5.248 7.128,5.248 4.555,0 7.237,-2.831 7.237,-7.073 v -4.82 h 19.425 v 5.471 c 0,16.941 -15.274,19.641 -26.285,19.641 -13.833,0 -25.136,-4.592 -27.204,-17.309 -0.566,-3.491 -0.663,-6.562 0.155,-10.497 3.372,-15.922 31.05,-20.526 35.077,-30.601 0.754,-1.873 0.526,-4.278 0.152,-5.75 -0.639,-2.618 -2.396,-5.261 -7.606,-5.261 -4.865,0 -7.775,2.834 -7.775,7.091 l -0.027,7.494 h -20.898 v -5.955 c 0,-17.412 13.675,-22.648 28.311,-22.648 14.071,0 25.626,4.795 27.511,17.828 0.937,6.718 0.234,11.09 -0.082,12.748 -3.287,16.345 -32.823,21.186 -35.04,30.302" />
                        </g>
                    </g>
                </svg>
                <!-- [MODIFICATION] Added left padding to visually align with SVG above -->
                <p class="animated-gradient-text text-md font-bold tracking-widest -mt-1 pl-3"> R&D CENTER ISRAEL</p>
            </div>
            <div class="flex items-center space-x-4">
                <button id="logout-button" class="text-sm font-medium text-gray-600 hover:text-red-600 transition duration-150 ease-in-out">Logout</button>
            </div>
        </header>
        
        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-200">
            <nav id="main-nav" class="relative flex space-x-2 sm:space-x-4 overflow-x-auto pb-2 -mb-2">
                <div id="active-tab-indicator"></div>
                <button id="tab-profile" class="tab-btn relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 hover:text-gray-700">
                    My Profile
                </button>
                <button id="tab-update" class="tab-btn relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 hover:text-gray-700">
                    Update Week
                </button>
                <button id="tab-display" class="tab-btn active relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 hover:text-gray-700">
                    Team View
                </button>
                 <button id="tab-statistics" class="tab-btn hidden relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 hover:text-gray-700">
                    Statistics
                </button>
                <button id="tab-tl-tools" class="tab-btn hidden relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 hover:text-gray-700">
                    TL Tools
                    <span id="tl-notification-dot" class="absolute top-2 right-2 h-2.5 w-2.5 rounded-full bg-red-500 hidden"></span>
                </button>
                <!-- Super Admin Tab -->
                 <button id="tab-super-admin" class="tab-btn hidden relative z-10 whitespace-nowrap py-3 px-4 font-medium text-sm text-gray-500 hover:text-gray-700">
                    Super Admin
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- Profile Content -->
            <div id="content-profile" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Employee Information</h2>
                        <form id="profile-form">
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label for="full-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="full-name" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="email" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                </div>
                                <div>
                                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                                    <input type="text" id="username" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                    <p class="mt-2 text-xs text-gray-500">Must be unique, no spaces allowed.</p>
                                    <p id="username-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                                </div>
                                <div>
                                    <label for="group" class="block text-sm font-medium text-gray-700">Group</label>
                                      <div class="flex items-center space-x-2 mt-1">
                                           <select id="group" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3"></select>
                                           <button type="button" id="manage-groups-btn" class="hidden p-2 rounded-md bg-gray-200 hover:bg-gray-300">
                                               <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                                           </button>
                                       </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Role</label>
                                    <p id="role-display" class="mt-1 text-md font-semibold text-gray-900"></p>
                                </div>
                            </div>
                            <div class="mt-8 flex items-center">
                                <button type="submit" class="btn btn-primary">Save Profile</button>
                                <div id="profile-success-animation" class="success-animation-container">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                        <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                        <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                        <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                    </svg>
                                </div>
                            </div>
                        </form>
                    </div>
                      <!-- [MODIFICATION 2] Right card is now "Settings" -->
                       <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold text-gray-900 mb-8">Settings</h2>
                            
                            <!-- Dark Mode Toggle -->
                            <div class="flex justify-between items-center">
                                <div>
                                    <label for="dark-mode-toggle" class="block text-sm font-medium text-gray-700">Dark Mode</label>
                                    <p class="text-xs text-gray-500">Toggle to switch themes</p>
                                </div>
                                <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" id="dark-mode-toggle" class="sr-only peer">
                                    <!-- Apple-style toggle with gradient -->
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-gradient-to-r from-pink-400 via-purple-400 to-green-400"></div>
                                </label>
                            </div>

                            <!-- Divider and Change Password Section -->
                            <div class="mt-8 pt-8 border-t">
                                 <h3 class="text-lg font-bold text-gray-900 mb-6">Change Password</h3>
                                <form id="change-password-form">
                                    <div class="grid grid-cols-1 gap-6">
                                        <div>
                                            <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                                            <input type="password" id="new-password" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                        </div>
                                        <div>
                                            <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                                            <input type="password" id="confirm-new-password" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3" required>
                                        </div>
                                    </div>
                                     <p id="password-change-error" class="text-red-500 text-xs italic mt-4 hidden"></p>
                                    <div class="mt-8 flex items-center">
                                        <button type="submit" class="btn btn-primary">Change Password</button>
                                        <div id="password-change-success-animation" class="success-animation-container">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                                <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                                <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                                <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                            </svg>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Update Week Content -->
            <div id="content-update" class="tab-content hidden">
                <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                    <div class="flex items-center justify-center space-x-2 sm:space-x-4">
                        <button id="update-view-prev-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div class="text-center">
                            <h2 id="update-week-main-title" class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Weekly Attendance</h2>
                            <p id="week-dates-title" class="text-sm sm:text-md text-gray-500">Loading...</p>
                        </div>
                        <button id="update-view-next-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <form id="attendance-form" class="mt-6">
                        <div id="attendance-days-container" class="space-y-4">
                        </div>
                        <div class="mt-8 flex items-center">
                            <button type="submit" class="btn btn-primary">Save Week</button>
                            <div id="week-success-animation" class="success-animation-container">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                    <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                    <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                    <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                </svg>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Team View Content -->
            <div id="content-display" class="tab-content">
                 <div class="bg-white dark:bg-transparent p-4 sm:p-6 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                         <div class="flex items-center justify-center sm:justify-start space-x-2 sm:space-x-4">
                            <button id="team-view-prev-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <div class="text-center sm:text-left">
                                <h2 id="team-view-main-title" class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Team View</h2>
                                <p id="team-week-dates-title" class="text-sm sm:text-md text-gray-500">Loading...</p>
                            </div>
                            <button id="team-view-next-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div class="flex items-center justify-center">
                            <label for="group-filter" class="block text-sm font-medium text-gray-700 mr-3 whitespace-nowrap">Group:</label>
                            <select id="group-filter" class="form-input block w-full max-w-xs border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </select>
                        </div>
                    </div>
                    <div id="team-view-container" class="overflow-x-auto mt-6">
                    </div>
                </div>
            </div>

            <!-- Statistics Content -->
            <div id="content-statistics" class="tab-content hidden">
                 <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                         <div class="flex items-center justify-center sm:justify-start space-x-2 sm:space-x-4">
                            <button id="stats-view-prev-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <div class="text-center sm:text-left">
                                <h2 id="statistics-main-title" class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Statistics</h2>
                                <p id="stats-week-dates-title" class="text-sm sm:text-md text-gray-500">Loading...</p>
                            </div>
                            <button id="stats-view-next-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                            <div>
                                <label for="stats-group-filter" class="block text-sm font-medium text-gray-700 mb-1">Group:</label>
                                <select id="stats-group-filter" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                                     </select>
                            </div>
                            <div>
                                <label for="stats-employee-filter" class="block text-sm font-medium text-gray-700 mb-1">Employee:</label>
                                <select id="stats-employee-filter" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                                     </select>
                            </div>
                            <div class="flex flex-col sm:flex-row items-center gap-3">
                                
                                <div class="flex items-center bg-white dark:bg-gray-800 shadow-sm border border-gray-300 dark:border-gray-600 p-1" style="border-radius: 12px !important;">
                                    
                                    <button id="prev-month-btn" class="p-2 rounded-lg hover:text-violet-700 hover:bg-violet-50 dark:hover:bg-gray-700 transition focus:outline-none" style="color: #4b5563 !important;">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                                    </button>
                                    
                                    <span id="export-month-text" class="px-2 text-sm font-extrabold min-w-[150px] text-center select-none tracking-wide" style="color: #111827 !important;">
                                        November 2025
                                    </span>

                                    <button id="next-month-btn" class="p-2 rounded-lg hover:text-violet-700 hover:bg-violet-50 dark:hover:bg-gray-700 transition focus:outline-none" style="color: #4b5563 !important;">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                                    </button>
                                </div>

                                <button id="export-stats-pdf-btn" class="group relative flex items-center gap-2 px-6 py-2.5 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 text-white text-sm font-bold shadow-md hover:shadow-lg hover:shadow-purple-500/30 transition-all duration-300 transform hover:-translate-y-0.5 overflow-hidden" style="border-radius: 12px !important;">
                                    <div class="absolute inset-0 bg-white/20 group-hover:translate-x-full transition-transform duration-700 ease-in-out -translate-x-full skew-x-12"></div>
                                    <svg class="w-4 h-4 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    <span class="relative z-10">Export Report</span>
                                </button>

                            </div>
                        </div>
                    </div>
                    <div id="statistics-container" class="mt-8">
                    </div>
                 </div>
            </div>

            <!-- TL Tools Content -->
            <div id="content-tl-tools" class="tab-content hidden">
                 <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Pending Registrations</h2>
                        <div id="pending-actions-container" class="hidden">
                            <!-- Bulk action buttons will be injected here by JS -->
                        </div>
                    </div>
                    <div id="pending-users-container">
                        <p class="text-gray-500">Loading pending requests...</p>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent my-8"></div>

                 <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Bulk Attendance Update</h2>
                    <p class="text-sm text-gray-600 mb-6">Set a status for all employees on a specific day of a chosen week.</p>
                     <div class="flex items-center justify-center space-x-2 sm:space-x-4 mb-6">
                        <button id="tl-view-prev-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div class="text-center">
                            <h3 id="tl-week-dates-title" class="text-lg font-semibold text-gray-800">Loading...</h3>
                        </div>
                        <button id="tl-view-next-week" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <form id="tl-form">
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="tl-day" class="block text-sm font-medium text-gray-700">Day of Week</label>
                                <select id="tl-day" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                                </select>
                            </div>
                            <div>
                                <label for="tl-group-filter" class="block text-sm font-medium text-gray-700">Target Group</label>
                                <select id="tl-group-filter" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                                    <option value="all">All Groups</option>
                                </select>
                            </div>
                             <div>
                                <label for="tl-status-select" class="block text-sm font-medium text-gray-700">Set Status To</label>
                                <select id="tl-status-select" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">
                                 </select>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button id="bulk-update-btn" type="submit" class="btn btn-danger">Update All Employees</button>
                        </div>
                    </form>
                </div>

                <!-- Divider -->
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent my-8"></div>

                <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Create New User</h2>
                    <p class="text-sm text-gray-600 mb-6">Create a new employee profile. The default password will be <span class="font-mono bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-2 py-1 rounded">123456</span>.</p>
                    <form id="create-user-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="new-user-fullname" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="new-user-fullname" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                            <div>
                                <label for="new-user-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" id="new-user-email" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                            </div>
                             <div class="md:col-span-2">
                                <label for="new-user-group" class="block text-sm font-medium text-gray-700">Group</label>
                                <select id="new-user-group" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                                     </select>
                            </div>
                        </div>
                         <p id="create-user-error" class="text-red-500 text-xs italic mt-4 hidden"></p>
                        <div class="mt-8 flex items-center">
                            <button type="submit" class="btn btn-primary">Create User</button>
                            <div id="create-user-success-animation" class="success-animation-container">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                    <circle class="circle-bg" cx="26" cy="26" r="24"/>
                                    <circle class="circle-progress" cx="26" cy="26" r="24"/>
                                    <path class="checkmark" transform="rotate(90 26 26)" d="M16 26l7 7 14-14"/>
                                </svg>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Divider -->
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent my-8"></div>

                <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Remove User</h2>
                    <p class="text-sm text-gray-600 mb-6">Select a user to permanently remove them from the system. This will delete their profile and all attendance records.</p>
                    <form id="remove-user-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="remove-user-group-filter" class="block text-sm font-medium text-gray-700">Filter by Group</label>
                                <select id="remove-user-group-filter" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm"></select>
                            </div>
                            <div>
                                <label for="remove-user-select" class="block text-sm font-medium text-gray-700">Select User to Remove</label>
                                <select id="remove-user-select" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                                    <option value="">-- Select a user --</option>
                                </select>
                            </div>
                        </div>
                        <p id="remove-user-error" class="text-red-500 text-xs italic mt-4 hidden"></p>
                        <div class="mt-8">
                            <button type="submit" class="btn btn-danger">Remove User</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Super Admin Content -->
            <div id="content-super-admin" class="tab-content hidden">
                <div class="bg-white dark:bg-transparent p-6 sm:p-8 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">User Management</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <input type="text" id="user-search-input" class="form-input block w-full md:w-1/3 border-gray-300 rounded-lg shadow-sm" placeholder="Search by name or email...">
                        <select id="user-group-filter" class="form-input block w-full md:w-1/4 border-gray-300 rounded-lg shadow-sm">
                            <option value="all">All Groups</option>
                        </select>
                    </div>
                    <div id="user-management-container" class="overflow-x-auto">
                        <p class="text-gray-500">Loading users...</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="modal-overlay hidden z-[1001]">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4" id="modal-title">Confirm Action</h3>
            <p id="modal-body" class="mb-6 text-gray-700">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="modal-confirm" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="edit-employee-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4" id="edit-modal-title">Edit Attendance</h3>
            <div id="edit-modal-body" class="space-y-4">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="edit-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="edit-modal-save" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="reauth-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Confirm Your Identity</h3>
            <p class="mb-4 text-gray-700">To change your email address, please enter your current password.</p>
            <form id="reauth-form">
                <label for="reauth-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                <input type="password" id="reauth-password" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                 <p id="reauth-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="reauth-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="manage-groups-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Manage Groups</h3>
            <p id="manage-groups-error" class="bg-red-100 text-red-700 p-3 rounded-md text-sm mb-4 hidden"></p>
            <div id="manage-groups-list" class="my-4 max-h-60 overflow-y-auto space-y-2">
             </div>
             <form id="add-group-form" class="mt-6 border-t pt-4">
                <label for="new-group-name" class="block text-sm font-medium text-gray-700">Add New Group</label>
                <div class="flex items-center space-x-2 mt-1">
                    <input type="text" id="new-group-name" class="form-input block w-full border-gray-300 rounded-lg shadow-sm" required>
                    <button type="submit" class="btn btn-primary px-4 py-2">Add</button>
                </div>
                <p id="add-group-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
            </form>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="manage-groups-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Super Admin Edit User Modal -->
    <div id="super-admin-edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4" id="sa-modal-title">Edit User</h3>
            <form id="super-admin-edit-form">
                <div class="space-y-4">
                    <div>
                        <label for="sa-edit-fullname" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="sa-edit-fullname" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                    </div>
                     <div>
                        <div class="flex justify-between items-center">
                            <label for="sa-edit-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <button type="button" id="sa-email-info-btn">
                                <svg class="w-5 h-5 text-gray-400 hover:text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                                </svg>
                            </button>
                        </div>
                        <input type="email" id="sa-edit-email" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed dark:bg-gray-600" readonly>
                    </div>
                     <div>
                        <label for="sa-edit-group" class="block text-sm font-medium text-gray-700">Group</label>
                        <select id="sa-edit-group" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Role</label>
                        <div class="mt-2 space-y-2">
                             <div class="flex items-center">
                                <input id="sa-role-employee" name="sa-role" type="radio" value="employee" class="h-4 w-4 text-violet-600 border-gray-300 focus:ring-violet-500">
                                <label for="sa-role-employee" class="ml-3 block text-sm font-medium text-gray-700">Employee</label>
                            </div>
                            <div class="flex items-center">
                                <input id="sa-role-tl" name="sa-role" type="radio" value="tl" class="h-4 w-4 text-violet-600 border-gray-300 focus:ring-violet-500">
                                <label for="sa-role-tl" class="ml-3 block text-sm font-medium text-gray-700">Team Leader</label>
                            </div>
                             <div class="flex items-center">
                                <input id="sa-role-superadmin" name="sa-role" type="radio" value="superadmin" class="h-4 w-4 text-violet-600 border-gray-300 focus:ring-violet-500">
                                <label for="sa-role-superadmin" class="ml-3 block text-sm font-medium text-gray-700">Super Admin</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="super-admin-edit-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Reset Password</h3>
            <p class="mb-4 text-gray-700">Enter your email address and we'll send you a link to reset your password.</p>
            <form id="forgot-password-form">
                <label for="forgot-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="forgot-email" class="form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm" required>
                 <p id="forgot-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                 <p id="forgot-success" class="text-green-600 text-sm mt-4 hidden"></p>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="forgot-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        /*
        =============================================================================
        ACTION REQUIRED: FIREBASE SECURITY RULES UPDATE
        =============================================================================

        To allow users who are not logged in to see the list of available groups
        during registration, the `config` collection needs to be readable by everyone.

        HOW TO FIX:
        1. Go to your Firebase project.
        2. In the left menu, go to Build -> Firestore Database.
        3. Click the "Rules" tab at the top.
        4. Add/Update the following rule blocks inside the main `match /databases/{database}/documents { ... }` block:

        // Update your existing config rule to look like this
        match /config/{docId} {
            allow read: if true; // Allows group list on registration page
            allow write: if isSuperAdmin() || isTL();
        }

        5. Click "Publish". This allows anyone to see the group list.
        */
        
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, updatePassword, EmailAuthProvider, reauthenticateWithCredential, updateEmail, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, Timestamp, deleteDoc, writeBatch, updateDoc, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDzYoBxIWBh2TVN9HrdP8mq4zVPOkyZU2o",
            authDomain: "attendance-samsung.firebaseapp.com",
            projectId: "attendance-samsung",
            storageBucket: "attendance-samsung.firebasestorage.app",
            messagingSenderId: "358353821443",
            appId: "1:358353821443:web:32a65c3b8199542c1b5336",
            measurementId: "G-KLRM1EDLE5"
        };

        const app = initializeApp(firebaseConfig, "PRIMARY");
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Explicitly set persistence to 'local' to remember the user across browser sessions.
        setPersistence(auth, browserLocalPersistence);

        // --- Global State ---
        let currentUser = null;
        let currentUserProfile = null;
        let currentDate = new Date(); // This will be updated by getEffectiveCurrentDate
        let tlToolDate = new Date();
        let availableGroups = ["Management", "CIS1", "CIS2", "Application", "DT", "DV", "FW"];
        const ATTENDANCE_OPTIONS = ["Office", "Home-full", "Half day off", "Day off", "Sick", "Reserved duty", "Team event", "Holiday", "Business trip", "Vacation", "University", "Conference", "Maternity leave"];
        let allUsersCache = []; // Cache for user management panel
        let pendingUsersSnapshot = null; // Cache for pending users
        
        // Realtime listeners cleanup functions
        let teamViewUnsubscribe = null;
        let updateWeekUnsubscribe = null;
        let statisticsUnsubscribe = null;
        let pendingUsersUnsubscribe = null;


        // --- [חדש] לוגיקה עבור אפקט הטאבים ---
        const tabClickState = {};
        const nav = document.getElementById('main-nav');

        // אתחול אובייקט המצב עבור כל הטאבים
        nav.querySelectorAll('.tab-btn').forEach(tab => {
            tabClickState[tab.id] = {
                count: 0,
                lastClickTime: 0,
                heat: 0, // 'חום' הלחיצות, בין 0 ל-1
                cooldownTimer: null
            };
        });
        
        // פונקציה ליצירת חלקיקי ניצוצות
        function createSparkles(e, heat) {
            const tab = e.target;
            const rect = tab.getBoundingClientRect();
            const originX = rect.left + rect.width / 2;
            const originY = rect.top + rect.height / 2;
            
            const particleCount = 2 + Math.floor(heat * 15);

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('sparkle-particle');
                document.body.appendChild(particle);

                const angle = Math.random() * 2 * Math.PI;
                const distance = 50 + Math.random() * 80 * heat;
                const size = 3 + Math.random() * 5;
                const hue = 300 + (Math.random() * 120); // Pink to Red to Yellow

                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.background = `hsl(${hue}, 100%, 70%)`;
                particle.style.left = `${originX}px`;
                particle.style.top = `${originY}px`;
                
                // Trigger animation
                requestAnimationFrame(() => {
                    const finalX = Math.cos(angle) * distance;
                    const finalY = Math.sin(angle) * distance;
                    particle.style.transform = `translate(${finalX}px, ${finalY}px) scale(0)`;
                    particle.style.opacity = '0';
                });
                
                // Remove particle after animation
                setTimeout(() => {
                    particle.remove();
                }, 800);
            }
        }
        
        // פונקציה שמתחילה את תהליך ה"קירור" של הטאב
        function startCooldown(tab) {
            const state = tabClickState[tab.id];
            if (state.cooldownTimer) cancelAnimationFrame(state.cooldownTimer);
            
            const cool = () => {
                if (state.heat > 0) {
                    state.heat -= 0.01; // קצב הקירור
                    updateTabStyle(tab);
                    state.cooldownTimer = requestAnimationFrame(cool);
                } else {
                    state.heat = 0;
                    updateTabStyle(tab); // ודא שהצבע חזר למקורי
                    cancelAnimationFrame(state.cooldownTimer);
                }
            };
            state.cooldownTimer = requestAnimationFrame(cool);
        }

        // פונקציה שמעדכנת את סגנון הטאב (צבע ופעימה)
        function updateTabStyle(tab) {
            const state = tabClickState[tab.id];
            const heat = Math.max(0, Math.min(1, state.heat)); // הגבלת הערך בין 0 ל-1

            // עדכון צבע - אינטרפולציה בין סגול/ורוד לאדום
            const startColor = { r: 168, g: 85, b: 247 }; // #a855f7
            const endColor = { r: 236, g: 72, b: 153 }; // #ec4899
            const hotColor = { r: 239, g: 68, b: 68 }; // #ef4444 (red-500)

            const r1 = startColor.r * (1 - heat) + hotColor.r * heat;
            const g1 = startColor.g * (1 - heat) + hotColor.g * heat;
            const b1 = startColor.b * (1 - heat) + hotColor.b * heat;
            
            const r2 = endColor.r * (1 - heat) + hotColor.r * heat;
            const g2 = endColor.g * (1 - heat) + hotColor.g * heat;
            const b2 = endColor.b * (1 - heat) + hotColor.b * heat;

            tab.style.setProperty('--tab-active-start', `rgb(${r1}, ${g1}, ${b1})`);
            tab.style.setProperty('--tab-active-end', `rgb(${r2}, ${g2}, ${b2})`);
            
            // עדכון פעימה
            const pulseScale = 1 + Math.min(state.count * 0.01, 0.08) + heat * 0.05;
            tab.style.transform = `scale(${pulseScale})`;
            setTimeout(() => {
                if(tab.style) tab.style.transform = 'scale(1)';
            }, 100);
        }
        
        // מאזין אירועים ראשי לניווט
        nav.addEventListener('click', (e) => {
            const tab = e.target.closest('.tab-btn');
            if (!tab) return;
            
            const state = tabClickState[tab.id];
            if (!state) return;

            const now = Date.now();
            const timeDiff = now - state.lastClickTime;
            
            if (timeDiff > 800) { // אם עבר הרבה זמן, אפס את הספירה והחום
                state.count = 0;
                state.heat = 0;
            }

            state.count++;
            state.lastClickTime = now;
            
            // הגברת ה'חום' בהתבסס על מהירות הלחיצה
            const heatIncrease = (500 - Math.min(timeDiff, 500)) / 500 * 0.2;
            state.heat = Math.min(1, state.heat + heatIncrease);

            if (state.cooldownTimer) cancelAnimationFrame(state.cooldownTimer);
            
            // הפעל את האפקטים
            updateTabStyle(tab);
            
            if (state.count > 10) {
                createSparkles(e, state.heat);
            }
            
            // התחל טיימר לקירור אם המשתמש יפסיק ללחוץ
            setTimeout(() => startCooldown(tab), 1000);
        });
        // --- סוף הלוגיקה החדשה ---


        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Forms
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const profileForm = document.getElementById('profile-form');
        const attendanceForm = document.getElementById('attendance-form');
        const tlForm = document.getElementById('tl-form');
        const createUserForm = document.getElementById('create-user-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const addGroupForm = document.getElementById('add-group-form');
        const removeUserForm = document.getElementById('remove-user-form');
        const superAdminEditForm = document.getElementById('super-admin-edit-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');

        // Buttons & Links
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const showAboutLink = document.getElementById('show-about');
        const showForgotPasswordLink = document.getElementById('show-forgot-password');
        const aboutContent = document.getElementById('about-content');
        const logoutButton = document.getElementById('logout-button');
        const bulkUpdateButton = document.getElementById('bulk-update-btn');
        const manageGroupsBtn = document.getElementById('manage-groups-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // Containers
        const userManagementContainer = document.getElementById('user-management-container');


        // Filters
        const groupFilter = document.getElementById('group-filter');
        const statsGroupFilter = document.getElementById('stats-group-filter');
        const statsEmployeeFilter = document.getElementById('stats-employee-filter');

        // Month navigation for PDF export
        const now = new Date();
        let currentExportMonthIndex = 0;
        const availableMonths = [];
        
        // Generate 12 months
        for (let i = 0; i < 12; i++) {
            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            availableMonths.push({
                value: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                text: date.toLocaleString('en-US', { month: 'long', year: 'numeric' })
            });
        }
        
        // Update the display
        function updateExportMonthDisplay() {
            const monthText = document.getElementById('export-month-text');
            const monthContainer = monthText.parentElement;
            monthText.textContent = availableMonths[currentExportMonthIndex].text;
            
            // Check if we're on current month (index 0 is current month)
            const isCurrentMonth = currentExportMonthIndex === 0;
            
            if (isCurrentMonth) {
                // Remove gradient and pulse effects
                monthContainer.classList.remove('return-to-today-btn', 'animated-gradient-text');
                monthContainer.style.cursor = 'default';
            } else {
                // Add gradient and pulse effects
                monthContainer.classList.add('return-to-today-btn', 'animated-gradient-text');
                monthContainer.style.cursor = 'pointer';
            }
            
            // Disable/enable buttons at boundaries
            document.getElementById('prev-month-btn').disabled = (currentExportMonthIndex === availableMonths.length - 1);
            document.getElementById('next-month-btn').disabled = (currentExportMonthIndex === 0);
        }
        
        updateExportMonthDisplay();
        
        // Add click handler to return to current month
        document.getElementById('export-month-text').parentElement.addEventListener('click', (e) => {
            // Only respond if we're not on current month
            if (currentExportMonthIndex !== 0) {
                currentExportMonthIndex = 0;
                updateExportMonthDisplay();
            }
        });
        
        // Previous month button
        document.getElementById('prev-month-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentExportMonthIndex < availableMonths.length - 1) {
                currentExportMonthIndex++;
                updateExportMonthDisplay();
            }
        });
        
        // Next month button
        document.getElementById('next-month-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentExportMonthIndex > 0) {
                currentExportMonthIndex--;
                updateExportMonthDisplay();
            }
        });
        
        // Export button
        document.getElementById('export-stats-pdf-btn').addEventListener('click', async (e) => {
            e.stopPropagation();
            const selectedMonth = availableMonths[currentExportMonthIndex];
            await exportPDFForMonth(selectedMonth.value, selectedMonth.text);
        });
        const removeUserGroupFilter = document.getElementById('remove-user-group-filter');
        const removeUserSelect = document.getElementById('remove-user-select');
        const userSearchInput = document.getElementById('user-search-input');
        const userGroupFilter = document.getElementById('user-group-filter');

        // Week Nav Buttons
        const teamViewPrevWeekBtn = document.getElementById('team-view-prev-week');
        const teamViewNextWeekBtn = document.getElementById('team-view-next-week');
        const updateViewPrevWeekBtn = document.getElementById('update-view-prev-week');
        const updateViewNextWeekBtn = document.getElementById('update-view-next-week');
        const statsViewPrevWeekBtn = document.getElementById('stats-view-prev-week');
        const statsViewNextWeekBtn = document.getElementById('stats-view-next-week');
        const tlViewPrevWeekBtn = document.getElementById('tl-view-prev-week');
        const tlViewNextWeekBtn = document.getElementById('tl-view-next-week');


        // Modals
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        
        const editEmployeeModal = document.getElementById('edit-employee-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editModalBody = document.getElementById('edit-modal-body');
        const editModalCancel = document.getElementById('edit-modal-cancel');
        const editModalSave = document.getElementById('edit-modal-save');

        const reauthModal = document.getElementById('reauth-modal');
        const reauthForm = document.getElementById('reauth-form');
        const reauthCancel = document.getElementById('reauth-cancel');
        const reauthError = document.getElementById('reauth-error');

        const manageGroupsModal = document.getElementById('manage-groups-modal');
        const manageGroupsClose = document.getElementById('manage-groups-close');
        const addGroupError = document.getElementById('add-group-error');
        const manageGroupsError = document.getElementById('manage-groups-error');
        const manageGroupsList = document.getElementById('manage-groups-list');
        
        const superAdminEditModal = document.getElementById('super-admin-edit-modal');
        const superAdminEditCancel = document.getElementById('super-admin-edit-cancel');

        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const forgotCancelBtn = document.getElementById('forgot-cancel');
        const forgotError = document.getElementById('forgot-error');
        const forgotSuccess = document.getElementById('forgot-success');


        // Error/Success Messages
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const registerSuccess = document.getElementById('register-success');
        const createUserError = document.getElementById('create-user-error');
        const passwordChangeError = document.getElementById('password-change-error');
        const usernameError = document.getElementById('username-error');
        const profileSuccessAnimation = document.getElementById('profile-success-animation');
        const weekSuccessAnimation = document.getElementById('week-success-animation');
        const passwordChangeSuccessAnimation = document.getElementById('password-change-success-animation');
        const createUserSuccessAnimation = document.getElementById('create-user-success-animation');

        // Track whether Statistics tab has been visited
        let statisticsTabVisited = false;

        // Tabs
        const tabs = {
            profile: document.getElementById('tab-profile'),
            update: document.getElementById('tab-update'),
            display: document.getElementById('tab-display'),
            statistics: document.getElementById('tab-statistics'),
            tlTools: document.getElementById('tab-tl-tools'),
            superAdmin: document.getElementById('tab-super-admin'),
        };
        const contents = {
            profile: document.getElementById('content-profile'),
            update: document.getElementById('content-update'),
            display: document.getElementById('content-display'),
            statistics: document.getElementById('content-statistics'),
            tlTools: document.getElementById('content-tl-tools'),
            superAdmin: document.getElementById('content-super-admin'),
        };
        
        // --- Helper Functions ---
        function showSuccessAnimation(element) {
            if (!element) return;
            element.classList.remove('show');
            // A trick to restart the CSS animation.
            void element.offsetWidth; 
            element.classList.add('show');

            // Hide after some time
            setTimeout(() => {
                element.classList.remove('show');
            }, 3000);
        }

        function hideAllMessages() {
            loginError.classList.add('hidden');
            registerError.classList.add('hidden');
            registerSuccess.classList.add('hidden');
            createUserError.classList.add('hidden');
            passwordChangeError.classList.add('hidden');
            usernameError.classList.add('hidden');
            forgotError.classList.add('hidden');
            forgotSuccess.classList.add('hidden');
            profileSuccessAnimation.classList.remove('show');
            weekSuccessAnimation.classList.remove('show');
            passwordChangeSuccessAnimation.classList.remove('show');
            createUserSuccessAnimation.classList.remove('show');
        }

        function getStatusColorClass(status, type = 'badge') {
             const baseBadgeClasses = "px-2 py-1 text-[11px] sm:px-2.5 sm:py-1.5 sm:text-xs rounded-full font-semibold leading-none inline-block";
             const baseProgressClasses = "h-2.5 rounded-full";

            let colorClasses = {};
            switch (status) {
                case "Office":
                    colorClasses = { badge: 'bg-green-100 text-green-800', progress: 'bg-green-500' }; break;
                case "Home-full":
                    colorClasses = { badge: 'bg-blue-100 text-blue-800', progress: 'bg-blue-500' }; break;
                case "Sick": case "Day off": case "Vacation": case "Maternity leave":
                    colorClasses = { badge: 'bg-red-100 text-red-800', progress: 'bg-red-500' }; break;
                case "Half day off":
                    colorClasses = { badge: 'bg-yellow-100 text-yellow-800', progress: 'bg-yellow-500' }; break;
                case "Business trip": case "Conference": case "University":
                    colorClasses = { badge: 'bg-purple-100 text-purple-800', progress: 'bg-purple-500' }; break;
                case "Reserved duty":
                    colorClasses = { badge: 'bg-gray-200 text-gray-700', progress: 'bg-gray-500' }; break;
                case "Team event": case "Holiday":
                    colorClasses = { badge: 'bg-indigo-100 text-indigo-800', progress: 'bg-indigo-500' }; break;
                default:
                    return "text-gray-400 dark:text-gray-500"; // For '---' or other cases
            }
            return type === 'badge' ? `${baseBadgeClasses} ${colorClasses.badge}` : `${baseProgressClasses} ${colorClasses.progress}`;
        }

        // New function to determine the date to display (advances on Friday)
        function getEffectiveCurrentDate() {
            const now = new Date();
            // 5 = Friday, 6 = Saturday. In these cases, show next week.
            // If it's Friday (5) or Saturday (6), set the effective date to the upcoming Sunday
            // so the table will start on Sunday and the Sunday header can be highlighted/blinked.
            if (now.getDay() === 5) { // Friday -> add 2 days => Sunday
                now.setDate(now.getDate() + 2);
            } else if (now.getDay() === 6) { // Saturday -> add 1 day => Sunday
                now.setDate(now.getDate() + 1);
            }
            return now;
        }
        
        // --- Modal Logic ---
        let confirmCallback = null;
        function showConfirmationModal(title, body, onConfirm) {
            // [FIX] Add guard against accidental calls with no arguments to prevent showing on page load
            if (!title || !body || typeof onConfirm !== 'function') {
                console.error('showConfirmationModal was called incorrectly. Aborting.', { title, body, onConfirm });
                return;
            }
            modalTitle.textContent = title;
            modalBody.innerHTML = body.replace(/\n/g, '<br>'); // Support newlines in modal body
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }
        modalCancel.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        modalConfirm.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            if(confirmCallback) confirmCallback();
        });


        // --- Auth Logic ---
        onAuthStateChanged(auth, async (user) => {
            loadingSpinner.style.display = 'none'; // Hide spinner once auth state is known
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                currentDate = getEffectiveCurrentDate(); // Reset to current week on login
                // [MODIFICATION 4] Set TL Tool date to also be the effective date
                tlToolDate = getEffectiveCurrentDate(); 
                await loadGroups();
                currentUserProfile = await loadProfileData(user.uid);
                
                // [MODIFICATION 5] Apply dark mode based on user preference
                if (currentUserProfile && currentUserProfile.darkMode) {
                    document.documentElement.classList.add('dark');
                    darkModeToggle.checked = true;
                    updateExportMonthColors(true);
                } else {
                    document.documentElement.classList.remove('dark');
                    darkModeToggle.checked = false;
                    updateExportMonthColors(false);
                }

                setDefaultTab(); // Set the default view on login
                refreshViews();
                moveActiveIndicator(); // Position indicator on load
            } else {
                // Cleanup all realtime listeners on logout
                if (teamViewUnsubscribe) {
                    teamViewUnsubscribe();
                    teamViewUnsubscribe = null;
                }
                if (updateWeekUnsubscribe) {
                    updateWeekUnsubscribe();
                    updateWeekUnsubscribe = null;
                }
                if (statisticsUnsubscribe) {
                    statisticsUnsubscribe();
                    statisticsUnsubscribe = null;
                }
                if (pendingUsersUnsubscribe) {
                    pendingUsersUnsubscribe();
                    pendingUsersUnsubscribe = null;
                }
                
                currentUser = null;
                currentUserProfile = null;
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                document.documentElement.classList.remove('dark'); // Ensure dark mode is off on logout
                await loadGroups(); // Load groups for the registration form
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            const identifier = document.getElementById('login-identifier').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(identifier);
                let emailToLogin = identifier;

                if (!isEmail) {
                    // It's a username, find the email
                    const q = query(collection(db, "users"), where("username", "==", identifier));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        throw new Error("User with that username not found.");
                    }
                    emailToLogin = querySnapshot.docs[0].data().email;
                }
                
                await signInWithEmailAndPassword(auth, emailToLogin, password);

            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            }
        });
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            const fullName = document.getElementById('register-fullname').value;
            const email = document.getElementById('register-email').value;
            const group = document.getElementById('register-group').value;

            try {
                await addDoc(collection(db, "pendingUsers"), {
                    fullName,
                    email,
                    group,
                    status: 'pending',
                    timestamp: Timestamp.now()
                });
                registerSuccess.classList.remove('hidden');
                registerForm.reset();
            } catch (error) {
                console.error("Error sending registration request:", error);
                registerError.textContent = "Failed to send request. Please try again.";
                registerError.classList.remove('hidden');
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            aboutContent.classList.add('hidden');
            hideAllMessages();
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            aboutContent.classList.add('hidden');
            hideAllMessages();
        });

        showAboutLink.addEventListener('click', (e) => {
            e.preventDefault();
            aboutContent.classList.toggle('hidden');
        });

        showForgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordModal.classList.remove('hidden');
            hideAllMessages();
        });

        forgotCancelBtn.addEventListener('click', () => {
            forgotPasswordModal.classList.add('hidden');
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            const email = document.getElementById('forgot-email').value;
            try {
                await sendPasswordResetEmail(auth, email);
                forgotSuccess.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-gray-500 mr-2 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                        </svg>
                        <div>
                            Password reset link sent! Check your inbox.
                            <p class="text-xs text-gray-500 mt-1">
                                Also, please check your spam folder.
                            </p>
                        </div>
                    </div>`;
                forgotSuccess.classList.remove('hidden');
            } catch (error) {
                console.error("Error sending password reset email:", error);
                forgotError.textContent = "Could not send reset link. Is the email correct?";
                forgotError.classList.remove('hidden');
            }
        });


        // --- Week Navigation ---
        function navigateWeek(direction) {
            currentDate.setDate(currentDate.getDate() + 7 * direction);
            refreshViews();
        }
        
        function navigateTlToolWeek(direction) {
            tlToolDate.setDate(tlToolDate.getDate() + 7 * direction);
            setupBulkUpdateView();
        }

        function refreshViews() {
            if (currentUser) {
                // Clear cache to force fresh user data on manual refresh
                allUsersCache = [];
                setupTeamViewTab();
                setupUpdateTab(currentUser.uid);
                setupStatisticsTab();
                setupAdminTabs(); // This now handles TL and Super Admin
            }
        }
        
        function setDefaultTab() {
            Object.values(tabs).forEach(t => t && t.classList.remove('active'));
            Object.values(contents).forEach(c => c && c.classList.add('hidden'));
            
            tabs.display.classList.add('active');
            contents.display.classList.remove('hidden');
            moveActiveIndicator();
        }

        teamViewPrevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        teamViewNextWeekBtn.addEventListener('click', () => navigateWeek(1));
        updateViewPrevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        updateViewNextWeekBtn.addEventListener('click', () => navigateWeek(1));
        statsViewPrevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        statsViewNextWeekBtn.addEventListener('click', () => navigateWeek(1));
        tlViewPrevWeekBtn.addEventListener('click', () => navigateTlToolWeek(-1));
        tlViewNextWeekBtn.addEventListener('click', () => navigateTlToolWeek(1));

        // --- Tab Navigation Logic ---
        function moveActiveIndicator() {
            const activeTab = document.querySelector('.tab-btn.active');
            const indicator = document.getElementById('active-tab-indicator');
            if (activeTab && indicator) {
                indicator.style.width = `${activeTab.offsetWidth}px`;
                indicator.style.left = `${activeTab.offsetLeft}px`;
            }
        }
        window.addEventListener('resize', moveActiveIndicator);

        Object.keys(tabs).forEach(key => {
            if(tabs[key]) {
                tabs[key].addEventListener('click', () => {
                    Object.values(tabs).forEach(t => t && t.classList.remove('active'));
                    Object.values(contents).forEach(c => c && c.classList.add('hidden'));
                    
                    tabs[key].classList.add('active');
                    contents[key].classList.remove('hidden');
                    moveActiveIndicator();
                    
                    // Trigger animation for Statistics tab
                    if (key === 'statistics') {
                        statisticsTabVisited = true; // Mark as visited
                        setTimeout(() => {
                            animateProgressCircles();
                        }, 150);
                    }
                    
                    // Scroll the clicked tab into view (centered on mobile)
                    tabs[key].scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest', 
                        inline: 'center' 
                    });
                });
            }
        });

        // Function to animate progress circles in Statistics tab
        function animateProgressCircles() {
            const container = document.getElementById('statistics-container');
            if (!container) return;
            
            const circles = container.querySelectorAll('.progress-circle-fill');
            const percentages = container.querySelectorAll('.progress-circle-percentage');
            
            if (circles.length === 0) return;
            
            circles.forEach((circle, index) => {
                const targetOffset = parseFloat(circle.getAttribute('data-target-offset'));
                const circumference = 2 * Math.PI * 42;
                const targetPercentage = ((circumference - targetOffset) / circumference * 100).toFixed(1);
                
                // Reset to start position first
                circle.style.strokeDashoffset = circumference;
                if (percentages[index]) {
                    percentages[index].textContent = '0%';
                }
                
                // Small delay then animate
                setTimeout(() => {
                    // Animate the circle
                    circle.style.strokeDashoffset = targetOffset;
                    
                    // Animate the percentage text
                    let currentPercentage = 0;
                    const duration = 1200; // 1.2 seconds
                    const steps = 60;
                    const increment = parseFloat(targetPercentage) / steps;
                    const stepDuration = duration / steps;
                    
                    const intervalId = setInterval(() => {
                        currentPercentage += increment;
                        if (currentPercentage >= targetPercentage) {
                            currentPercentage = targetPercentage;
                            clearInterval(intervalId);
                        }
                        if (percentages[index]) {
                            percentages[index].textContent = Math.round(currentPercentage) + '%';
                        }
                    }, stepDuration);
                }, 50);
            });
        }

        // --- Event Listener for Group Filter ---
        // New function to handle group filter change and save preference
        async function handleGroupFilterChange() {
            if (currentUser && currentUserProfile) {
                const selectedGroup = groupFilter.value;
                // Don't save if the profile hasn't loaded yet or something is wrong
                if (currentUserProfile.teamViewFilter !== selectedGroup) {
                    try {
                        const userRef = doc(db, "users", currentUser.uid);
                        await updateDoc(userRef, { teamViewFilter: selectedGroup });
                        currentUserProfile.teamViewFilter = selectedGroup; // Update local state
                    } catch (error) {
                        console.error("Failed to save group filter preference:", error);
                    }
                }
            }
            setupTeamViewTab(); // Now, render the view
        }
        groupFilter.addEventListener('change', handleGroupFilterChange);

        statsGroupFilter.addEventListener('change', () => {
            // Reset employee filter when group changes
            statsEmployeeFilter.value = 'all';
            setupStatisticsTab();
        });
        statsEmployeeFilter.addEventListener('change', setupStatisticsTab);
        userSearchInput.addEventListener('input', renderUserManagementList);
        userGroupFilter.addEventListener('change', renderUserManagementList);

        // --- Dark Mode Logic ---
        darkModeToggle.addEventListener('change', async () => {
            if (!currentUser) return;
            const isEnabled = darkModeToggle.checked;
            document.documentElement.classList.toggle('dark', isEnabled);
            
            // Update export month text and buttons colors for dark mode
            updateExportMonthColors(isEnabled);
            
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { darkMode: isEnabled });
                currentUserProfile.darkMode = isEnabled; // Update local state
            } catch (error) {
                console.error("Failed to save dark mode preference:", error);
                // Optionally revert the toggle if save fails
                document.documentElement.classList.toggle('dark', !isEnabled);
                darkModeToggle.checked = !isEnabled;
                updateExportMonthColors(!isEnabled);
            }
        });

        // Helper function to update export month colors
        function updateExportMonthColors(isDark) {
            const exportMonthText = document.getElementById('export-month-text');
            const prevBtn = document.getElementById('prev-month-btn');
            const nextBtn = document.getElementById('next-month-btn');
            
            if (exportMonthText) {
                exportMonthText.style.setProperty('color', isDark ? '#ffffff' : '#111827', 'important');
            }
            if (prevBtn) {
                prevBtn.style.setProperty('color', isDark ? '#d1d5db' : '#4b5563', 'important');
            }
            if (nextBtn) {
                nextBtn.style.setProperty('color', isDark ? '#d1d5db' : '#4b5563', 'important');
            }
        }

        // --- Groups Logic ---
        async function loadGroups() {
            const groupsRef = doc(db, "config", "groups");
            try {
                const docSnap = await getDoc(groupsRef);
                if (docSnap.exists() && docSnap.data().names) {
                    availableGroups = docSnap.data().names;
                }
            } catch (e) {
                console.error("Could not load groups config:", e);
                 // Fallback to default list on error, which is fine
            }
            populateGroupSelects();
        }

        function populateGroupSelects() {
            const groupSelects = [
                document.getElementById('group'),
                document.getElementById('register-group'),
                document.getElementById('new-user-group'),
                document.getElementById('user-group-filter'),
                document.getElementById('sa-edit-group'),
            ];
            
            groupSelects.forEach(select => {
                if (select) {
                    const currentVal = select.value;
                    // For filters, keep the 'All Groups' option
                    if(select.id === 'user-group-filter') {
                        select.innerHTML = '<option value="all">All Groups</option>';
                    } else {
                        select.innerHTML = '';
                    }

                    availableGroups.forEach(groupName => {
                        const option = document.createElement('option');
                        option.value = groupName;
                        option.textContent = groupName;
                        select.appendChild(option);
                    });
                    if (availableGroups.includes(currentVal) || currentVal === 'all') {
                        select.value = currentVal;
                    }
                }
            });
        }
        
        function populateManageGroupsList() {
            manageGroupsList.innerHTML = ''; // Clear existing list
            manageGroupsError.classList.add('hidden');
            let draggedItemName = null;

            availableGroups.forEach((groupName, index) => {
                const groupElement = document.createElement('div');
                groupElement.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                groupElement.dataset.groupName = groupName;
                groupElement.draggable = true;

                // Drag & Drop event listeners
                groupElement.addEventListener('dragstart', e => {
                    draggedItemName = groupName;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', groupName);
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                });

                groupElement.addEventListener('dragend', e => {
                    e.target.classList.remove('dragging');
                    document.querySelectorAll('.drag-over-indicator').forEach(el => el.classList.remove('drag-over-indicator'));
                    draggedItemName = null;
                });
                
                groupElement.addEventListener('dragenter', e => {
                    if (groupName !== draggedItemName) {
                        document.querySelectorAll('.drag-over-indicator').forEach(el => el.classList.remove('drag-over-indicator'));
                        e.currentTarget.classList.add('drag-over-indicator');
                    }
                });

                groupElement.addEventListener('dragover', e => {
                    e.preventDefault(); // Necessary to allow dropping
                });


                groupElement.addEventListener('drop', e => {
                    e.preventDefault();
                    e.currentTarget.classList.remove('drag-over-indicator');
                    const targetGroupName = e.currentTarget.dataset.groupName;
                    const draggedName = e.dataTransfer.getData('text/plain');

                    if (draggedName && draggedName !== targetGroupName) {
                        const fromIndex = availableGroups.indexOf(draggedName);
                        const toIndex = availableGroups.indexOf(targetGroupName);
                        
                        if (fromIndex !== -1 && toIndex !== -1) {
                            let newOrder = [...availableGroups];
                            const [movedItem] = newOrder.splice(fromIndex, 1);
                            newOrder.splice(toIndex, 0, movedItem);
                            saveGroups(newOrder);
                        }
                    }
                });

                const leftSide = document.createElement('div');
                leftSide.className = 'flex items-center';

                const dragHandle = document.createElement('span');
                dragHandle.className = 'cursor-move mr-3 text-gray-400 hover:text-gray-600';
                dragHandle.title = 'Drag to reorder';
                dragHandle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>`;
                leftSide.appendChild(dragHandle);

                const groupText = document.createElement('span');
                groupText.textContent = groupName;
                leftSide.appendChild(groupText);
                groupElement.appendChild(leftSide);


                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'flex items-center space-x-2';

                // Up Arrow
                if (index > 0) {
                    const upBtn = document.createElement('button');
                    upBtn.title = 'Move up';
                    upBtn.innerHTML = `<svg class="w-5 h-5 text-gray-500 hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>`;
                    upBtn.onclick = () => {
                        const newOrder = [...availableGroups];
                        [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]]; // Swap
                        saveGroups(newOrder);
                    };
                    buttonsContainer.appendChild(upBtn);
                }

                // Down Arrow
                if (index < availableGroups.length - 1) {
                    const downBtn = document.createElement('button');
                    downBtn.title = 'Move down';
                    downBtn.innerHTML = `<svg class="w-5 h-5 text-gray-500 hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                    downBtn.onclick = () => {
                        const newOrder = [...availableGroups];
                        [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]]; // Swap
                        saveGroups(newOrder);
                    };
                    buttonsContainer.appendChild(downBtn);
                }

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg class="w-5 h-5 text-red-500 hover:text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                deleteBtn.onclick = async () => {
                    manageGroupsError.classList.add('hidden'); // Hide previous errors
                    
                    try {
                        const q = query(collection(db, "users"), where("group", "==", groupName));
                        const querySnapshot = await getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            manageGroupsError.textContent = `Cannot delete "${groupName}" because it contains ${querySnapshot.size} member(s). Please reassign them first.`;
                            manageGroupsError.classList.remove('hidden');
                            return; // Stop execution
                        }
                        
                        // If group is empty, proceed with confirmation
                        showConfirmationModal('Delete Group', `Are you sure you want to delete the group "${groupName}"? It is empty and this action cannot be undone.`, () => {
                            const updatedGroups = availableGroups.filter(g => g !== groupName);
                            saveGroups(updatedGroups);
                        });

                    } catch (error) {
                        console.error("Error checking group members:", error);
                        manageGroupsError.textContent = "Could not verify group members. Please try again.";
                        manageGroupsError.classList.remove('hidden');
                    }
                };
                buttonsContainer.appendChild(deleteBtn);
                
                groupElement.appendChild(buttonsContainer);
                manageGroupsList.appendChild(groupElement);
            });
        }

        async function saveGroups(newGroupOrder) {
            const groupsRef = doc(db, "config", "groups");
            try {
                await setDoc(groupsRef, { names: newGroupOrder });
                availableGroups = newGroupOrder; // Update global state
                populateGroupSelects();
                populateManageGroupsList();
                refreshViews(); // Refresh main views to reflect new order
            } catch (error) {
                console.error("Error saving group order:", error);
                manageGroupsError.textContent = "Failed to save new order.";
                manageGroupsError.classList.remove('hidden');
            }
        }

        manageGroupsBtn.addEventListener('click', () => {
            populateManageGroupsList();
            manageGroupsModal.classList.remove('hidden');
        });

        manageGroupsClose.addEventListener('click', () => {
            manageGroupsModal.classList.add('hidden');
        })

        addGroupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addGroupError.classList.add('hidden');
            const newGroupName = document.getElementById('new-group-name').value;
            
            if (newGroupName && newGroupName.trim() !== '') {
                const trimmedName = newGroupName.trim();
                if (availableGroups.some(g => g.toLowerCase() === trimmedName.toLowerCase())) {
                    addGroupError.textContent = "This group already exists.";
                    addGroupError.classList.remove('hidden');
                    return;
                }
                const updatedGroups = [...availableGroups, trimmedName];
                await saveGroups(updatedGroups);
                addGroupForm.reset();
            }
        });


        // --- Profile Tab Logic ---
        async function loadProfileData(userId) {
            const userRef = doc(db, "users", userId);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('full-name').value = data.fullName || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('username').value = data.username || '';
                document.getElementById('group').value = data.group || '';
                
                let roleText = 'Employee';
                if(data.isSuperAdmin) {
                    roleText = 'Super Admin';
                } else if (data.isTL) {
                    roleText = 'Team Leader';
                }
                document.getElementById('role-display').textContent = roleText;

                return data;
            } else {
                console.log("No such profile document!");
                await signOut(auth);
                return null;
            }
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            if (!currentUser) return;

            const newEmail = document.getElementById('email').value.trim();
            const newUsername = document.getElementById('username').value.trim();

            // Validate username
            if (/\s/.test(newUsername) || newUsername.length < 3) {
                usernameError.textContent = 'Username must be at least 3 characters and contain no spaces.';
                usernameError.classList.remove('hidden');
                return;
            }
            
            // Check if username changed and if it's unique
            if (newUsername !== (currentUserProfile.username || '')) {
                const q = query(collection(db, "users"), where("username", "==", newUsername));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    usernameError.textContent = 'This username is already taken.';
                    usernameError.classList.remove('hidden');
                    return;
                }
            }

            // Check if email changed
            if (newEmail !== currentUserProfile.email) {
                showReauthModal(newEmail);
                return; // Stop here, re-auth flow will handle the rest
            }

            // If only other details changed, save directly
            saveProfileDetails();
        });

        async function saveProfileDetails(newEmail = null) {
            const userRef = doc(db, "users", currentUser.uid);
            const dataToUpdate = {
                fullName: document.getElementById('full-name').value,
                group: document.getElementById('group').value,
                username: document.getElementById('username').value.trim(),
                email: newEmail || currentUserProfile.email, // Update email if it was changed
            };

            try {
                // Use updateDoc to only change the fields in dataToUpdate
                await updateDoc(userRef, dataToUpdate);
                
                // Update local profile state
                currentUserProfile.fullName = dataToUpdate.fullName;
                currentUserProfile.group = dataToUpdate.group;
                currentUserProfile.username = dataToUpdate.username;
                if(newEmail) currentUserProfile.email = newEmail;

                showSuccessAnimation(profileSuccessAnimation);
                
                refreshViews();
            } catch (error) {
                console.error("Error updating profile: ", error);
                alert(`Failed to save profile: ${error.message}`)
            }
        }

        // Re-authentication for sensitive operations
        let emailToUpdate = '';
        function showReauthModal(newEmail) {
            emailToUpdate = newEmail;
            reauthModal.classList.remove('hidden');
            reauthError.classList.add('hidden');
            reauthForm.reset();
        }
        reauthCancel.addEventListener('click', () => reauthModal.classList.add('hidden'));

        reauthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('reauth-password').value;
            const credential = EmailAuthProvider.credential(currentUser.email, password);

            try {
                await reauthenticateWithCredential(currentUser, credential);
                await updateEmail(currentUser, emailToUpdate);
                await saveProfileDetails(emailToUpdate);
                reauthModal.classList.add('hidden');
            } catch (error) {
                console.error("Re-authentication failed: ", error);
                reauthError.textContent = `Error: ${error.message}`;
                reauthError.classList.remove('hidden');
            }
        });


        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;

            if (newPassword !== confirmPassword) {
                passwordChangeError.textContent = "Passwords do not match.";
                passwordChangeError.classList.remove('hidden');
                return;
            }
            if (newPassword.length < 6) {
                 passwordChangeError.textContent = "Password must be at least 6 characters long.";
                passwordChangeError.classList.remove('hidden');
                return;
            }

            try {
                await updatePassword(currentUser, newPassword);
                showSuccessAnimation(passwordChangeSuccessAnimation);
                changePasswordForm.reset();
            } catch (error) {
                console.error("Error changing password: ", error);
                passwordChangeError.textContent = `Error: ${error.message}`;
                passwordChangeError.classList.remove('hidden');
            }
        });

        // --- Update Week Tab Logic ---
        function getWeekId(d) {
            const date = new Date(d.getTime());
            date.setHours(0, 0, 0, 0);
            // Set to the Sunday of the current week
            date.setDate(date.getDate() - date.getDay());
            
            const year = date.getFullYear();
            // Calculate week number
            const firstDayOfYear = new Date(year, 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            const weekNo = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);

            return `${year}-W${String(weekNo).padStart(2, '0')}`;
        }

        async function setupUpdateTab(userId) {
            // Cleanup previous listener if exists
            if (updateWeekUnsubscribe) {
                updateWeekUnsubscribe();
                updateWeekUnsubscribe = null;
            }

            const weekDatesTitle = document.getElementById('week-dates-title');
            const mainTitle = document.getElementById('update-week-main-title'); // Get the new element
            const attendanceDaysContainer = document.getElementById('attendance-days-container');
            
            const displayDate = new Date(currentDate);
            const dayOfWeek = displayDate.getDay();
            const startDate = new Date(displayDate);
            startDate.setDate(displayDate.getDate() - dayOfWeek);
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4);

            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            weekDatesTitle.textContent = `Week of ${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
            
            // Check if it's the current week
            const isCurrentWeek = getWeekId(currentDate) === getWeekId(getEffectiveCurrentDate());

            if (isCurrentWeek) {
                mainTitle.classList.remove('return-to-today-btn', 'animated-gradient-text');
            } else {
                mainTitle.classList.add('return-to-today-btn', 'animated-gradient-text');
            }
            
            attendanceDaysContainer.innerHTML = ''; 
            
            for (let i = 0; i < 5; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                const dateString = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric'});

                const selectOptions = ATTENDANCE_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                
                let buttonHtml = '';
                const doubleChevronSvg = `<div class="animated-chevron pointer-events-none"></div>`;


                if (i < 4) { // For Monday to Thursday, make draggable
                    buttonHtml = `
                    <button type="button" draggable="true" class="apply-down-btn p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500 transition-transform" data-day-index="${i}" title="Drag down to apply status">
                        ${doubleChevronSvg}
                    </button>`;
                } else { // For Friday, a non-draggable drop target
                    buttonHtml = `
                    <div class="apply-down-btn p-2 rounded-md flex items-center justify-center w-9 h-9" data-day-index="${i}" title="Drop here to apply status">
                        <div class="w-2.5 h-2.5 bg-gray-300 dark:bg-gray-500 rounded-full"></div>
                    </div>`;
                }


                const dayHtml = `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center">
                        <div class="font-medium text-gray-800">
                            ${dayName} <span class="text-sm text-gray-500">${dateString}</span>
                        </div>
                        <div class="sm:col-span-2 flex items-center space-x-2">
                            <select id="day-${i}" class="form-input block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">${selectOptions}</select>
                            ${buttonHtml}
                        </div>
                    </div>`;
                attendanceDaysContainer.insertAdjacentHTML('beforeend', dayHtml);
            }

            initializeUpdateWeekDragDrop();

            const weekId = getWeekId(currentDate);
            const attendanceRef = doc(db, "attendance", `${weekId}_${userId}`);
            
            // Set up realtime listener for user's own attendance
            updateWeekUnsubscribe = onSnapshot(attendanceRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    for (let i = 0; i < 5; i++) {
                        const selectElement = document.getElementById(`day-${i}`);
                        if (selectElement && data.days && data.days[i]) {
                            selectElement.value = data.days[i];
                        }
                    }
                } else {
                    // Set defaults if no document exists
                    for (let i = 0; i < 5; i++) {
                        const selectElement = document.getElementById(`day-${i}`);
                        if (selectElement) {
                            selectElement.value = "Office";
                        }
                    }
                }
            }, (error) => {
                console.error("Error in Update Week realtime listener:", error);
            });
        }

        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            if (!currentUser) return;
            
            const weekId = getWeekId(currentDate);
            const attendanceRef = doc(db, "attendance", `${weekId}_${currentUser.uid}`);
            
            const daysData = [];
            for (let i = 0; i < 5; i++) {
                daysData.push(document.getElementById(`day-${i}`).value);
            }
            
            try {
                await setDoc(attendanceRef, { 
                    days: daysData,
                    weekId: weekId,
                    userId: currentUser.uid
                });
                showSuccessAnimation(weekSuccessAnimation);
                // refreshViews() removed - realtime listeners will update automatically
            } catch (error) {
                console.error("Error saving week: ", error);
            }
        });
        
        // --- Helper: Cached Users Fetching ---
        async function getCachedUsers() {
            // אם כבר יש לנו מידע בזיכרון והוא לא ריק - תחזיר אותו מיד בלי לפנות לשרת
            if (allUsersCache && allUsersCache.length > 0) {
                const usersMap = {};
                allUsersCache.forEach(user => {
                    usersMap[user.id] = user;
                });
                return usersMap;
            }

            // אם אין בזיכרון, תוריד מהשרת (קורה רק פעם אחת ב-Session)
            console.log("Fetching users from Firestore..."); // לוג לבדיקה
            const usersCol = collection(db, "users");
            const userSnapshot = await getDocs(usersCol);
            
            const usersMap = {};
            allUsersCache = []; // עדכון המשתנה הגלובלי

            userSnapshot.forEach(doc => {
                const userData = doc.data();
                usersMap[doc.id] = userData;
                allUsersCache.push({ id: doc.id, ...userData });
            });

            return usersMap;
        }
        
        // --- Team View Tab Logic ---
        async function setupTeamViewTab() {
            // Cleanup previous listener if exists
            if (teamViewUnsubscribe) {
                teamViewUnsubscribe();
                teamViewUnsubscribe = null;
            }

            const container = document.getElementById('team-view-container');
            const teamWeekTitle = document.getElementById('team-week-dates-title');
            const mainTitle = document.getElementById('team-view-main-title');
            
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Loading team data...</p>';
            
            const displayDate = new Date(currentDate);
            const dayOfWeek = displayDate.getDay();
            const startDate = new Date(displayDate);
            startDate.setDate(displayDate.getDate() - dayOfWeek);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            teamWeekTitle.textContent = `Week of ${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
            
            const isCurrentWeek = getWeekId(currentDate) === getWeekId(getEffectiveCurrentDate());
            if (isCurrentWeek) {
                mainTitle.classList.remove('return-to-today-btn', 'animated-gradient-text');
            } else {
                mainTitle.classList.add('return-to-today-btn', 'animated-gradient-text');
            }
            
            try {
                // Fetch users from cache (saves $$ and reads)
                const users = await getCachedUsers();

                const weekId = getWeekId(currentDate);
                
                // Function to render the table
                const renderTable = (attendances) => {
                    const groupedUsers = {};
                    Object.keys(users).forEach(uid => {
                        const user = users[uid];
                        const groupKey = user.group;
                        if (!groupedUsers[groupKey]) groupedUsers[groupKey] = [];
                        groupedUsers[groupKey].push({ ...user, uid });
                    });

                    // Populate filter dropdown while preserving the user's selection
                    const currentSelection = (currentUserProfile && currentUserProfile.teamViewFilter) || 'all';

                    groupFilter.innerHTML = '<option value="all">All Groups</option>';
                    availableGroups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        groupFilter.appendChild(option);
                    });
                    // Restore the previous selection if it's still a valid option
                    if (groupFilter.querySelector(`option[value="${currentSelection}"]`)) {
                        groupFilter.value = currentSelection;
                    } else {
                         // If the saved group no longer exists, default to 'all'
                        groupFilter.value = 'all';
                    }
                    
                    const selectedGroup = groupFilter.value;
                    
                    container.innerHTML = ''; 
                    
                    if (Object.keys(groupedUsers).length === 0) {
                          container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No team data available for this week.</p>';
                          return;
                    }
                    
                    const isCurrentUserTL = currentUserProfile && (currentUserProfile.isTL || currentUserProfile.isSuperAdmin);

                    const dayHeaders = [];
                    // Determine which weekday index is "today" relative to the week start, but only if viewing the real current week
                    const realNow = new Date();
                    realNow.setHours(0,0,0,0);
                    const isViewingCurrentEffectiveWeek = getWeekId(currentDate) === getWeekId(getEffectiveCurrentDate());
                    const realDayOfWeek = realNow.getDay(); // 0=Sun .. 6=Sat
                    // Highlight rules:
                    // - If viewing the real current week:
                    //   - Sun-Thu: bold the exact real today
                    //   - Fri/Sat: bold Sunday of this displayed week (upcoming Sunday)
                    // - Otherwise: no bold
                    let highlightTimestamp = null;
                    if (isViewingCurrentEffectiveWeek) {
                        if (realDayOfWeek >= 0 && realDayOfWeek <= 4) {
                            highlightTimestamp = realNow.getTime();
                        } else if (realDayOfWeek === 5 || realDayOfWeek === 6) {
                            const sunday = new Date(startDate);
                            sunday.setHours(0,0,0,0);
                            highlightTimestamp = sunday.getTime();
                        }
                    }
                    
                    for (let i = 0; i < 5; i++) {
                        const dayDate = new Date(startDate);
                        dayDate.setDate(startDate.getDate() + i);
                        dayDate.setHours(0,0,0,0);
                        const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'short' });
                        const dateString = `${String(dayDate.getDate()).padStart(2,'0')}/${String(dayDate.getMonth()+1).padStart(2,'0')}`;

                        // Add bold class only if highlightTimestamp is set AND this day matches that timestamp
                        const isToday = (highlightTimestamp !== null) && (dayDate.getTime() === highlightTimestamp);

                        const classes = ['py-3','px-2','text-left','text-[11px]','sm:text-xs','font-semibold','text-gray-600','uppercase','tracking-wider','w-20','sm:w-24'];
                        if (isToday) classes.push('day-header-today');

                        dayHeaders.push(`<th class="${classes.join(' ')}">${dayName}<br>${dateString}</th>`);
                    }
                    
                    const actionsHeader = isCurrentUserTL ? `<th class="py-3 px-2 text-left text-[11px] sm:text-xs font-semibold text-gray-600 uppercase tracking-wider w-20 sm:w-24">Actions</th>` : '';

                    const renderOrder = availableGroups;

                    let hasVisibleUsers = false;
                    renderOrder.forEach(groupName => {
                        if (!groupedUsers[groupName] || (selectedGroup !== 'all' && groupName !== selectedGroup)) {
                            return;
                        }
                        hasVisibleUsers = true;

                        let tableHtml = `
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">${groupName}</h3>
                                <div class="shadow-sm border border-gray-200 rounded-lg overflow-x-auto">
                                    <table class="bg-white divide-y divide-gray-200 table-fixed min-w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="py-3 px-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-32 sm:w-36 sticky-col">Employee</th>
                                                ${dayHeaders.join('')}
                                                ${actionsHeader}
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">`;

                        groupedUsers[groupName].sort((a, b) => {
                            if (a.isTL !== b.isTL) return b.isTL - a.isTL;
                            return (a.fullName || a.email).localeCompare(b.fullName || b.email);
                        }).forEach(user => {
                            const userAttendance = attendances[user.uid] || Array(5).fill('---');
                            const rowClass = user.isTL ? 'bg-gray-50' : '';
                            const attendanceCells = userAttendance.map(status => `<td class="py-3 px-2 text-left"><span class="status-label ${getStatusColorClass(status, 'badge')}">${status}</span></td>`).join('');
                            const nameFontWeight = user.isTL ? 'font-bold' : 'font-medium';
                            
                            const actionsCell = isCurrentUserTL ? `<td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm"><button class="edit-btn theme-link hover:underline" data-uid="${user.uid}" data-name="${user.fullName || user.email}">Edit</button></td>` : '';

                            tableHtml += `
                                <tr class="${rowClass}">
                                    <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm ${nameFontWeight} text-gray-900 truncate sticky-col">${user.fullName || user.email}</td>
                                    ${attendanceCells}
                                    ${actionsCell}
                                </tr>`;
                        });

                        tableHtml += `</tbody></table></div></div>`;
                        container.insertAdjacentHTML('beforeend', tableHtml);
                    });

                    if (!hasVisibleUsers) {
                        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No employees found for the selected group.</p>';
                    }
                };

                // Set up realtime listener for attendance changes
                const attendanceCol = collection(db, "attendance");
                const q = query(attendanceCol, where("weekId", "==", weekId));
                
                teamViewUnsubscribe = onSnapshot(q, (snapshot) => {
                    const attendances = {};
                    snapshot.forEach(doc => {
                        attendances[doc.data().userId] = doc.data().days;
                    });
                    renderTable(attendances);
                }, (error) => {
                    console.error("Error in Team View realtime listener:", error);
                    const errorMessage = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert"><strong class="font-bold">Action Required!</strong><p class="block sm:inline">To enable this view, a database index must be created. Please open the developer console (F12), find the error message from Firebase, and click the link to create the index. This is a one-time setup.</p></div>`;
                    container.innerHTML = errorMessage;
                });

            } catch (error) {
                console.error("Error fetching team view: ", error);
                const errorMessage = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert"><strong class="font-bold">Action Required!</strong><p class="block sm:inline">To enable this view, a database index must be created. Please open the developer console (F12), find the error message from Firebase, and click the link to create the index. This is a one-time setup.</p></div>`;
                container.innerHTML = errorMessage;
            }
        }

        // --- Statistics Tab Logic ---
        async function setupStatisticsTab() {
            // Cleanup previous listener if exists
            if (statisticsUnsubscribe) {
                statisticsUnsubscribe();
                statisticsUnsubscribe = null;
            }

            const container = document.getElementById('statistics-container');
            const statsWeekTitle = document.getElementById('stats-week-dates-title');
            const mainTitle = document.getElementById('statistics-main-title');
            
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full">Loading statistics...</p>';

            const displayDate = new Date(currentDate);
            const dayOfWeek = displayDate.getDay();
            const startDate = new Date(displayDate);
            startDate.setDate(displayDate.getDate() - dayOfWeek);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            statsWeekTitle.textContent = `Week of ${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
            
            const isCurrentWeek = getWeekId(currentDate) === getWeekId(getEffectiveCurrentDate());
            if (isCurrentWeek) {
                mainTitle.classList.remove('return-to-today-btn', 'animated-gradient-text');
            } else {
                mainTitle.classList.add('return-to-today-btn', 'animated-gradient-text');
            }

            try {
                // Fetch users from cache (saves $$ and reads)
                const allUsers = await getCachedUsers();
                
                const weekId = getWeekId(currentDate);
                const mergedGroupName = "DT, DV, FW";
                const groupsToMerge = ["DT", "DV", "FW"];

                // Populate group filter dropdown
                if (statsGroupFilter.options.length <= 1) {
                    statsGroupFilter.innerHTML = '<option value="all">All Groups</option>';
                    availableGroups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        statsGroupFilter.appendChild(option);
                    });
                }

                // Function to render statistics
                const renderStatistics = (attendances) => {
                    // Filter users for employee dropdown based on selected group
                    const selectedGroup = statsGroupFilter.value;
                    const usersInSelectedGroup = Object.entries(allUsers).filter(([uid, user]) => {
                         if (selectedGroup === 'all') return true;
                        let userGroup = user.group;
                        if (groupsToMerge.includes(userGroup)) userGroup = mergedGroupName;
                        return userGroup === selectedGroup;
                    });

                    // Populate employee filter
                    const currentEmployee = statsEmployeeFilter.value;
                    statsEmployeeFilter.innerHTML = '<option value="all">All Employees</option>';
                    usersInSelectedGroup.sort(([, a], [, b]) => (a.fullName || a.email).localeCompare(b.fullName || b.email))
                        .forEach(([uid, user]) => {
                        const option = document.createElement('option');
                        option.value = uid;
                        option.textContent = user.fullName || user.email;
                        statsEmployeeFilter.appendChild(option);
                    });
                     // Try to keep the selection if possible
                    if (statsEmployeeFilter.querySelector(`option[value="${currentEmployee}"]`)) {
                        statsEmployeeFilter.value = currentEmployee;
                    } else {
                        statsEmployeeFilter.value = 'all';
                    }

                    // Final filter based on both group and employee
                    const selectedEmployee = statsEmployeeFilter.value;
                    const finalFilteredUserIds = usersInSelectedGroup
                        .map(([uid]) => uid)
                        .filter(uid => selectedEmployee === 'all' || uid === selectedEmployee);

                    const totalUsersInFilter = finalFilteredUserIds.length;
                    if (totalUsersInFilter === 0) {
                        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full">No employees found for the selected filter.</p>';
                        return;
                    }
                    
                    // Calculate stats
                    const dailyStats = Array.from({ length: 5 }, () => ({}));
                    const weeklyStats = {};
                    let totalSlots = 0;
                    
                    finalFilteredUserIds.forEach(uid => {
                        const userAttendance = attendances[uid] || Array(5).fill("Office"); // Default to Office
                        for (let i = 0; i < 5; i++) {
                            const status = userAttendance[i];
                            // Daily
                            if (!dailyStats[i][status]) dailyStats[i][status] = 0;
                            dailyStats[i][status]++;
                            // Weekly
                            if(!weeklyStats[status]) weeklyStats[status] = 0;
                            weeklyStats[status]++;
                        }
                        totalSlots += 5;
                    });
                    
                    container.innerHTML = '';
                    
                    // [MODIFICATION 3] Render Weekly Summary Card with circular progress indicators
                    const weeklySummaryCard = document.createElement('div');
                    weeklySummaryCard.className = "weekly-summary-card p-6 rounded-lg col-span-full";
                    let weeklyHtml = '<h3 class="weekly-summary-title font-bold text-xl mb-4">Weekly Summary</h3>';
                    const sortedWeekly = Object.keys(weeklyStats).sort((a,b) => weeklyStats[b] - weeklyStats[a]);
                    if(sortedWeekly.length === 0){
                        weeklyHtml += '<p class="text-sm text-gray-500 dark:text-gray-400">No data reported for this week.</p>';
                    } else {
                        weeklyHtml += '<div class="progress-circles-container">';
                        sortedWeekly.forEach(status => {
                            const count = weeklyStats[status];
                            const percentage = ((count / totalSlots) * 100).toFixed(1);
                            const circumference = 2 * Math.PI * 42; // radius = 42
                            const offset = circumference - (percentage / 100) * circumference;
                            
                            // Get color for this status using existing color mapping
                            const colorMap = {
                                'Office': '#10b981', // green-500
                                'Home-full': '#3b82f6', // blue-500
                                'Sick': '#ef4444', // red-500
                                'Day off': '#ef4444', // red-500
                                'Vacation': '#ef4444', // red-500
                                'Maternity leave': '#ef4444', // red-500
                                'Half day off': '#eab308', // yellow-500
                                'Business trip': '#a855f7', // purple-500
                                'Conference': '#a855f7', // purple-500
                                'University': '#a855f7', // purple-500
                                'Reserved duty': '#6b7280', // gray-500
                                'Team event': '#6366f1', // indigo-500
                                'Holiday': '#6366f1' // indigo-500
                            };
                            const color = colorMap[status] || '#6366f1';
                            
                            weeklyHtml += `
                                <div class="progress-circle-item">
                                    <div class="progress-circle">
                                        <svg viewBox="0 0 100 100">
                                            <circle class="progress-circle-bg" cx="50" cy="50" r="42"></circle>
                                            <circle class="progress-circle-fill" cx="50" cy="50" r="42"
                                                stroke="${color}"
                                                stroke-dasharray="${circumference}"
                                                stroke-dashoffset="${circumference}"
                                                data-target-offset="${offset}"></circle>
                                        </svg>
                                        <div class="progress-circle-text">
                                            <div class="progress-circle-percentage">0%</div>
                                        </div>
                                    </div>
                                    <div class="progress-circle-label">${status}</div>
                                    <div class="progress-circle-count">${count}/${totalSlots} slots</div>
                                </div>
                            `;
                        });
                        weeklyHtml += '</div>';
                    }
                    weeklySummaryCard.innerHTML = weeklyHtml;
                    container.appendChild(weeklySummaryCard);

                    // Trigger animation if Statistics tab has been visited
                    if (statisticsTabVisited) {
                        setTimeout(() => {
                            animateProgressCircles();
                        }, 100);
                    }

                    // Render Daily Cards
                     const dailyCardsContainer = document.createElement('div');
                     dailyCardsContainer.className = "mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 col-span-full";
                    
                    for (let i = 0; i < 5; i++) {
                        const dayDate = new Date(startDate);
                        dayDate.setDate(startDate.getDate() + i);
                        const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                        const dateString = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        
                        const statsForDay = dailyStats[i];
                        let statsHtml = '';

                        // Sort statuses by count
                        const sortedStatuses = Object.keys(statsForDay).sort((a, b) => statsForDay[b] - statsForDay[a]);

                        if (sortedStatuses.length === 0) {
                            statsHtml = '<p class="text-sm text-gray-500">No data reported.</p>';
                        } else {
                            sortedStatuses.forEach(status => {
                                const count = statsForDay[status];
                                const percentage = ((count / totalUsersInFilter) * 100).toFixed(1);
                                statsHtml += `
                                    <div class="mb-3">
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">${status}</span>
                                            <span class="text-sm font-medium text-gray-500 daily-percentage" data-target="${percentage}">0% (${count}/${totalUsersInFilter})</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                            <div class="${getStatusColorClass(status, 'progress')} daily-progress-bar" style="width: 0%; transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);" data-target-width="${percentage}"></div>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        
                        const dayCardHtml = `
                            <div class="day-card bg-gray-50 p-4 rounded-lg border">
                                <h4 class="font-bold text-lg text-gray-800">${dayName}</h4>
                                <p class="text-sm text-gray-500 mb-4">${dateString}</p>
                                ${statsHtml}
                            </div>
                        `;
                        dailyCardsContainer.insertAdjacentHTML('beforeend', dayCardHtml);
                    }
                    container.appendChild(dailyCardsContainer);
                    
                    // Set up Intersection Observer for daily cards animation (always, not just when visited)
                    setTimeout(() => {
                        setupDailyCardsObserver();
                    }, 150);
                };

                // Set up realtime listener for attendance changes
                const attendanceCol = collection(db, "attendance");
                const q = query(attendanceCol, where("weekId", "==", weekId));
                
                statisticsUnsubscribe = onSnapshot(q, (snapshot) => {
                    const attendances = {};
                    snapshot.forEach(doc => {
                        attendances[doc.data().userId] = doc.data().days;
                    });
                    renderStatistics(attendances);
                }, (error) => {
                    console.error("Error in Statistics realtime listener:", error);
                    container.innerHTML = '<p class="text-red-500 col-span-full">Failed to load statistics.</p>';
                });

            } catch(error) {
                 console.error("Error fetching statistics: ", error);
                 container.innerHTML = '<p class="text-red-500 col-span-full">Failed to load statistics.</p>';
            }
        }

        // Function to set up Intersection Observer for daily statistics cards
        function setupDailyCardsObserver() {
            const cards = document.querySelectorAll('.day-card');
            
            const observerOptions = {
                root: null, // viewport
                rootMargin: '0px',
                threshold: 0.2 // trigger when 20% of card is visible
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !entry.target.dataset.animated) {
                        // Mark as animated so it only happens once
                        entry.target.dataset.animated = 'true';
                        
                        // Animate all progress bars in this card
                        const progressBars = entry.target.querySelectorAll('.daily-progress-bar');
                        const percentageTexts = entry.target.querySelectorAll('.daily-percentage');
                        
                        setTimeout(() => {
                            progressBars.forEach((bar, index) => {
                                const targetWidth = parseFloat(bar.getAttribute('data-target-width'));
                                bar.style.width = targetWidth + '%';
                                
                                // Animate percentage text
                                if (percentageTexts[index]) {
                                    const targetPercentage = parseFloat(percentageTexts[index].getAttribute('data-target'));
                                    let currentPercentage = 0;
                                    const duration = 1200;
                                    const steps = 60;
                                    const increment = targetPercentage / steps;
                                    const stepDuration = duration / steps;
                                    
                                    const intervalId = setInterval(() => {
                                        currentPercentage += increment;
                                        if (currentPercentage >= targetPercentage) {
                                            currentPercentage = targetPercentage;
                                            clearInterval(intervalId);
                                        }
                                        // Keep the count text intact
                                        const fullText = percentageTexts[index].textContent;
                                        const countPart = fullText.substring(fullText.indexOf('('));
                                        percentageTexts[index].textContent = currentPercentage.toFixed(1) + '% ' + countPart;
                                    }, stepDuration);
                                }
                            });
                        }, 100);
                        
                        // Stop observing this card
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);
            
            // Observe all cards
            cards.forEach(card => observer.observe(card));
        }


        // --- Admin/TL/SuperAdmin Tools Logic ---
        async function setupAdminTabs() {
            const tlNotificationDot = document.getElementById('tl-notification-dot');
            const isTL = currentUserProfile && currentUserProfile.isTL;
            const isSuperAdmin = currentUserProfile && currentUserProfile.isSuperAdmin;

            // Super Admin gets all TL tools plus their own panel
            if (isSuperAdmin) {
                tabs.tlTools.classList.remove('hidden');
                tabs.statistics.classList.remove('hidden');
                tabs.superAdmin.classList.remove('hidden');
                manageGroupsBtn.classList.remove('hidden');
                await setupSuperAdminPanel();
            } else if (isTL) {
                tabs.tlTools.classList.remove('hidden');
                tabs.statistics.classList.remove('hidden');
                tabs.superAdmin.classList.add('hidden'); // Ensure SA tab is hidden for normal TLs
                manageGroupsBtn.classList.remove('hidden');
            } else { // Normal Employee
                tabs.tlTools.classList.add('hidden');
                tabs.statistics.classList.add('hidden');
                tabs.superAdmin.classList.add('hidden');
                manageGroupsBtn.classList.add('hidden');
                tlNotificationDot.classList.add('hidden');
                return; // Exit if not an admin type
            }

            // Common tools for TL and Super Admin
            const select = document.getElementById('tl-status-select');
            select.innerHTML = ATTENDANCE_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            
            // Populate group filter for bulk update
            const tlGroupFilter = document.getElementById('tl-group-filter');
            tlGroupFilter.innerHTML = '<option value="all">All Groups</option>';
            availableGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                tlGroupFilter.appendChild(option);
            });
            
            setupBulkUpdateView();

            // Cleanup previous listener if exists
            if (pendingUsersUnsubscribe) {
                pendingUsersUnsubscribe();
                pendingUsersUnsubscribe = null;
            }

            const pendingContainer = document.getElementById('pending-users-container');
            const actionsContainer = document.getElementById('pending-actions-container');
            pendingContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Loading pending requests...</p>';
            actionsContainer.classList.add('hidden');
            
            let q = query(collection(db, "pendingUsers"), where("status", "==", "pending"));
            
            // Super Admin sees all requests, TL sees only for their group(s)
            if (!isSuperAdmin) {
                 const userGroup = currentUserProfile.group;
                if (userGroup) {
                    const groupsToQuery = ["DT", "DV", "FW"].includes(userGroup) ? ["DT", "DV", "FW"] : [userGroup];
                    q = query(collection(db, "pendingUsers"), where("status", "==", "pending"), where("group", "in", groupsToQuery));
                }
            }
            
            // Set up realtime listener for pending users
            pendingUsersUnsubscribe = onSnapshot(q, (querySnapshot) => {
                pendingUsersSnapshot = querySnapshot; // Cache for bulk actions
                tlNotificationDot.classList.toggle('hidden', querySnapshot.empty);

                if (querySnapshot.empty) {
                    pendingContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No pending registration requests.</p>';
                    actionsContainer.classList.add('hidden');
                } else {
                    let html = '<div class="space-y-4">';
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        html += `
                            <div class="p-4 bg-gray-50 rounded-lg border flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div>
                                    <p class="font-bold text-gray-800">${data.fullName}</p>
                                    <p class="text-sm text-gray-600">${data.email}</p>
                                    <p class="text-sm text-gray-500">Group: ${data.group}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="approve-user-btn btn btn-success text-sm py-2 px-3" data-doc-id="${doc.id}">Approve</button>
                                    <button class="reject-user-btn btn btn-danger text-sm py-2 px-3" data-doc-id="${doc.id}">Reject</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    pendingContainer.innerHTML = html;

                    // Show and set up bulk action buttons
                    actionsContainer.innerHTML = `
                        <div class="flex space-x-2">
                            <button id="approve-all-btn" class="btn btn-success text-xs py-2 px-3">Approve All</button>
                            <button id="reject-all-btn" class="btn btn-danger text-xs py-2 px-3">Reject All</button>
                        </div>
                    `;
                    actionsContainer.classList.remove('hidden');
                    
                    // Remove old listeners first to avoid duplicates
                    const approveBtn = document.getElementById('approve-all-btn');
                    const rejectBtn = document.getElementById('reject-all-btn');
                    if (approveBtn) approveBtn.addEventListener('click', handleApproveAll);
                    if (rejectBtn) rejectBtn.addEventListener('click', handleRejectAll);
                }
            }, (error) => {
                console.error("Error in Pending Users realtime listener:", error);
                pendingContainer.innerHTML = '<p class="text-red-500">Failed to load pending requests.</p>';
            });
            
            setupRemoveUserTool();
        }
        
        async function handleApproveAll() {
            if (!pendingUsersSnapshot || pendingUsersSnapshot.empty) return;
            
            showConfirmationModal('Approve All Users', `Are you sure you want to approve all ${pendingUsersSnapshot.size} pending requests?`, async () => {
                let successCount = 0;
                let errorCount = 0;
                let errors = [];

                for (const docSnap of pendingUsersSnapshot.docs) {
                    const { fullName, email, group } = docSnap.data();
                    try {
                        await createUserByAdmin(fullName, email, group);
                        successCount++;
                    } catch (error) {
                        errorCount++;
                        errors.push(`- ${email}: ${error.message}`);
                        console.error(`Failed to approve ${email}:`, error);
                    }
                }

                // After attempting to create all users, delete all original pending docs in a batch
                const batch = writeBatch(db);
                pendingUsersSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                let resultMessage = `${successCount} user(s) approved successfully.`;
                if (errorCount > 0) {
                    resultMessage += `\n\n${errorCount} user(s) failed:\n${errors.join('\n')}`;
                }

                showConfirmationModal('Bulk Approval Complete', resultMessage, () => {});
                refreshViews();
            });
        }

        async function handleRejectAll() {
            if (!pendingUsersSnapshot || pendingUsersSnapshot.empty) return;

            showConfirmationModal('Reject All Users', `Are you sure you want to reject all ${pendingUsersSnapshot.size} pending requests?`, async () => {
                try {
                    const batch = writeBatch(db);
                    pendingUsersSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    showConfirmationModal('Success', 'All pending requests have been rejected.', () => {});
                    refreshViews();
                } catch (error) {
                    console.error("Error rejecting all users:", error);
                    showConfirmationModal('Error', 'Failed to reject all requests.', () => {});
                }
            });
        }

        function setupBulkUpdateView() {
            const tlWeekDatesTitle = document.getElementById('tl-week-dates-title');
            const tlDaySelect = document.getElementById('tl-day');

            const displayDate = new Date(tlToolDate);
            const dayOfWeek = displayDate.getDay();
            const startDate = new Date(displayDate);
            startDate.setDate(displayDate.getDate() - dayOfWeek);
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 4);

            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            tlWeekDatesTitle.textContent = `Week of ${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
            
            tlDaySelect.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                const dateString = dayDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${dayName} (${dateString})`;
                tlDaySelect.appendChild(option);
            }
        }
        
        appContainer.addEventListener('click', e => {
            const target = e.target;

            // Handler for pending user buttons
            const pendingContainer = target.closest('#pending-users-container');
            if (pendingContainer) {
                 const docId = target.dataset.docId;
                if (!docId) return;
                if (target.classList.contains('approve-user-btn')) {
                    showConfirmationModal('Approve User', 'Are you sure you want to approve this user? An account will be created for them.', () => handleApproveUser(docId));
                } else if (target.classList.contains('reject-user-btn')) {
                    showConfirmationModal('Reject User', 'Are you sure you want to reject this registration request?', () => handleRejectUser(docId));
                }
            }
        });

        async function handleApproveUser(docId) {
            const pendingDocRef = doc(db, "pendingUsers", docId);
            try {
                const pendingDoc = await getDoc(pendingDocRef);
                if (!pendingDoc.exists()) throw new Error("Request not found.");

                const { fullName, email, group } = pendingDoc.data();
                await createUserByAdmin(fullName, email, group);
                await deleteDoc(pendingDocRef);

                showConfirmationModal('Success', 'User approved and created successfully!', () => {});
                refreshViews();

            } catch (error) {
                console.error("Error approving user:", error);
                let userMessage = `Failed to approve user: ${error.message}`;
                 if (error.code === 'auth/email-already-in-use' || (error.message && error.message.includes('email-already-in-use'))) {
                       userMessage = `Failed to approve user: The email address is already in use. Please reject this request and ask the user to sign in.`;
                 }
                showConfirmationModal('Error', userMessage, () => {});
            }
        }

        async function handleRejectUser(docId) {
             const pendingDocRef = doc(db, "pendingUsers", docId);
             try {
                await deleteDoc(pendingDocRef);
                showConfirmationModal('Success', 'Request rejected.', () => {});
                setupAdminTabs();
             } catch (error) {
                console.error("Error rejecting user:", error);
                showConfirmationModal('Error', 'Failed to reject request.', () => {});
             }
        }
        
        tlForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const dayIndex = document.getElementById('tl-day').value;
            const dayName = document.getElementById('tl-day').options[document.getElementById('tl-day').selectedIndex].text;
            const newStatus = document.getElementById('tl-status-select').value;
            const selectedGroup = document.getElementById('tl-group-filter').value;
            const groupText = selectedGroup === 'all' ? 'all employees' : `employees in group "${selectedGroup}"`;
            
            showConfirmationModal(
                'Confirm Bulk Update', 
                `Are you sure you want to set status to "${newStatus}" for ${groupText} on ${dayName}? This cannot be undone.`,
                () => handleBulkUpdate(parseInt(dayIndex), newStatus, tlToolDate, selectedGroup)
            );
        });

        async function handleBulkUpdate(dayIndex, newStatus, dateForUpdate, selectedGroup = 'all') {
            const originalButtonText = bulkUpdateButton.textContent;
            bulkUpdateButton.disabled = true;
            bulkUpdateButton.textContent = 'Updating...';
            
            const weekId = getWeekId(dateForUpdate);
            try {
                const usersQuery = query(collection(db, "users"));
                const usersSnapshot = await getDocs(usersQuery);
                
                // Filter users by selected group
                const allUsers = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const filteredUsers = selectedGroup === 'all' 
                    ? allUsers 
                    : allUsers.filter(user => user.group === selectedGroup);
                const filteredUserIds = filteredUsers.map(user => user.id);

                const attendanceQuery = query(collection(db, "attendance"), where("weekId", "==", weekId));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const existingAttendances = {};
                attendanceSnapshot.forEach(doc => {
                    existingAttendances[doc.data().userId] = doc.data().days;
                });

                const batch = writeBatch(db);
                filteredUserIds.forEach(userId => {
                    const docRef = doc(db, "attendance", `${weekId}_${userId}`);
                    let currentDays = existingAttendances[userId] || Array(5).fill("Office");
                    let newDays = [...currentDays];
                    newDays[dayIndex] = newStatus;
                    batch.set(docRef, {
                        userId: userId,
                        weekId: weekId,
                        days: newDays
                    });
                });
                await batch.commit();
                
                const groupMsg = selectedGroup === 'all' ? 'all employees' : `${filteredUserIds.length} employee(s) in group "${selectedGroup}"`;
                showConfirmationModal('Success', `Bulk update successful! Updated ${groupMsg}.`, () => {});
                // refreshViews() removed - realtime listeners will update automatically

            } catch (error) {
                console.error("Bulk update failed: ", error);
                showConfirmationModal('Error', 'Bulk update failed. See console for details.', () => {});
            } finally {
                bulkUpdateButton.disabled = false;
                bulkUpdateButton.textContent = originalButtonText;
            }
        }

        async function createUserByAdmin(fullName, email, group) {
             const defaultPassword = '123456';
             const tempAppName = `temp-app-${Date.now()}`;
             const tempApp = initializeApp(firebaseConfig, tempAppName);
             const tempAuth = getAuth(tempApp);

             try {
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, defaultPassword);
                const newUser = userCredential.user;

                const userRef = doc(db, "users", newUser.uid);
                await setDoc(userRef, {
                    email: newUser.email,
                    fullName: fullName,
                    group: group,
                    isTL: false,
                    isSuperAdmin: false,
                    username: '', // Initialize username as empty
                    darkMode: false, // Initialize dark mode as false
                    teamViewFilter: 'all', // Initialize filter preference
                    createdBy: currentUser.uid 
                });
                return true;
             } catch(error) {
                throw error; // Re-throw the original error to be caught by the caller
             } finally {
                   try {
                       await deleteApp(tempApp);
                   } catch (e) {
                         console.error("Error deleting temp app", e);
                   }
             }
        }
        
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAllMessages();
            const fullName = document.getElementById('new-user-fullname').value;
            const email = document.getElementById('new-user-email').value;
            const group = document.getElementById('new-user-group').value;

            try {
                await createUserByAdmin(fullName, email, group);
                showSuccessAnimation(createUserSuccessAnimation);
                createUserForm.reset();
                refreshViews(); 

            } catch (error) {
                console.error("Error creating new user:", error);
                let userMessage = `Error: ${error.message}`;
                if (error.code === 'auth/email-already-in-use' || (error.message && error.message.includes('email-already-in-use'))) {
                    userMessage = `Error: The email address ${email} is already in use.`;
                }
                createUserError.textContent = userMessage;
                createUserError.classList.remove('hidden');
            }
        });
        
        async function setupRemoveUserTool() {
            removeUserGroupFilter.innerHTML = `<option value="all">All Groups</option>`;
            availableGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                removeUserGroupFilter.appendChild(option);
            });
            
            await populateRemoveUserSelect(); // Initial population
            removeUserGroupFilter.addEventListener('change', populateRemoveUserSelect);
        }

        async function populateRemoveUserSelect() {
            const selectedGroup = removeUserGroupFilter.value;
            let usersQuery = query(collection(db, "users"));
            if (selectedGroup !== 'all') {
                usersQuery = query(collection(db, "users"), where("group", "==", selectedGroup));
            }

            const snapshot = await getDocs(usersQuery);
            removeUserSelect.innerHTML = '<option value="">-- Select a user --</option>';
            snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(user => user.id !== currentUser.uid) // Can't delete yourself
                .filter(user => !user.isSuperAdmin || currentUserProfile.isSuperAdmin) // TLs cannot see Super Admins
                .sort((a,b) => (a.fullName || "").localeCompare(b.fullName || ""))
                .forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.fullName} (${user.email})`;
                    removeUserSelect.appendChild(option);
                });
        }
        
        removeUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userIdToRemove = removeUserSelect.value;
            if (!userIdToRemove) return;
            const userName = removeUserSelect.options[removeUserSelect.selectedIndex].text;

            showConfirmationModal(
                'Confirm User Deletion',
                `Are you sure you want to permanently delete ${userName}? This action is irreversible and will delete all their data.`,
                () => handleDeleteUser(userIdToRemove)
            );
        });
        
        async function handleDeleteUser(userId, fromAdminPanel = false) {
             try {
                // Delete user's Firestore document
                await deleteDoc(doc(db, "users", userId));
                
                // Find and delete all attendance records for this user
                const attendanceQuery = query(collection(db, "attendance"), where("userId", "==", userId));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const batch = writeBatch(db);
                attendanceSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // Remove from local cache if deleted from admin panel
                if(fromAdminPanel) {
                    allUsersCache = allUsersCache.filter(user => user.id !== userId);
                    renderUserManagementList();
                }

                showConfirmationModal('User Data Deleted', 'User data has been deleted from the database. \nIMPORTANT: Please also delete the user from the Firebase Authentication tab to fully remove them.', () => {});
                
                // Refresh main views if not called from admin panel (e.g. from TL tools)
                if (!fromAdminPanel) {
                    refreshViews();
                }

             } catch (error) {
                console.error("Error deleting user:", error);
                showConfirmationModal('Error', `Failed to delete user data: ${error.message}`, () => {});
             }
        }
        
        // --- Edit Employee Modal Logic ---
        document.getElementById('team-view-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const userId = e.target.dataset.uid;
                const userName = e.target.dataset.name;
                openEditModal(userId, userName);
            }
        });
        
        async function openEditModal(userId, userName) {
            editModalTitle.textContent = `Editing attendance for: ${userName}`;
            editModalBody.innerHTML = '<p>Loading attendance...</p>';
            editEmployeeModal.dataset.editingUid = userId;
            
            const displayDate = new Date(currentDate);
            const dayOfWeek = displayDate.getDay();
            const startDate = new Date(displayDate);
            startDate.setDate(displayDate.getDate() - dayOfWeek);
            
            let formHtml = '';
            for (let i = 0; i < 5; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                const selectOptions = ATTENDANCE_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                formHtml += `
                    <div class="grid grid-cols-3 gap-4 items-center">
                         <label class="font-medium text-gray-800" for="edit-day-${i}">${dayName}</label>
                         <select id="edit-day-${i}" class="col-span-2 form-input mt-1 block w-full border-gray-300 rounded-lg shadow-sm py-2 px-3">${selectOptions}</select>
                    </div>
                `;
            }
            editModalBody.innerHTML = formHtml;
            
            const weekId = getWeekId(currentDate);
            const attendanceRef = doc(db, "attendance", `${weekId}_${userId}`);
            const docSnap = await getDoc(attendanceRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                for (let i = 0; i < 5; i++) {
                    if (data.days && data.days[i]) {
                        document.getElementById(`edit-day-${i}`).value = data.days[i];
                    }
                }
            } else {
                // If no attendance doc exists, pre-fill with defaults
                 for (let i = 0; i < 5; i++) {
                    document.getElementById(`edit-day-${i}`).value = "Office";
                }
            }
            
            editEmployeeModal.classList.remove('hidden');
        }
        
        editModalCancel.addEventListener('click', () => {
            editEmployeeModal.classList.add('hidden');
        });

        editModalSave.addEventListener('click', async () => {
            const userId = editEmployeeModal.dataset.editingUid;
            if (!userId) return;

            const weekId = getWeekId(currentDate);
            const attendanceRef = doc(db, "attendance", `${weekId}_${userId}`);
            const daysData = [];
            for (let i = 0; i < 5; i++) {
                daysData.push(document.getElementById(`edit-day-${i}`).value);
            }

            try {
                // Use setDoc here which creates or overwrites.
                await setDoc(attendanceRef, { 
                    days: daysData,
                    weekId: weekId,
                    userId: userId
                });
                editEmployeeModal.classList.add('hidden');
                // refreshViews() removed - realtime listeners will update automatically
            } catch (error) {
                console.error("Error saving employee week:", error);
                showConfirmationModal('Error', "Failed to save changes.", () => {});
            }
        });

        // --- Super Admin Panel Logic ---
        async function setupSuperAdminPanel() {
            populateGroupSelects(); // Ensure user management filter is populated
            const usersRef = collection(db, "users");
            const snapshot = await getDocs(usersRef);
            allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderUserManagementList();
        }

        function renderUserManagementList() {
            const searchTerm = userSearchInput.value.toLowerCase();
            const groupFilterVal = userGroupFilter.value;

            const filteredUsers = allUsersCache.filter(user => {
                const nameMatch = (user.fullName || '').toLowerCase().includes(searchTerm);
                const emailMatch = (user.email || '').toLowerCase().includes(searchTerm);
                const groupMatch = groupFilterVal === 'all' || user.group === groupFilterVal;
                return (nameMatch || emailMatch) && groupMatch;
            });

            if (filteredUsers.length === 0) {
                userManagementContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No users found.</p>';
                return;
            }

            let tableHtml = `
                <div class="shadow-sm border border-gray-200 dark:border-gray-700 rounded-lg overflow-x-auto relative" style="isolation: isolate;">
                    <table class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700 min-w-max md:w-full table-auto">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th class="sticky-col py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Name</th>
                                <th class="py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Email</th>
                                <th class="py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Group</th>
                                <th class="py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Role</th>
                                <th class="py-3 px-2 text-left text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            `;

            filteredUsers.sort((a,b) => (a.fullName || "").localeCompare(b.fullName || "")).forEach(user => {
                let role = 'Employee';
                if (user.isSuperAdmin) role = 'Super Admin';
                else if (user.isTL) role = 'Team Leader';

                tableHtml += `
                    <tr>
                        <td class="sticky-col py-3 px-2 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100">${user.fullName}</td>
                        <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm text-gray-500 dark:text-gray-400">${user.email}</td>
                        <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm text-gray-500 dark:text-gray-400">${user.group}</td>
                        <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm font-medium ${user.isSuperAdmin ? 'text-red-600' : (user.isTL ? 'theme-purple-text-dark' : 'text-gray-500 dark:text-gray-400')}">${role}</td>
                        <td class="py-3 px-2 whitespace-nowrap text-xs sm:text-sm">
                            <button class="sa-edit-user-btn theme-link hover:underline font-medium mr-3" data-uid="${user.id}">Edit</button>
                            <button class="sa-delete-user-btn text-red-600 hover:underline font-medium" data-uid="${user.id}" data-name="${user.fullName}">Delete</button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table></div>`;
            userManagementContainer.innerHTML = tableHtml;
        }

        userManagementContainer.addEventListener('click', e => {
            if (e.target.classList.contains('sa-edit-user-btn')) {
                const userId = e.target.dataset.uid;
                openSuperAdminEditModal(userId);
            }
            if (e.target.classList.contains('sa-delete-user-btn')) {
                const userId = e.target.dataset.uid;
                const userName = e.target.dataset.name;
                 showConfirmationModal(
                     'Confirm User Deletion',
                     `Are you sure you want to permanently delete ${userName}? This action is irreversible and will delete all their data.`,
                     () => handleDeleteUser(userId, true) // Pass true to signify it's from the admin panel
                 );
            }
        });
        
        function openSuperAdminEditModal(userId) {
            const user = allUsersCache.find(u => u.id === userId);
            if (!user) return;

            superAdminEditForm.dataset.editingUid = userId;
            document.getElementById('sa-modal-title').textContent = `Edit User: ${user.fullName}`;
            document.getElementById('sa-edit-fullname').value = user.fullName;
            document.getElementById('sa-edit-email').value = user.email;
            document.getElementById('sa-edit-group').value = user.group;

            if (user.isSuperAdmin) {
                document.getElementById('sa-role-superadmin').checked = true;
            } else if (user.isTL) {
                document.getElementById('sa-role-tl').checked = true;
            } else {
                document.getElementById('sa-role-employee').checked = true;
            }
            
            superAdminEditModal.classList.remove('hidden');
        }

        superAdminEditCancel.addEventListener('click', () => {
            superAdminEditModal.classList.add('hidden');
        });
        
        document.getElementById('sa-email-info-btn').addEventListener('click', (e) => {
             e.preventDefault();
             showConfirmationModal('Action Not Allowed', 'Changing a user\'s email address requires server-side logic (Cloud Functions) with Admin SDK privileges and is not supported in this client-only app.', ()=>{});
        });

        superAdminEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = superAdminEditForm.dataset.editingUid;
            if (!userId) return;
            
            const selectedRole = document.querySelector('input[name="sa-role"]:checked').value;
            const dataToUpdate = {
                fullName: document.getElementById('sa-edit-fullname').value,
                group: document.getElementById('sa-edit-group').value,
                isTL: selectedRole === 'tl' || selectedRole === 'superadmin',
                isSuperAdmin: selectedRole === 'superadmin'
            };

            try {
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, dataToUpdate);
                
                // Update local cache to reflect changes immediately
                const userIndex = allUsersCache.findIndex(u => u.id === userId);
                if (userIndex > -1) {
                    allUsersCache[userIndex] = { ...allUsersCache[userIndex], ...dataToUpdate };
                }
                
                superAdminEditModal.classList.add('hidden');
                renderUserManagementList(); // Re-render the list with updated data
                refreshViews(); // Refresh other views like team view if group changed

            } catch (error) {
                console.error("Error updating user:", error);
                alert(`Failed to update user: ${error.message}`);
            }
        });
        
        // --- [NEW] Click listener for the main title in Update Week tab ---
        document.getElementById('update-week-main-title').addEventListener('click', () => {
            const titleEl = document.getElementById('update-week-main-title');
            if (titleEl.classList.contains('return-to-today-btn')) {
                currentDate = getEffectiveCurrentDate();
                refreshViews();
            }
        });
        document.getElementById('team-view-main-title').addEventListener('click', () => {
            const titleEl = document.getElementById('team-view-main-title');
            if (titleEl.classList.contains('return-to-today-btn')) {
                currentDate = getEffectiveCurrentDate();
                refreshViews();
            }
        });
        document.getElementById('statistics-main-title').addEventListener('click', () => {
            const titleEl = document.getElementById('statistics-main-title');
            if (titleEl.classList.contains('return-to-today-btn')) {
                currentDate = getEffectiveCurrentDate();
                refreshViews();
            }
        });

        // --- Export Statistics to PDF ---
        async function exportPDFForMonth(selectedMonthValue, monthName) {
            const button = document.getElementById('export-stats-pdf-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            try {
                const { jsPDF } = window.jspdf;
                const groupFilter = document.getElementById('stats-group-filter');
                const employeeFilter = document.getElementById('stats-employee-filter');
                
                const selectedGroup = groupFilter.value;
                const selectedGroupText = groupFilter.options[groupFilter.selectedIndex].text;
                const selectedEmployee = employeeFilter.value;
                const selectedEmployeeText = employeeFilter.options[employeeFilter.selectedIndex].text;

                // Get selected month data
                const [selectedYear, selectedMonthStr] = selectedMonthValue.split('-').map(Number);
                const currentMonth = selectedMonthStr - 1; // Convert to 0-indexed
                const currentYear = selectedYear;

                // Fetch all users
                const usersCol = collection(db, "users");
                const userSnapshot = await getDocs(usersCol);
                const allUsers = {};
                userSnapshot.forEach(doc => {
                    allUsers[doc.id] = doc.data();
                });

                // Filter users by selected group
                let filteredUsers = Object.entries(allUsers);
                if (selectedGroup !== 'all') {
                    filteredUsers = filteredUsers.filter(([uid, user]) => user.group === selectedGroup);
                }
                if (selectedEmployee !== 'all') {
                    filteredUsers = filteredUsers.filter(([uid]) => uid === selectedEmployee);
                }
                
                filteredUsers.sort(([, a], [, b]) => (a.fullName || a.email).localeCompare(b.fullName || b.email));

                // Fetch all attendance records for the current month
                const attendanceCol = collection(db, "attendance");
                const allAttendance = await getDocs(attendanceCol);
                
                // Calculate monthly statistics per employee
                const monthlyStats = {};
                const weeklyTrends = {}; // Track data by week for trend chart
                
                filteredUsers.forEach(([uid, user]) => {
                    monthlyStats[uid] = {
                        name: user.fullName || user.email,
                        group: user.group || 'Unknown',
                        isTL: user.isTL || false,
                        office: 0,
                        homeFull: 0,
                        dayOff: 0,
                        vacation: 0,
                        sick: 0,
                        halfDayOff: 0,
                        businessTrip: 0,
                        conference: 0,
                        university: 0,
                        reservedDuty: 0,
                        teamEvent: 0,
                        holiday: 0,
                        notSet: 0,
                        totalWorkDays: 0
                    };
                });

                allAttendance.forEach(doc => {
                    const data = doc.data();
                    const userId = data.userId;
                    const weekId = data.weekId;
                    
                    // Parse weekId format: "2025-W47"
                    const weekIdMatch = weekId.match(/^(\d{4})-W(\d{2})$/);
                    if (!weekIdMatch) return;
                    
                    const weekYear = parseInt(weekIdMatch[1]);
                    const weekNum = parseInt(weekIdMatch[2]);
                    
                    // Calculate the date of the week's Sunday
                    const firstDayOfYear = new Date(weekYear, 0, 1);
                    const daysOffset = (weekNum - 1) * 7;
                    const weekDate = new Date(firstDayOfYear.getTime() + daysOffset * 86400000);
                    weekDate.setDate(weekDate.getDate() - firstDayOfYear.getDay());
                    
                    // Check if this week is in the current month
                    if (weekDate.getMonth() === currentMonth && weekDate.getFullYear() === currentYear) {
                        // Initialize week data if not exists
                        if (!weeklyTrends[weekId]) {
                            weeklyTrends[weekId] = {
                                weekNum: weekNum,
                                office: 0,
                                homeFull: 0,
                                other: 0
                            };
                        }
                        
                        if (monthlyStats[userId]) {
                            const days = data.days || [];
                            days.forEach(status => {
                                monthlyStats[userId].totalWorkDays++;
                                
                                // Count for monthly stats
                                if (status === 'Office') monthlyStats[userId].office++;
                                else if (status === 'Home-full') monthlyStats[userId].homeFull++;
                                else if (status === 'Day off') monthlyStats[userId].dayOff++;
                                else if (status === 'Vacation') monthlyStats[userId].vacation++;
                                else if (status === 'Sick') monthlyStats[userId].sick++;
                                else if (status === 'Half day off') monthlyStats[userId].halfDayOff++;
                                else if (status === 'Business trip') monthlyStats[userId].businessTrip++;
                                else if (status === 'Conference') monthlyStats[userId].conference++;
                                else if (status === 'University') monthlyStats[userId].university++;
                                else if (status === 'Reserved duty') monthlyStats[userId].reservedDuty++;
                                else if (status === 'Team event') monthlyStats[userId].teamEvent++;
                                else if (status === 'Holiday') monthlyStats[userId].holiday++;
                                else monthlyStats[userId].notSet++;
                                
                                // Count for weekly trends
                                if (status === 'Office') {
                                    weeklyTrends[weekId].office++;
                                } else if (status === 'Home-full') {
                                    weeklyTrends[weekId].homeFull++;
                                } else {
                                    weeklyTrends[weekId].other++;
                                }
                            });
                        }
                    }
                });

                // Calculate aggregated statistics
                const aggregateStats = {
                    totalOffice: 0,
                    totalHome: 0,
                    totalDayOff: 0,
                    totalVacation: 0,
                    totalSick: 0,
                    totalBusinessTrip: 0,
                    totalOther: 0
                };

                Object.values(monthlyStats).forEach(stats => {
                    aggregateStats.totalOffice += stats.office;
                    aggregateStats.totalHome += stats.homeFull;
                    aggregateStats.totalDayOff += stats.dayOff + stats.halfDayOff;
                    aggregateStats.totalVacation += stats.vacation;
                    aggregateStats.totalSick += stats.sick;
                    aggregateStats.totalBusinessTrip += stats.businessTrip + stats.conference + stats.university;
                    aggregateStats.totalOther += stats.reservedDuty + stats.teamEvent + stats.holiday + stats.notSet;
                });

                // Create temporary container for PDF content
                const pdfContent = document.createElement('div');
                pdfContent.style.padding = '20px';
                pdfContent.style.backgroundColor = 'white';
                pdfContent.style.width = '1000px';
                
                // Add header
                pdfContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="font-size: 26px; font-weight: bold; color: #1428a0; margin-bottom: 5px;">Samsung R&D Center Israel</h1>
                        <h2 style="font-size: 22px; font-weight: 600; color: #333; margin-bottom: 5px;">Monthly Attendance Analytics</h2>
                        <p style="font-size: 16px; color: #666; margin-bottom: 10px;">${monthName}</p>
                        <div style="font-size: 12px; color: #888;">
                            <span><strong>Group:</strong> ${selectedGroupText}</span> | 
                            <span><strong>Employee:</strong> ${selectedEmployeeText}</span>
                        </div>
                        <div style="font-size: 10px; color: #aaa; margin-top: 10px;">
                            Generated on ${new Date().toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'short' })}
                        </div>
                    </div>
                `;

                // Add KPI Summary Cards
                const kpiSection = document.createElement('div');
                kpiSection.style.cssText = 'display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;';
                
                const totalDays = aggregateStats.totalOffice + aggregateStats.totalHome + aggregateStats.totalDayOff + 
                                 aggregateStats.totalVacation + aggregateStats.totalSick + aggregateStats.totalBusinessTrip + aggregateStats.totalOther;
                const officePercentage = totalDays > 0 ? ((aggregateStats.totalOffice / totalDays) * 100).toFixed(1) : 0;
                const homePercentage = totalDays > 0 ? ((aggregateStats.totalHome / totalDays) * 100).toFixed(1) : 0;
                
                kpiSection.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Total Work Days</div>
                        <div style="font-size: 28px; font-weight: bold;">${totalDays}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Office Days</div>
                        <div style="font-size: 28px; font-weight: bold;">${aggregateStats.totalOffice}</div>
                        <div style="font-size: 11px; opacity: 0.9;">${officePercentage}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Remote Days</div>
                        <div style="font-size: 28px; font-weight: bold;">${aggregateStats.totalHome}</div>
                        <div style="font-size: 11px; opacity: 0.9;">${homePercentage}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; text-align: center; color: white;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Time Off</div>
                        <div style="font-size: 28px; font-weight: bold;">${aggregateStats.totalDayOff + aggregateStats.totalVacation + aggregateStats.totalSick}</div>
                    </div>
                `;
                pdfContent.appendChild(kpiSection);

                // Add Charts Section
                const chartsSection = document.createElement('div');
                chartsSection.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;';
                
                // Create canvas elements for charts
                const pieCanvas = document.createElement('canvas');
                pieCanvas.width = 400;
                pieCanvas.height = 300;
                pieCanvas.style.cssText = 'background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                
                const barCanvas = document.createElement('canvas');
                barCanvas.width = 400;
                barCanvas.height = 300;
                barCanvas.style.cssText = 'background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                
                chartsSection.appendChild(pieCanvas);
                chartsSection.appendChild(barCanvas);
                pdfContent.appendChild(chartsSection);

                // Draw Pie Chart - Status Distribution
                const pieCtx = pieCanvas.getContext('2d');
                new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Office', 'Remote', 'Day Off', 'Vacation', 'Sick', 'Business Trip', 'Other'],
                        datasets: [{
                            data: [
                                aggregateStats.totalOffice,
                                aggregateStats.totalHome,
                                aggregateStats.totalDayOff,
                                aggregateStats.totalVacation,
                                aggregateStats.totalSick,
                                aggregateStats.totalBusinessTrip,
                                aggregateStats.totalOther
                            ],
                            backgroundColor: [
                                '#10b981',
                                '#3b82f6',
                                '#f59e0b',
                                '#ef4444',
                                '#dc2626',
                                '#8b5cf6',
                                '#6b7280'
                            ]
                        }]
                    },
                    options: {
                        responsive: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Status Distribution',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Draw Bar Chart - Weekly Trend
                const sortedWeeks = Object.entries(weeklyTrends).sort((a, b) => a[1].weekNum - b[1].weekNum);
                const weekLabels = sortedWeeks.map(([weekId]) => weekId);
                const officeByWeek = sortedWeeks.map(([, data]) => data.office);
                const homeByWeek = sortedWeeks.map(([, data]) => data.homeFull);
                const otherByWeek = sortedWeeks.map(([, data]) => data.other);
                
                const barCtx = barCanvas.getContext('2d');
                new Chart(barCtx, {
                    type: 'line',
                    data: {
                        labels: weekLabels,
                        datasets: [
                            {
                                label: 'Office',
                                data: officeByWeek,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            },
                            {
                                label: 'Remote',
                                data: homeByWeek,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            },
                            {
                                label: 'Other',
                                data: otherByWeek,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }
                        ]
                    },
                    options: {
                        responsive: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Weekly Attendance Trend',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Days'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Week'
                                }
                            }
                        }
                    }
                });

                // Wait for charts to render
                await new Promise(resolve => setTimeout(resolve, 500));

                // Add detailed statistics table
                const tableSection = document.createElement('div');
                tableSection.style.cssText = 'margin-top: 30px; page-break-before: always;';
                
                let tableHTML = `
                    <h3 style="font-size: 20px; font-weight: bold; color: #333; margin-bottom: 20px; text-align: center;">
                        Detailed Monthly Statistics
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Employee</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Office</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Remote</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Day Off</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Vacation</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Sick</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Business</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Other</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Total</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Office %</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                Object.entries(monthlyStats).forEach(([uid, stats], index) => {
                    const total = stats.totalWorkDays;
                    const officePercent = total > 0 ? ((stats.office / total) * 100).toFixed(1) : 0;
                    const rowBg = index % 2 === 0 ? '#f9fafb' : 'white';
                    const fontWeight = stats.isTL ? 'bold' : 'normal';
                    
                    tableHTML += `
                        <tr style="background-color: ${rowBg};">
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: ${fontWeight};">${stats.name}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #dcfce7;">${stats.office}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #dbeafe;">${stats.homeFull}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #fef3c7;">${stats.dayOff + stats.halfDayOff}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #fee2e2;">${stats.vacation}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #fecaca;">${stats.sick}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #f3e8ff;">${stats.businessTrip + stats.conference + stats.university}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #f3f4f6;">${stats.reservedDuty + stats.teamEvent + stats.holiday + stats.notSet}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;">${total}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold; color: #10b981;">${officePercent}%</td>
                        </tr>
                    `;
                });

                // Add summary row
                const grandTotal = Object.values(monthlyStats).reduce((sum, stats) => sum + stats.totalWorkDays, 0);
                const avgOfficePercent = grandTotal > 0 ? ((aggregateStats.totalOffice / grandTotal) * 100).toFixed(1) : 0;
                
                tableHTML += `
                        <tr style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; font-weight: bold;">
                            <td style="border: 1px solid #ddd; padding: 10px;">TOTAL</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${aggregateStats.totalOffice}</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${aggregateStats.totalHome}</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${aggregateStats.totalDayOff}</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${aggregateStats.totalVacation}</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${aggregateStats.totalSick}</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${aggregateStats.totalBusinessTrip}</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${aggregateStats.totalOther}</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${grandTotal}</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${avgOfficePercent}%</td>
                        </tr>
                    </tbody>
                </table>
                `;
                
                tableSection.innerHTML = tableHTML;
                pdfContent.appendChild(tableSection);

                // Temporarily add to DOM for rendering
                pdfContent.style.position = 'absolute';
                pdfContent.style.left = '-9999px';
                document.body.appendChild(pdfContent);

                // Wait a bit more for everything to render
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Capture the content as canvas
                const canvas = await html2canvas(pdfContent, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: 1000,
                    windowWidth: 1000
                });

                // Remove temporary element
                document.body.removeChild(pdfContent);

                // Create PDF
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 190;
                const pageHeight = 277;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 10;

                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight + 10;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Generate filename
                const groupName = selectedGroupText.replace(/[^a-z0-9]/gi, '_');
                const employeeName = selectedEmployeeText.replace(/[^a-z0-9]/gi, '_');
                const dateStr = `${currentYear}_${String(currentMonth + 1).padStart(2, '0')}`;
                const filename = `Monthly_Analytics_${groupName}_${employeeName}_${dateStr}.pdf`;

                pdf.save(filename);

                // Wait a bit before downloading Excel to avoid browser blocking
                await new Promise(resolve => setTimeout(resolve, 500));

                // --- Export Excel file ---
                await exportExcelForMonth(monthlyStats, aggregateStats, selectedGroupText, selectedEmployeeText, monthName, currentYear, currentMonth);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // --- Export Statistics to Excel ---
        async function exportExcelForMonth(monthlyStats, aggregateStats, selectedGroupText, selectedEmployeeText, monthName, currentYear, currentMonth) {
            try {
                // Prepare data for Excel
                const excelData = [];
                
                // Add header row
                excelData.push([
                    'Employee',
                    'Group',
                    'Office',
                    'Remote',
                    'Day Off',
                    'Vacation',
                    'Sick',
                    'Half Day Off',
                    'Business Trip',
                    'Conference',
                    'University',
                    'Reserved Duty',
                    'Team Event',
                    'Holiday',
                    'Not Set',
                    'Total Work Days',
                    'Office %'
                ]);

                // Add employee data rows
                Object.entries(monthlyStats).forEach(([uid, stats]) => {
                    const total = stats.totalWorkDays;
                    const officePercent = total > 0 ? ((stats.office / total) * 100).toFixed(1) : 0;
                    
                    excelData.push([
                        stats.name,
                        stats.group,
                        stats.office,
                        stats.homeFull,
                        stats.dayOff,
                        stats.vacation,
                        stats.sick,
                        stats.halfDayOff,
                        stats.businessTrip,
                        stats.conference,
                        stats.university,
                        stats.reservedDuty,
                        stats.teamEvent,
                        stats.holiday,
                        stats.notSet,
                        total,
                        officePercent + '%'
                    ]);
                });

                // Add summary row
                const grandTotal = Object.values(monthlyStats).reduce((sum, stats) => sum + stats.totalWorkDays, 0);
                const avgOfficePercent = grandTotal > 0 ? ((aggregateStats.totalOffice / grandTotal) * 100).toFixed(1) : 0;
                
                excelData.push([
                    'TOTAL',
                    '',
                    aggregateStats.totalOffice,
                    aggregateStats.totalHome,
                    aggregateStats.totalDayOff,
                    aggregateStats.totalVacation,
                    aggregateStats.totalSick,
                    '',
                    aggregateStats.totalBusinessTrip,
                    '',
                    '',
                    '',
                    '',
                    '',
                    aggregateStats.totalOther,
                    grandTotal,
                    avgOfficePercent + '%'
                ]);

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                // Set column widths
                const colWidths = [
                    { wch: 20 }, // Employee
                    { wch: 12 }, // Group
                    { wch: 8 },  // Office
                    { wch: 8 },  // Remote
                    { wch: 10 }, // Day Off
                    { wch: 10 }, // Vacation
                    { wch: 8 },  // Sick
                    { wch: 12 }, // Half Day Off
                    { wch: 14 }, // Business Trip
                    { wch: 12 }, // Conference
                    { wch: 12 }, // University
                    { wch: 14 }, // Reserved Duty
                    { wch: 12 }, // Team Event
                    { wch: 10 }, // Holiday
                    { wch: 10 }, // Not Set
                    { wch: 14 }, // Total Work Days
                    { wch: 10 }  // Office %
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Monthly Statistics');

                // Generate filename
                const groupName = selectedGroupText.replace(/[^a-z0-9]/gi, '_');
                const employeeName = selectedEmployeeText.replace(/[^a-z0-9]/gi, '_');
                const dateStr = `${currentYear}_${String(currentMonth + 1).padStart(2, '0')}`;
                const excelFilename = `Monthly_Analytics_${groupName}_${employeeName}_${dateStr}.xlsx`;

                // Save Excel file
                XLSX.writeFile(wb, excelFilename);

            } catch (error) {
                console.error('Error generating Excel:', error);
                alert('Failed to generate Excel: ' + error.message);
            }
        }

        // --- Drag and Drop for Update Week ---
        function initializeUpdateWeekDragDrop() {
            const container = document.getElementById('attendance-days-container');
            let sourceIndex = null;
            let lastHoveredElement = null;

            // Cleanup function to reset states
            const cleanup = () => {
                if (lastHoveredElement) {
                    lastHoveredElement.classList.remove('drag-over-animated');
                }
                document.querySelectorAll('.dragging-item').forEach(el => el.classList.remove('dragging-item'));
                sourceIndex = null;
                lastHoveredElement = null;
            };

            // This function is called on drop/touchend to perform the cascade
            const performCascadeUpdate = (targetIndex) => {
                if (sourceIndex === null || targetIndex === null || sourceIndex >= targetIndex) return;

                // Cascade the value down from the source to the target
                for (let i = sourceIndex + 1; i <= targetIndex; i++) {
                    const valueFromAbove = document.getElementById(`day-${i - 1}`).value;
                    const currentSelect = document.getElementById(`day-${i}`);
                    if (currentSelect) {
                        currentSelect.value = valueFromAbove;
                    }
                }
            };

            const handleMove = (x, y) => {
                const targetElement = document.elementFromPoint(x, y)?.closest('.apply-down-btn');
                
                // If not hovering over a valid target anymore, remove animation from last hovered
                if (lastHoveredElement && lastHoveredElement !== targetElement) {
                    lastHoveredElement.classList.remove('drag-over-animated');
                    lastHoveredElement = null;
                }

                // If hovering over a new, valid target
                if (targetElement) {
                    const targetIndex = parseInt(targetElement.dataset.dayIndex, 10);
                    if (sourceIndex !== null && targetIndex > sourceIndex) {
                        targetElement.classList.add('drag-over-animated');
                        lastHoveredElement = targetElement;
                    }
                }
            };

            // --- Mouse Events ---
            container.addEventListener('dragstart', (e) => {
                const target = e.target.closest('.apply-down-btn');
                if (target && target.draggable) {
                    sourceIndex = parseInt(target.dataset.dayIndex, 10);
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', sourceIndex);
                    setTimeout(() => { target.classList.add('dragging-item'); }, 0);
                } else {
                    e.preventDefault();
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                handleMove(e.clientX, e.clientY);
            });
            
            container.addEventListener('dragend', cleanup);

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                if (lastHoveredElement) {
                    const targetIndex = parseInt(lastHoveredElement.dataset.dayIndex, 10);
                    performCascadeUpdate(targetIndex);
                }
                cleanup();
            });

            // --- Touch Events ---
            container.addEventListener('touchstart', (e) => {
                const target = e.target.closest('.apply-down-btn');
                if (target && target.draggable) {
                    sourceIndex = parseInt(target.dataset.dayIndex, 10);
                    target.classList.add('dragging-item');
                    // Prevent page scroll while dragging the icon
                    e.preventDefault();
                }
            }, { passive: false });

            container.addEventListener('touchmove', (e) => {
                if (sourceIndex === null) return;
                e.preventDefault();
                const touch = e.touches[0];
                handleMove(touch.clientX, touch.clientY);
            }, { passive: false });

            container.addEventListener('touchend', (e) => {
                if (sourceIndex === null) return;
                if (lastHoveredElement) {
                    const targetIndex = parseInt(lastHoveredElement.dataset.dayIndex, 10);
                    performCascadeUpdate(targetIndex);
                }
                cleanup();
            });
        }

    </script>

    <script>
      let deferredPrompt;
      const installButton = document.getElementById('install-pwa-button');

      window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later.
        deferredPrompt = e;
        // Update UI notify the user they can install the PWA
        installButton.style.display = 'block';
      });

      installButton.addEventListener('click', async () => {
        // hide our user interface that shows our A2HS button
        installButton.style.display = 'none';
        // Show the prompt
        deferredPrompt.prompt();
        // Wait for the user to respond to the prompt
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        // We've used the prompt, and can't use it again, throw it away
        deferredPrompt = null;
      });

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('Service Worker registered!');
            })
            .catch(error => {
              console.log('Service Worker registration failed: ', error);
            });
        });
      }
    </script>

</body>
</html>


